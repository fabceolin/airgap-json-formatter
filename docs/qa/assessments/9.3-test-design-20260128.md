# Test Design: Story 9.3 - Share Button UI Integration

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** Share Button UI Integration
**Status:** DRAFT

---

## Test Strategy Overview

| Metric | Count | Percentage |
|--------|-------|------------|
| **Total test scenarios** | 42 | 100% |
| Unit tests | 8 | 19% |
| Integration tests | 18 | 43% |
| E2E tests | 16 | 38% |

**Priority distribution:**
- P0 (Critical): 14 tests
- P1 (High): 16 tests
- P2 (Medium): 10 tests
- P3 (Low): 2 tests

**Rationale for test level distribution:**
- Heavy integration focus (43%) due to bridge.js ↔ WASM ↔ QML component interactions
- Significant E2E coverage (38%) required for cross-browser validation (AC16) and user journey completeness
- Unit tests (19%) focus on isolated URL construction and parameter parsing logic

---

## Test Scenarios by Acceptance Criteria

### AC1: Share button placement in Toolbar.qml

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-001 | Integration | P1 | Share button renders in correct position (between separator and Copy) | UI component placement requires integration with Toolbar.qml layout |
| 9.3-E2E-001 | E2E | P2 | Visual regression - Share button styling matches existing buttons | Cross-browser visual consistency |

### AC2: Share button disabled state

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-UNIT-001 | Unit | P0 | `canShare` property false when input empty | Pure state logic |
| 9.3-UNIT-002 | Unit | P0 | `canShare` property false when JSON invalid | Pure validation logic |
| 9.3-INT-002 | Integration | P0 | Share button disabled when `canShare=false` | Button binding to property |
| 9.3-INT-003 | Integration | P1 | Share button enabled when valid JSON present | State propagation test |

### AC3: Security tooltip

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-004 | Integration | P0 | Tooltip displays security warning text | Security UX - must warn users about URL access model |
| 9.3-E2E-002 | E2E | P1 | Tooltip appears after 500ms delay | User experience timing |

### AC4: ShareDialog modal

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-005 | Integration | P1 | ShareDialog opens when Share button clicked | Component wiring |
| 9.3-INT-006 | Integration | P1 | ShareDialog displays passphrase field | Component structure |
| 9.3-INT-007 | Integration | P1 | ShareDialog emits `shareConfirmed(passphrase)` signal | Signal wiring |
| 9.3-INT-008 | Integration | P2 | ShareDialog emits `cancelled()` signal | Signal wiring |

### AC5: Quick share URL format

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-UNIT-003 | Unit | P0 | URL constructed as `?d={data}#{key}` for quick share | Pure URL construction logic - security critical |
| 9.3-INT-009 | Integration | P0 | `createShareUrl()` returns correct format with no passphrase | Bridge ↔ WASM interaction |
| 9.3-E2E-003 | E2E | P0 | Quick share generates valid URL across browsers | Cross-browser validation |

### AC6: Protected share URL format

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-UNIT-004 | Unit | P0 | URL constructed as `?d={data}&p=1` for protected share | Pure URL construction logic - security critical |
| 9.3-INT-010 | Integration | P0 | `createShareUrl()` returns correct format with passphrase | Bridge ↔ WASM interaction |
| 9.3-E2E-004 | E2E | P0 | Protected share generates URL without key fragment | Security verification |

### AC7: Clipboard and status message

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-011 | Integration | P0 | URL copied to clipboard on success | Clipboard API integration |
| 9.3-E2E-005 | E2E | P0 | Clipboard works in Chrome | Cross-browser clipboard - critical |
| 9.3-E2E-006 | E2E | P0 | Clipboard works in Firefox | Cross-browser clipboard - critical |
| 9.3-E2E-007 | E2E | P0 | Clipboard works in Safari | Cross-browser clipboard - critical (stricter API) |
| 9.3-E2E-008 | E2E | P0 | Clipboard works in Edge | Cross-browser clipboard - critical |
| 9.3-INT-012 | Integration | P1 | Quick share success message displayed | Status feedback |
| 9.3-INT-013 | Integration | P1 | Protected share success message displayed | Status feedback |

### AC8: JSON too large error

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-UNIT-005 | Unit | P1 | URL length check rejects >8000 chars | Pure validation logic |
| 9.3-INT-014 | Integration | P1 | "Too large" error shown in dialog for >50KB JSON | Error display integration |

### AC9: Startup share URL detection

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-UNIT-006 | Unit | P0 | `getShareParams()` extracts `d` parameter correctly | URL parsing logic |
| 9.3-UNIT-007 | Unit | P0 | `getShareParams()` detects `p=1` flag | URL parsing logic |
| 9.3-UNIT-008 | Unit | P0 | `getShareParams()` extracts key from hash fragment | URL parsing logic |

### AC10: Passphrase prompt for protected links

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-015 | Integration | P0 | PassphrasePrompt.qml shown when `p=1` in URL | Component wiring - security critical |
| 9.3-E2E-009 | E2E | P1 | Passphrase field uses password masking | Security UX |

### AC11: Successful share load

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-016 | Integration | P0 | Valid quick share URL loads JSON into input pane | Core functionality |
| 9.3-INT-017 | Integration | P0 | Valid protected share with correct passphrase loads JSON | Core functionality |
| 9.3-E2E-010 | E2E | P1 | Auto-format triggered after share load | User experience |

### AC12: Expired link handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-INT-018 | Integration | P1 | Expired link shows correct error message | Error handling |
| 9.3-E2E-011 | E2E | P2 | Expired link message user-friendly | UX validation |

### AC13: Wrong passphrase handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-E2E-012 | E2E | P1 | Wrong passphrase shows "Incorrect passphrase" | Error message display |
| 9.3-E2E-013 | E2E | P1 | Retry allowed after wrong passphrase | Retry flow works |

### AC14: Invalid/corrupted link handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-E2E-014 | E2E | P1 | Corrupted data shows "Invalid or corrupted" message | Error handling |
| 9.3-E2E-015 | E2E | P2 | Truncated URL handled gracefully | Edge case |

### AC15: Keyboard shortcut

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-E2E-016 | E2E | P2 | Ctrl+Shift+S opens share dialog | Keyboard accessibility |

### AC16: Cross-browser testing

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.3-E2E-017 | E2E | P2 | Full quick share flow in Chrome 90+ | Browser compatibility |
| 9.3-E2E-018 | E2E | P2 | Full protected share flow in Firefox 88+ | Browser compatibility |
| 9.3-E2E-019 | E2E | P3 | URL fragment preserved in Safari 14+ | Safari-specific behavior |
| 9.3-E2E-020 | E2E | P3 | Full share flow in Edge 90+ | Browser compatibility |

---

## Risk Coverage Mapping

| Risk ID | Risk Title | Mitigating Tests |
|---------|------------|------------------|
| SEC-001 | URL fragment key leakage | 9.3-INT-004 (tooltip), 9.3-UNIT-003, 9.3-E2E-004 |
| SEC-002 | Passphrase exposure in DOM | 9.3-E2E-009 (password masking) |
| TECH-001 | Clipboard cross-browser | 9.3-E2E-005, 9.3-E2E-006, 9.3-E2E-007, 9.3-E2E-008 |
| TECH-002 | URL length limits | 9.3-UNIT-005, 9.3-INT-014 |
| SEC-003 | Browser history/referer leakage | Covered by clearShareParams() - verify URL cleaned |
| OPS-001 | PBKDF2 blocking UI | Manual verification during P1 tests |
| UX-001 | Passphrase dialog UX | 9.3-E2E-012, 9.3-E2E-013 |

---

## Recommended Execution Order

### Phase 1: P0 Tests (Fail Fast - 14 tests)
1. Unit tests: 9.3-UNIT-001 through 9.3-UNIT-008 (8 tests)
2. Integration tests: 9.3-INT-002, 9.3-INT-004, 9.3-INT-009, 9.3-INT-010, 9.3-INT-011, 9.3-INT-015, 9.3-INT-016, 9.3-INT-017 (6 tests)

### Phase 2: P1 Tests (Core Functionality - 16 tests)
1. Integration: 9.3-INT-001, 9.3-INT-003, 9.3-INT-005-008, 9.3-INT-012-014, 9.3-INT-018 (11 tests)
2. E2E: 9.3-E2E-002, 9.3-E2E-009, 9.3-E2E-010, 9.3-E2E-012-014 (5 tests)

### Phase 3: P2 Tests (Secondary - 10 tests)
1. E2E: 9.3-E2E-001, 9.3-E2E-011, 9.3-E2E-015-018 (6 tests)
2. Integration: 9.3-INT-008 (1 test)

### Phase 4: P3 Tests (If Time Permits - 2 tests)
1. E2E: 9.3-E2E-019, 9.3-E2E-020 (2 tests)

---

## Test Data Requirements

### Valid JSON Samples
```json
// Small (< 1KB)
{"name": "test", "value": 123}

// Medium (~10KB)
// Array with 100 objects

// Large (~50KB - at limit)
// Array with 500 objects

// Too large (>50KB - should fail)
// Array with 1000 objects
```

### URL Test Data
```
// Quick share URL
?d=eyJhbGciOiJBMjU2R0NNIn0.eyJ0IjoxNzA2NDU2MDAwfQ.BASE64DATA#BASE64KEY

// Protected share URL
?d=eyJhbGciOiJBMjU2R0NNIn0.eyJ0IjoxNzA2NDU2MDAwfQ.BASE64DATA&p=1

// Expired URL (timestamp > 5 min old)
?d=eyJhbGciOiJBMjU2R0NNIn0.eyJ0IjoxNzA2NDU1MDAwfQ.EXPIREDDATA#KEY

// Corrupted URL
?d=INVALID_BASE64_DATA#KEY
```

### Passphrase Test Data
```
// Valid passphrases
"simple"
"Complex123!"
"Unicode: 日本語"
"Very long passphrase with spaces and special chars !@#$%"

// Invalid (for wrong passphrase tests)
"wrongpassword"
```

---

## Environment Requirements

### Browser Matrix

| Browser | Minimum Version | Priority |
|---------|-----------------|----------|
| Chrome | 90+ | P0 |
| Firefox | 88+ | P0 |
| Safari | 14+ | P0 |
| Edge | 90+ | P1 |

### Test Tooling

| Tool | Purpose |
|------|---------|
| Jest/Vitest | Unit tests for bridge.js functions |
| QML Test Framework | Integration tests for QML components |
| Playwright | E2E cross-browser tests |
| Manual Testing | Safari clipboard quirks, visual validation |

### Special Considerations

1. **Safari Clipboard**: Safari has stricter clipboard API requirements - user gesture required
2. **WASM Initialization**: Tests must wait for WASM module to initialize
3. **AsyncSerialiser**: Share operations use the async serialiser - ensure queue handling
4. **Time-dependent tests**: Expired link tests need mocked timestamps or wait mechanisms

---

## Quality Checklist

- [x] Every AC has test coverage (16 ACs → 42 tests)
- [x] Test levels are appropriate (shift-left applied)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (security = P0)
- [x] Test IDs follow naming convention (9.3-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Risk mitigations mapped to tests

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 42
  by_level:
    unit: 8
    integration: 18
    e2e: 16
  by_priority:
    p0: 14
    p1: 16
    p2: 10
    p3: 2
  coverage_gaps: []
  risk_coverage:
    - SEC-001: covered
    - SEC-002: covered
    - TECH-001: covered
    - TECH-002: covered
```

---

## Trace References

```
Test design matrix: docs/qa/assessments/9.3-test-design-20260128.md
P0 tests identified: 14
Critical security tests: 9.3-UNIT-003, 9.3-UNIT-004, 9.3-INT-004, 9.3-INT-015, 9.3-E2E-004
Cross-browser tests: 9.3-E2E-005 through 9.3-E2E-008
```

---

**Reviewed by:** Quinn (Test Architect) — 2026-01-28
