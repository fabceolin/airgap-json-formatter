# Requirements Traceability Matrix

## Story: 9.2 - Rust Share Decoding & Validation

**Date:** 2026-01-28 | **Reviewer:** Quinn (Test Architect) | **Status:** Post-Implementation VERIFIED

### Coverage Summary

- **Total Requirements:** 15
- **Fully Covered:** 13 (87%)
- **Partially Covered:** 2 (13%)
- **Not Covered:** 0 (0%)

### Test Execution Results

```
cargo test share:: --lib
    Passed: 39/39 tests
    Failed: 0
```

### Requirement Mappings

#### AC1: `decode_share_payload` function signature

**Coverage: FULL**

Given-When-Then Mappings:

- **Implementation**: `share.rs:296-348`
  - Given: Valid encoded payload and key/passphrase
  - When: `decode_share_payload(data, key_or_passphrase, is_passphrase)` called
  - Then: Returns `Result<DecodeResult, ShareError>` with json, created_at, mode

#### AC2: `DecodeResult` struct fields

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_decode_result_fields`
  - Given: Successful decode
  - When: Result inspected
  - Then: Contains `json: String`, `created_at: u64`, `mode: String` ("quick" or "protected")

#### AC3: Base64URL decoding

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_base64url_roundtrip`
  - Given: Arbitrary bytes
  - When: Encoded then decoded
  - Then: Original bytes recovered

- **Unit Test**: `test_base64url_no_padding`
  - Given: Short data requiring padding in standard base64
  - When: Encoded
  - Then: No '=' padding characters present

- **Unit Test**: `test_base64url_url_safe_chars`
  - Given: Bytes 0-255
  - When: Encoded
  - Then: No '+' or '/' characters (URL-safe)

- **Unit Test**: `test_base64url_invalid_input`
  - Given: Invalid base64 string
  - When: Decoded
  - Then: Returns `ShareError::InvalidBase64`

#### AC4: Random key mode decryption

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_encrypt_decrypt_roundtrip`
  - Given: Plaintext and random 32-byte key
  - When: Encrypted then decrypted
  - Then: Original plaintext recovered

- **Integration Test**: `test_roundtrip_random_key_mode`
  - Given: JSON payload, no passphrase
  - When: Created share payload then decoded with returned key
  - Then: Original JSON recovered, mode="quick"

#### AC5: Passphrase mode: salt, PBKDF2, nonce, decrypt

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_pbkdf2_deterministic`
  - Given: Same passphrase and salt
  - When: Key derived twice
  - Then: Identical 32-byte keys produced

- **Unit Test**: `test_pbkdf2_different_passphrase`
  - Given: Different passphrases, same salt
  - When: Keys derived
  - Then: Different keys produced

- **Unit Test**: `test_pbkdf2_different_salt`
  - Given: Same passphrase, different salts
  - When: Keys derived
  - Then: Different keys produced

- **Integration Test**: `test_roundtrip_passphrase_mode`
  - Given: JSON payload with passphrase
  - When: Created then decoded with same passphrase
  - Then: Original JSON recovered, mode="protected"

#### AC6: Version byte verification (0x01/0x02)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_extract_header_valid`
  - Given: Header with version=0x01 and timestamp
  - When: Extracted
  - Then: Version byte parsed correctly as 0x01

- **Integration Test**: `test_mode_mismatch_key_as_passphrase`
  - Given: Random-key payload (version=0x01)
  - When: Decoded as passphrase mode (expects version=0x02)
  - Then: Error returned (version mismatch)

#### AC7: Timestamp extraction (bytes 1-8, big-endian u64)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_extract_header_valid`
  - Given: Header with known timestamp bytes
  - When: Extracted
  - Then: Correct u64 timestamp parsed from bytes 1-8

#### AC8: Expiration (>300s returns `Expired`)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_expiration_boundary_not_expired`
  - Given: Timestamp 299 seconds ago
  - When: Validated
  - Then: Success (not expired)

- **Unit Test**: `test_expiration_boundary_exactly_300`
  - Given: Timestamp 300 seconds ago
  - When: Validated
  - Then: Success (boundary inclusive)

- **Unit Test**: `test_expiration_boundary_expired`
  - Given: Timestamp 301 seconds ago
  - When: Validated
  - Then: Returns `ShareError::Expired`

- **Integration Test**: `test_expired_link`
  - Given: Payload created, then time advanced 301 seconds
  - When: Decoded
  - Then: Returns `ShareError::Expired`

**Implementation Note:** Injectable clock via `#[cfg(test)]` thread-local `MOCK_TIMESTAMP` at `share.rs:102-125`

#### AC9: DEFLATE decompression

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_compress_decompress_roundtrip`
  - Given: JSON with header compressed via DEFLATE
  - When: Decompressed
  - Then: Original header + JSON bytes recovered

- **Unit Test**: `test_decompress_invalid_data`
  - Given: Invalid DEFLATE bytes
  - When: Decompression attempted
  - Then: Error returned

**Implementation Note:** `MAX_DECOMPRESSED_SIZE = 10MB` enforced via chunked reads at `share.rs:280-291`

#### AC10: `InvalidPayload` for malformed data

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_extract_header_too_short`
  - Given: Data < 9 bytes
  - When: Header extraction attempted
  - Then: Returns `ShareError::InvalidPayload`

- **Unit Test**: `test_decrypt_too_short`
  - Given: Ciphertext < nonce length
  - When: Decryption attempted
  - Then: Returns `ShareError::InvalidPayload`

- **Integration Test**: `test_truncated_data`
  - Given: Only 5 bytes of payload
  - When: Full decode attempted
  - Then: Returns error

#### AC11: `DecryptionFailed` for wrong key/tampered data

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_decrypt_wrong_key`
  - Given: Ciphertext encrypted with key1
  - When: Decrypted with key2
  - Then: Returns `ShareError::DecryptionFailed`

- **Integration Test**: `test_wrong_key`
  - Given: Valid payload
  - When: Decoded with random wrong key
  - Then: Returns `ShareError::DecryptionFailed`

- **Integration Test**: `test_wrong_passphrase`
  - Given: Payload created with "correct-pass"
  - When: Decoded with "wrong-pass"
  - Then: Returns `ShareError::DecryptionFailed`

- **Integration Test**: `test_tampered_data`
  - Given: Valid payload with bit flipped
  - When: Decoded
  - Then: Returns `ShareError::DecryptionFailed` (GCM tag verification fails)

#### AC12: WASM binding `decodeSharePayload`

**Coverage: PARTIAL (Code Review Only)**

Given-When-Then Mappings:

- **Code Review**: `lib.rs:196-218`
  - Given: JS caller with data, keyOrPassphrase, isPassphrase
  - When: `decodeSharePayload()` binding invoked
  - Then: Returns JSON string response

**Gap:** No `wasm-pack test` scenario verifying JS-callable interface

#### AC13: WASM response shape

**Coverage: PARTIAL (Code Review Only)**

Given-When-Then Mappings:

- **Code Review**: `lib.rs:199-217`
  - Given: Successful decode
  - When: Response serialized
  - Then: `{"success":true,"json":"...","createdAt":N,"mode":"quick|protected"}`

  - Given: Failed decode
  - When: Response serialized
  - Then: `{"success":false,"error":"...","errorCode":"..."}`

**Gap:** No JSON schema validation test for response structure

#### AC14: Error codes mapping

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `test_error_codes`
  - Given: Each ShareError variant
  - When: `error_code()` called
  - Then: Correct string code returned

- **WASM Layer**: `lib.rs:208-211`
  - Given: `DecryptionFailed` error with `is_passphrase=true`
  - When: Error serialized
  - Then: errorCode = `"wrong_passphrase"` (special mapping)

Error code mapping:
| ShareError | errorCode |
|------------|-----------|
| Expired | `"expired"` |
| InvalidPayload | `"invalid_payload"` |
| DecryptionFailed | `"decryption_failed"` |
| DecryptionFailed (passphrase mode) | `"wrong_passphrase"` |
| InvalidBase64 | `"invalid_base64"` |

#### AC15: Unit tests for both modes, expiry, wrong passphrase, tampered

**Coverage: FULL**

All required scenarios implemented and passing:

| Scenario | Test | Status |
|----------|------|--------|
| Random key round-trip | `test_roundtrip_random_key_mode` | ✅ PASS |
| Passphrase round-trip | `test_roundtrip_passphrase_mode` | ✅ PASS |
| Expired link rejection | `test_expired_link` | ✅ PASS |
| Wrong key rejection | `test_wrong_key` | ✅ PASS |
| Wrong passphrase rejection | `test_wrong_passphrase` | ✅ PASS |
| Tampered data rejection | `test_tampered_data` | ✅ PASS |
| Mode mismatch | `test_mode_mismatch_key_as_passphrase` | ✅ PASS |
| Truncated data | `test_truncated_data` | ✅ PASS |
| Invalid Base64 | `test_invalid_base64_input` | ✅ PASS |

### Critical Gaps

| Gap ID | ACs | Description | Severity | Recommendation |
|--------|-----|-------------|----------|----------------|
| GAP-3 | AC12-13 | No WASM-target integration test | Low | Add `wasm-pack test --headless --chrome` scenarios |
| GAP-5 | NFR | No PBKDF2 performance benchmark | Low | Add latency assertion (<2s for 1MB in WASM) |

### Resolved Gaps

| Gap ID | ACs | Original Issue | Resolution |
|--------|-----|----------------|------------|
| GAP-1 | AC8 | Non-deterministic timestamp tests | `#[cfg(test)]` injectable clock at `share.rs:102-125` |
| GAP-2 | AC9 | No decompression bomb mitigation | `MAX_DECOMPRESSED_SIZE = 10MB` with chunked reads |
| GAP-4 | AC14 | `wrong_passphrase` code ambiguity | Mapped in WASM layer at `lib.rs:209` |
| GAP-6 | NFR | Timing side-channel | Accepted: relies on `aes-gcm` crate guarantees |

### Risk Assessment

- **Low Risk:** AC12, AC13 - WASM binding interface tested via code review only (no automated test)
- **No High Risk Requirements:** All functional ACs have full unit + integration coverage

### Test Design Recommendations

Based on remaining gaps:

1. **WASM Integration Tests** (Low Priority)
   - Add `wasm-pack test --headless --chrome` scenarios
   - Test: binding returns valid JSON
   - Test: error responses have correct schema

2. **Performance Benchmark** (Low Priority)
   - Add PBKDF2 decode latency test in WASM
   - Target: <2 seconds for 1MB payload

3. **Decompression Bomb Test** (Enhancement)
   - Logic exists but no explicit test
   - Create crafted payload expanding >10MB
   - Verify `InvalidPayload` returned

---

**Trace matrix file:** `docs/qa/assessments/9.2-trace-20260128.md`
