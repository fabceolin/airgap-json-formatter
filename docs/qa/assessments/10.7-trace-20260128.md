# Requirements Traceability Matrix

## Story: 10.7 - Theme Extension for Markdown

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 5 (71%)
- Partially Covered: 2 (29%)
- Not Covered: 0 (0%)

### Traceability Matrix Overview

| AC | Requirement | Coverage | Test IDs | Level(s) |
|----|-------------|----------|----------|----------|
| AC1 | Theme.qml extended with Markdown syntax colors | **FULL** | 10.7-UNIT-001, 002, 003, 004 | Unit |
| AC2 | Theme.qml extended with preview pane colors | **FULL** | 10.7-UNIT-005, 006, 007 | Unit |
| AC3 | Mermaid theme configuration defined | **FULL** | 10.7-UNIT-008, 009, 10.7-INT-001 | Unit, Integration |
| AC4 | WCAG AA contrast requirements | **FULL** | 10.7-UNIT-010, 10.7-INT-002 | Unit, Integration |
| AC5 | Colors documented with usage notes | **PARTIAL** | 10.7-INT-003 | Integration |
| AC6 | Both themes look professional | **PARTIAL** | 10.7-E2E-001, 002 | E2E (visual only) |
| AC7 | Theme toggle updates Markdown views | **FULL** | 10.7-INT-004, 005, 10.7-E2E-003 | Integration, E2E |

---

### Requirement Mappings

#### AC1: Theme.qml extended with Markdown syntax colors

**Coverage: FULL**

Given-When-Then Mappings:

- **10.7-UNIT-001** (P0) - Property Existence Test
  - Given: Theme.qml is loaded
  - When: All `syntax*` properties are accessed (syntaxHeading, syntaxStrike, syntaxLink, syntaxUrl, syntaxCodeInlineBg, syntaxCodeBlockBg, syntaxCodeBorder, syntaxBlockquote, syntaxBlockquoteBorder, syntaxListMarker, syntaxMermaidBg, syntaxMermaidBorder)
  - Then: Each returns a valid QML `color` type (no undefined)

- **10.7-UNIT-002** (P1) - Heading Color Values
  - Given: Theme with `darkMode = true` then `darkMode = false`
  - When: `syntaxHeading` is read
  - Then: Returns `#569cd6` (dark) / `#0066cc` (light)

- **10.7-UNIT-003** (P1) - Link vs URL Distinction
  - Given: Theme loaded in either mode
  - When: `syntaxLink` and `syntaxUrl` are compared
  - Then: They are visually distinct colors (link: teal family, url: orange/purple family)

- **10.7-UNIT-004** (P2) - Inline vs Block Code Background
  - Given: Theme loaded
  - When: `syntaxCodeInlineBg` and `syntaxCodeBlockBg` are compared
  - Then: They are distinct values (inline slightly lighter than block in dark mode)

#### AC2: Theme.qml extended with preview pane colors

**Coverage: FULL**

Given-When-Then Mappings:

- **10.7-UNIT-005** (P0) - Property Existence Test
  - Given: Theme.qml is loaded
  - When: All `preview*` properties are accessed (previewBackground, previewText, previewHeading, previewLink, previewCodeBg, previewCodeText, previewTableBorder, previewTableHeaderBg, previewBlockquoteBorder, previewHrColor)
  - Then: Each returns a valid QML `color` type

- **10.7-UNIT-006** (P1) - Text/Background Contrast
  - Given: Theme loaded in dark mode
  - When: Contrast ratio of `previewText` (#d4d4d4) on `previewBackground` (#1e1e1e) is computed
  - Then: Ratio = 10.5:1 (exceeds 4.5:1 requirement)

- **10.7-UNIT-007** (P2) - Heading vs Text Distinction
  - Given: Theme loaded
  - When: `previewHeading` (#569cd6) and `previewText` (#d4d4d4) compared
  - Then: They are visually distinct (heading: blue accent, text: neutral gray)

#### AC3: Mermaid theme configuration defined

**Coverage: FULL**

Given-When-Then Mappings:

- **10.7-UNIT-008** (P1) - Dark Theme Structure
  - Given: Theme loaded
  - When: `mermaidDarkTheme` accessed
  - Then: Object contains `theme: "dark"` and `themeVariables` with required keys:
    - `primaryColor` (#1a365d)
    - `primaryTextColor` (#d4d4d4)
    - `lineColor` (#808080)
    - `background` (#1e1e1e)
    - Plus 20+ diagram-specific variables

- **10.7-UNIT-009** (P1) - Light Theme Structure
  - Given: Theme loaded
  - When: `mermaidLightTheme` accessed
  - Then: Object has same structure as dark theme with `theme: "default"` and matching keys

- **10.7-INT-001** (P1) - Theme Switch Integration
  - Given: Theme with `darkMode = true`
  - When: `darkMode` toggled to `false`
  - Then: `mermaidTheme` property returns light theme object instead of dark

#### AC4: WCAG AA contrast requirements

**Coverage: FULL**

Given-When-Then Mappings:

- **10.7-UNIT-010** (P0) - Contrast Ratio Validation
  - Given: All 12 foreground/background color pairs from both themes:
    1. syntaxHeading (#569cd6) on background (#1e1e1e) - Dark
    2. syntaxLink (#4ec9b0) on background (#1e1e1e) - Dark
    3. syntaxUrl (#ce9178) on background (#1e1e1e) - Dark
    4. syntaxStrike (#808080) on background (#1e1e1e) - Dark
    5. syntaxBlockquote (#608b4e) on background (#1e1e1e) - Dark
    6. syntaxListMarker (#d4d4d4) on background (#1e1e1e) - Dark
    7. previewText (#d4d4d4) on previewBackground (#1e1e1e) - Dark
    8. previewHeading (#569cd6) on previewBackground (#1e1e1e) - Dark
    9. previewLink (#4ec9b0) on previewBackground (#1e1e1e) - Dark
    10. previewCodeText (#d4d4d4) on previewCodeBg (#252526) - Dark
    11. mermaid primaryTextColor on primaryColor - Dark
    12. Same 11 pairs for Light theme
  - When: Contrast ratios computed using relative luminance formula `(L1+0.05)/(L2+0.05)`
  - Then: All pairs >= 4.5:1 (WCAG AA for normal text)

- **10.7-INT-002** (P0) - CI Pipeline Integration
  - Given: CI pipeline running on code changes
  - When: Contrast check script executes against Theme.qml color values
  - Then: Build fails if any pair < 4.5:1; passes otherwise

#### AC5: Colors documented with usage notes

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **10.7-INT-003** (P2) - Section Comment Validation
  - Given: Theme.qml source file
  - When: Section comment markers are searched
  - Then: Grouped comments exist for:
    - "Markdown Syntax Highlighting Colors"
    - "Markdown Preview Pane Colors"
    - "Mermaid Diagram Theme Configuration"

**Gap**: Test only verifies section headers exist, not per-property inline comments with usage notes.

#### AC6: Both themes look professional

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **10.7-E2E-001** (P1) - Dark Theme Visual Review
  - Given: App loaded with dark theme and sample Markdown containing h1-h6, bold, italic, strikethrough, links, inline code, fenced code blocks, blockquotes, ordered/unordered lists, and a mermaid diagram
  - When: Visual review performed by human reviewer
  - Then: All elements visible, distinct from each other, and appear professional (VS Code Dark+ aesthetic)

- **10.7-E2E-002** (P1) - Light Theme Visual Review
  - Given: App loaded with light theme and same sample Markdown
  - When: Visual review performed by human reviewer
  - Then: All elements visible, distinct from each other, and appear professional (GitHub light aesthetic)

**Gap**: Visual review is inherently manual. No baseline screenshots for regression comparison.

#### AC7: Theme toggle updates Markdown views correctly

**Coverage: FULL**

Given-When-Then Mappings:

- **10.7-INT-004** (P1) - Property Reactivity Test
  - Given: Theme loaded in dark mode
  - When: `darkMode` property toggled to `false`
  - Then: All new `syntax*`, `preview*`, `mermaid*` properties return their light-mode values

- **10.7-INT-005** (P2) - Rapid Toggle Stress Test
  - Given: Theme loaded
  - When: `darkMode` toggled 10 times in <1 second
  - Then: No QML warnings emitted, no undefined values returned, state remains consistent

- **10.7-E2E-003** (P2) - Visual Toggle with Preview
  - Given: Preview pane open with rendered Markdown content
  - When: Theme toggled via UI control
  - Then: No flicker, smooth color transition, all elements update simultaneously

---

### Critical Gaps

#### GAP-001: Documentation Depth (Low Severity)

- **Requirement**: AC5 - Colors documented with usage notes
- **Gap**: Test 10.7-INT-003 only checks for section comments, not per-property inline comments
- **Risk**: Low - Developers can understand usage from property names and section context
- **Action**: Add assertion that each new property has an inline comment explaining its purpose

#### GAP-002: Visual Regression Baseline (Medium Severity)

- **Requirement**: AC6 - Both themes look professional
- **Gap**: Visual review is manual-only; no baseline screenshots exist for regression testing
- **Risk**: Medium - Future changes to dependent stories (10.5, 10.6) could regress appearance
- **Action**: Capture reference screenshots for both themes as baseline before closing this story

#### GAP-003: Downstream Contract Test (Low Severity)

- **Requirement**: AC1 - Syntax colors
- **Gap**: No negative test verifying property names match what downstream stories (10.5, 10.6) expect
- **Risk**: Low - Rename/removal would break dependents but would likely surface during integration
- **Action**: Add contract test verifying exact property names expected by 10.5 and 10.6

#### GAP-004: Light Theme Contrast Enumeration (Low Severity)

- **Requirement**: AC4 - WCAG AA contrast
- **Gap**: Story lists dark theme contrast ratios explicitly but only notes "similar - all pass AA" for light theme
- **Risk**: Low - Ratios should be computed and documented during implementation
- **Action**: Explicitly list all light theme ratios in WCAG table during implementation

---

### Test Design Recommendations

Based on gaps identified:

1. **Visual Baseline Capture** (Priority: Before closing)
   - Capture screenshots of both dark and light themes with comprehensive sample Markdown
   - Store in `docs/qa/baselines/10.7/` for regression comparison
   - Include: syntax highlighting view, preview pane, mermaid diagram

2. **Property Contract Test** (Priority: Nice-to-have)
   - Type: Unit
   - Create test that asserts all property names expected by stories 10.5 and 10.6 exist
   - Prevents accidental renames from breaking downstream

3. **Documentation Completeness Check** (Priority: Nice-to-have)
   - Type: Integration
   - Parse Theme.qml and verify each `syntax*`, `preview*`, `mermaid*` property has inline comment

4. **Light Theme Contrast Validation** (Priority: During implementation)
   - Compute and document all 12 light theme color pairs with exact ratios
   - Add to story's WCAG Contrast Verification table

---

### Test Data Requirements

- **Sample Markdown File**: Must contain all element types:
  - Headings h1 through h6
  - Bold, italic, strikethrough text
  - Links with visible URLs
  - Inline `code` and fenced code blocks
  - Blockquotes (single and nested)
  - Ordered and unordered lists
  - Mermaid diagram block (flowchart recommended)

- **Contrast Calculator**: Script using relative luminance formula:
  ```
  L = 0.2126 * R + 0.7152 * G + 0.0722 * B
  (after sRGB linearization)
  Ratio = (L1 + 0.05) / (L2 + 0.05)
  ```

---

### Risk Assessment

| Risk Level | Requirements | Notes |
|------------|--------------|-------|
| Low Risk | AC1, AC2, AC3, AC4, AC7 | Full coverage with unit + integration tests |
| Medium Risk | AC6 | Visual-only testing, no automated regression |
| Low Risk | AC5 | Partial coverage sufficient for documentation |

---

### Summary

- **18 test scenarios** cover all 7 acceptance criteria
- **No AC is completely uncovered**
- **2 partial coverages** (AC5 documentation, AC6 visual) are inherently subjective and difficult to fully automate
- **4 gaps identified** - GAP-002 (visual baseline) is the only medium-severity item worth addressing before closing
- **Overall trace quality: GOOD** - Comprehensive Given-When-Then mappings enable clear understanding of test intent

---

Reviewed by: Quinn (Test Architect) | 2026-01-28
