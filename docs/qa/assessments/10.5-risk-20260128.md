# Risk Profile: Story 10.5 - Markdown Preview Pane

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 1
- High Risks: 2
- Medium Risks: 2
- Low Risks: 3
- Risk Score: 62/100 (calculated)

This story introduces a WebEngineView-based preview pane for rendered Markdown/HTML content. The primary concern is **XSS vulnerability** through malicious content injection in user-provided Markdown that renders as HTML with embedded SVG diagrams.

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: XSS via Malicious HTML/SVG in Rendered Content

**Score: 9 (Critical)**

**Probability**: High (3) - User-provided Markdown is converted to HTML and rendered in a WebEngineView. Malicious users can craft Markdown with embedded JavaScript via:
- `<script>` tags in raw HTML blocks
- SVG `onload`/`onerror` event handlers
- `javascript:` URIs in links
- CSS expressions and behaviors

**Impact**: High (3) - Arbitrary JavaScript execution could:
- Access Qt bridge and invoke WASM functions
- Exfiltrate clipboard data
- Manipulate DOM to phish user credentials
- Access local storage/session data

**Mitigation**:
- Implement robust HTML sanitization (DOMPurify or equivalent)
- Strip all `on*` event handlers
- Remove `<script>`, `<iframe>`, `<object>`, `<embed>` tags
- Sanitize SVG content specifically (Mermaid output)
- Use Content Security Policy with `script-src 'none'`

**Testing Focus**:
- XSS payload injection tests (OWASP XSS filter evasion cheat sheet)
- SVG-based XSS vectors
- Markdown edge cases that produce dangerous HTML

## High Risks

### 2. SEC-002: External Resource Loading Bypasses Security Controls

**Score: 6 (High)**

**Probability**: Medium (2) - AC#5 mentions image placeholders, but implementation gaps could allow:
- CSS `url()` fetches for backgrounds, fonts
- `<link>` tags for external stylesheets
- Favicon requests
- `<img>` srcset variants

**Impact**: High (3) - Violates "airgap" security model:
- Leaks user IP/activity to external servers
- Potential for tracking pixels
- SSRF-like behavior in sensitive environments

**Mitigation**:
- Configure WebEngineView with `setUrlRequestInterceptor` to block all non-local requests
- Set `QWebEngineSettings::LocalContentCanAccessRemoteUrls` to false
- Implement CSS sanitization to remove `url()` references
- Test with network monitoring

**Testing Focus**:
- Network traffic monitoring during preview rendering
- CSS with external `url()` references
- HTML with various external resource types

### 3. TECH-001: WebEngineView vs TextArea Decision Impacts Feature Scope

**Score: 6 (High)**

**Probability**: High (3) - Story recommends WebEngineView but leaves door open for TextArea. This architectural decision affects:
- SVG rendering capability (TextArea cannot render SVG)
- Security surface area (WebEngineView is much larger)
- Binary size and dependencies
- Cross-platform consistency

**Impact**: Medium (2) - Wrong choice leads to:
- Rework if TextArea chosen then SVG needed
- Security hardening complexity if WebEngineView chosen
- User confusion if features vary by platform

**Mitigation**:
- Make definitive architecture decision before implementation
- Document trade-offs in ADR
- If WebEngineView: Plan security hardening sprint
- If TextArea: Accept SVG limitation and document workaround

**Testing Focus**:
- Verify chosen approach meets all ACs
- Test SVG rendering if WebEngineView
- Test fallback behavior if TextArea

## Medium Risks

### 4. SEC-003: WebEngineView Link Navigation Escape

**Score: 4 (Medium)**

**Probability**: Medium (2) - AC#3 specifies links "are not clickable for security," but:
- `onNavigationRequested` rejection may not cover all cases
- Middle-click, drag-drop, context menu could bypass
- `window.open()` from JS (if XSS exists)

**Impact**: Medium (2) - User could be redirected to malicious site:
- Phishing attacks
- Malware downloads
- Privacy leakage via URL parameters

**Mitigation**:
- Disable JavaScript entirely in WebEngineView
- Set `QWebEngineSettings::JavascriptEnabled` to false
- Use `pointer-events: none` on all `<a>` tags via CSS
- Intercept all navigation types

**Testing Focus**:
- Click, middle-click, ctrl+click on links
- Drag link to address bar
- Right-click context menu options

### 5. PERF-001: Large Document Rendering Causes UI Freeze

**Score: 4 (Medium)**

**Probability**: Medium (2) - AC#8 mentions 500KB test target, but:
- HTML rendering is synchronous
- Complex Mermaid diagrams add SVG overhead
- Multiple theme switches could compound

**Impact**: Medium (2) - Poor user experience:
- UI becomes unresponsive
- User thinks app crashed
- May lose work if they force-quit

**Mitigation**:
- Implement 300ms debounce per AC#9
- Use `requestAnimationFrame` for chunked rendering
- Add loading indicator during render
- Consider virtualized/paginated rendering for very large docs

**Testing Focus**:
- Render 500KB Markdown with 10+ diagrams
- Rapid content changes (typing test)
- Theme toggle during render

## Low Risks

### 6. TECH-002: Theme CSS Injection Timing Issues

**Score: 2 (Low)**

**Probability**: Medium (2) - Theme toggle must update preview CSS:
- Race between theme change and CSS reload
- Flash of unstyled content possible

**Impact**: Low (1) - Visual glitch only, no data loss

**Mitigation**:
- Debounce theme changes
- Fade transition during theme switch
- Pre-load both theme stylesheets

### 7. DATA-001: Clipboard Copy Exposes Raw HTML Unexpectedly

**Score: 2 (Low)**

**Probability**: Low (1) - AC#7 specifies copy copies HTML source, but users may expect plain text

**Impact**: Medium (2) - User pastes HTML into unexpected context

**Mitigation**:
- Clear copy button labeling ("Copy HTML")
- Toast notification confirms what was copied
- Consider offering both HTML and plain text options

### 8. OPS-001: QtWebEngine Dependency Adds Significant Binary Size

**Score: 3 (Low)**

**Probability**: High (3) - QtWebEngine is a large dependency (~50MB+)

**Impact**: Low (1) - Affects distribution size but not functionality

**Mitigation**:
- Document binary size impact
- Consider making WebEngine optional/lazy-loaded
- For WASM: Use browser's native rendering (iframe or shadow DOM)

## Risk Distribution

### By Category
- Security: 3 risks (1 critical, 1 high, 1 medium)
- Performance: 1 risk (1 medium)
- Technical: 2 risks (1 high, 1 low)
- Data: 1 risk (1 low)
- Operational: 1 risk (1 low)

### By Component
- WebEngineView/Preview: 6 risks
- Theme System: 1 risk
- Copy Functionality: 1 risk

## Detailed Risk Register

| Risk ID | Category | Title | Prob | Impact | Score | Priority | Mitigation Status |
|---------|----------|-------|------|--------|-------|----------|-------------------|
| SEC-001 | Security | XSS via HTML/SVG content | 3 | 3 | 9 | Critical | Required |
| SEC-002 | Security | External resource loading | 2 | 3 | 6 | High | Required |
| TECH-001 | Technical | Architecture decision pending | 3 | 2 | 6 | High | Required |
| SEC-003 | Security | Link navigation escape | 2 | 2 | 4 | Medium | Required |
| PERF-001 | Performance | Large doc UI freeze | 2 | 2 | 4 | Medium | Recommended |
| OPS-001 | Operational | Binary size increase | 3 | 1 | 3 | Low | Optional |
| TECH-002 | Technical | Theme CSS timing | 2 | 1 | 2 | Low | Optional |
| DATA-001 | Data | Clipboard HTML confusion | 1 | 2 | 2 | Low | Optional |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (SEC-001)
- XSS injection test suite with OWASP payloads
- SVG-based XSS vectors (onload, onerror, etc.)
- Script injection via Markdown code blocks
- Event handler injection tests
- `javascript:` URI tests

### Priority 2: High Risk Tests (SEC-002, TECH-001)
- Network traffic monitoring during all preview operations
- External resource blocking verification
- Architecture validation tests
- Feature completeness tests per chosen approach

### Priority 3: Medium Risk Tests (SEC-003, PERF-001)
- Link interaction tests (all click types)
- Navigation interception tests
- 500KB document rendering test
- Rapid input test (typing while preview updates)

### Priority 4: Low Risk Tests
- Theme switching visual tests
- Copy functionality clarity tests
- Binary size measurement

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-001: XSS vulnerability (score 9)
- SEC-002: External resource loading (score 6)
- TECH-001: Architecture decision (score 6)

### Can Deploy with Mitigation
- SEC-003: Link navigation (with JS disabled)
- PERF-001: Large documents (with debounce + indicator)

### Accepted Risks
- TECH-002: Theme timing (cosmetic only)
- DATA-001: Clipboard confusion (UX improvement, not blocking)
- OPS-001: Binary size (documented trade-off)

## Monitoring Requirements

Post-deployment monitoring for:
- Error rates in preview rendering
- Performance metrics for large documents
- User reports of security/navigation issues

## Risk Review Triggers

Review and update risk profile when:
- Architecture decision is finalized
- New content types added to preview
- Security vulnerabilities discovered in QtWebEngine
- Performance issues reported by users

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 1
    high: 2
    medium: 2
    low: 3
  highest:
    id: SEC-001
    score: 9
    title: 'XSS via malicious HTML/SVG in rendered content'
  recommendations:
    must_fix:
      - 'Implement HTML sanitization (DOMPurify or equivalent) before rendering'
      - 'Configure CSP with script-src none'
      - 'Block all external resource loading in WebEngineView'
      - 'Finalize WebEngineView vs TextArea architecture decision'
    monitor:
      - 'Large document rendering performance'
      - 'Theme switching timing'
```

---

Risk profile: docs/qa/assessments/10.5-risk-20260128.md
