# Requirements Traceability Matrix

## Story: 10.6 - Markdown Syntax Highlighting (Code View)

**Trace Date:** 2026-01-28
**Traced By:** Quinn (Test Architect)
**Story Status:** Draft (NOT IMPLEMENTED)

---

### Coverage Summary

| Metric | Count | Percentage |
|--------|-------|------------|
| Total Requirements | 7 | 100% |
| Fully Covered | 0 | 0% |
| Partially Covered | 0 | 0% |
| Not Covered | 7 | 100% |

**Overall Coverage Status:** ❌ **NONE** - Implementation not started

---

### Implementation Status

The `markdown_highlighter.rs` module referenced in the story **does not exist**. Current codebase only contains:
- `src/markdown_renderer.rs` - Markdown to HTML rendering (Story 10.1)
- `src/highlighter.rs` - JSON syntax highlighting
- `src/xml_highlighter.rs` - XML syntax highlighting

The story 10.6 requires creating a **new** module `src/markdown_highlighter.rs` following the patterns established in `highlighter.rs` and `xml_highlighter.rs`.

---

### Requirement Mappings

#### AC1: Markdown syntax highlighted in Code view with Theme.qml colors

**Coverage: NONE**

| Test Type | Test File | Test Case | Status |
|-----------|-----------|-----------|--------|
| Unit | `src/markdown_highlighter.rs` | (not created) | Missing |
| Integration | `qt/qml/Theme.qml` | CSS variable integration | Missing |
| E2E | Browser | Visual verification | Missing |

**Gap Analysis:**
- Module not created
- No Rust tests exist
- No Theme.qml integration
- No CSS class definitions for `.md-*` classes

**Suggested Tests:**
```rust
// Given-When-Then for traceability (not test code)
Given: Valid Markdown source text
When: highlightMarkdown() is called
Then: Returns HTML with span elements using Theme.qml compatible classes
```

---

#### AC2: Elements highlighted (headings, bold, italic, code, links, lists, blockquotes, horizontal rules)

**Coverage: NONE**

| Element | Span Class | Test Status |
|---------|------------|-------------|
| Headings (`#`-`######`) | `.md-heading` | Missing |
| Bold (`**text**`) | `.md-bold` | Missing |
| Italic (`*text*`) | `.md-italic` | Missing |
| Strikethrough (`~~text~~`) | `.md-strike` | Missing |
| Inline code (`` `code` ``) | `.md-code-inline` | Missing |
| Code blocks (``` ``` ```) | `.md-code-block` | Missing |
| Links (`[text](url)`) | `.md-link`, `.md-link-text`, `.md-link-url` | Missing |
| Lists (`-`, `*`, `1.`) | `.md-list-marker` | Missing |
| Blockquotes (`>`) | `.md-blockquote` | Missing |
| Horizontal rules (`---`) | `.md-hr` | Missing |

**Suggested Test Mappings:**

```yaml
# 10.6-UNIT-001: Heading H1
test_file: 'src/markdown_highlighter.rs::tests'
test_case: 'test_highlight_heading_h1'
given: '# Heading'
when: 'highlight_markdown() called'
then: 'Returns <span class="md-heading"># Heading</span>'
coverage: none

# 10.6-UNIT-002: Bold text
test_file: 'src/markdown_highlighter.rs::tests'
test_case: 'test_highlight_bold'
given: '**bold text**'
when: 'highlight_markdown() called'
then: 'Returns <span class="md-bold">**bold text**</span>'
coverage: none

# 10.6-UNIT-003: Italic text
test_file: 'src/markdown_highlighter.rs::tests'
test_case: 'test_highlight_italic'
given: '*italic text*'
when: 'highlight_markdown() called'
then: 'Returns <span class="md-italic">*italic text*</span>'
coverage: none
```

---

#### AC3: Mermaid code blocks highlighted distinctly

**Coverage: NONE**

| Test Type | Test File | Given | When | Then | Status |
|-----------|-----------|-------|------|------|--------|
| Unit | `markdown_highlighter.rs` | ` ```mermaid\ngraph TD\n``` ` | highlight_markdown() | Returns `<span class="md-mermaid">` | Missing |
| Visual | E2E | Mermaid block in Code view | User views | Distinct background/border | Missing |

**Gap Analysis:**
- Special class `.md-mermaid` not implemented
- No visual distinction testing

---

#### AC4: WASM binding `highlightMarkdown(input)` exposed to JavaScript

**Coverage: NONE**

| Test Type | Location | Given | When | Then | Status |
|-----------|----------|-------|------|------|--------|
| Integration | `src/lib.rs` | WASM compiled | `highlightMarkdown()` exported | Function callable from JS | Missing |
| Integration | `public/bridge.js` | Bridge method | `JsonBridge.highlightMarkdown()` | Returns HTML string | Missing |
| E2E | `tests/` | Browser loaded | Call from console | Returns highlighted HTML | Missing |

**Gap Analysis:**
- `#[wasm_bindgen]` export not in `lib.rs`
- No `highlightMarkdown()` method in `bridge.js`
- Reference pattern exists: `highlightJson()` and `highlightXml()` in bridge.js

---

#### AC5: Performance acceptable for 1MB documents (< 200ms)

**Coverage: NONE**

| Test Type | Test File | Given | When | Then | Status |
|-----------|-----------|-------|------|------|--------|
| Unit | `markdown_highlighter.rs` | 1MB Markdown document | highlight_markdown() | Completes in < 200ms | Missing |
| Unit | `markdown_highlighter.rs` | Pathological regex input | highlight_markdown() | No catastrophic backtracking | Missing |

**Gap Analysis:**
- No performance benchmark test
- Regex patterns not yet defined
- Risk: PERF-001 (regex backtracking) not mitigated

**Suggested Test:**
```rust
#[test]
fn test_large_document_performance() {
    let large_doc = "# Heading\n\nParagraph with **bold** and *italic*.\n".repeat(10000);
    let start = std::time::Instant::now();
    let _ = highlight_markdown(&large_doc);
    assert!(start.elapsed().as_millis() < 200, "Should complete in < 200ms");
}
```

---

#### AC6: Output is XSS-safe (HTML entities escaped)

**Coverage: NONE**

| Test Type | Test File | Given | When | Then | Status |
|-----------|-----------|-------|------|------|--------|
| Unit | `markdown_highlighter.rs` | `<script>alert(1)</script>` | highlight_markdown() | `<` → `&lt;`, `>` → `&gt;` | Missing |
| Unit | `markdown_highlighter.rs` | `**</span><script>**` | highlight_markdown() | Span injection blocked | Missing |
| Unit | `markdown_highlighter.rs` | `" and '` in content | highlight_markdown() | `&quot;` and `&#39;` | Missing |
| E2E | Browser | XSS payload | Render in Code view | No script execution | Missing |

**Gap Analysis:**
- `escape_html()` function shown in Dev Notes only escapes `<`, `>`, `&`
- Missing quote escaping (`"`, `'`) per NFR assessment
- Story test cases exist but no implementation

**Critical Security Gap:**
The story's Dev Notes `escape_html()` function is incomplete:
```rust
// CURRENT (incomplete)
fn escape_html(s: &str) -> String {
    s.replace('&', "&amp;")
     .replace('<', "&lt;")
     .replace('>', "&gt;")
}

// REQUIRED (complete)
fn escape_html(s: &str) -> String {
    s.replace('&', "&amp;")
     .replace('<', "&lt;")
     .replace('>', "&gt;")
     .replace('"', "&quot;")
     .replace('\'', "&#39;")
}
```

---

#### AC7: Works correctly with Theme.qml dark and light modes

**Coverage: NONE**

| Test Type | Location | Given | When | Then | Status |
|-----------|----------|-------|------|------|--------|
| Integration | `qt/qml/Theme.qml` | Theme properties defined | Dark mode active | Correct colors applied | Missing |
| Integration | `qt/qml/Theme.qml` | Theme properties defined | Light mode active | Correct colors applied | Missing |
| Visual | E2E | Theme toggle | User switches | All `.md-*` classes update | Missing |

**Gap Analysis:**
- Theme.qml additions shown in Dev Notes not implemented
- CSS variables for Markdown syntax colors not defined
- No integration between highlight output and Theme system

---

### Critical Gaps Summary

| Gap ID | Severity | AC | Description | Recommendation |
|--------|----------|-----|-------------|----------------|
| GAP-001 | Critical | All | Module `markdown_highlighter.rs` does not exist | Create module following xml_highlighter.rs pattern |
| GAP-002 | Critical | AC4 | WASM binding not exposed | Add `#[wasm_bindgen]` to lib.rs |
| GAP-003 | Critical | AC4 | Bridge method not implemented | Add `highlightMarkdown()` to bridge.js |
| GAP-004 | High | AC6 | Incomplete HTML escaping (missing `"`, `'`) | Add quote escaping to escape_html() |
| GAP-005 | High | AC6 | No span injection test | Add test for `**</span><script>**` pattern |
| GAP-006 | Medium | AC5 | No performance benchmark | Add 1MB document test |
| GAP-007 | Medium | AC7 | Theme integration missing | Add Theme.qml properties |

---

### Test Design Recommendations

Based on the gap analysis, the following tests are required before implementation can pass QA:

#### Must Have (P0)

1. **Unit Tests - Rust** (`src/markdown_highlighter.rs::tests`)
   - `test_highlight_heading_h1` through `test_highlight_heading_h6`
   - `test_highlight_bold`
   - `test_highlight_italic`
   - `test_highlight_code_inline`
   - `test_highlight_code_block`
   - `test_highlight_mermaid_block`
   - `test_highlight_link`
   - `test_xss_script_tag`
   - `test_xss_span_injection`
   - `test_xss_quote_escaping`
   - `test_large_document_performance`

2. **Integration Tests - WASM**
   - `test_wasm_binding_exposed`
   - `test_bridge_method_works`

#### Should Have (P1)

3. **Integration Tests - Theme**
   - `test_theme_dark_mode_colors`
   - `test_theme_light_mode_colors`

4. **E2E Tests - Browser**
   - Visual verification in Code view
   - XSS payload security test

---

### Gate YAML Block

```yaml
trace:
  totals:
    requirements: 7
    full: 0
    partial: 0
    none: 7
  planning_ref: 'docs/qa/assessments/10.6-test-design-20260128.md'
  uncovered:
    - ac: 'AC1'
      reason: 'Module markdown_highlighter.rs not created'
    - ac: 'AC2'
      reason: 'No pattern matching implementation'
    - ac: 'AC3'
      reason: 'No Mermaid block detection'
    - ac: 'AC4'
      reason: 'No WASM binding, no bridge method'
    - ac: 'AC5'
      reason: 'No performance benchmarks'
    - ac: 'AC6'
      reason: 'No XSS tests (implementation missing)'
    - ac: 'AC7'
      reason: 'No Theme.qml integration'
  notes: 'Story is in Draft status. No implementation exists. Full implementation required.'
```

---

### Risk Assessment

| Risk | Probability | Impact | Score | Mitigation |
|------|-------------|--------|-------|------------|
| XSS vulnerability in highlighter | Medium | Critical | High | Follow xml_highlighter.rs escape pattern (5 chars) |
| Regex backtracking on large docs | Medium | High | Medium | Profile before release, use state machine if needed |
| Theme colors not visible | Low | Medium | Low | Visual QA during integration |

---

### Trace Matrix Hook Line

```text
Trace matrix: docs/qa/assessments/10.6-trace-20260128.md
```
