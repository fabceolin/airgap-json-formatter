# Test Design: Story 9.2 — Rust Share Decoding & Validation

Date: 2026-01-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 32
- Unit tests: 22 (69%)
- Integration tests: 8 (25%)
- E2E tests: 2 (6%)
- Priority distribution: P0: 14, P1: 12, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: decode_share_payload function signature (AC 1)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-001 | Unit | P1 | Function accepts `(data, key_or_passphrase, is_passphrase)` and returns `Result<DecodeResult, ShareError>` | Pure function contract |

### AC2: DecodeResult struct (AC 2)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-002 | Unit | P1 | DecodeResult contains `json`, `created_at`, `mode` fields with correct types | Struct definition validation |

### AC3: Base64URL decoding (AC 3)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-003 | Unit | P0 | Valid Base64URL input decodes correctly | Core decode path |
| 9.2-UNIT-004 | Unit | P0 | Invalid Base64 returns `ShareError::InvalidBase64` | Error path |
| 9.2-UNIT-005 | Unit | P1 | Empty string input returns error | Edge case |
| 9.2-UNIT-006 | Unit | P2 | Standard Base64 (with +/) is rejected vs URL-safe alphabet | Encoding strictness |

### AC4: Random key mode decryption (AC 4)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-007 | Unit | P0 | Extract 12-byte nonce, decrypt with correct key succeeds | Core crypto path |
| 9.2-UNIT-008 | Unit | P0 | Wrong key returns `ShareError::DecryptionFailed` | Security-critical |
| 9.2-UNIT-009 | Unit | P0 | Ciphertext < 12 bytes returns `ShareError::InvalidPayload` | Boundary: truncated nonce |
| 9.2-UNIT-010 | Unit | P1 | Ciphertext exactly 12 bytes (nonce only, no data) returns error | Boundary |

### AC5: Passphrase mode decryption (AC 5)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-011 | Unit | P0 | Extract 16-byte salt, derive key via PBKDF2, decrypt succeeds | Core crypto path |
| 9.2-UNIT-012 | Unit | P0 | Wrong passphrase returns `ShareError::DecryptionFailed` | Security-critical |
| 9.2-UNIT-013 | Unit | P1 | Payload < 16 bytes (missing salt) returns `ShareError::InvalidPayload` | Boundary: truncated salt |
| 9.2-UNIT-014 | Unit | P1 | Same passphrase + salt produces same derived key as encoder (9.1) | Key derivation consistency |

### AC6: Version byte verification (AC 6)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-015 | Unit | P0 | Version 0x01 accepted for random key mode | Mode matching |
| 9.2-UNIT-016 | Unit | P0 | Version 0x02 accepted for passphrase mode | Mode matching |
| 9.2-UNIT-017 | Unit | P0 | Version mismatch returns `ShareError::InvalidPayload` | Security: mode confusion |
| 9.2-UNIT-018 | Unit | P2 | Unknown version byte (e.g., 0x03) returns error | Forward compat |

### AC7-8: Timestamp extraction and expiration (AC 7, 8)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-UNIT-019 | Unit | P0 | Timestamp 299s ago: succeeds | Expiration boundary |
| 9.2-UNIT-020 | Unit | P0 | Timestamp 301s ago: returns `ShareError::Expired` | Expiration boundary |
| 9.2-UNIT-021 | Unit | P1 | Timestamp 300s ago: verify inclusive/exclusive boundary | Exact boundary |
| 9.2-UNIT-022 | Unit | P2 | Timestamp in the future (clock skew): verify behavior | Edge case |

### AC9: DEFLATE decompression (AC 9)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-INT-001 | Integration | P0 | Compressed JSON decompresses to valid UTF-8 string | Multi-step decode |
| 9.2-INT-002 | Integration | P1 | Invalid compressed data returns error | Error path |
| 9.2-INT-003 | Integration | P2 | Decompression bomb (>10MB output) is rejected or bounded | Risk mitigation: DATA-001 |

### AC10-11: Error handling (AC 10, 11)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-INT-004 | Integration | P0 | Tampered ciphertext (bit-flip) returns `DecryptionFailed` | Tamper detection |
| 9.2-INT-005 | Integration | P1 | Truncated payload at various offsets returns `InvalidPayload` | Robustness |

### AC12-13: WASM bindings (AC 12, 13)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-INT-006 | Integration | P1 | `decodeSharePayload` WASM export returns JSON with `success: true` on valid input | WASM binding contract |
| 9.2-INT-007 | Integration | P1 | WASM export returns `{success: false, error, errorCode}` on failure | WASM error contract |

### AC14: Error codes (AC 14)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-INT-008 | Integration | P1 | All five error codes map correctly: `expired`, `invalid_payload`, `decryption_failed`, `invalid_base64`, `wrong_passphrase` | Error code mapping |

### AC15: Round-trip integration tests (AC 15)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 9.2-E2E-001 | E2E | P0 | Encode (9.1) → Decode (9.2) round-trip: random key mode | End-to-end correctness |
| 9.2-E2E-002 | E2E | P0 | Encode (9.1) → Decode (9.2) round-trip: passphrase mode | End-to-end correctness |

## Risk Coverage

| Risk ID | Test IDs | Coverage |
|---------|----------|----------|
| SEC-001 (Timing side-channel) | 9.2-UNIT-008, 9.2-UNIT-012 | Partial — verify constant-time via `aes-gcm` crate; no explicit timing test |
| SEC-003 (Ciphertext length) | 9.2-UNIT-009, 9.2-UNIT-010, 9.2-UNIT-013, 9.2-INT-005 | Full — boundary tests for truncated payloads |
| TECH-001 (Wire format compat) | 9.2-E2E-001, 9.2-E2E-002, 9.2-UNIT-014 | Full — round-trip encode/decode both modes |
| SEC-002 (Error oracle) | 9.2-INT-008 | Partial — verifies mapping exists; recommend collapsing crypto errors |
| PERF-001 (PBKDF2 blocking) | — | Gap — no performance test scenario (recommend adding benchmark) |
| DATA-002 (Clock skew) | 9.2-UNIT-022 | Partial — tests future timestamp but no configurable clock |
| DATA-001 (Decompression bomb) | 9.2-INT-003 | Full — if max size limit is implemented |
| OPS-001 (js_sys testing) | 9.2-UNIT-019–022 | Partial — requires injectable clock for deterministic tests |

## Test Data Requirements

| Data Item | Description | Source |
|-----------|-------------|--------|
| Valid encoded payloads | Both random-key and passphrase modes | Generate via Story 9.1 `create_share_payload` |
| Known key pairs | Fixed key/passphrase for deterministic tests | Hard-coded test fixtures |
| Tampered payloads | Bit-flipped ciphertext bytes | Derive from valid payloads |
| Truncated payloads | Payloads cut at offsets 0, 11, 12, 15, 16, 28 | Derive from valid payloads |
| Expired payloads | Payloads with timestamps >300s old | Requires injectable clock or manual timestamp construction |
| Decompression bomb | DEFLATE stream expanding to >10MB | Craft synthetic compressed payload |
| Invalid Base64 strings | Non-URL-safe characters, padding issues | Hand-crafted strings |

## Environment Requirements

- Rust toolchain with `wasm32-unknown-unknown` target
- `wasm-pack` for WASM integration tests
- Story 9.1 encoder must be implemented and passing for round-trip tests
- Injectable clock mechanism (or `#[cfg(test)]` timestamp override) for deterministic expiration tests

## Recommended Execution Order

1. P0 Unit tests (fail fast on core crypto logic)
2. P0 Integration tests (tamper detection, decompression)
3. P0 E2E tests (round-trip encode/decode)
4. P1 tests in order (boundaries, WASM bindings, error mapping)
5. P2 tests as time permits (edge cases, decompression bomb)

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 22
    integration: 8
    e2e: 2
  by_priority:
    p0: 14
    p1: 12
    p2: 6
  coverage_gaps:
    - "PERF-001: No PBKDF2 performance benchmark scenario"
    - "OPS-001: Timestamp tests require injectable clock for full determinism"
```

## Trace Reference

Test design matrix: docs/qa/assessments/9.2-test-design-20260128.md
P0 tests identified: 14
