# Test Design: Story 8.7 - Integration Testing

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** Integration Testing for XML Workflows
**Status:** Complete

---

## Test Strategy Overview

| Metric | Value |
|--------|-------|
| Total test scenarios | 54 |
| Unit tests | 8 (15%) |
| Integration tests | 34 (63%) |
| E2E tests | 12 (22%) |
| P0 (Critical) | 18 |
| P1 (High) | 24 |
| P2 (Medium) | 12 |

### Strategy Rationale

This story is unique: it IS the testing task. The test design focuses on:
1. **Integration-heavy approach** - Core value is validating component interactions (formatter ↔ highlighter ↔ tree ↔ bridge)
2. **E2E for cross-browser** - Browser-specific behavior requires real browser execution
3. **Unit for edge cases** - Pure format detection and parsing logic benefits from fast unit tests
4. **Regression protection** - JSON functionality must remain intact

---

## Test Scenarios by Acceptance Criteria

### AC1: Auto-detection correctly identifies JSON vs XML

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-UNIT-001 | Unit | P0 | Detect JSON object `{"a":1}` | Pure parsing logic | - |
| 8.7-UNIT-002 | Unit | P0 | Detect JSON array `[1,2,3]` | Pure parsing logic | - |
| 8.7-UNIT-003 | Unit | P0 | Detect XML element `<root/>` | Pure parsing logic | - |
| 8.7-UNIT-004 | Unit | P0 | Detect XML with declaration `<?xml version="1.0"?>` | Pure parsing logic | - |
| 8.7-UNIT-005 | Unit | P1 | Detect content with BOM prefix | Edge case validation | - |
| 8.7-UNIT-006 | Unit | P1 | Detect whitespace-prefixed content | Edge case validation | - |
| 8.7-INT-001 | Integration | P0 | Bridge `detectFormat()` returns correct type | Component contract | TECH-001 |
| 8.7-INT-002 | Integration | P1 | Format selector updates on detection | UI integration | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-UNIT-001 - Detect JSON object
  Given input text '{"key":"value"}'
  When detectFormat() is called
  Then result equals "json"

Scenario: 8.7-INT-001 - Bridge detection contract
  Given JsonBridge is initialized and WASM ready
  When detectFormat('{"a":1}') is invoked
  Then signal emits with format="json"
  And result available within 1000ms
```

---

### AC2: Format button produces correctly indented XML

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-003 | Integration | P0 | Format XML with 2-space indent | Core functionality | - |
| 8.7-INT-004 | Integration | P0 | Format XML with 4-space indent | Core functionality | - |
| 8.7-INT-005 | Integration | P1 | Format XML with tabs | Configuration option | - |
| 8.7-INT-006 | Integration | P0 | Format preserves attributes order | Data integrity | - |
| 8.7-INT-007 | Integration | P1 | Format preserves namespace prefixes | Data integrity | - |
| 8.7-INT-008 | Integration | P1 | Format preserves CDATA sections | Data integrity | - |
| 8.7-INT-009 | Integration | P1 | Format preserves XML comments | Data integrity | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-003 - Format with 2-space indent
  Given input XML '<root><child/></root>'
  And indent setting is "spaces:2"
  When formatXml() is called via bridge
  Then output contains newlines
  And each nested element is indented by 2 spaces
  And signal completes within 5000ms

Scenario: 8.7-INT-008 - Preserve CDATA
  Given input XML '<root><![CDATA[<special>]]></root>'
  When formatXml() is called
  Then output contains '<![CDATA[<special>]]>'
  And CDATA content is unmodified
```

---

### AC3: Minify button produces compact XML

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-010 | Integration | P0 | Minify removes all whitespace between elements | Core functionality | - |
| 8.7-INT-011 | Integration | P1 | Minify preserves significant whitespace in text nodes | Data integrity | - |
| 8.7-INT-012 | Integration | P1 | Minify preserves CDATA whitespace | Data integrity | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-010 - Minify XML
  Given formatted XML with newlines and indentation
  When minifyXml() is called
  Then output is single line (except preserved whitespace)
  And no whitespace between closing and opening tags
```

---

### AC4: Syntax highlighting displays correct colors

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-013 | Integration | P0 | Tags highlighted in blue (elements) | Visual correctness | - |
| 8.7-INT-014 | Integration | P1 | Attributes highlighted in light blue | Visual correctness | - |
| 8.7-INT-015 | Integration | P1 | Attribute values highlighted in orange | Visual correctness | - |
| 8.7-INT-016 | Integration | P1 | Comments highlighted in green | Visual correctness | - |
| 8.7-INT-017 | Integration | P1 | CDATA highlighted in yellow | Visual correctness | - |
| 8.7-INT-018 | Integration | P1 | Declarations highlighted in purple | Visual correctness | - |
| 8.7-E2E-001 | E2E | P2 | Visual regression - all token types | Full visual validation | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-013 - Tag highlighting
  Given XML '<root><child/></root>'
  When highlightXml() is called
  Then output contains spans with class 'xml-tag'
  And 'root' and 'child' are within tag spans

Scenario: 8.7-E2E-001 - Visual regression
  Given browser at localhost with formatted XML
  When complex XML with all token types is displayed
  Then tags appear blue, attributes light blue
  And values appear orange, comments green
```

---

### AC5: Tree view displays XML structure with expandable nodes

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-019 | Integration | P0 | Elements appear as expandable nodes | Core tree functionality | - |
| 8.7-INT-020 | Integration | P1 | Attributes appear with @ prefix | Display convention | - |
| 8.7-INT-021 | Integration | P1 | Text content appears as leaf nodes | Structure correctness | - |
| 8.7-INT-022 | Integration | P0 | Expand/collapse works | Interactivity | - |
| 8.7-E2E-002 | E2E | P1 | Tree navigation with keyboard | Accessibility | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-019 - Expandable elements
  Given XML '<root><child><grandchild/></child></root>'
  When tree model is constructed
  Then 'root' node is expandable (has children)
  And 'child' node is expandable
  And 'grandchild' is leaf node

Scenario: 8.7-INT-022 - Expand/collapse
  Given tree model with nested XML
  When expand is triggered on 'root'
  Then children become visible
  When collapse is triggered on 'root'
  Then children are hidden
```

---

### AC6: Copy from tree view produces valid XML

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-023 | Integration | P0 | Copy element produces valid XML subtree | Core functionality | - |
| 8.7-INT-024 | Integration | P1 | Copy attribute produces attribute value | Utility feature | - |
| 8.7-E2E-003 | E2E | P1 | Copy to system clipboard works | Cross-platform | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-023 - Copy element
  Given tree model from '<root><item id="1">text</item></root>'
  When copy is triggered on 'item' element
  Then clipboard contains '<item id="1">text</item>'
  And copied XML is well-formed
```

---

### AC7: All JSON functionality continues to work (regression)

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-INT-025 | Integration | P0 | JSON format still works | Regression prevention | BUS-001 |
| 8.7-INT-026 | Integration | P0 | JSON minify still works | Regression prevention | BUS-001 |
| 8.7-INT-027 | Integration | P0 | JSON syntax highlighting works | Regression prevention | BUS-001 |
| 8.7-INT-028 | Integration | P0 | JSON tree view works | Regression prevention | BUS-001 |
| 8.7-INT-029 | Integration | P0 | JSON validation still works | Regression prevention | BUS-001 |
| 8.7-INT-030 | Integration | P1 | History save/load still works | Feature preservation | BUS-001 |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-025 - JSON format regression
  Given input '{"key":"value"}'
  When formatJson() is called with 2-space indent
  Then output is properly formatted JSON
  And output is valid JSON (can be parsed)

Scenario: 8.7-INT-030 - History persistence
  Given formatted JSON document
  When save to history is triggered
  And page is reloaded
  And history item is loaded
  Then original JSON is restored correctly
```

---

### AC8: Cross-browser testing passes

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-E2E-004 | E2E | P0 | Chrome (latest) - full test suite | Primary browser | TECH-002 |
| 8.7-E2E-005 | E2E | P0 | Firefox (latest) - full test suite | Major browser | TECH-002 |
| 8.7-E2E-006 | E2E | P1 | Safari (latest) - full test suite | Apple ecosystem | TECH-002 |
| 8.7-E2E-007 | E2E | P0 | Edge (latest) - full test suite | Enterprise users | TECH-002 |

**Browser Matrix:**
| Test Category | Chrome | Firefox | Safari | Edge |
|---------------|--------|---------|--------|------|
| Format XML | Required | Required | Optional | Required |
| Minify XML | Required | Required | Optional | Required |
| Highlighting | Required | Required | Optional | Required |
| Tree View | Required | Required | Optional | Required |
| JSON Regression | Required | Required | Optional | Required |
| History | Required | Required | Optional | Required |

---

### AC9: No console errors during normal usage

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-E2E-008 | E2E | P0 | Zero console errors - Chrome | Quality baseline | - |
| 8.7-E2E-009 | E2E | P0 | Zero console errors - Firefox | Quality baseline | - |
| 8.7-E2E-010 | E2E | P1 | Zero console errors - Safari | Quality baseline | - |
| 8.7-E2E-011 | E2E | P0 | Zero console errors - Edge | Quality baseline | - |

**Given-When-Then:**
```gherkin
Scenario: 8.7-E2E-008 - No console errors Chrome
  Given Chrome browser with DevTools open
  When all standard operations are performed
    And XML is formatted
    And XML is minified
    And tree view is navigated
    And JSON regression suite runs
  Then console.error count equals 0
  And no uncaught exceptions
```

---

### Edge Case Testing (Task 8)

| ID | Level | Priority | Test Scenario | Justification | Mitigates |
|----|-------|----------|---------------|---------------|-----------|
| 8.7-UNIT-007 | Unit | P1 | Large XML (1MB) parses successfully | Performance boundary | PERF-001 |
| 8.7-UNIT-008 | Unit | P1 | Deeply nested XML (100 levels) handled | Recursion safety | - |
| 8.7-INT-031 | Integration | P1 | XML with 100+ attributes formatted | Stress test | - |
| 8.7-INT-032 | Integration | P0 | Invalid XML shows clear error | Error handling | - |
| 8.7-INT-033 | Integration | P1 | Mixed JSON→XML→JSON workflow | Format switching | - |
| 8.7-INT-034 | Integration | P1 | Format 1MB XML completes < 150ms | Performance NFR | PERF-001 |
| 8.7-E2E-012 | E2E | P2 | Large file renders without browser hang | UX quality | PERF-001 |

**Given-When-Then:**
```gherkin
Scenario: 8.7-INT-032 - Invalid XML error
  Given malformed XML '<root><unclosed>'
  When formatXml() is called
  Then error result is returned
  And error message describes issue
  And no exception thrown

Scenario: 8.7-INT-034 - Performance threshold
  Given 1MB valid XML document
  When formatXml() is called
  Then operation completes
  And elapsed time < 150ms
```

---

## Risk Coverage Matrix

| Risk ID | Risk Description | Test Coverage |
|---------|------------------|---------------|
| TECH-001 | WASM async timing issues | 8.7-INT-001, all INT tests use 5000ms timeout |
| TECH-002 | Cross-browser environment | 8.7-E2E-004 through 8.7-E2E-007 |
| TECH-003 | Qt signal/slot timing | All INT tests use QSignalSpy::wait() |
| PERF-001 | Large file flaky timeouts | 8.7-UNIT-007, 8.7-INT-034, 8.7-E2E-012 |
| DATA-001 | Test fixture inconsistency | Fixtures defined in Dev Notes section |
| BUS-001 | Incomplete regression | 8.7-INT-025 through 8.7-INT-030 |

---

## Test Data Requirements

### Sample Documents

| Type | Size | Purpose | Location |
|------|------|---------|----------|
| Simple XML | <1KB | Basic functionality | Inline in test |
| Complex XML | ~5KB | All token types | `qt/tests/fixtures/complex.xml` |
| 1MB XML | 1MB | Performance testing | `qt/tests/fixtures/large.xml` (generate) |
| Deep XML | 100 levels | Recursion testing | Generated in test |
| Wide XML | 100+ attrs | Attribute handling | Generated in test |
| Invalid XML | <1KB | Error handling | Inline in test |

### Test Data Generation

```cpp
// Generate 1MB XML
QString generateLargeXml() {
    QString xml = "<?xml version=\"1.0\"?>\n<root>\n";
    for (int i = 0; i < 10000; i++) {
        xml += QString("  <item id=\"%1\">Some content data here</item>\n").arg(i);
    }
    xml += "</root>";
    return xml; // ~1MB
}

// Generate deeply nested XML
QString generateDeepXml(int depth) {
    QString xml = "<?xml version=\"1.0\"?>\n";
    for (int i = 0; i < depth; i++) xml += QString("<level%1>").arg(i);
    xml += "leaf";
    for (int i = depth - 1; i >= 0; i--) xml += QString("</level%1>").arg(i);
    return xml;
}
```

---

## Test Environment Requirements

### Automated Test Environment (Qt/C++)

| Component | Requirement |
|-----------|-------------|
| Qt Version | 6.x with Test module |
| Build | CMake with `tst_xml_integration` target |
| WASM | Pre-compiled wasm binary available |
| Timeout | QSignalSpy::wait(5000) minimum |
| Fixtures | `qt/tests/fixtures/` directory |

### Manual Browser Testing Environment

| Component | Requirement |
|-----------|-------------|
| Local Server | `python -m http.server 8080` |
| Browsers | Chrome, Firefox, Safari, Edge (latest) |
| DevTools | Console visible for error detection |
| Build | Fresh `wasm-pack build && qt-wasm-build` |

### CI/CD Considerations

- Run unit tests first (fail fast)
- Integration tests require WASM binary
- E2E tests require browser headless mode
- 30-second max timeout for large file tests
- Parallel execution limited by WASM singleton

---

## Recommended Execution Order

1. **P0 Unit Tests** (8.7-UNIT-001 through 8.7-UNIT-006) - ~10 seconds
2. **P0 Integration Tests** (8.7-INT-001, 003, 004, 006, 010, 019, 022, 023, 025-029, 032) - ~60 seconds
3. **P0 E2E Tests** (8.7-E2E-004, 005, 007, 008, 009, 011) - ~5 minutes
4. **P1 Tests** (all remaining P1) - ~3 minutes
5. **P2 Tests** (as time permits) - ~2 minutes

**Total Automated Runtime:** ~10-12 minutes
**Manual Browser Testing:** ~30 minutes per browser

---

## Gate YAML Block

```yaml
test_design:
  story: "8.7"
  date: "2026-01-28"
  designer: "Quinn (Test Architect)"
  scenarios_total: 54
  by_level:
    unit: 8
    integration: 34
    e2e: 12
  by_priority:
    p0: 18
    p1: 24
    p2: 12
  coverage_gaps: []
  risk_coverage:
    - TECH-001
    - TECH-002
    - TECH-003
    - PERF-001
    - DATA-001
    - BUS-001
  ac_coverage:
    ac1: [8.7-UNIT-001, 8.7-UNIT-002, 8.7-UNIT-003, 8.7-UNIT-004, 8.7-UNIT-005, 8.7-UNIT-006, 8.7-INT-001, 8.7-INT-002]
    ac2: [8.7-INT-003, 8.7-INT-004, 8.7-INT-005, 8.7-INT-006, 8.7-INT-007, 8.7-INT-008, 8.7-INT-009]
    ac3: [8.7-INT-010, 8.7-INT-011, 8.7-INT-012]
    ac4: [8.7-INT-013, 8.7-INT-014, 8.7-INT-015, 8.7-INT-016, 8.7-INT-017, 8.7-INT-018, 8.7-E2E-001]
    ac5: [8.7-INT-019, 8.7-INT-020, 8.7-INT-021, 8.7-INT-022, 8.7-E2E-002]
    ac6: [8.7-INT-023, 8.7-INT-024, 8.7-E2E-003]
    ac7: [8.7-INT-025, 8.7-INT-026, 8.7-INT-027, 8.7-INT-028, 8.7-INT-029, 8.7-INT-030]
    ac8: [8.7-E2E-004, 8.7-E2E-005, 8.7-E2E-006, 8.7-E2E-007]
    ac9: [8.7-E2E-008, 8.7-E2E-009, 8.7-E2E-010, 8.7-E2E-011]
```

---

## Quality Checklist

- [x] Every AC has test coverage (9 ACs, all covered)
- [x] Test levels are appropriate (63% integration for component interactions)
- [x] No duplicate coverage across levels (verified)
- [x] Priorities align with business risk (P0 for critical paths)
- [x] Test IDs follow naming convention (8.7-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent (verified)
- [x] Risk mitigations addressed (6 risks covered)
- [x] Edge cases included (Task 8 scenarios)
- [x] Performance thresholds defined (150ms for 1MB)
