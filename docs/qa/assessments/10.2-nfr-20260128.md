# NFR Assessment: 10.2 Mermaid.js Library Integration

**Date:** 2026-01-28 (Comprehensive Reassessment Post v1.4)
**Reviewer:** Quinn (Test Architect)
**Mode:** YOLO (non-interactive, core four NFRs)
**Story Version:** v1.4

## Summary

| NFR | Status | Summary |
|-----|--------|---------|
| **Security** | PASS | Two-layer XSS defense (mermaid strict + DOMPurify v3.2.4); airgap verified; versions pinned |
| **Performance** | PASS | Explicit <500ms render target (AC9); 5s timeout ceiling (AC11); benchmarks defined |
| **Reliability** | PASS | Error handling (AC5); render timeout (AC11); AsyncSerialiser via C++ wrapper (AC12); DOM cleanup |
| **Maintainability** | CONCERNS | Manual browser testing only; no automated test framework; 35 test cases documented but not executable |

**Overall Status:** CONCERNS
**Quality Score:** 90/100

---

## Detailed Assessment

### 1. Security - PASS

**Evidence of Implementation:**
- **XSS Defense Layer 1:** Mermaid.js configured with `securityLevel: 'strict'` and `htmlLabels: false` (AC2)
- **XSS Defense Layer 2:** DOMPurify v3.2.4 post-processes all SVG output before DOM insertion (AC10)
- **Airgap Compliance:** AC8 mandates zero network requests, verified via DevTools Network tab
- **Version Pinning:** mermaid v11.4.1, DOMPurify v3.2.4 explicitly pinned for security traceability
- **XSS Test Vectors:** Task 9 includes explicit test vectors: `<script>`, `onload=`, `<foreignObject>`, `javascript:` URI

**Assessment:**
- Two-layer defense-in-depth approach is industry best practice
- Pinned versions prevent supply chain attacks from auto-updates
- Airgap guarantee prevents data exfiltration even if XSS occurred
- XSS test vectors provide concrete validation criteria

**Gaps:** None critical. CSP policy for inline SVG not explicitly defined but acceptable for airgapped application.

### 2. Performance - PASS

**Evidence of Implementation:**
- **Render Target:** AC9 defines explicit <500ms per diagram target
- **Timeout Ceiling:** AC11 implements 5-second render timeout to prevent browser hang
- **Benchmark Tasks:** Task 8 includes measurement for simple (5 nodes) and complex (20+ nodes) diagrams
- **Efficient Pattern:** Initialize-once via `setMermaidTheme()` prevents per-render config overhead
- **Library Size:** 2MB mermaid.js + 15KB DOMPurify documented and accepted for documentation tool use case

**Assessment:**
- Clear, measurable performance targets defined
- Timeout mechanism prevents worst-case runaway renders
- Performance benchmarks built into test plan (PERF-001 through PERF-004)

**Gaps:** None. Performance requirements are well-specified with validation approach.

### 3. Reliability - PASS

**Evidence of Implementation:**
- **Error Handling:** AC5 requires invalid syntax returns structured error object, not crash
- **Render Timeout:** AC11's 5s timeout with graceful error response via `Promise.race`
- **Concurrency Safety:** AC12 routes renders through C++ `JsonBridge::renderMermaid()` → AsyncSerialiser to prevent concurrent Asyncify suspensions
- **DOM Cleanup:** Error path includes orphan node removal (`document.getElementById('d' + id)?.remove()`)
- **Library Load Check:** `renderMermaid()` validates `typeof mermaid !== 'undefined'` and `typeof DOMPurify !== 'undefined'`
- **Theme Race Prevention:** AsyncSerialiser ensures sequential execution prevents theme toggle race conditions
- **Signal-Based Async:** C++ wrapper emits `renderMermaidCompleted(QVariantMap)` signal for QML consumption

**Assessment:**
- Comprehensive error handling at all layers (JS wrapper, C++ bridge, QML consumer)
- Asyncify suspension management critical for WASM reliability
- v1.3/v1.4 correctly identified and fixed the C++/Qt architecture for AsyncSerialiser

**Gaps:** None critical. Memory leak testing after repeated renders documented as low-priority gap.

### 4. Maintainability - CONCERNS

**Evidence of Implementation:**
- **Test Documentation:** 35 test scenarios documented with Given-When-Then format
- **Test Coverage Matrix:** All 12 ACs mapped to specific test IDs
- **Dev Notes:** Comprehensive inline code examples (JavaScript + C++) in story file
- **C++ Pattern:** Complete AsyncSerialiser integration pattern provided (lines 243-314)
- **Source Tree:** Clear file structure documented showing both `/public/` and `/qt/` changes

**Gaps Identified:**
1. **No Automated Test Framework:** All 35 tests are manual browser tests
2. **No Executable Test Harness:** Test cases documented but not codified as runnable tests
3. **Regression Risk:** As diagram support grows, manual-only testing creates maintenance burden
4. **C++ Test Gap:** Task 12's C++ wrapper has no unit test specified

**Assessment:**
The story has excellent test design documentation but lacks automation infrastructure. This creates:
- Manual regression burden for each release
- Risk of test drift as manual tests aren't version-controlled as code
- Barrier to continuous integration

---

## What Changed Since Previous Assessment (v1.2 → v1.4)

| Change | NFR Impact |
|--------|------------|
| Task 12: C++ JsonBridge wrapper added | Reliability improved (proper AsyncSerialiser integration) |
| AC12 clarified: C++/Qt, not JavaScript | Architecture correctness (no new NFR impact) |
| Estimate 3→5 points | Reflects scope, no NFR change |
| AsyncSerialiser dependency explicit | Documentation clarity |

Previous gaps resolved by v1.1-v1.4:
- DOMPurify sanitization (AC10) - RESOLVED
- Render timeout (AC11) - RESOLVED
- AsyncSerialiser integration (AC12) - RESOLVED (correctly via C++ wrapper)
- Global state/per-render init - RESOLVED
- Version pinning - RESOLVED

Remaining gaps:
- CSP policy for inline SVG - OPEN (Low risk)
- Automated test suite - OPEN (Medium priority)
- C++ wrapper unit tests - OPEN (Low priority)

---

## Critical Issues

1. **No Automated Test Framework** (Maintainability)
   - Risk: Manual testing burden grows with each feature; regression risk increases
   - Impact: Medium - affects development velocity and quality assurance efficiency
   - Fix: Add test harness (Playwright, Vitest, or in-browser test runner) for `renderMermaid` wrapper

---

## Recommendations

### High Priority
1. **Add automated smoke test harness** covering:
   - Success path: Valid diagram renders to SVG
   - Error path: Invalid syntax returns structured error
   - XSS vectors: `<script>`, `onload=`, `<foreignObject>`, `javascript:` URI blocked
   - Timeout path: Mock slow render triggers 5s timeout

### Medium Priority
2. **Add CSP meta tag** to `index.html`:
   ```html
   <meta http-equiv="Content-Security-Policy" content="script-src 'self';">
   ```
   Defense-in-depth against potential XSS even though airgapped.

3. **Add C++ wrapper test** for `JsonBridge::renderMermaid()` verifying AsyncSerialiser queue behavior

### Low Priority
4. **Add DOM node count assertion** after 100+ sequential renders to detect memory leaks

---

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Two-layer XSS defense (mermaid strict + DOMPurify v3.2.4); airgap verified; versions pinned'
  performance:
    status: PASS
    notes: 'Render <500ms (AC9); 5s timeout (AC11); benchmarks in test plan'
  reliability:
    status: PASS
    notes: 'Error handling; timeout; AsyncSerialiser via C++ JsonBridge wrapper (AC12); DOM cleanup'
  maintainability:
    status: CONCERNS
    notes: 'Manual testing only (35 test cases); recommend automated test harness'
```

---

## Quality Score Calculation

```
Base Score: 100
- Security: PASS (+0)
- Performance: PASS (+0)
- Reliability: PASS (+0)
- Maintainability: CONCERNS (-10)
Final Score: 90/100
```

---

## Acceptance Criteria Assessment

| AC | NFR Impact | Status | Notes |
|----|------------|--------|-------|
| AC2 | Security | PASS | `securityLevel: 'strict'`, XSS-safe SVG |
| AC5 | Reliability | PASS | Error handling, no crash on invalid input |
| AC8 | Security | PASS | Airgap compliance, zero network requests |
| AC9 | Performance | PASS | <500ms render target defined |
| AC10 | Security | PASS | DOMPurify v3.2.4 SVG sanitization |
| AC11 | Reliability, Performance | PASS | 5s render timeout |
| AC12 | Reliability | PASS | AsyncSerialiser via C++ JsonBridge wrapper |
| - | Maintainability | CONCERNS | No automated test framework |

---

NFR assessment: docs/qa/assessments/10.2-nfr-20260128.md

Gate NFR block ready → paste into docs/qa/gates/10.2-mermaid-js-integration.yml under nfr_validation
