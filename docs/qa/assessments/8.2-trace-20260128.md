# Requirements Traceability Matrix

## Story: 8.2 - Productionize XML Highlighter

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Method:** Requirements traceability analysis - AC to code to tests

---

## Coverage Summary

- **Total Requirements:** 7
- **Fully Covered:** 2 (29%)
- **Partially Covered:** 3 (43%)
- **Not Covered:** 2 (29%)

---

## Requirement Mappings

### AC1: Token Type Highlighting

**Requirement:** All XML token types are correctly highlighted with their designated colors: tags (`#569cd6`), attributes (`#9cdcfe`), values (`#ce9178`), comments (`#6a9955`), CDATA (`#dcdcaa`), declarations (`#c586c0`), entities (`#d7ba7d`), brackets (`#808080`), text (`#d4d4d4`)

**Coverage: PARTIAL**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| `src/xml_highlighter.rs` | `test_highlight_simple_element` | Simple XML `<root>text</root>` | `highlight_xml()` called | Output contains "root", "text", `<span>` tags | Unit |
| `src/xml_highlighter.rs` | `test_highlight_with_attributes` | XML with attribute `<elem attr="value"/>` | Highlighted | Output contains "elem", "attr", "value" | Unit |
| `src/xml_highlighter.rs` | `test_highlight_comment` | XML comment `<!-- comment -->` | Highlighted | Output contains "comment" and COMMENT color (#6a9955) | Unit |
| `src/xml_highlighter.rs` | `test_highlight_cdata` | CDATA section `<![CDATA[raw data]]>` | Highlighted | Output contains "raw data" and CDATA color (#dcdcaa) | Unit |
| `src/xml_highlighter.rs` | `test_highlight_declaration` | XML declaration `<?xml version="1.0"?>` | Highlighted | Output contains "xml" and DECLARATION color (#c586c0) | Unit |
| `src/xml_highlighter.rs` | `test_highlight_namespace` | Namespaced element | Highlighted | Output contains namespace prefix and attribute | Unit |

**Gaps:**
- No test for Doctype highlighting
- No test for entity highlighting (`&amp;`, `&lt;`, etc.)
- No test for text-only content
- Existing tests use weak `contains()` assertions - don't verify correct color applied to correct token

---

### AC2: VS Code Dark Theme Colors

**Requirement:** Colors match the VS Code dark theme palette as defined in the `colors` module

**Coverage: PARTIAL**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| `src/xml_highlighter.rs` | `test_highlight_comment` | XML comment | Highlighted | Verifies COMMENT color (#6a9955) | Unit |
| `src/xml_highlighter.rs` | `test_highlight_cdata` | CDATA section | Highlighted | Verifies CDATA color (#dcdcaa) | Unit |
| `src/xml_highlighter.rs` | `test_highlight_declaration` | XML declaration | Highlighted | Verifies DECLARATION color (#c586c0) | Unit |

**Code Evidence:**
- `colors` module defined at lines 7-17 in `xml_highlighter.rs`
- 9 color constants matching documented palette

**Gaps:**
- No dedicated test verifies all 9 colors
- TAG (#569cd6), ATTR_NAME (#9cdcfe), ATTR_VALUE (#ce9178), BRACKET (#808080), ENTITY (#d7ba7d), TEXT (#d4d4d4) colors not explicitly tested

---

### AC3: Graceful Degradation

**Requirement:** Malformed or partial XML (unclosed tags, unclosed comments, unclosed CDATA, unclosed attribute values) degrades gracefully: returns valid HTML with partial highlighting in contextually correct colors, never crashes or hangs

**Coverage: NONE**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| — | — | — | — | — | — |

**Code Evidence:**
- EOF flush at lines 297-307 handles some states
- `TagOpen` else branch (line 113-116) transitions to Text state

**Critical Gaps:**
- **TECH-001:** Infinite loop bug - `TagOpen` else branch doesn't increment `i`; `<` + control char hangs parser
- No tests for unclosed tags (`<root`)
- No tests for unclosed comments (`<!-- comment`)
- No tests for unclosed CDATA (`<![CDATA[data`)
- No tests for unclosed attribute values (`<a b="value`)
- **TECH-002:** EOF flush uses `colors::TEXT` for TagName, AttrName, AttrValue, InTag, TagClose, AttrEquals - wrong colors

---

### AC4: XSS Prevention

**Requirement:** All 5 HTML special characters (`<`, `>`, `&`, `"`, `'`) are escaped in output to prevent XSS in any rendering context

**Coverage: PARTIAL**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| `src/xml_highlighter.rs` | `test_escapes_html` | CDATA containing `<script>` | Highlighted | `<script>` escaped as `&lt;script&gt;` | Unit |

**Code Evidence:**
- `push_colored_escaped()` at lines 350-363 escapes `<`, `>`, `&`, `"`
- Single quote (`'`) NOT escaped - SEC-001

**Critical Gaps:**
- **SEC-001:** Single quote not escaped - XSS vector in HTML attribute contexts
- No test for single-quoted attributes (`<a b='val'>`)
- No test for `onclick=` attribute injection
- No test for direct `<script>` tag injection (not in CDATA)
- Only 1 of 4 required XSS scenarios tested

---

### AC5: Performance

**Requirement:** XML documents over 100KB are highlighted in under 100ms; input exceeding 5MB is rejected with an error message (not a crash)

**Coverage: NONE**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| — | — | — | — | — | — |

**Code Evidence:**
- `String::with_capacity(input.len() * 3)` pre-allocation at line 42
- No input size guard implemented

**Gaps:**
- No benchmark tests exist (Task 5 unchecked)
- Cannot verify <100ms requirement
- No 5MB input size limit implemented
- Memory ceiling not enforced - potential OOM in WASM

---

### AC6: State Machine Edge Cases

**Requirement:** State machine handles: control characters after `<`, null bytes, incomplete sequences, unclosed tags/comments/CDATA/attributes - all terminate and produce valid HTML

**Coverage: PARTIAL**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| `src/xml_highlighter.rs` | `test_highlight_empty` | Empty string | `highlight_xml("")` | Returns empty string | Unit |

**Code Evidence:**
- 12 states implemented in `State` enum (lines 21-34)
- State transitions cover happy paths

**Gaps:**
- Edge case table in Dev Notes documents 4 unknowns - all untested
- 8 happy-path tests only
- No control character tests (`<\x00`, `<\x01`, `<\t`)
- No null byte tests
- **TECH-002:** EOF buffer flush wrong color for 6 states

---

### AC7: WASM Build Clean

**Requirement:** WASM build (`wasm-pack build --target web --release`) succeeds with no new compiler warnings

**Coverage: FULL**

| Test File | Test Case | Given | When | Then | Coverage Level |
|-----------|-----------|-------|------|------|----------------|
| Manual | Task 7 verification | Clean codebase | `wasm-pack build` | No new warnings | Manual |

**Code Evidence:**
- `js_highlight_xml` export in `lib.rs`
- Standard WASM export pattern

**Notes:**
- Low risk - standard WASM export pattern
- Task 7 is a manual verification step, acceptable as-is

---

## Given-When-Then Mappings Summary

| Test | Given | When | Then | Maps to AC |
|------|-------|------|------|------------|
| `test_highlight_empty` | Empty string input | `highlight_xml("")` called | Returns empty string | AC6 |
| `test_highlight_simple_element` | Simple XML `<root>text</root>` | Highlighted | Output contains "root", "text", `<span>` | AC1 |
| `test_highlight_with_attributes` | XML with attribute `<elem attr="value"/>` | Highlighted | Output contains "elem", "attr", "value" | AC1 |
| `test_highlight_comment` | XML comment `<!-- comment -->` | Highlighted | Output contains "comment" and COMMENT color | AC1, AC2 |
| `test_highlight_cdata` | CDATA section `<![CDATA[raw data]]>` | Highlighted | Output contains "raw data" and CDATA color | AC1, AC2 |
| `test_highlight_declaration` | XML declaration `<?xml version="1.0"?>` | Highlighted | Output contains "xml" and DECLARATION color | AC1, AC2 |
| `test_highlight_namespace` | Namespaced element | Highlighted | Output contains namespace prefix and attribute | AC1 |
| `test_escapes_html` | CDATA containing `<script>` | Highlighted | `<script>` escaped as `&lt;script&gt;` | AC4 |

---

## Critical Gaps Summary

### 1. AC3 - Graceful Degradation (NONE)
- **Severity:** Critical
- **Gap:** Zero tests for malformed XML
- **Risk:** TECH-001 infinite loop bug completely untested - control character after `<` hangs parser
- **Suggested Tests:**
  - `test_unclosed_tag`: Input `<root` - returns valid HTML with TAG color
  - `test_unclosed_comment`: Input `<!-- comment` - remainder in COMMENT color
  - `test_unclosed_cdata`: Input `<![CDATA[data` - remainder in CDATA color
  - `test_unclosed_attr_value`: Input `<a b="value` - remainder in ATTR_VALUE color
  - `test_control_char_after_lt`: Input `<\x01` - terminates, returns valid HTML

### 2. AC4 - XSS Prevention (PARTIAL)
- **Severity:** Critical
- **Gap:** Single quote (`'`) not escaped (SEC-001); only 1 of 4 XSS scenarios tested
- **Risk:** XSS vulnerability in HTML attribute contexts
- **Suggested Tests:**
  - `test_single_quote_escaping`: Input `<a b='val'>` - output contains `&#39;`
  - `test_script_tag_escaping`: Input `<script>alert(1)</script>` - fully escaped
  - `test_onclick_attribute_escaping`: Input `<a onclick="x">` - attribute escaped

### 3. AC5 - Performance (NONE)
- **Severity:** High
- **Gap:** No benchmarks; no input size limit
- **Risk:** Cannot verify <100ms requirement; potential OOM with large inputs
- **Suggested Tests:**
  - `test_100kb_performance`: 100KB XML highlighted in <100ms
  - `test_5mb_rejection`: Input >5MB returns error message

### 4. AC6 - Edge Cases (PARTIAL)
- **Severity:** Medium
- **Gap:** EOF buffer flush uses wrong color for 6 states (TECH-002)
- **Risk:** Incorrect highlighting for truncated inputs
- **Suggested Tests:**
  - Tests for each unclosed state verifying correct flush color

### 5. Test Quality
- **Severity:** Medium
- **Gap:** Existing tests use weak `contains()` assertions
- **Risk:** Tests pass even if color-token pairing is incorrect
- **Suggested Fix:** Strengthen assertions to verify specific color wraps specific token type

---

## Test Design Recommendations

### P0 - Must Have Before Merge

1. **Infinite loop regression test**
   - Type: Unit
   - Input: `<\x01`, `<\x00`
   - Expected: Terminates, returns valid HTML
   - Maps to: TECH-001, AC3

2. **Single quote escaping test**
   - Type: Unit
   - Input: `<a b='val'>`
   - Expected: Output contains `&#39;`
   - Maps to: SEC-001, AC4

### P1 - Should Have

3. **Unclosed tag test** - Input: `<root` - AC3
4. **Unclosed comment test** - Input: `<!-- comment` - AC3
5. **Unclosed CDATA test** - Input: `<![CDATA[data` - AC3
6. **Unclosed attribute value test** - Input: `<a b="value` - AC3
7. **Script tag escaping test** - Input: `<script>alert(1)</script>` - AC4
8. **Onclick attribute escaping test** - Input: `<a onclick="x">` - AC4
9. **Strengthen existing tests** - Verify color-token pairing with specific assertions

### P2 - Nice to Have

10. **100KB benchmark** - Verify <100ms performance - AC5
11. **5MB rejection test** - Verify error message - AC5
12. **Doctype highlighting test** - AC1
13. **Entity highlighting test** - AC1
14. **Color palette verification test** - All 9 colors - AC2

---

## Risk Assessment

| Risk Level | Requirements | Action |
|------------|--------------|--------|
| **High Risk** | AC3, AC5 | No coverage - block merge until P0 tests added |
| **Medium Risk** | AC4, AC6 | Partial coverage - add P1 tests before release |
| **Low Risk** | AC1, AC2, AC7 | Full/partial coverage acceptable |

---

## Gate Trace Block

```yaml
trace:
  totals:
    requirements: 7
    full: 2
    partial: 3
    none: 2
  planning_ref: 'docs/qa/assessments/8.2-test-design-20260128.md'
  uncovered:
    - ac: 'AC3'
      reason: 'No malformed input tests; infinite loop bug (TECH-001) untested'
    - ac: 'AC5'
      reason: 'No performance benchmarks; no input size limit implemented'
  notes: 'See docs/qa/assessments/8.2-trace-20260128.md'
```

---

## Trace Hook Line

Trace matrix: docs/qa/assessments/8.2-trace-20260128.md
