# Risk Profile: Story 10.2 - Mermaid.js Library Integration

**Date:** 2026-01-28 (Reassessment post v1.4)
**Reviewer:** Quinn (Test Architect)
**Mode:** YOLO

## Executive Summary

- **Total Risks Identified:** 11
- **Critical Risks:** 0
- **High Risks:** 0
- **Medium Risks:** 1
- **Low Risks:** 7
- **Minimal Risks:** 3
- **Risk Score:** 77/100 (Low Risk)
- **Gate Recommendation:** PASS

## Revision Impact (v1.3/v1.4)

The primary change since the v1.2 risk assessment is the addition of Task 12: C++ JsonBridge wrapper. This introduces one new risk (ARCH-002) but also resolves ARCH-001 from the prior assessment.

| Change | Risk Impact |
|--------|-------------|
| Task 12: C++ JsonBridge wrapper | New ARCH-002 (C++ implementation complexity) |
| AC12 clarification | ARCH-001 resolved (architecture now correctly documented) |
| Estimate 3→5 points | Reflects increased scope, no new risk |
| AsyncSerialiser dependency explicit | Risk clarity improved, no new risk |

## Risk Matrix

| Risk ID | Description | Prob | Impact | Score | Priority | Status |
|---------|-------------|------|--------|-------|----------|--------|
| SEC-001 | XSS via mermaid SVG output despite strict mode | Low (1) | High (3) | 3 | Low | MITIGATED |
| SEC-002 | Mermaid covert network requests (airgap violation) | Low (1) | High (3) | 3 | Low | MITIGATED |
| TECH-001 | `mermaid.initialize()` per-render resets global state | Low (1) | Med (2) | 2 | Low | RESOLVED |
| TECH-002 | Mermaid render ID collisions in DOM | Low (1) | Med (2) | 2 | Low | ACCEPTED |
| TECH-003 | Theme re-render race with AsyncSerialiser | Low (1) | Med (2) | 2 | Low | MITIGATED |
| **ARCH-002** | **C++ JsonBridge wrapper implementation complexity** | **Med (2)** | **Med (2)** | **4** | **Medium** | **OPEN** |
| PERF-001 | 2MB library increases initial load/cache size | Med (2) | Low (1) | 2 | Low | ACCEPTED |
| PERF-002 | Complex diagrams exceed 500ms render target | Low (1) | Low (1) | 1 | Minimal | MITIGATED |
| OPS-001 | Service Worker cache version not incremented | Med (2) | Med (2) | 4 | Medium | OPEN (tied with ARCH-002) |
| DATA-001 | Sensitive data exposed in SVG DOM nodes | Low (1) | Low (1) | 1 | Minimal | ACCEPTED |
| ARCH-001 | AC12 implementation requires C++ wrapper | - | - | - | - | RESOLVED (v1.3) |

## Critical Risks Requiring Immediate Attention

**None.** All identified risks are Medium priority or lower.

## Detailed Risk Analysis

### NEW: ARCH-002 — C++ JsonBridge Wrapper Complexity

**Score: 4 (Medium)**
**Probability:** Medium (2) — C++ + Asyncify + emscripten val interop is non-trivial
**Impact:** Medium (2) — Incorrect implementation could cause race conditions, hangs, or silent failures

**Description:** Task 12 introduces a new C++ method `JsonBridge::renderMermaid()` that must:
1. Enqueue via AsyncSerialiser singleton
2. Use emscripten `val::global` to access window.renderMermaid
3. Call `.await()` on the JS Promise (Asyncify suspension)
4. Marshal result from JS object to QVariantMap
5. Emit signal on Qt main thread via `QMetaObject::invokeMethod`

**Affected Components:**
- `qt/jsonbridge.h`
- `qt/jsonbridge.cpp`
- `qt/asyncserialiser.h` (dependency)

**Mitigation:**
- Dev Notes include complete C++ implementation pattern (lines 244-314)
- Pattern follows existing AsyncSerialiser usage in codebase (per CLAUDE.md)
- Test strategy includes INT-024 (serial execution verification)

**Residual Risk:** Low — Pattern is documented, but first-time implementation may have subtle errors.

**Testing Focus:**
1. Verify sequential execution when multiple renders queued
2. Verify no concurrent Asyncify suspensions
3. Verify signal emits on main thread (QML receives callback)
4. Test exception handling in C++ try/catch blocks

---

### OPS-001 — Service Worker Cache Version (Unchanged)

**Score: 4 (Medium)**
**Probability:** Medium (2) — Manual SW update required in Task 7
**Impact:** Medium (2) — Stale cache could serve old mermaid.js without DOMPurify

**Mitigation:**
- Task 7 explicitly includes cache version increment
- Add integration test verifying SW cache manifest includes mermaid.min.js + purify.min.js

**Residual Risk:** Low — If developer follows Task 7, risk is eliminated.

---

### SEC-001 — XSS via SVG Output

**Score: 3 (Low)**
**Probability:** Low (1) — Two-layer defense in place
**Impact:** High (3) — XSS could compromise user session

**Mitigation:** (v1.2 addressed)
- Layer 1: `securityLevel: 'strict'` + `htmlLabels: false`
- Layer 2: DOMPurify.sanitize() with SVG profile on all output
- XSS test vectors in Task 9: `<script>`, `onload=`, `<foreignObject>`, `javascript:`

**Residual Risk:** Minimal — Would require zero-day in both mermaid AND DOMPurify.

---

### SEC-002 — Airgap Violation

**Score: 3 (Low)**
**Probability:** Low (1) — AC8 verification + DevTools test
**Impact:** High (3) — Network request would violate privacy guarantee

**Mitigation:**
- AC8 mandates zero network requests verified in DevTools
- Test 10.2-E2E-005 covers airgap verification
- Library is bundled locally (no CDN)

**Residual Risk:** Minimal.

---

### TECH-001 — Per-Render Initialize Pattern

**Score: 2 (Low)**
**Probability:** Low (1) — Dev Notes updated
**Impact:** Medium (2) — Could corrupt mermaid global state

**Mitigation:** (v1.1 addressed)
- Dev Notes specify initialize-once pattern via `setMermaidTheme()`
- Only re-initializes on actual theme change

**Status:** RESOLVED.

---

### TECH-002 — SVG ID Collisions

**Score: 2 (Low)**
**Probability:** Low (1) — Counter-based ID generation
**Impact:** Medium (2) — Could cause DOM element conflicts

**Mitigation:**
- `mermaid-${++mermaidIdCounter}` ensures unique IDs
- DOM cleanup on error removes orphaned containers

**Status:** ACCEPTED — Residual risk minimal.

---

### TECH-003 — Theme Re-Render Race

**Score: 2 (Low)**
**Probability:** Low (1) — AsyncSerialiser serializes renders
**Impact:** Medium (2) — Could produce garbled output

**Mitigation:** (v1.1 addressed)
- AC12 mandates AsyncSerialiser integration (via C++ wrapper)
- Theme toggle cannot race with in-flight render

**Status:** MITIGATED.

---

### PERF-001 — 2MB Bundle Size

**Score: 2 (Low)**
**Probability:** Medium (2) — Library is 2MB
**Impact:** Low (1) — Longer initial load, larger cache

**Mitigation:**
- Acceptable for documentation tool
- No lazy-loading to maintain airgap guarantee
- Service Worker caches after first load

**Status:** ACCEPTED.

---

### PERF-002 — Complex Diagram Performance

**Score: 1 (Minimal)**
**Probability:** Low (1) — 5s timeout ceiling prevents hang
**Impact:** Low (1) — User waits longer for complex diagrams

**Mitigation:** (v1.1 addressed)
- AC11 adds 5s timeout with graceful error
- Task 8 includes performance benchmarks

**Status:** MITIGATED.

---

### DATA-001 — Sensitive Data in SVG

**Score: 1 (Minimal)**
**Probability:** Low (1) — Mermaid only renders diagram syntax
**Impact:** Low (1) — SVG contains labels, not arbitrary user data

**Mitigation:**
- Diagrams are defined by user, not auto-extracted from sensitive content
- No data exfiltration vector (airgap)

**Status:** ACCEPTED.

## Risk Distribution

### By Category

| Category | Count | Critical | High | Medium |
|----------|-------|----------|------|--------|
| Security (SEC) | 2 | 0 | 0 | 0 |
| Technical (TECH) | 3 | 0 | 0 | 0 |
| Architecture (ARCH) | 1 | 0 | 0 | 1 |
| Performance (PERF) | 2 | 0 | 0 | 0 |
| Operational (OPS) | 1 | 0 | 0 | 1 |
| Data (DATA) | 1 | 0 | 0 | 0 |
| **Total** | **10** | **0** | **0** | **2** |

### By Component

| Component | Risks |
|-----------|-------|
| Frontend (JS) | SEC-001, SEC-002, TECH-001, TECH-002, PERF-002 |
| C++/Qt Bridge | ARCH-002, TECH-003 |
| Service Worker | OPS-001 |
| Infrastructure | PERF-001 |
| Data | DATA-001 |

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests (ARCH-002, OPS-001)

| Test ID | Description | Risk Coverage |
|---------|-------------|---------------|
| 10.2-INT-024 | Queue 5 renders rapidly, verify sequential execution | ARCH-002 |
| 10.2-UNIT-017 | Verify renderMermaid uses AsyncSerialiser.enqueue() | ARCH-002 |
| 10.2-E2E-011 | Theme toggle during render, verify no race | ARCH-002, TECH-003 |
| 10.2-INT-018/019 | Verify SW cache manifest includes mermaid + DOMPurify | OPS-001 |
| 10.2-E2E-006 | New version deployed, verify cache update | OPS-001 |

### Priority 2: Security Tests (SEC-001, SEC-002)

| Test ID | Description | Risk Coverage |
|---------|-------------|---------------|
| 10.2-INT-002..005 | XSS vectors: script, onload, foreignObject, javascript: | SEC-001 |
| 10.2-INT-021 | DOMPurify removes dangerous attributes | SEC-001 |
| 10.2-INT-020 | Network intercept, verify zero external requests | SEC-002 |
| 10.2-E2E-001 | Offline render works | SEC-002 |

### Priority 3: Functional & Performance Tests

| Test ID | Description | Risk Coverage |
|---------|-------------|---------------|
| 10.2-INT-006..013 | All 8 diagram types render | Functional |
| 10.2-UNIT-006..010 | Error handling for invalid syntax | TECH-001, TECH-002 |
| 10.2-PERF-001..004 | Render time benchmarks | PERF-002 |

## Risk Score Calculation

```
Base Score: 100
- ARCH-002 (score 4, medium): -5 points
- OPS-001 (score 4, medium): -5 points
- SEC-001 (score 3, low): -2 points
- SEC-002 (score 3, low): -2 points
- TECH-001 (score 2, low): -2 points
- TECH-002 (score 2, low): -2 points
- TECH-003 (score 2, low): -2 points
- PERF-001 (score 2, low): -2 points
- DATA-001 (score 1, minimal): -1 point
- PERF-002 (score 1, minimal): 0 points (minimal, no deduction)
Final Score: 77/100 (Low Risk)
```

## Risk Acceptance Criteria

### Must Fix Before Production

- **None.** No critical (score 9) or high (score 6) risks.

### Can Deploy with Mitigation

- **ARCH-002:** C++ wrapper implementation requires careful code review and Task 12 test coverage
- **OPS-001:** SW cache version must be incremented per Task 7

### Accepted Risks

- **SEC-001:** Two-layer defense acceptable; zero-day in both libraries is residual risk
- **TECH-002:** Counter-based IDs prevent collisions; minimal residual risk
- **PERF-001:** 2MB bundle acceptable for documentation tool
- **DATA-001:** Diagram labels only; no sensitive data exfiltration vector

## Monitoring Requirements

Post-deployment monitoring for:

1. **Performance:** Render time metrics via console.time() or PerformanceObserver
2. **Errors:** renderMermaid failure rate (success: false responses)
3. **Security:** Any network requests after load (should be zero)

## Gate YAML Block

```yaml
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 2
    low: 7
  highest:
    id: ARCH-002
    score: 4
    title: 'C++ JsonBridge wrapper implementation complexity'
  recommendations:
    must_fix: []
    monitor:
      - 'Code review C++ JsonBridge::renderMermaid() implementation'
      - 'Verify SW cache version incremented in Task 7'
```

---

**Risk profile:** docs/qa/assessments/10.2-risk-20260128.md
