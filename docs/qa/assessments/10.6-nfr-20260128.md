# NFR Assessment: 10.6 - Markdown Syntax Highlighting

Date: 2026-01-28
Reviewer: Quinn (Test Architect)
Mode: YOLO (Non-interactive, Core Four NFRs)

## Summary

- Security: CONCERNS - XSS protection exists but incomplete (missing quote escaping, span injection)
- Performance: PASS - Explicit 200ms target, optimization task, appropriate implementation patterns
- Reliability: CONCERNS - Bridge fallback exists but core function lacks error recovery for edge cases
- Maintainability: CONCERNS - Follows established patterns but no explicit coverage target, missing integration tests

**Quality Score:** 70/100

## Critical Issues

### 1. Incomplete XSS Protection (Security)

**Risk:** Attribute injection via unescaped quotes, span boundary injection attacks

**Evidence:**
- `escape_html()` function only escapes `<`, `>`, `&`
- Missing `"` → `&quot;` and `'` → `&#39;`
- Span boundary injection (e.g., `**</span><script>**`) not explicitly tested

**Fix:**
```rust
fn escape_html(s: &str) -> String {
    s.replace('&', "&amp;")
     .replace('<', "&lt;")
     .replace('>', "&gt;")
     .replace('"', "&quot;")
     .replace('\'', "&#39;")
}
```

Add test case:
```rust
#[test]
fn test_xss_span_injection() {
    let input = "**</span><script>alert(1)</script>**";
    let result = highlight_markdown(input);
    assert!(!result.contains("<script>"));
    assert!(result.contains("&lt;script&gt;"));
}
```

### 2. Unclosed Code Block Handling (Reliability)

**Risk:** Unexpected output or partial highlighting when code block never closes

**Evidence:**
- State machine tracks `in_code_block` flag
- No explicit handling when EOF reached while `in_code_block = true`
- Could leave unclosed `<span>` tags in output

**Fix:**
```rust
pub fn highlight_markdown(input: &str) -> String {
    // ... existing code ...

    // EOF handling: close any open spans
    if in_code_block {
        output.push_str("</span>");
    }

    output
}
```

### 3. Missing Test Coverage Target (Maintainability)

**Risk:** Insufficient test coverage for security-critical code handling sensitive data

**Evidence:**
- Architecture.md mentions 80% coverage target generally
- Story does not specify explicit coverage requirement
- No integration tests with WASM environment specified

**Fix:**
- Add to Definition of Done: "Test coverage ≥ 80% for markdown_highlighter.rs"
- Add WASM integration test using wasm-bindgen-test

## NFR Validation Details

### Security

**Status: CONCERNS**

| Criteria | Status | Evidence |
|----------|--------|----------|
| Input validation | ✅ | HTML entities escaped before processing |
| Output sanitization | ⚠️ | Partial - missing quote characters |
| XSS prevention | ⚠️ | Test cases exist but incomplete coverage |
| Secrets handling | ✅ | N/A - no secrets in scope |
| Rate limiting | ✅ | N/A - client-side only |

### Performance

**Status: PASS**

| Criteria | Status | Evidence |
|----------|--------|----------|
| Response time target | ✅ | < 200ms for 1MB documents (AC5) |
| Memory efficiency | ✅ | Pre-allocated string buffer |
| Resource optimization | ✅ | lazy_static regex compilation |
| Caching strategy | ✅ | N/A - stateless processing |
| Bottleneck analysis | ✅ | Task 9 performance optimization |

### Reliability

**Status: CONCERNS**

| Criteria | Status | Evidence |
|----------|--------|----------|
| Error handling | ⚠️ | Bridge fallback only, core lacks recovery |
| Graceful degradation | ✅ | Falls back to escaped HTML in bridge.js |
| State management | ⚠️ | Code block tracking lacks EOF handling |
| Retry logic | ✅ | N/A - synchronous processing |
| Recovery mechanisms | ⚠️ | No explicit recovery for malformed input |

### Maintainability

**Status: CONCERNS**

| Criteria | Status | Evidence |
|----------|--------|----------|
| Test coverage | ⚠️ | Tests exist but no explicit target |
| Code structure | ✅ | Follows highlighter.rs pattern |
| Documentation | ✅ | Dev notes comprehensive |
| Dependencies | ✅ | regex, lazy_static (stable crates) |
| Technical debt | ⚠️ | Hardcoded CSS classes, multiple regex patterns |

## Recommendations

### Must Fix Before Gate

1. Expand `escape_html()` to include quote characters
2. Add EOF handling for unclosed code blocks
3. Add span injection test case to XSS tests

### Should Fix

1. Specify explicit 80% coverage target in DoD
2. Add wasm-bindgen-test integration test
3. Document regex pattern rationale for maintainers

### Nice to Have

1. Consider state-machine approach if regex performance insufficient
2. Add CSS class name constants instead of inline strings
3. Add visual regression tests for theme switching

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: 'XSS protection incomplete - missing quote escaping and span injection tests'
  performance:
    status: PASS
    notes: 'Explicit 200ms target with optimization task and appropriate patterns'
  reliability:
    status: CONCERNS
    notes: 'Bridge fallback exists but core lacks EOF handling for unclosed blocks'
  maintainability:
    status: CONCERNS
    notes: 'Follows patterns but no explicit coverage target, missing integration tests'
```

---

NFR assessment: docs/qa/assessments/10.6-nfr-20260128.md

Gate NFR block ready → paste into docs/qa/gates/10.6-markdown-syntax-highlighting.yml under nfr_validation
