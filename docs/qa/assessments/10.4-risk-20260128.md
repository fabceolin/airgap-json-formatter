# Risk Profile: Story 10.4

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 0
- Medium Risks: 4
- Low Risks: 3
- Risk Score: 78/100 (calculated)

This story extends format auto-detection to recognize Markdown content. The implementation builds on established patterns from Story 8.4 (JSON/XML detection). The primary risks are around heuristic detection accuracy (false positives/negatives) and regex performance. No critical or high risks identified.

## Risk Matrix

| Risk ID   | Description                                | Probability | Impact     | Score | Priority |
|-----------|-------------------------------------------|-------------|------------|-------|----------|
| TECH-001  | Regex pattern performance degradation      | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | False positive detection on plain text     | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-003  | Heuristic detection misses valid Markdown  | Medium (2)  | Low (1)    | 2     | Low      |
| TECH-004  | Regression in existing JSON/XML detection  | Low (1)     | High (3)   | 3     | Low      |
| PERF-001  | Large input causes detection timeout       | Low (1)     | Medium (2) | 2     | Low      |
| DATA-001  | Detection priority conflicts               | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001   | UI state desync with detected format       | Medium (2)  | Medium (2) | 4     | Medium   |

## Detailed Risk Analysis

### TECH-001: Regex Pattern Performance Degradation

**Score: 4 (Medium)**

**Probability**: Medium (2) - Regular expressions with backtracking can degrade on pathological inputs. The proposed regex patterns (`^#{1,6}\s`, link patterns) are relatively simple but could still cause issues.

**Impact**: Medium (2) - Would violate the <1ms detection requirement (AC8) and cause UI jank.

**Affected Components**:
- `JsonBridge::isLikelyMarkdown()`
- `JsonBridge::detectFormat()`

**Mitigation**:
- Use `static QRegularExpression` for compilation caching (already in proposed code)
- Limit search area to first 2KB as proposed
- Add explicit performance test with pathological inputs
- Consider using `QString::indexOf()` for simple pattern checks instead of regex where possible

**Testing Requirements**:
- Performance tests with 1MB inputs
- Test with inputs containing many `#` characters
- Test with repeated `[](` patterns

**Residual Risk**: Low - Capped search area limits worst case

---

### TECH-002: False Positive Detection on Plain Text

**Score: 4 (Medium)**

**Probability**: Medium (2) - Plain text can accidentally match Markdown patterns:
- Email addresses with `@` after `#` (hashtags)
- Code with `#include` or `# comment`
- URLs that look like `[text](url)`

**Impact**: Medium (2) - User gets unexpected format routing, leading to confusion but no data loss.

**Affected Components**:
- `JsonBridge::isLikelyMarkdown()`
- Main.qml format routing

**Mitigation**:
- Require `# ` (hash + space) for heading detection (already specified)
- Consider requiring multiple matching patterns for higher confidence
- Ensure manual override works (AC9)

**Testing Requirements**:
- Test `#include <stdio.h>` → should not detect as markdown
- Test hashtags like `#trending` → should not detect
- Test email content with signatures

**Residual Risk**: Low - Manual override provides escape hatch

---

### TECH-003: Heuristic Detection Misses Valid Markdown

**Score: 2 (Low)**

**Probability**: Medium (2) - Some valid Markdown has no distinctive markers:
- Pure prose paragraphs
- Markdown using only emphasis (`*italic*`, `**bold**`)
- Inline code only (single backticks)

**Impact**: Low (1) - User can manually select format; content still processable.

**Affected Components**:
- `JsonBridge::isLikelyMarkdown()`

**Mitigation**:
- Document that detection is heuristic
- Add emphasis patterns to detection (low priority)
- Ensure format selector (AC5, AC9) provides manual override

**Testing Requirements**:
- Test pure prose → "unknown" (as specified)
- Test `*emphasis*` only text

**Residual Risk**: Accepted - False negatives are less problematic than false positives

---

### TECH-004: Regression in Existing JSON/XML Detection

**Score: 3 (Low)**

**Probability**: Low (1) - The detection priority chain is well-defined:
1. JSON (`{` or `[`)
2. XML (`<`)
3. Markdown (heuristics)
4. Unknown

**Impact**: High (3) - Breaking JSON/XML detection would severely impact existing functionality.

**Affected Components**:
- `JsonBridge::detectFormat()`

**Mitigation**:
- Maintain strict priority ordering
- Run full existing test suite (23+ tests in tst_format_detection.cpp)
- Add explicit regression tests for edge cases

**Testing Requirements**:
- All existing 8.4 tests must pass
- Test JSON containing `# comment` in string → still "json"
- Test XML with text nodes containing Markdown → still "xml"

**Residual Risk**: Minimal - Test coverage is strong

---

### PERF-001: Large Input Causes Detection Timeout

**Score: 2 (Low)**

**Probability**: Low (1) - Existing tests show 1MB detection completes in <10ms. Markdown detection adds minimal overhead if search area is capped.

**Impact**: Medium (2) - UI freeze, poor user experience.

**Affected Components**:
- `JsonBridge::isLikelyMarkdown()`

**Mitigation**:
- Cap search to first 2KB as proposed
- Use early-return on first match
- Preserve existing performance test pattern

**Testing Requirements**:
- Test 1MB Markdown input
- Test 1MB whitespace + Markdown
- Verify <1ms (or <10ms with generous allowance)

**Residual Risk**: Low - Capped search provides hard limit

---

### DATA-001: Detection Priority Conflicts

**Score: 4 (Medium)**

**Probability**: Medium (2) - Ambiguous content can occur:
- JSON with Markdown-like strings: `{"title": "# Heading"}`
- XML with Markdown content: `<doc># Title</doc>`
- YAML frontmatter that starts with `---`

**Impact**: Medium (2) - Wrong format selected, but recoverable via manual override.

**Affected Components**:
- `JsonBridge::detectFormat()`
- Format routing in Main.qml

**Mitigation**:
- Strict priority: JSON > XML > Markdown > Unknown
- JSON/XML take priority since they have unambiguous markers
- `---` frontmatter detection should only trigger if at document start

**Testing Requirements**:
- Test `{"title": "# Heading"}` → "json"
- Test `<doc># Title</doc>` → "xml"
- Test `---\ntitle: test\n---` → "markdown"

**Residual Risk**: Low - Priority chain prevents misrouting structured formats

---

### OPS-001: UI State Desync with Detected Format

**Score: 4 (Medium)**

**Probability**: Medium (2) - The format selector, detected format, and actual processing must stay synchronized. Multiple entry points (paste, type, format button) increase desync risk.

**Impact**: Medium (2) - User confusion, wrong formatter applied.

**Affected Components**:
- Toolbar.qml format selector
- Main.qml state management
- `formatDetected` signal handling

**Mitigation**:
- Clear signal-to-state binding
- Use single source of truth for current format
- Test all entry points

**Testing Requirements**:
- Test paste → detect → format flow
- Test manual override persists
- Test switching between formats

**Residual Risk**: Low - QML binding model helps ensure consistency

---

## Risk Distribution

### By Category
- Technical: 4 risks (0 critical, 0 high)
- Performance: 1 risk (0 critical, 0 high)
- Data: 1 risk (0 critical, 0 high)
- Operational: 1 risk (0 critical, 0 high)

### By Component
- JsonBridge (C++): 5 risks
- QML UI: 2 risks
- Bridge Layer: 1 risk

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests (Score 4)
1. **Regex Performance** (TECH-001)
   - Benchmark all regex patterns with 1MB inputs
   - Test pathological inputs (many `#`, repeated patterns)

2. **False Positive Prevention** (TECH-002)
   - `#include` and other code patterns
   - Hashtags without space
   - Plain prose

3. **Priority Conflicts** (DATA-001)
   - JSON/XML containing Markdown-like content
   - Verify strict priority ordering

4. **UI State Sync** (OPS-001)
   - All entry point flows
   - Manual override persistence

### Priority 2: Low Risk Tests (Score 2-3)
1. **Regression Tests** (TECH-004)
   - Full existing test suite
   - Edge case JSON/XML inputs

2. **Performance Bounds** (PERF-001)
   - Large inputs with generous timing allowance

3. **Heuristic Coverage** (TECH-003)
   - Document limitations
   - Test obvious Markdown patterns

## Risk Acceptance Criteria

### Must Fix Before Production
- None (no critical/high risks)

### Can Deploy with Mitigation
- TECH-001: With search area cap and performance tests
- TECH-002: With proper pattern matching (hash+space)
- DATA-001: With strict priority ordering
- OPS-001: With proper signal binding

### Accepted Risks
- TECH-003: False negatives for subtle Markdown (user can manually select)

## Monitoring Requirements

Post-deployment monitoring:
- Performance metrics: Detection timing on various input sizes
- Error rates: Invalid format routing complaints
- User feedback: Manual override usage frequency

## Risk Review Triggers

Review and update risk profile when:
- New Markdown patterns need detection
- Detection priority needs adjustment
- Performance issues reported
- New format types added (e.g., YAML)
