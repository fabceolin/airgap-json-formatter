# NFR Assessment: 8.2 - Productionize XML Highlighter

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Mode:** YOLO (Non-interactive, core four NFRs)
**Story:** docs/stories/8.2.productionize-xml-highlighter.md
**Code Inspected:** src/xml_highlighter.rs (435 lines)

## Summary

| NFR | Status | Score Deduction |
|-----|--------|-----------------|
| Security | **CONCERNS** | -10 |
| Performance | **CONCERNS** | -10 |
| Reliability | **CONCERNS** | -10 |
| Maintainability | **PASS** | -0 |
| **Quality Score** | **70/100** | |

## Security Assessment

### Status: CONCERNS

**Targets (from AC4):** All 5 HTML special characters must be escaped: `<`, `>`, `&`, `"`, `'`

**Evidence Found:**
- `push_colored_escaped()` at lines 350-364 implements character escaping
- Line 355-360 shows match block handling:
  ```rust
  match c {
      '<' => output.push_str("&lt;"),
      '>' => output.push_str("&gt;"),
      '&' => output.push_str("&amp;"),
      '"' => output.push_str("&quot;"),
      _ => output.push(c),  // Single quote passes through!
  }
  ```

**Critical Gap - SEC-001:**
- Single quote (`'`) is NOT escaped
- This is an XSS vulnerability in HTML attribute contexts
- Example: `<a onclick='alert(1)'>` would not be properly escaped
- **Fix required:** Add `'\'' => output.push_str("&#39;")` before the `_ =>` arm

**Secondary Concern - SEC-002:**
- `push_colored()` (lines 367-373) bypasses escaping entirely
- Current callers only pass static strings (safe), but no invariant enforces this
- Low risk but fragile design

**Positive Findings:**
- No hardcoded credentials or secrets
- No network calls (aligns with airgap architecture)
- HTML entity escaping is consistent where implemented

## Performance Assessment

### Status: CONCERNS

**Targets (from AC5):**
- Documents over 100KB highlighted in under 100ms
- Input exceeding 5MB rejected with error message (not crash)

**Evidence Found:**
- Line 42: `String::with_capacity(input.len() * 3)` - efficient pre-allocation
- O(n) single-pass state machine - good algorithmic complexity
- No benchmarks exist in test suite

**Critical Gap - PERF-001:**
- No input size guard before allocation at line 42
- Large inputs (e.g., 10MB) would allocate ~30MB without check
- WASM memory is limited (~2GB); this could cause OOM
- **Fix required:** Add 5MB size guard before line 42

**Secondary Concern - PERF-002:**
- `matches_str()` at line 315 re-allocates `Vec<char>` per call
- Pattern: `let pattern_chars: Vec<char> = pattern.chars().collect();`
- Low impact but inefficient for hot path

**Missing Validation:**
- No benchmark tests to verify <100ms for 100KB
- Memory ratio (~3x input size) is informal, not validated

## Reliability Assessment

### Status: CONCERNS

**Targets (from AC3, AC6):**
- Graceful degradation for malformed XML
- State machine handles control chars, null bytes, incomplete sequences

**Evidence Found:**
- 12 states defined in `State` enum (lines 21-34)
- EOF flush at lines 297-307 handles buffer on termination
- Comment (line 301) and CDATA (line 302) EOF flush are correctly mapped

**Critical Gap - TECH-001:**
- Lines 113-116 (`State::TagOpen` else branch):
  ```rust
  } else {
      push_colored(&mut output, "&lt;", colors::BRACKET);
      state = State::Text;
      // No i += 1 - relies on Text state to advance
  }
  ```
- Missing `i += 1` after state transition to Text
- Trace analysis shows current behavior is safe (Text state advances `i`)
- However, this is poor defensive coding - future changes could create infinite loop
- **Fix required:** Add `i += 1;` for defense-in-depth

**Critical Gap - TECH-002:**
- EOF flush at lines 299-305:
  ```rust
  let color = match state {
      State::Text => colors::TEXT,
      State::Comment => colors::COMMENT,
      State::Cdata => colors::CDATA,
      State::Declaration | State::Doctype => colors::DECLARATION,
      _ => colors::TEXT,  // 6 states get wrong color!
  };
  ```
- `TagName`, `TagClose`, `AttrName`, `AttrValue`, `AttrEquals`, `InTag` all incorrectly map to TEXT color
- Truncated input renders in wrong color
- **Fix required:** Replace `_ =>` with explicit state-to-color mappings

**Missing Validation:**
- No tests for malformed input (unclosed tags, comments, CDATA, attributes)
- No tests for control characters after `<`

## Maintainability Assessment

### Status: PASS

**Targets:** Clean code structure, tests, documentation

**Evidence Found:**
- Clean state machine pattern mirrors `highlighter.rs` reference implementation
- 8 passing unit tests covering happy path (lines 376-434)
- Color palette documented in `colors` module (lines 7-17)
- Module-level documentation present (lines 1-4)

**Minor Concerns:**
- Test assertions use weak `contains()` - don't verify color-token pairing
- No tests for Doctype, entity highlighting, or text-only content
- Missing ENTITY color assertion in tests

**Positive Findings:**
- Story file has comprehensive dev notes with line numbers
- Change log tracks version history
- Task breakdown is clear and actionable

## Missing NFR Considerations

The following NFRs were not assessed (outside core four):

1. **Accessibility:** Color contrast ratios for syntax highlighting palette against dark backgrounds not validated. WCAG AA requires 4.5:1 contrast ratio.

2. **Internationalization:** Non-ASCII content (CJK, RTL scripts) in XML tag names/attribute values untested.

3. **Compatibility:** Generated HTML/CSS inline styles not tested across browsers.

## Quality Score Calculation

```
Base: 100
- Security CONCERNS: -10
- Performance CONCERNS: -10
- Reliability CONCERNS: -10
- Maintainability PASS: -0
= 70/100
```

## Test Recommendations

### P0 - Must have before merge (blocks gate)

| Test | Input | Expected | Risk Mitigated |
|------|-------|----------|----------------|
| Single quote escape | `<a b='val'>` | Output contains `&#39;` | SEC-001 |
| Control char termination | `<\x01` | Terminates, valid HTML | TECH-001 |
| Null byte handling | `<\x00` | Terminates, valid HTML | TECH-001 |
| XSS script tag | `<script>alert(1)</script>` | `&lt;script&gt;` escaped | SEC-001 |

### P1 - Should have before release

| Test | Input | Expected | Risk Mitigated |
|------|-------|----------|----------------|
| Unclosed tag color | `<root` | TAG color (`#569cd6`) | TECH-002 |
| Unclosed attr value | `<a b="val` | ATTR_VALUE color (`#ce9178`) | TECH-002 |
| Unclosed comment | `<!-- comment` | COMMENT color (`#6a9955`) | TECH-002 |
| Input size guard | 6MB XML | Error message, no OOM | PERF-001 |

### P2 - Nice to have

| Test | Input | Expected | Risk Mitigated |
|------|-------|----------|----------------|
| 100KB benchmark | Generated XML | <100ms | Performance |
| Memory profiling | 100KB+ | ~3x ratio | Performance |

## Acceptance Criteria Validation

| AC | NFR Mapping | Status | Gap |
|----|-------------|--------|-----|
| AC1: Token types highlighted | Maintainability | PARTIAL | Tests use weak assertions |
| AC2: VS Code colors | Maintainability | COVERED | Palette documented |
| AC3: Graceful degradation | Reliability | **GAP** | No malformed tests, TECH-001/002 |
| AC4: XSS prevention | Security | **GAP** | SEC-001 single quote |
| AC5: Performance thresholds | Performance | **GAP** | No benchmarks, no size guard |
| AC6: Edge cases | Reliability | **GAP** | Edge cases documented but untested |
| AC7: WASM build | Maintainability | LOW RISK | Manual verification |

## Gate Recommendation

**CONCERNS** - Three of four core NFRs have gaps. All are addressable within the story's existing task list:

- **Task 1** addresses SEC-001, TECH-001, TECH-002 (P0 fixes)
- **Task 2** addresses PERF-001 (input size guard)
- **Task 3** addresses reliability tests
- **Task 4** addresses XSS tests
- **Task 5** addresses performance benchmarks

**Recommendation:** Complete Tasks 1-5 before requesting gate review.

## Gate YAML Block

```yaml
# Copy to docs/qa/gates/8.2-productionize-xml-highlighter.yml under nfr_validation
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: "SEC-001: Single quote not escaped in push_colored_escaped() (line 360); SEC-002: push_colored() bypass lacks invariant enforcement"
  performance:
    status: CONCERNS
    notes: "No benchmarks for <100ms/100KB target (AC5); no 5MB input size guard (PERF-001); memory ratio unvalidated"
  reliability:
    status: CONCERNS
    notes: "TECH-001: TagOpen else branch missing i++ (line 116); TECH-002: EOF flush uses TEXT color for 6 states (line 304); no malformed input tests"
  maintainability:
    status: PASS
    notes: "Clean state machine (12 states), 8 unit tests, documented color palette, comprehensive dev notes with line numbers"
```

---

NFR assessment: docs/qa/assessments/8.2-nfr-v2-20260128.md
Gate NFR block ready -> paste into `docs/qa/gates/8.2-productionize-xml-highlighter.yml` under `nfr_validation`
