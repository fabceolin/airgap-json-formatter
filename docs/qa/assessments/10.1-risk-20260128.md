# Risk Profile: Story 10.1 — Rust Markdown Renderer Module

Date: 2026-01-28 (v3 — reassessed post Architect v1.3 corrections)
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5 (was 6; OPS-001 resolved by AC13)
- Critical Risks: 0
- High Risks: 2
- Risk Score: 71/100 (Moderate)
- Gate Recommendation: CONCERNS

## Resolved Risks

### OPS-001: Memory Budget Undefined — RESOLVED

**Original Score: 2 (Low)**
**Status: RESOLVED** — Architect v1.3 added AC13 (2MB input size guard) and Task 9 for implementation. Input exceeding 2MB is rejected with a descriptive error, preventing WASM heap exhaustion.

### TECH-001 (syntect): WASM Incompatibility — RESOLVED (v1.1)

**Original Score: 9 (Critical)**
**Status: RESOLVED** — Architect v1.1 correction changed dependency to `default-features = false`, explicitly excluding syntect.

## Risk Distribution

### By Category

- Technical: 2 risks (0 critical)
- Performance: 2 risks (0 critical, 2 high)
- Security: 1 risk (0 critical, 1 high)

### By Component

- Rust/WASM: 4 risks
- CI/Build: 1 risk

## Detailed Risk Register

| Risk ID | Description | Prob | Impact | Score | Priority | Status |
|---------|-------------|------|--------|-------|----------|--------|
| PERF-001 | Bundle size increase approaches/exceeds 200KB budget with comrak | Medium (2) | High (3) | 6 | High | Active |
| SEC-001 | comrak safe mode may not strip `javascript:`/`data:`/`vbscript:` URIs from Markdown links | Medium (2) | High (3) | 6 | High | Active — Task 8 covers |
| PERF-002 | 500KB render time exceeds 100ms in WASM (overhead vs native) | Medium (2) | Medium (2) | 4 | Medium | Active |
| TECH-002 | Deep nesting (100+ levels) causes WASM stack overflow | Low (1) | High (3) | 3 | Low | Active |
| TECH-001 | comrak 0.28 API options struct differences | Low (1) | Medium (2) | 2 | Low | Active |

### Risk Score Calculation

```
Base Score = 100
- PERF-001 (Score 6): -10 points
- SEC-001 (Score 6): -10 points
- PERF-002 (Score 4): -5 points
- TECH-002 (Score 3): -2 points
- TECH-001 (Score 2): -2 points
Total deductions: 29 points
Final Score: 71/100
```

## Risk Details and Mitigations

### PERF-001: Bundle Size Budget

**Score: 6 (High)**
**Probability**: Medium — comrak core without syntect is ~80-150KB WASM depending on features; approaching 200KB budget is likely.
**Impact**: High — Exceeding budget violates AC9 and affects page load performance for airgap security tool.
**Mitigation**:
- Strategy: Detective
- Actions:
  - Measure bundle size delta in CI after adding comrak
  - Apply `wasm-opt -Oz` if approaching budget
  - Consider tree-shaking unused comrak features if available
- Testing: INT-002 (bundle size gate)
- Owner: dev
- Timeline: During Task 1 implementation

### SEC-001: URI Scheme Sanitization

**Score: 6 (High)**
**Probability**: Medium — comrak's `unsafe_ = false` blocks raw HTML but URI scheme handling is less certain.
**Impact**: High — XSS via `javascript:` URLs would undermine the security-first design.
**Mitigation**:
- Strategy: Preventive
- Actions:
  - Task 8 covers: verify comrak behavior for `javascript:`, `data:`, `vbscript:` URIs
  - Add post-processing sanitization if comrak does not strip these
  - AC12 explicitly requires this validation
- Testing: UNIT-021, E2E-002, E2E-003
- Owner: dev
- Timeline: Task 8 implementation

### PERF-002: WASM Render Performance

**Score: 4 (Medium)**
**Probability**: Medium — WASM has overhead vs native; 500KB document parsing may approach 100ms threshold.
**Impact**: Medium — Violating AC10 degrades UX but doesn't affect security.
**Mitigation**:
- Strategy: Detective
- Actions:
  - Use `Performance.now()` in WASM runtime for accurate measurement (Task 7 corrected)
  - Test with synthetic 500KB document
  - Profile in browser DevTools
- Testing: INT-006, E2E-001
- Owner: dev
- Timeline: Task 7 implementation

### TECH-002: Deep Nesting Stack Overflow

**Score: 3 (Low)**
**Probability**: Low — Users rarely create 100+ nested structures in documentation.
**Impact**: High — Stack overflow would crash the WASM runtime.
**Mitigation**:
- Strategy: Preventive
- Actions:
  - Test with 100+ level nested lists
  - Document comrak behavior at extreme depth
  - Consider implementing depth limit if problematic
- Testing: Part of UNIT-019 (edge cases)
- Owner: dev
- Timeline: Task 6 (unit tests)

### TECH-001: comrak API Differences

**Score: 2 (Low)**
**Probability**: Low — comrak 0.28 is current and stable.
**Impact**: Medium — API changes would require code adjustments but are straightforward.
**Mitigation**:
- Strategy: Detective
- Actions:
  - Pin version in Cargo.toml
  - Review comrak changelog before version updates
- Testing: Compilation tests
- Owner: dev
- Timeline: Ongoing

## Risk-Based Testing Strategy

### Priority 0: Gate-Required Tests

1. WASM compilation succeeds with `default-features = false` (INT-001)
2. Bundle size delta < 200KB (INT-002)
3. URI scheme sanitization verified: `javascript:`, `data:`, `vbscript:` (UNIT-021)
4. Error path HTML-escaping prevents XSS (INT-007)
5. Input size guard rejects > 2MB (UNIT-022, INT-008)

### Priority 1: High/Medium Risk Tests

1. WASM render performance < 100ms for 500KB input (INT-006)
2. Error path HTML-escaping in WASM binding (INT-007)
3. All GFM functional tests (UNIT-013 through UNIT-018)

### Priority 2: Low Risk Tests

1. Deep nesting stress test (100+ levels)
2. Memory profiling for large inputs (within 2MB limit)
3. comrak version pinning verification

## Risk Acceptance Criteria

### Must Fix Before Production

- All high risks (score 6) must have verified mitigations
- SEC-001 requires passing URI sanitization tests
- PERF-001 requires bundle size under budget

### Can Deploy with Mitigation

- PERF-002: Accept if close to 100ms with documented performance characteristics
- TECH-002: Accept if deep nesting doesn't crash; document limitations

### Accepted Risks

- TECH-001: Low impact, can be addressed incrementally

## Monitoring Requirements

Post-deployment monitoring for:

- WASM bundle size tracked per build (CI artifact)
- Render performance for large documents (browser DevTools during testing)
- No runtime monitoring required for security risks (preventive controls in place)

## Integration with Quality Gate

**Gate Mapping:**

- No risks with score ≥ 9 → Gate ≠ FAIL
- Two risks with score 6 → Gate = CONCERNS
- Recommendation: CONCERNS with mandatory testing for SEC-001 and PERF-001 mitigations

### Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 1
    low: 2
  highest:
    id: PERF-001
    score: 6
    title: 'Bundle size approaches 200KB budget'
  recommendations:
    must_fix:
      - 'Verify bundle size delta < 200KB in CI'
      - 'Test URI scheme sanitization (javascript:, data:, vbscript:)'
    monitor:
      - 'Deep nesting behavior at 100+ levels'
```

## Risk Review Triggers

Review and update risk profile when:

- comrak version is changed
- New Markdown extensions are added
- Performance thresholds are adjusted
- Security vulnerabilities discovered in comrak
- Input size limit is changed
