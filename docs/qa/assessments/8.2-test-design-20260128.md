# Test Design: Story 8.2 — Productionize XML Highlighter

Date: 2026-01-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 25
- Unit tests: 21 (84%)
- Integration tests: 2 (8%)
- E2E tests: 2 (8%)
- Priority distribution: P0: 8, P1: 10, P2: 7

## Test Scenarios by Acceptance Criteria

### AC1: All XML token types correctly highlighted

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.2-UNIT-001 | Unit | P1 | Simple element `<root>text</root>` — tag name colored TAG, text colored TEXT, brackets colored BRACKET | Pure logic, verify each token type |
| 8.2-UNIT-002 | Unit | P1 | Attributes `<a href="url">` — attr name colored ATTR_NAME, value colored ATTR_VALUE | Pure logic |
| 8.2-UNIT-003 | Unit | P1 | Comment `<!-- x -->` — body colored COMMENT | Pure logic |
| 8.2-UNIT-004 | Unit | P1 | CDATA `<![CDATA[data]]>` — body colored CDATA | Pure logic |
| 8.2-UNIT-005 | Unit | P1 | Declaration `<?xml version="1.0"?>` — colored DECLARATION | Pure logic |
| 8.2-UNIT-006 | Unit | P1 | DOCTYPE `<!DOCTYPE html>` — colored DECLARATION | Pure logic |
| 8.2-UNIT-007 | Unit | P1 | Entity `&amp;` — colored ENTITY | Pure logic |
| 8.2-UNIT-008 | Unit | P2 | Namespace `<ns:tag xmlns:ns="uri"/>` — colon allowed in tag/attr names | Edge case |
| 8.2-UNIT-009 | Unit | P2 | Self-closing `<br/>` — `/&gt;` bracket rendered | Pure logic |

### AC2: VS Code dark theme colors consistent

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.2-UNIT-010 | Unit | P2 | Verify all color constants match documented palette values | Static assertion on constants |

### AC3: Malformed XML degrades gracefully

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.2-UNIT-011 | Unit | P0 | Unclosed tag `<root` — returns valid HTML, no crash | Robustness, AC3 | TECH-002 |
| 8.2-UNIT-012 | Unit | P0 | Unclosed comment `<!-- comment` — highlights to end as COMMENT color | Robustness | TECH-002 |
| 8.2-UNIT-013 | Unit | P0 | Unclosed CDATA `<![CDATA[data` — highlights to end as CDATA color | Robustness | TECH-002 |
| 8.2-UNIT-014 | Unit | P0 | Unclosed attr value `<a b="value` — highlights to end as ATTR_VALUE color | Robustness | TECH-002 |
| 8.2-UNIT-015 | Unit | P0 | Incomplete entity `&amp` (no semicolon) — returns valid HTML | Robustness |
| 8.2-UNIT-016 | Unit | P0 | `<` followed by control char (`<\x01`) — terminates, no infinite loop | Prevents hang | TECH-001 |
| 8.2-UNIT-017 | Unit | P1 | Empty input returns empty string | Boundary case |

### AC4: XSS prevention — HTML properly escaped

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.2-UNIT-018 | Unit | P0 | `<script>alert(1)</script>` in input — output contains `&lt;script&gt;`, not raw `<script>` | Security critical | SEC-001 |
| 8.2-UNIT-019 | Unit | P0 | `<a onclick="x">` in input — `onclick` attribute is escaped, not executable | Security |
| 8.2-UNIT-020 | Unit | P1 | Single quote `<a b='val'>` — output contains `&#39;` (or equivalent escape) | XSS in attribute contexts | SEC-001 |
| 8.2-UNIT-021 | Unit | P1 | All special chars `<`, `>`, `&`, `"`, `'` verified escaped in `push_colored_escaped` output | Comprehensive escape check | SEC-001 |

### AC5: Performance >100KB

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.2-UNIT-022 | Unit | P2 | Benchmark: 100KB XML highlights in < 100ms | Performance gate | PERF-001 |
| 8.2-UNIT-023 | Unit | P2 | Memory: output size ≤ ~3x input size for 100KB doc | Memory budget | PERF-001 |

### AC6: State machine edge cases

Covered by AC3 scenarios (8.2-UNIT-011 through 8.2-UNIT-016).

### AC7: WASM build succeeds

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.2-INT-001 | Integration | P1 | `wasm-pack build --target web --release` succeeds with no new warnings | Build verification |
| 8.2-INT-002 | Integration | P2 | `js_highlight_xml` WASM export callable from JS bridge with sample XML | Cross-boundary integration |

### Cross-cutting: End-to-End

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.2-E2E-001 | E2E | P2 | Paste XML into Code view → syntax highlighting visible with correct colors | User journey |
| 8.2-E2E-002 | E2E | P2 | Paste malformed XML → no crash, partial highlighting displayed | Degradation journey |

## Risk Coverage

| Risk ID | Test Scenarios | Coverage |
|---------|---------------|----------|
| SEC-001 | 8.2-UNIT-018, 019, 020, 021 | Full — tests escape of all 5 HTML-special characters including `'` |
| TECH-001 | 8.2-UNIT-016 | Full — verifies `<\x01` terminates without infinite loop |
| TECH-002 | 8.2-UNIT-011, 012, 013, 014 | Full — verifies correct color on buffer flush for each unclosed state |
| PERF-001 | 8.2-UNIT-022, 023 | Partial — benchmark + memory check, no fuzz |
| PERF-002 | Not covered | Low risk, optimization only |
| SEC-002 | Audit only | `push_colored` usage reviewed; no runtime test needed |
| TECH-003 | 8.2-UNIT-011 | Partial — unclosed tag exercises `TagClose` unexpected path |

## Recommended Execution Order

1. P0 Unit tests — fail fast on security and robustness (8.2-UNIT-011 through 020)
2. P1 Unit tests — token type coverage and remaining escaping (8.2-UNIT-001 through 009, 021)
3. P1 Integration — WASM build (8.2-INT-001)
4. P2 Unit — benchmarks and color constants (8.2-UNIT-010, 022, 023)
5. P2 Integration + E2E — WASM export and browser verification (8.2-INT-002, E2E-001, E2E-002)

## Test Data Requirements

- **Small XML samples**: Simple elements, attributes, comments, CDATA, declarations, DOCTYPE, entities, namespaces, self-closing tags
- **Malformed XML samples**: Unclosed tag, unclosed comment, unclosed CDATA, unclosed attribute value, incomplete entity, `<` + control char
- **XSS payloads**: `<script>alert(1)</script>`, `<a onclick="x">`, `<a b='val'>`, all 5 special chars
- **Large XML**: Programmatically generated 100KB+ XML document (nested elements with attributes)

## Environment Requirements

- Rust toolchain with `cargo test`
- `wasm32-unknown-unknown` target for WASM build tests
- `wasm-pack` for integration test 8.2-INT-001
- Browser (any modern) for E2E tests

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 25
  by_level:
    unit: 21
    integration: 2
    e2e: 2
  by_priority:
    p0: 8
    p1: 10
    p2: 7
  coverage_gaps: []
```
