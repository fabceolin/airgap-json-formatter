# Requirements Traceability Matrix

## Story: 10.1 - Rust Markdown Renderer Module

**Assessment Date:** 2026-01-28
**Assessor:** Quinn (Test Architect)
**Story Version:** v1.3 (post Architect v1.3 corrections - includes AC13)

### Coverage Summary

- **Total Requirements:** 15
- **Fully Covered:** 14 (93%)
- **Partially Covered:** 0 (0%)
- **Not Covered:** 1 (7%)

### Requirement Mappings

#### AC1: comrak dependency added to Cargo.toml with WASM-compatible features

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| INT-001 | Integration | comrak added to Cargo.toml with `default-features = false` | `cargo build --target wasm32-unknown-unknown` executes | Build succeeds with exit code 0 |
| INT-002 | Integration | WASM binary before and after comrak addition | Bundle sizes compared | Delta < 200KB |

---

#### AC2: render_markdown(input: &str) -> Result<String, RenderError> implemented

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-001 | Unit | Empty string input `""` | `render_markdown("")` called | Returns `Ok("")` |
| UNIT-002 | Unit | Valid Markdown input | `render_markdown(input)` called | Returns `Ok(String)` with valid HTML |
| UNIT-003 | Unit | Error condition triggered | `render_markdown` fails | Returns `Err(RenderError)` with meaningful message |

---

#### AC3: Standard Markdown renders correctly

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-004 | Unit | Input `# H1` through `###### H6` | `render_markdown` called | Output contains `<h1>H1</h1>` through `<h6>H6</h6>` |
| UNIT-005 | Unit | Input `**bold**` | `render_markdown` called | Output contains `<strong>bold</strong>` |
| UNIT-006 | Unit | Input `*italic*` | `render_markdown` called | Output contains `<em>italic</em>` |
| UNIT-007 | Unit | Input with ordered/unordered lists | `render_markdown` called | Output contains `<ol>`, `<ul>`, `<li>` elements |
| UNIT-008 | Unit | Input `> blockquote` | `render_markdown` called | Output contains `<blockquote>` |
| UNIT-009 | Unit | Input `---` (horizontal rule) | `render_markdown` called | Output contains `<hr>` |
| UNIT-010 | Unit | Input `[link](url)` | `render_markdown` called | Output contains `<a href="url">link</a>` |
| UNIT-011 | Unit | Input `![alt](src)` | `render_markdown` called | Output contains `<img src="src" alt="alt">` |
| UNIT-012 | Unit | Input with inline code and fenced blocks | `render_markdown` called | Output contains `<code>` elements with content |

---

#### AC4: GFM extensions render correctly

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-013 | Unit | GFM table with `\|:-\|:-:\|-:\|` alignment markers | `render_markdown` called | Output contains `<table>` with `align` attributes |
| UNIT-014 | Unit | Input `- [ ] task` and `- [x] done` | `render_markdown` called | Output contains `<input type="checkbox">` elements |
| UNIT-015 | Unit | Input `~~strikethrough~~` | `render_markdown` called | Output contains `<del>strikethrough</del>` |
| UNIT-016 | Unit | Bare URL (autolink) | `render_markdown` called | Output wraps URL in `<a>` tag |

---

#### AC5: Fenced code blocks include `language-{lang}` class attribute

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-017 | Unit | Fenced code block with ` ```javascript ` | `render_markdown` called | Output contains `<code class="language-javascript">` |

---

#### AC6: Mermaid blocks output as `<pre><code class="language-mermaid">...</code></pre>`

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-018 | Unit | Fenced code block with ` ```mermaid ` | `render_markdown` called | Output contains `<pre><code class="language-mermaid">` wrapping diagram source |

---

#### AC7: WASM bindings expose `renderMarkdown` to JavaScript

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| INT-003 | Integration | WASM module initialized in JavaScript runtime | `renderMarkdown(input)` called from JS | Function executes and returns string |
| INT-004 | Integration | WASM binding with error condition | `renderMarkdown` returns error HTML | HTML is properly serialized for JS consumption |

---

#### AC8: Unit tests cover edge cases (empty input, unicode, deeply nested structures)

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-001 | Unit | Empty string | `render_markdown("")` called | Returns `Ok("")` |
| UNIT-019 | Unit | Deeply nested lists (10+ levels) | `render_markdown` called | Renders without panic, output contains nested `<ul>/<li>` |
| INT-005 | Integration | Unicode content (CJK, emoji, RTL, combining chars) | Roundtrip through WASM binding | Unicode preserved in output |

---

#### AC9: WASM bundle size increase < 200KB

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| INT-002 | Integration | Baseline WASM binary size | comrak added and WASM rebuilt | Size increase delta < 200KB |

---

#### AC10: Render time < 100ms for 500KB Markdown documents

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| INT-006 | Integration | 500KB synthetic Markdown document in WASM runtime | `renderMarkdown` called with `Performance.now()` timing | Delta < 100ms |
| E2E-001 | E2E | 500KB document in real browser | Document loaded and rendered | Total time < 100ms |

---

#### AC11: Error messages in WASM binding must be HTML-escaped before embedding in output

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| INT-007 | Integration | Error condition with message containing `<img onerror=alert(1)>` | WASM binding returns error HTML | Message is HTML-escaped (`<` becomes `&lt;`, etc.) |
| UNIT-020 | Unit | `<script>alert(1)</script>` in error message | Error path processes message | No executable content in output |

---

#### AC12: Rendered links must not contain `javascript:`, `data:`, or `vbscript:` URI schemes

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-021 | Unit | Input `[click](javascript:alert(1))` | `render_markdown` called | Link is sanitized or stripped |
| E2E-002 | E2E | Markdown with various dangerous URI schemes | Rendered in browser | No executable URIs in output, CSP not violated |
| E2E-003 | E2E | Pathological input with 100+ nesting | Rendered in browser | Browser tab does not crash |

---

#### AC13: Input size guard - reject input > 2MB with descriptive error

**Coverage: FULL**

| Test ID | Level | Given | When | Then |
|---------|-------|-------|------|------|
| UNIT-022 | Unit | Input string > 2MB (2,097,152 bytes) | `render_markdown(large_input)` called | Returns `Err(RenderError)` with size limit message |
| INT-008 | Integration | Oversized input (2.1MB) via WASM binding | `renderMarkdown(oversized)` called from JS | Returns user-friendly error HTML |

---

#### NFR: CSP interaction with rendered HTML

**Coverage: NONE**

**Reason:** CSP validation is deferred to Story 10.5 (Preview Pane) where rendered HTML is actually displayed in the DOM. This story produces HTML but does not embed it.

**Risk:** Low - The HTML produced by this story will be rendered in a controlled environment in Story 10.5.

---

### Critical Gaps Summary

| # | Gap | Severity | Recommendation |
|---|-----|----------|----------------|
| GAP-1 | CSP interaction with rendered HTML not tested | Low | Defer to Story 10.5 (Preview Pane) where HTML is rendered |

### Resolved Gaps

| # | Gap | Resolution |
|---|-----|------------|
| GAP-2 (v2) | Memory budget undefined for large documents | RESOLVED: AC13 adds 2MB input size guard (Task 9) |
| GAP-3 (v1) | Security ACs not in formal AC list | RESOLVED: AC11 and AC12 added by Architect v1.1 |
| GAP-4 (v1) | AC10 benchmark incompatible with WASM | RESOLVED: Task 7 corrected to use `Performance.now()` / `js_sys::Date::now()` |

### Test Design Recommendations

1. **P0 Tests (10 total):** UNIT-001, UNIT-020, UNIT-021, UNIT-022, INT-001, INT-002, INT-003, INT-006, INT-007, INT-008
2. **Memory protection:** AC13 (2MB input guard) provides WASM heap protection
3. **CSP validation:** Covered in Story 10.5 scope, not this story

### Risk Assessment

| Risk Level | Requirements |
|------------|-------------|
| **Low Risk** (Full coverage) | AC1, AC2, AC3, AC4, AC5, AC6, AC7, AC8, AC9, AC10, AC11, AC12, AC13 |
| **Low Risk** (Deferred) | NFR: CSP interaction |

## Gate YAML Block

```yaml
trace:
  totals:
    requirements: 15
    full: 14
    partial: 0
    none: 1
  uncovered:
    - ac: 'NFR: CSP interaction'
      reason: 'Deferrable to Story 10.5 (Preview Pane)'
  notes: 'v3 reassessment - all 13 formal ACs (AC1-AC13) fully covered; AC13 resolved memory budget gap'
```

## Trace References

- Test design matrix: docs/qa/assessments/10.1-test-design-20260128.md
- P0 tests identified: 10
- Story file: docs/stories/10.1.rust-markdown-renderer.md
