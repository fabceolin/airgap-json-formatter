# Test Design: Story 10.5 - Markdown Preview Pane

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** 10.5 - Markdown Preview Pane
**Risk Level:** HIGH (Score: 62/100 from risk profile)

## Test Strategy Overview

- **Total test scenarios:** 28
- **Unit tests:** 8 (29%)
- **Integration tests:** 12 (43%)
- **E2E tests:** 8 (29%)
- **Priority distribution:** P0: 8, P1: 12, P2: 6, P3: 2

### Strategy Rationale

This story has **critical security concerns** (XSS, external resource blocking) requiring extensive security-focused testing. The WebEngineView rendering approach adds complexity that shifts coverage toward integration tests. The security-critical nature elevates many scenarios to P0.

## Test Scenarios by Acceptance Criteria

### AC1: New "Preview" view mode added to OutputPane

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-001 | Unit | P1 | ViewMode enum includes "preview" value | Pure enum validation | - |
| 10.5-INT-001 | Integration | P1 | OutputPane switches to preview component when viewMode="preview" | Component loading behavior | - |
| 10.5-INT-002 | Integration | P1 | Preview mode only activates when format="markdown" | Cross-property interaction | - |

### AC2: View toggle includes Code | Tree | Preview (where applicable per format)

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-INT-003 | Integration | P1 | Toggle shows Preview option only for markdown format | Conditional UI visibility | - |
| 10.5-INT-004 | Integration | P1 | Toggle shows Tree option only for JSON/XML formats | Format-specific view options | - |
| 10.5-E2E-001 | E2E | P1 | User can cycle through available view modes via toggle | Complete user interaction flow | - |
| 10.5-UNIT-002 | Unit | P2 | View toggle correctly maps format to available modes | Pure logic for mode calculation | - |

### AC3: Preview mode displays rendered HTML correctly

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-INT-005 | Integration | P1 | Headings (H1-H6) render with proper font sizes | HTML/CSS rendering | - |
| 10.5-INT-006 | Integration | P1 | Tables render with borders and alignment | Complex HTML structure | - |
| 10.5-INT-007 | Integration | P1 | Code blocks render with background styling | CSS application | - |
| 10.5-INT-008 | Integration | P0 | Links display but are not clickable (pointer-events: none) | Security requirement | SEC-003 |
| 10.5-INT-009 | Integration | P0 | Mermaid SVG diagrams display inline correctly | Critical functionality | - |
| 10.5-E2E-002 | E2E | P1 | Complex markdown with mixed elements renders correctly | Full rendering validation | - |

### AC4: Preview pane respects Theme.qml colors

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-003 | Unit | P1 | CSS variable mapping produces correct dark theme values | Pure transformation logic | TECH-002 |
| 10.5-UNIT-004 | Unit | P1 | CSS variable mapping produces correct light theme values | Pure transformation logic | TECH-002 |
| 10.5-INT-010 | Integration | P1 | Theme switch triggers CSS re-injection in preview | Component coordination | TECH-002 |
| 10.5-E2E-003 | E2E | P2 | User toggles theme and preview colors update immediately | Full user flow | TECH-002 |

### AC5: Images show placeholder (no external fetch by default)

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-005 | Unit | P0 | External URL detection correctly identifies http/https sources | Security logic | SEC-002 |
| 10.5-INT-011 | Integration | P0 | External images replaced with placeholder in rendered output | Security implementation | SEC-002 |
| 10.5-E2E-004 | E2E | P0 | No network requests made when rendering markdown with external images | Critical security validation | SEC-002 |

### AC6: Code view shows syntax-highlighted raw HTML

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-006 | Unit | P2 | HTML syntax highlighting tokenizes tags correctly | Highlighting logic | - |
| 10.5-INT-012 | Integration | P2 | Switching to Code view displays raw HTML source with highlighting | View mode behavior | - |

### AC7: Copy button copies rendered HTML source

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-007 | Unit | P2 | Copy extracts HTML source string, not rendered text | Data extraction logic | DATA-001 |
| 10.5-E2E-005 | E2E | P2 | User clicks copy, pastes elsewhere, receives HTML markup | Full clipboard flow | DATA-001 |

### AC8: Large documents scroll smoothly

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-UNIT-008 | Unit | P1 | 500KB document does not exceed memory threshold | Performance boundary | PERF-001 |
| 10.5-E2E-006 | E2E | P1 | Scrolling 500KB document maintains 60fps frame rate | User experience validation | PERF-001 |

### AC9: Preview updates when content changes (debounced)

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-E2E-007 | E2E | P1 | Typing in input triggers preview update after 300ms pause | Debounce behavior | PERF-001 |
| 10.5-E2E-008 | E2E | P3 | Rapid typing does not cause multiple preview refreshes | Debounce optimization | PERF-001 |

## Security Test Scenarios (SEC-001 XSS Mitigation - Critical)

These scenarios specifically address the critical SEC-001 risk identified in the risk profile.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 10.5-SEC-001 | Integration | P0 | Script tags in markdown are stripped from output | XSS prevention | SEC-001 |
| 10.5-SEC-002 | Integration | P0 | Event handlers (onclick, onerror, onload) stripped | XSS prevention | SEC-001 |
| 10.5-SEC-003 | Integration | P0 | SVG with embedded script is sanitized | XSS prevention | SEC-001 |
| 10.5-SEC-004 | Integration | P0 | javascript: URLs in links are blocked | XSS prevention | SEC-001 |
| 10.5-SEC-005 | Integration | P0 | iframe, object, embed tags are removed | XSS prevention | SEC-001 |
| 10.5-SEC-006 | E2E | P0 | OWASP XSS cheat sheet payloads do not execute | Comprehensive XSS validation | SEC-001 |

## Risk Coverage Matrix

| Risk ID | Description | Test Coverage |
|---------|-------------|---------------|
| SEC-001 | XSS via malicious HTML/SVG | 10.5-SEC-001 to 10.5-SEC-006 (6 tests) |
| SEC-002 | External resource loading | 10.5-UNIT-005, 10.5-INT-011, 10.5-E2E-004 (3 tests) |
| SEC-003 | Link navigation escape | 10.5-INT-008 (1 test) |
| PERF-001 | Large document rendering | 10.5-UNIT-008, 10.5-E2E-006, 10.5-E2E-007, 10.5-E2E-008 (4 tests) |
| TECH-002 | Theme CSS injection timing | 10.5-UNIT-003, 10.5-UNIT-004, 10.5-INT-010, 10.5-E2E-003 (4 tests) |
| DATA-001 | Clipboard copy exposes HTML | 10.5-UNIT-007, 10.5-E2E-005 (2 tests) |

## Test Data Requirements

### Markdown Test Documents

| Document | Size | Contents | Purpose |
|----------|------|----------|---------|
| basic.md | <1KB | H1, paragraph, list | Basic rendering |
| complex.md | 10KB | All markdown elements + Mermaid | Full feature validation |
| large.md | 500KB | Generated content with tables | Performance testing |
| malicious.md | 5KB | OWASP XSS payloads | Security testing |
| external-refs.md | 2KB | External images, scripts, iframes | Security blocking |

### XSS Payload Test Set

```markdown
# Security Test Payloads (malicious.md)

<!-- Script injection -->
<script>alert('XSS')</script>

<!-- Event handler injection -->
<img src="x" onerror="alert('XSS')">
<svg onload="alert('XSS')">

<!-- SVG script injection -->
<svg><script>alert('XSS')</script></svg>

<!-- javascript: URL -->
[Click me](javascript:alert('XSS'))

<!-- Data URI with script -->
<img src="data:text/html,<script>alert('XSS')</script>">

<!-- iframe injection -->
<iframe src="https://evil.com"></iframe>

<!-- object/embed injection -->
<object data="https://evil.com/evil.swf"></object>
<embed src="https://evil.com/evil.swf">
```

## Test Environment Requirements

### QML Test Environment
- Qt 6.x with QtWebEngine
- QML TestCase framework
- Mock clipboard access

### Browser Test Environment (if WebView testing)
- Chromium DevTools Protocol for network monitoring
- Content Security Policy verification tools

### Performance Test Environment
- Frame rate monitoring (60fps target)
- Memory profiler
- Render time instrumentation

## Coverage Gaps Analysis

| Gap | Severity | Recommendation |
|-----|----------|----------------|
| No automated test for CSP headers | Medium | Add INT test for Content-Security-Policy validation |
| Missing memory limit validation | Low | Add monitoring but not blocking test |
| No accessibility testing | Low | Consider P3 screen reader compatibility test |

## Recommended Execution Order

### Phase 1: Security (P0 - Fail Fast)
1. 10.5-SEC-001 through 10.5-SEC-006 (XSS prevention)
2. 10.5-UNIT-005, 10.5-INT-011, 10.5-E2E-004 (External resource blocking)
3. 10.5-INT-008 (Link navigation blocking)

### Phase 2: Core Functionality (P1)
4. 10.5-UNIT-001 through 10.5-UNIT-004 (Core logic)
5. 10.5-INT-001 through 10.5-INT-010 (Component integration)
6. 10.5-E2E-001, 10.5-E2E-002 (User journeys)

### Phase 3: Secondary Features (P2)
7. Remaining unit tests
8. Copy functionality tests
9. Theme switching E2E

### Phase 4: Nice-to-Have (P3)
10. Rapid typing debounce optimization test

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 34
  by_level:
    unit: 8
    integration: 18  # Including 6 SEC tests
    e2e: 8
  by_priority:
    p0: 14  # 8 regular + 6 security
    p1: 12
    p2: 6
    p3: 2
  coverage_gaps:
    - "CSP header validation (medium severity)"
    - "Memory limit enforcement (low severity)"
    - "Accessibility testing (low severity)"
  security_tests:
    xss_prevention: 6
    external_resource_blocking: 3
    link_navigation: 1
  performance_tests:
    scroll_performance: 1
    debounce_behavior: 2
    memory_threshold: 1
```

## Trace References

Test design matrix: docs/qa/assessments/10.5-test-design-20260128.md
P0 tests identified: 14
Security tests (SEC-001 mitigation): 6
External resource blocking tests: 3
