# Test Design: Story 10.4 Format Auto-Detection Extension

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** 10.4 - Format Auto-Detection Extension
**Title:** Markdown detection in auto-format workflow

## Test Strategy Overview

- **Total test scenarios:** 28
- **Unit tests:** 18 (64%)
- **Integration tests:** 7 (25%)
- **E2E tests:** 3 (11%)
- **Priority distribution:** P0: 8, P1: 12, P2: 6, P3: 2

### Strategy Rationale

Markdown detection is heuristic-based pattern matching - ideally suited for unit testing. The core `isLikelyMarkdown()` function is pure logic that can be exhaustively tested at the unit level. Integration tests validate the detection→signal→routing flow, while E2E tests confirm the complete paste→detect→render user journey.

## Test Scenarios by Acceptance Criteria

### AC1: detectFormat() extended to detect Markdown content

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-001 | Unit | P0 | detectFormat returns "markdown" for `# Heading` | Core detection path - validates basic heading recognition |
| 10.4-UNIT-002 | Unit | P0 | detectFormat returns "markdown" for multi-line Markdown document | Verifies real-world content detection |
| 10.4-INT-001 | Integration | P0 | detectFormat called from QML triggers formatDetected signal with "markdown" | Component boundary validation |

---

### AC2: Detection patterns include headings, code blocks, frontmatter, lists, blockquotes, links

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-003 | Unit | P0 | Heading detection: `#`, `##`, `###`, `####`, `#####`, `######` all detected | All heading levels must work |
| 10.4-UNIT-004 | Unit | P1 | Code block detection: ``` at line start triggers markdown | Fenced code blocks are common |
| 10.4-UNIT-005 | Unit | P1 | Frontmatter detection: `---` at document start triggers markdown | YAML frontmatter pattern |
| 10.4-UNIT-006 | Unit | P1 | Unordered list detection: `- item` and `* item` both work | Both markers must be recognized |
| 10.4-UNIT-007 | Unit | P1 | Ordered list detection: `1. item`, `42. item` patterns | Numbered lists with any digit |
| 10.4-UNIT-008 | Unit | P1 | Blockquote detection: `> quote` triggers markdown | Standard blockquote syntax |
| 10.4-UNIT-009 | Unit | P1 | Link detection: `[text](url)` anywhere in document | Links may appear mid-document |

---

### AC3: Detection works with leading whitespace (trimmed)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-010 | Unit | P1 | Leading spaces before `# Heading` still detected as markdown | Common paste behavior includes whitespace |
| 10.4-UNIT-011 | Unit | P2 | Leading tabs before patterns still detected | Tab-indented content |
| 10.4-UNIT-012 | Unit | P2 | Mixed whitespace (spaces + tabs + newlines) trimmed correctly | Edge case robustness |

---

### AC4: Detection works for patterns mid-document (not just start)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-013 | Unit | P1 | Heading on line 5 of document still triggers markdown detection | Pattern search is not first-line only |
| 10.4-UNIT-014 | Unit | P1 | Code block starting mid-document (after `\n`) detected | Multi-line pattern matching |
| 10.4-UNIT-015 | Unit | P2 | Link `[text](url)` in paragraph 3 triggers detection | Deep document pattern recognition |

---

### AC5: Format selector UI updated to include "Markdown" option

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-INT-002 | Integration | P1 | Toolbar ComboBox model contains "Markdown" option | UI component contract |
| 10.4-E2E-001 | E2E | P1 | User can see and select "Markdown" in format dropdown | Visual verification of option visibility |

---

### AC6: formatDetected signal emits "markdown" for detected content

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-INT-003 | Integration | P0 | formatDetected signal emits exactly "markdown" (case-sensitive) | Signal contract verification |
| 10.4-INT-004 | Integration | P1 | Signal emission triggers UI format indicator update | End-to-end signal flow |

---

### AC7: Plain prose without Markdown patterns returns "unknown" (not false positive)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-016 | Unit | P0 | Plain text "Hello world" returns "unknown" | False positive prevention - critical |
| 10.4-UNIT-017 | Unit | P0 | `#hashtag` (no space) returns "unknown" | Common false positive case |
| 10.4-UNIT-018 | Unit | P1 | `#include <stdio.h>` returns "unknown" | C/C++ code false positive prevention |
| 10.4-UNIT-019 | Unit | P1 | CSS color `#ffffff` returns "unknown" | Color hex code false positive |
| 10.4-UNIT-020 | Unit | P2 | Shell command `# this is a comment` returns "unknown" | Shell comments look like headings |

---

### AC8: Detection is fast (< 1ms for any input size)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-021 | Unit | P0 | Detection completes in < 1ms for 10KB input | Performance requirement verification |
| 10.4-UNIT-022 | Unit | P1 | Detection completes in < 1ms for 1MB input | Large file performance bound |
| 10.4-UNIT-023 | Unit | P2 | 1000 sequential calls complete in < 100ms | Throughput under rapid invocation |

---

### AC9: Manual override via toolbar still works

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-INT-005 | Integration | P1 | Selecting "JSON" manually overrides auto-detected "markdown" | Manual override must take precedence |
| 10.4-INT-006 | Integration | P1 | Selecting "Markdown" manually on JSON content routes to markdown renderer | User intent honored over detection |
| 10.4-E2E-002 | E2E | P2 | Complete flow: paste JSON, override to Markdown, verify markdown renderer called | Full override journey |

---

### Cross-Cutting: Regression Prevention

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.4-UNIT-024 | Unit | P0 | `{"json": true}` still returns "json" (not markdown) | JSON priority preserved |
| 10.4-UNIT-025 | Unit | P0 | `<xml/>` still returns "xml" (not markdown) | XML priority preserved |
| 10.4-UNIT-026 | Unit | P1 | Empty string returns "unknown" | Existing behavior maintained |
| 10.4-INT-007 | Integration | P1 | Run full 8.4 test suite - all 23+ tests pass | Regression prevention |
| 10.4-E2E-003 | E2E | P3 | Complete paste→detect→format flow for all three formats | End-to-end regression |

---

## Risk Coverage

Mapping test scenarios to identified risks from risk profile:

| Risk ID | Risk Description | Mitigating Tests |
|---------|------------------|------------------|
| TECH-001 | Regex pattern performance degradation | 10.4-UNIT-021, 10.4-UNIT-022, 10.4-UNIT-023 |
| TECH-002 | False positive detection on plain text | 10.4-UNIT-016, 10.4-UNIT-017, 10.4-UNIT-018, 10.4-UNIT-019, 10.4-UNIT-020 |
| DATA-001 | Detection priority conflicts | 10.4-UNIT-024, 10.4-UNIT-025 |
| OPS-001 | UI state desync with detected format | 10.4-INT-003, 10.4-INT-004, 10.4-E2E-001 |
| TECH-004 | Regression in existing JSON/XML detection | 10.4-INT-007, 10.4-E2E-003 |
| TECH-003 | Heuristic detection misses valid Markdown | 10.4-UNIT-003 through 10.4-UNIT-009 |
| PERF-001 | Large input causes detection timeout | 10.4-UNIT-021, 10.4-UNIT-022 |

**All identified risks have test coverage.**

---

## Test Data Requirements

### Unit Test Fixtures

```yaml
fixtures:
  markdown_headings:
    - "# H1"
    - "## H2 with text"
    - "### H3\nWith content below"
    - "#### H4"
    - "##### H5"
    - "###### H6"

  markdown_code_blocks:
    - "```\ncode\n```"
    - "```javascript\nconst x = 1;\n```"
    - "Some text\n```\ncode\n```"

  markdown_frontmatter:
    - "---\ntitle: Test\n---\n# Content"
    - "---\n---"

  markdown_lists:
    - "- item 1\n- item 2"
    - "* bullet point"
    - "1. first\n2. second"
    - "42. numbered"

  markdown_blockquotes:
    - "> quote"
    - "> line 1\n> line 2"

  markdown_links:
    - "[link](https://example.com)"
    - "See [here](url) for details"
    - "Text with [multiple](a) [links](b)"

  false_positive_cases:
    - "#hashtag"
    - "#include <stdio.h>"
    - "#ffffff"
    - "# " # hash + space only
    - "Hello world"
    - "Plain text without any markdown"

  priority_test_cases:
    - input: '{"key": "# value"}'
      expected: "json"
    - input: '<root># heading</root>'
      expected: "xml"
    - input: '[{"#": 1}]'
      expected: "json"

  performance_fixtures:
    - size: 10KB
      content: "# Heading\n" repeated
    - size: 1MB
      content: mixed markdown content
    - size: 2KB
      content: plain text (no patterns) - worst case for scan
```

### Integration Test Environment

```yaml
environment:
  qt_version: "6.x"
  build_type: "Debug"
  test_framework: "QtTest"

mocks:
  - None required - testing real JsonBridge

signals_to_verify:
  - formatDetected(QString)
  - formatSelected(QString)

components:
  - JsonBridge
  - Toolbar.qml
  - Main.qml
```

### E2E Test Environment

```yaml
environment:
  browser: "Chrome/Chromium"
  wasm_build: required

test_data:
  json_sample: '{"name": "test"}'
  xml_sample: '<root><item/></root>'
  markdown_sample: |
    # Test Document

    This is a **bold** statement.

    - Item 1
    - Item 2

    ```javascript
    console.log("Hello");
    ```

verification_points:
  - Format indicator shows correct format
  - Output pane renders expected format
  - Manual override changes format
```

---

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on core logic)
   - 10.4-UNIT-001, 002, 003, 016, 017, 021, 024, 025

2. **P0 Integration tests** (validate component contracts)
   - 10.4-INT-001, 003

3. **P1 Unit tests** (complete pattern coverage)
   - 10.4-UNIT-004 through 015, 018, 019, 022, 026

4. **P1 Integration/E2E tests** (validate user flows)
   - 10.4-INT-002, 004, 005, 006, 007
   - 10.4-E2E-001

5. **P2+ tests** (as time permits)
   - Remaining scenarios

---

## Gate YAML Block

```yaml
test_design:
  date: 2026-01-28
  designer: Quinn
  scenarios_total: 28
  by_level:
    unit: 18
    integration: 7
    e2e: 3
  by_priority:
    p0: 8
    p1: 12
    p2: 6
    p3: 2
  coverage_gaps: []
  risk_coverage: complete
  ac_coverage:
    ac1: 3
    ac2: 7
    ac3: 3
    ac4: 3
    ac5: 2
    ac6: 2
    ac7: 5
    ac8: 3
    ac9: 3
  regression_tests: 5
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] All identified risks have mitigating tests
- [x] Performance requirements have dedicated tests
- [x] False positive prevention is comprehensive
- [x] Regression prevention for existing JSON/XML detection

---

## Trace References

```text
Test design matrix: docs/qa/assessments/10.4-test-design-20260128.md
P0 tests identified: 8
Total scenarios: 28
Risk coverage: 7/7 risks mitigated
```
