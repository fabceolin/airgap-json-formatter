# Test Design: Story 8.2 - Productionize XML Highlighter

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Mode:** YOLO (Non-interactive comprehensive design)
**Story:** 8.2.productionize-xml-highlighter.md
**Source File:** src/xml_highlighter.rs (435 lines)

## Test Strategy Overview

- **Total test scenarios:** 27
- **Unit tests:** 23 (85%)
- **Integration tests:** 2 (7%)
- **E2E tests:** 2 (7%)
- **Priority distribution:** P0: 8, P1: 12, P2: 7

### Level Justification

| Level | Count | Rationale |
|-------|-------|-----------|
| Unit | 23 | State machine is pure logic - no external dependencies, O(n) algorithm, isolated function |
| Integration | 2 | WASM build verification requires toolchain integration |
| E2E | 2 | Browser rendering validation for critical user journey |

## Test Scenarios by Acceptance Criteria

### AC1: All XML Token Types Highlighted with Designated Colors

**Requirement:** Tags (#569cd6), attributes (#9cdcfe), values (#ce9178), comments (#6a9955), CDATA (#dcdcaa), declarations (#c586c0), entities (#d7ba7d), brackets (#808080), text (#d4d4d4)

| ID | Level | Priority | Test Description | Expected Result | Justification |
|----|-------|----------|------------------|-----------------|---------------|
| 8.2-UNIT-001 | Unit | P1 | Tag name highlighting | `<root>` → "root" in span with `#569cd6` | Core token type |
| 8.2-UNIT-002 | Unit | P1 | Attribute name highlighting | `<a href="x">` → "href" in span with `#9cdcfe` | Core token type |
| 8.2-UNIT-003 | Unit | P1 | Attribute value highlighting | `<a href="url">` → `"url"` in span with `#ce9178` | Core token type |
| 8.2-UNIT-004 | Unit | P1 | Comment highlighting | `<!-- text -->` → "text" in span with `#6a9955` | Core token type |
| 8.2-UNIT-005 | Unit | P1 | CDATA highlighting | `<![CDATA[data]]>` → "data" in span with `#dcdcaa` | Core token type |
| 8.2-UNIT-006 | Unit | P1 | Declaration highlighting | `<?xml version="1.0"?>` → content in span with `#c586c0` | Core token type |
| 8.2-UNIT-007 | Unit | P1 | Entity highlighting | `&amp;` → entity in span with `#d7ba7d` | Core token type |
| 8.2-UNIT-008 | Unit | P2 | Bracket highlighting | `<root>` → `<` and `>` in spans with `#808080` | Secondary token |
| 8.2-UNIT-009 | Unit | P2 | Text content highlighting | `<a>text</a>` → "text" in span with `#d4d4d4` | Secondary token |

### AC2: VS Code Dark Theme Palette Matching

**Requirement:** Colors match defined palette in `colors` module

| ID | Level | Priority | Test Description | Expected Result | Justification |
|----|-------|----------|------------------|-----------------|---------------|
| 8.2-UNIT-010 | Unit | P2 | Color palette constants | All 9 color constants match AC1 hex values | Validates palette module |

### AC3: Graceful Degradation for Malformed XML

**Requirement:** Unclosed tags/comments/CDATA/attributes degrade gracefully with contextually correct colors

| ID | Level | Priority | Test Description | Expected Result | Justification | Mitigates |
|----|-------|----------|------------------|-----------------|---------------|-----------|
| 8.2-UNIT-011 | Unit | **P0** | Unclosed tag `<root` | Valid HTML; "root" in TAG color `#569cd6` | EOF flush must use correct color | TECH-002 |
| 8.2-UNIT-012 | Unit | **P0** | Unclosed comment `<!-- text` | Valid HTML; "text" in COMMENT color `#6a9955` | EOF flush handles Comment state | TECH-002 |
| 8.2-UNIT-013 | Unit | **P0** | Unclosed CDATA `<![CDATA[data` | Valid HTML; "data" in CDATA color `#dcdcaa` | EOF flush handles Cdata state | TECH-002 |
| 8.2-UNIT-014 | Unit | **P0** | Unclosed attribute `<a b="val` | Valid HTML; `"val` in ATTR_VALUE color `#ce9178` | EOF flush must use correct color | TECH-002 |
| 8.2-UNIT-015 | Unit | **P0** | Empty input `""` | Empty string returned | Edge case - no allocation | - |
| 8.2-UNIT-016 | Unit | **P0** | Control char after `<`: `<\x01` | Terminates without infinite loop; valid HTML | Defense-in-depth for TagOpen else | TECH-001 |
| 8.2-UNIT-017 | Unit | P1 | Null byte handling `<\x00` | Terminates without hang; valid HTML | Invalid XML char handling | TECH-001 |

### AC4: XSS Prevention - All 5 HTML Special Characters Escaped

**Requirement:** `<`, `>`, `&`, `"`, `'` all escaped in output

| ID | Level | Priority | Test Description | Expected Result | Justification | Mitigates |
|----|-------|----------|------------------|-----------------|---------------|-----------|
| 8.2-UNIT-018 | Unit | **P0** | Script tag escaping | `<script>alert(1)</script>` → `&lt;script&gt;` | Direct XSS payload | SEC-001 |
| 8.2-UNIT-019 | Unit | P1 | Attribute-context XSS | `<a onclick="x">` → onclick escaped | Event handler injection | SEC-001 |
| 8.2-UNIT-020 | Unit | **P0** | Single quote escaping | `<a b='val'>` → output contains `&#39;` | **CRITICAL**: Single quote missing in code | SEC-001 |
| 8.2-UNIT-021 | Unit | P1 | All 5 special chars | Input with `<>&"'` → all escaped | Complete XSS coverage | SEC-001 |

### AC5: Performance - 100KB in <100ms, >5MB Rejected

**Requirement:** Performance thresholds for large inputs

| ID | Level | Priority | Test Description | Expected Result | Justification | Mitigates |
|----|-------|----------|------------------|-----------------|---------------|-----------|
| 8.2-UNIT-022 | Unit | P2 | 100KB benchmark | 100KB XML highlighted in < 100ms | O(n) algorithm validation | PERF-001 |
| 8.2-UNIT-023 | Unit | P2 | 5MB+ input rejection | 6MB input → error message, no OOM | Memory guard validation | PERF-001 |

### AC6: State Machine Edge Cases

**Requirement:** Handle control chars, null bytes, incomplete sequences

| ID | Level | Priority | Test Description | Expected Result | Justification |
|----|-------|----------|------------------|-----------------|---------------|
| (Covered by 8.2-UNIT-016, 017) | - | - | Control chars, null bytes | See AC3 tests | Consolidated |

### AC7: WASM Build Succeeds with No New Warnings

**Requirement:** Clean WASM build

| ID | Level | Priority | Test Description | Expected Result | Justification |
|----|-------|----------|------------------|-----------------|---------------|
| 8.2-INT-001 | Integration | P1 | WASM build verification | `wasm-pack build --target web --release` succeeds | Toolchain integration |
| 8.2-INT-002 | Integration | P2 | No new compiler warnings | Build produces zero new warnings | Code quality |

### Cross-Cutting: Browser Validation

| ID | Level | Priority | Test Description | Expected Result | Justification |
|----|-------|----------|------------------|-----------------|---------------|
| 8.2-E2E-001 | E2E | P2 | Browser renders highlighted XML | Load output in browser, visual inspection | Real-world validation |
| 8.2-E2E-002 | E2E | P2 | Airgap tool integration | XML highlighting works in main app UI | User journey |

## Risk Coverage Matrix

| Risk ID | Severity | Test Coverage | Tests | Status |
|---------|----------|---------------|-------|--------|
| SEC-001 | **Critical** | Single quote XSS | 8.2-UNIT-018, 019, 020, 021 | **Full** |
| TECH-001 | High | Infinite loop on control char | 8.2-UNIT-016, 017 | **Full** |
| TECH-002 | Medium | Wrong EOF flush color | 8.2-UNIT-011, 012, 013, 014 | **Full** |
| PERF-001 | Low | Memory/OOM on large input | 8.2-UNIT-022, 023 | **Partial** |
| SEC-002 | Low | `push_colored` bypass | Code audit only | Audit |
| TECH-003 | Minimal | TagClose edge case | 8.2-UNIT-011 | **Partial** |

## Test Data Requirements

### Sample XML (Happy Path)

```xml
<!-- Complete token coverage -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root SYSTEM "root.dtd">
<root xmlns:ns="http://example.com" attr="value">
    <ns:child>Text content</ns:child>
    <!-- Comment text -->
    <![CDATA[<raw> data & content]]>
    &amp;&lt;&gt;&quot;
</root>
```

### Malformed XML (Graceful Degradation)

```
<root                    // Unclosed tag
<!-- comment             // Unclosed comment
<![CDATA[data            // Unclosed CDATA
<a b="value              // Unclosed attribute
<\x01                    // Control char after <
<\x00                    // Null byte after <
```

### XSS Payloads

```xml
<script>alert(1)</script>
<a onclick="javascript:alert(1)">
<a b='val'>              <!-- Single quote -->
<img src="x" onerror="alert(1)">
```

### Large XML Generator (Pseudocode)

```rust
fn generate_large_xml(size_kb: usize) -> String {
    let mut xml = String::new();
    xml.push_str("<?xml version=\"1.0\"?>\n<root>\n");
    while xml.len() < size_kb * 1024 {
        xml.push_str("  <item attr=\"value\">Content text here</item>\n");
    }
    xml.push_str("</root>");
    xml
}
```

## Environment Requirements

| Requirement | Purpose | Notes |
|-------------|---------|-------|
| Rust toolchain | Unit tests via `cargo test` | Stable channel |
| `wasm32-unknown-unknown` target | WASM build tests | `rustup target add` |
| `wasm-pack` | WASM packaging | Integration tests |
| `std::time::Instant` | Benchmark timing | P2 performance tests |
| Modern browser | E2E visual validation | Chrome/Firefox |

### Test Commands

```bash
# Run all XML highlighter tests
cargo test xml_highlighter -- --nocapture

# Run specific test
cargo test xml_highlighter::tests::test_highlight_empty

# Run with timing
cargo test xml_highlighter -- --nocapture --test-threads=1

# WASM build (integration)
wasm-pack build --target web --release
```

## Recommended Execution Order

1. **P0 Unit (8 tests)** — Fail fast on security/reliability
   - 8.2-UNIT-011 through 016 (graceful degradation)
   - 8.2-UNIT-018, 020 (XSS critical)

2. **P1 Unit (10 tests)** — Core token highlighting
   - 8.2-UNIT-001 through 007 (token types)
   - 8.2-UNIT-017, 019, 021 (edge cases, XSS)

3. **P1 Integration (1 test)** — WASM build
   - 8.2-INT-001

4. **P2 Unit (7 tests)** — Benchmarks, secondary tokens
   - 8.2-UNIT-008, 009, 010 (secondary tokens)
   - 8.2-UNIT-022, 023 (performance)

5. **P2 Integration + E2E (3 tests)** — Browser validation
   - 8.2-INT-002, 8.2-E2E-001, 002

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for pure logic)
- [x] No duplicate coverage across levels
- [x] Priorities align with risk (SEC-001, TECH-001/002 are P0)
- [x] Test IDs follow `{epic}.{story}-{LEVEL}-{SEQ}` convention
- [x] Scenarios are atomic and independent
- [x] Risk mitigations mapped to tests

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 27
  by_level:
    unit: 23
    integration: 2
    e2e: 2
  by_priority:
    p0: 8
    p1: 12
    p2: 7
  coverage_gaps: []
  risk_mitigation:
    sec_001: [8.2-UNIT-018, 8.2-UNIT-019, 8.2-UNIT-020, 8.2-UNIT-021]
    tech_001: [8.2-UNIT-016, 8.2-UNIT-017]
    tech_002: [8.2-UNIT-011, 8.2-UNIT-012, 8.2-UNIT-013, 8.2-UNIT-014]
    perf_001: [8.2-UNIT-022, 8.2-UNIT-023]
```

## Trace References

```
Test design matrix: docs/qa/assessments/8.2-test-design-v2-20260128.md
P0 tests identified: 8
P1 tests identified: 12
P2 tests identified: 7
```

---

**End of Test Design Document**
