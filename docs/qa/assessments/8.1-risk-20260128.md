# Risk Profile: Story 8.1 - Productionize XML Formatter

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 9
- Critical Risks: 0
- High Risks: 3
- Risk Score: 52/100 (moderate risk)

## High Risks Requiring Attention

### 1. TECH-001: Code duplication causes divergent behavior

**Score: 6 (High)**
**Probability**: High - The story explicitly identifies duplicated event handling between `format_xml()` (lines 42-116) and `minify_xml()` (lines 136-189). Currently `minify_xml` uses a catch-all `Ok(event)` arm while `format_xml` enumerates all events individually, meaning they already handle certain events differently.
**Impact**: Medium - Could result in one function preserving XML constructs (comments, PIs, DocType) while the other silently drops them.
**Mitigation**:
- Extract shared `write_event_to()` helper as specified in the story
- Add roundtrip tests that verify both paths preserve all XML construct types
- Diff test output between format and minify for construct preservation

**Testing Focus**: Roundtrip property tests; tests with comments, PIs, CDATA, DocType in both format and minify paths.

### 2. PERF-001: Deep nesting causes stack overflow or OOM in WASM

**Score: 6 (High)**
**Probability**: Medium - Story requires testing 100+ levels of nesting. WASM has a limited stack (typically 1MB default).
**Impact**: High - Could crash the WASM module, requiring page reload and losing user data in the editor.
**Mitigation**:
- Test with 100, 500, and 1000 levels of nesting
- Consider adding a configurable depth limit with a clear error
- Verify WASM stack size is sufficient

**Testing Focus**: Deep nesting stress tests; verify graceful failure rather than panic.

### 3. DATA-001: Mixed content whitespace trimming silently loses data

**Score: 6 (High)**
**Probability**: High - `trim_text_start` and `trim_text_end` are set to `true` on the reader (lines 35-36, 129-130). Any XML with significant whitespace in text nodes will have it silently removed.
**Impact**: Medium - Data loss for users with whitespace-sensitive XML (e.g., pre-formatted text, code blocks).
**Mitigation**:
- Document this as a known limitation clearly
- Add tests that demonstrate the trimming behavior
- Consider making trimming configurable in a future story

**Testing Focus**: Test whitespace-only text nodes, mixed content elements, significant whitespace scenarios.

## Risk Distribution

### By Category
- Technical: 3 risks (0 critical, 2 high)
- Performance: 2 risks (0 critical, 1 high)
- Security: 1 risk (0 critical)
- Data: 1 risk (0 critical, 1 high)
- Operational: 1 risk (0 critical)
- Business: 1 risk (0 critical)

### By Component
- xml_formatter.rs: 7 risks
- WASM build: 2 risks

## Detailed Risk Register

| Risk ID  | Description                                          | Prob    | Impact  | Score | Priority | Strategy   |
|----------|------------------------------------------------------|---------|---------|-------|----------|------------|
| TECH-001 | Code duplication divergent behavior                  | High(3) | Med(2)  | 6     | High     | Preventive |
| PERF-001 | Deep nesting stack overflow/OOM in WASM              | Med(2)  | High(3) | 6     | High     | Preventive |
| DATA-001 | Whitespace trimming silently loses data              | High(3) | Med(2)  | 6     | High     | Detective  |
| TECH-002 | Refactor breaks existing behavior                    | Med(2)  | Med(2)  | 4     | Medium   | Preventive |
| SEC-001  | XML entity expansion DoS (billion laughs)            | Low(1)  | High(3) | 3     | Low      | Preventive |
| PERF-002 | Large XML WASM memory exhaustion                     | Low(1)  | High(3) | 3     | Low      | Detective  |
| BUS-001  | Error positions always (0,0) provide no debug value  | High(3) | Low(1)  | 3     | Low      | Corrective |
| TECH-003 | Line/column off-by-one in position conversion        | Med(2)  | Low(1)  | 2     | Low      | Preventive |
| OPS-001  | WASM build regression                                | Low(1)  | Med(2)  | 2     | Low      | Detective  |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Roundtrip property tests (format -> minify -> format) with all XML construct types
- Deep nesting tests (100, 500, 1000 levels)
- Whitespace preservation/trimming behavior documentation tests
- Behavioral equivalence tests before/after refactor

### Priority 2: Medium Risk Tests
- Snapshot tests of current output to detect refactor regressions
- Malformed XML error message tests with position validation
- Edge cases: BOM, large attributes, multiple namespaces

### Priority 3: Low Risk Tests
- WASM build verification
- Entity expansion limits
- Large input memory behavior
- Off-by-one position tests

## Risk Acceptance Criteria

### Must Fix Before Production
- TECH-001: Eliminate code duplication (this is the story's primary goal)
- BUS-001: Error positions must include actual line/column (AC 3)

### Can Deploy with Mitigation
- DATA-001: Document whitespace trimming as known limitation
- PERF-001: Test and document nesting limits

### Accepted Risks
- SEC-001: quick-xml does not expand entities by default; risk is inherently mitigated by the library
- PERF-002: Client-side tool; user is limited by their own browser memory

## Monitoring Requirements

Not applicable - this is a client-side WASM module with no server-side telemetry (airgap constraint).

## Risk Review Triggers

- If `quick-xml` dependency is upgraded
- If WASM memory limits change
- If XML processing scope expands (e.g., DTD validation, schema validation)
