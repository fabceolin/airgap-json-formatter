# NFR Assessment: 8.1 - Productionize XML Formatter

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Assessment Mode:** YOLO (Non-interactive)

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | Client-side only, no XXE exposure, input validation present |
| Performance | CONCERNS | No input size limits, deep nesting stack risk, no defined targets |
| Reliability | CONCERNS | Error positions hardcoded (0,0), no graceful degradation for OOM |
| Maintainability | CONCERNS | ~70% code duplication, 9 happy-path tests, missing edge case coverage |

**Quality Score: 70/100** (100 - 10×3 CONCERNS = 70)

## Detailed Analysis

### Security: PASS

**Evidence Reviewed:**
- `src/xml_formatter.rs` lines 1-194

**Findings:**
1. **Client-side only architecture** - No network calls possible; aligns with airgap constraint
2. **No XXE vulnerability** - `quick-xml` doesn't expand external entities by default
3. **Input validation present** - Empty input check at lines 21-23 and 124-126
4. **No hardcoded secrets** - No credentials in code
5. **Memory safety** - Rust ownership model prevents buffer overflows

**Pass Criteria Met:**
- [x] No network access
- [x] Input validation present
- [x] No hardcoded credentials
- [x] Safe parsing library

### Performance: CONCERNS

**Evidence Reviewed:**
- `src/xml_formatter.rs` - Full file
- `docs/architecture.md` - Performance section (11.2)

**Findings:**
1. **No input size guard** - Functions accept arbitrary-length input strings
   - Risk: Large XML could exhaust WASM memory without warning
   - Location: `format_xml()` line 20, `minify_xml()` line 123

2. **Deep nesting stack risk** - Recursive event processing via quick-xml
   - Story requires: 100 levels must succeed, 500 levels graceful error
   - Current: Untested; may trap/panic at unknown depth
   - Location: Event loop at lines 41-116

3. **No performance targets defined** - Architecture mentions `<100ms for 1MB JSON` but no XML-specific targets

4. **Buffer allocation** - `Vec::new()` at lines 39, 133 starts small; may cause reallocations
   - Minor concern: Consider `Vec::with_capacity()` for known-size inputs

**Gaps:**
- No defined threshold for max input size
- No defined response time target
- No graceful handling of resource exhaustion

### Reliability: CONCERNS

**Evidence Reviewed:**
- `src/xml_formatter.rs` - Error handling paths
- `src/types.rs` - `FormatError` struct

**Findings:**
1. **Error positions always (0,0)** - All `FormatError::new()` calls use hardcoded zeros
   - Location: Lines 22, 45, 48, 53, 57, 61, 65, 68, 73, 78, 82, 88, 93, 98, 103, 108, 112, 119, 125, 139, 142, 147, 151, 155, 159, 163, 167, 172, 176, 183, 186, 193
   - Impact: AC3 cannot be satisfied; users get no error position info
   - Fix available: `reader.buffer_position()` exists but unused

2. **No OOM graceful degradation** - WASM memory exhaustion causes trap, not FormatError

3. **Error handling present** - All event types have explicit error paths with `map_err()`

4. **Catch-all in minify** - `Ok(event) =>` at line 180-184 handles CData/Comment/Decl/PI/DocType
   - Risk: Behavior may diverge from explicit handling in `format_xml()`

**Gaps:**
- AC3 structurally impossible with current code
- No circuit breaker for resource exhaustion
- No defined behavior for WASM traps

### Maintainability: CONCERNS

**Evidence Reviewed:**
- `src/xml_formatter.rs` - Full file structure
- Test suite at lines 196-271

**Findings:**
1. **~70% code duplication** - `format_xml()` (lines 20-120) and `minify_xml()` (lines 123-194) repeat event handling logic
   - `format_xml`: 10 explicit event handlers
   - `minify_xml`: 5 explicit + 1 catch-all
   - DRY violation noted in story (AC5)

2. **Limited test coverage**
   - 9 tests total, all happy-path
   - No malformed XML tests
   - No error position tests
   - No edge case tests (deep nesting, BOM, large attributes)

3. **Module documentation outdated** - Line 1 still says "Spike Investigation"

4. **Code structure**
   - Single file, ~270 lines - manageable
   - Clear function signatures
   - Proper use of Result types

**Test Coverage Analysis:**
| Category | Count | Coverage |
|----------|-------|----------|
| Happy path | 9 | Adequate |
| Error cases | 0 | **Missing** |
| Edge cases | 0 | **Missing** |
| Property tests | 0 | **Missing** |

## Critical Issues

1. **AC3 Cannot Pass** (Reliability)
   - All errors return position (0, 0)
   - `reader.buffer_position()` API available but unused
   - Fix: Implement `position_to_line_column()` helper per story Dev Notes

2. **No Resource Limits** (Performance)
   - Unbounded input size
   - Unknown stack depth tolerance
   - Fix: Add input size validation; test nesting limits

3. **Code Duplication** (Maintainability)
   - ~70 lines duplicated between format/minify
   - Catch-all divergence risk
   - Fix: Extract `write_event_to()` helper per story Task 2

## Quick Wins

1. **Wire error positions** - Use `reader.buffer_position()` in error paths
2. **Add input size check** - Return FormatError if input exceeds threshold (e.g., 10MB)
3. **Extract shared helper** - Deduplicate event handling into `write_event_to()`
4. **Update module docs** - Change "Spike Investigation" to production description

## Gate YAML Block

```yaml
# Gate NFR block - paste into docs/qa/gates/8.1-productionize-xml-formatter.yml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Client-side only, no XXE exposure, input validation present'
  performance:
    status: CONCERNS
    notes: 'No input size limits, deep nesting stack risk, no defined performance targets'
  reliability:
    status: CONCERNS
    notes: 'Error positions hardcoded (0,0) - AC3 cannot pass; no OOM graceful degradation'
  maintainability:
    status: CONCERNS
    notes: '~70% code duplication between format/minify; 9 happy-path tests only, missing error and edge case coverage'
```

## Recommendations

### Test Recommendations

1. **Error Position Tests (P0)**
   - Test unclosed tag returns non-zero line/column
   - Test mismatched tags returns accurate position
   - Test invalid attribute syntax error position

2. **Resource Boundary Tests (P1)**
   - Test input at 1MB, 5MB, 10MB
   - Define pass/fail behavior for each threshold
   - Test nesting at 100, 500, 1000 levels

3. **Equivalence Tests (P1)**
   - Pre/post refactor snapshot tests
   - Format/minify roundtrip property tests
   - Event handling parity tests (PI, DocType via minify catch-all)

### Acceptance Criteria Enhancements

Current ACs have these gaps:

| Gap | Recommendation |
|-----|----------------|
| No input size limit AC | Add: "Input over 10MB returns FormatError with descriptive message" |
| No resource exhaustion AC | Add: "Deep nesting at 500 levels either succeeds or returns graceful FormatError (no panic)" |
| No format/minify parity AC | Add: "Both functions preserve all XML construct types identically" |

---

**NFR assessment:** docs/qa/assessments/8.1-nfr-20260128.md

**Gate NFR block ready** → paste into docs/qa/gates/8.1-productionize-xml-formatter.yml under nfr_validation
