# Risk Profile: Story 9.3 - Share Button UI Integration

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Story:** 9.3 - Share Button UI Integration
**Risk Score:** 47/100 (MODERATE-HIGH)

## Executive Summary

- **Total Risks Identified:** 11
- **Critical Risks:** 0
- **High Risks:** 4
- **Medium Risks:** 5
- **Low Risks:** 2

This story integrates the share functionality (Stories 9.1/9.2) into the UI layer. While the cryptographic core is already implemented and tested, the UI integration introduces new risks around URL handling, clipboard operations, cross-browser compatibility, and user experience during passphrase entry.

## Risk Matrix (Sorted by Score)

| Risk ID   | Description                                           | Prob | Impact | Score | Priority |
|-----------|-------------------------------------------------------|------|--------|-------|----------|
| SEC-001   | URL fragment key leakage in quick share mode          | M(2) | H(3)   | 6     | High     |
| SEC-002   | Passphrase entry exposure in DOM/memory               | M(2) | H(3)   | 6     | High     |
| TECH-001  | Clipboard API cross-browser compatibility             | H(3) | M(2)   | 6     | High     |
| TECH-002  | URL length limits across browsers                     | M(2) | H(3)   | 6     | High     |
| SEC-003   | Browser history/referer leakage of share params       | M(2) | M(2)   | 4     | Medium   |
| OPS-001   | PBKDF2 blocking UI thread during passphrase mode      | M(2) | M(2)   | 4     | Medium   |
| UX-001    | Passphrase dialog confusing UX (when to use)          | M(2) | M(2)   | 4     | Medium   |
| TECH-003  | AsyncSerialiser contention during share operations    | L(1) | H(3)   | 3     | Low      |
| DATA-001  | Expired link UX - unclear error messaging             | M(2) | L(1)   | 2     | Low      |
| TECH-004  | ShareDialog.qml modal focus handling                  | L(1) | M(2)   | 2     | Low      |
| TECH-005  | PassphrasePrompt retry state management               | L(1) | M(2)   | 2     | Low      |

## Critical Risks Requiring Immediate Attention

None identified. All risks are High or below.

## High Priority Risks (Score 6)

### SEC-001: URL Fragment Key Leakage in Quick Share Mode

**Score: 6 (High)**
**Probability:** Medium (2) — Quick share is the default/most common mode
**Impact:** High (3) — Full JSON exposure if key is logged/shared

**Description:**
In quick share mode, the encryption key is placed in the URL fragment (`#key`). While fragments are not sent to servers, they can be:
- Logged by browser extensions
- Captured in screenshots/screen recordings
- Accidentally shared via chat when user copies full URL
- Stored in browser history (though typically cleared on navigation)

**Mitigation:**
- Tooltip clearly warns about URL security model (AC3)
- Passphrase mode provides alternative for higher security needs
- 5-minute expiration limits exposure window

**Testing Focus:**
- Verify tooltip text warns about link access (AC3)
- Verify fragment is not included in `?d=` query parameter
- Test that protected mode (`p=1`) has no key in URL

### SEC-002: Passphrase Entry Exposure in DOM/Memory

**Score: 6 (High)**
**Probability:** Medium (2) — Applies to all passphrase-protected shares
**Impact:** High (3) — Passphrase compromise enables decryption

**Description:**
The passphrase is entered in a QML TextField component (`ShareDialog.qml`, `PassphrasePrompt.qml`). Potential exposure vectors:
- TextField value accessible via DOM/DevTools
- JavaScript memory not cleared after use
- QML bindings may retain value references

**Mitigation:**
- Use `echoMode: TextInput.Password` to mask input visually
- Clear passphrase field on dialog close/cancel
- Passphrase is passed to WASM immediately; JS layer doesn't store it

**Testing Focus:**
- Verify password field uses masked input (`echoMode: TextInput.Password`)
- Verify field is cleared after share confirmation or cancel
- Manual security test: check DevTools cannot easily retrieve value

### TECH-001: Clipboard API Cross-Browser Compatibility

**Score: 6 (High)**
**Probability:** High (3) — Clipboard API has known quirks across browsers
**Impact:** Medium (2) — Share URL may not copy; user must manually copy

**Description:**
`navigator.clipboard.writeText()` requires:
- Secure context (HTTPS) — covered by GitHub Pages
- User gesture/focus — may fail if called asynchronously
- Permission may be needed in some browsers

Safari has historically had stricter clipboard restrictions.

**Mitigation:**
- Existing `copyToClipboard` in bridge.js handles basic errors (lines 177-185)
- Fallback: Display URL in dialog for manual copy if clipboard fails
- AC7 specifies "URL is copied to clipboard" — should have graceful degradation

**Testing Focus:**
- Cross-browser test (AC16): Chrome, Firefox, Safari, Edge
- Test clipboard write in all browsers
- Test with focus loss scenarios (rapid dialog interaction)

### TECH-002: URL Length Limits Across Browsers

**Score: 6 (High)**
**Probability:** Medium (2) — Large JSON payloads may exceed limits
**Impact:** High (3) — Share completely fails for valid JSON

**Description:**
Story specifies 6000-char payload limit (from 9.1), but full URL includes:
- Base URL (`https://...github.io/airgap-json-formatter/`)
- Query parameter prefix (`?d=`)
- URL encoding expansion (up to 3x for non-ASCII)
- Fragment with key (`#key` ~43 chars Base64)

Browser URL limits vary:
- Chrome/Firefox/Edge: ~2MB (URL bar, not all APIs)
- Safari: ~80KB
- IE11 (not supported): 2083 chars

Bridge.js checks `shareUrl.length > 8000` (line 284-287) but this may be insufficient for Safari in edge cases.

**Mitigation:**
- AC8 specifies "too large" error at ~50KB — payload limit is 6000 chars (~6KB)
- Bridge.js has 8000-char URL check (should be safe for ~50KB limit)
- Test with payloads near the limit in Safari

**Testing Focus:**
- Test large payload sharing in Safari specifically
- Verify error message shown for oversized JSON (AC8)
- Test URL encoding of Unicode JSON

## Medium Priority Risks (Score 4)

### SEC-003: Browser History/Referer Leakage

**Score: 4 (Medium)**
**Probability:** Medium (2) — Every share URL visits browser history
**Impact:** Medium (2) — Historical exposure of share data

**Description:**
- Share URLs with `?d=` parameter are stored in browser history
- If user navigates away and back, URL may be in autocomplete
- Referer header could leak `?d=` param to external sites if user clicks links

**Mitigation:**
- `clearShareParams()` uses `history.replaceState` to clean URL (AC per Dev Notes)
- 5-minute expiration limits replay value
- Fragment (`#key`) is not sent in Referer header

**Testing Focus:**
- Verify `clearShareParams()` is called after processing share (Task 6)
- Verify URL is cleaned from address bar after decode
- Test navigation back to check history state

### OPS-001: PBKDF2 Blocking UI Thread

**Score: 4 (Medium)**
**Probability:** Medium (2) — Every passphrase-protected share triggers PBKDF2
**Impact:** Medium (2) — UI freezes for 1-3 seconds on mid-range devices

**Description:**
PBKDF2 with 100K iterations runs synchronously in WASM. During both:
1. Share creation (passphrase mode)
2. Share decryption (protected link open)

UI will be unresponsive. This is inherited from Stories 9.1/9.2.

**Mitigation:**
- Task 5 specifies using AsyncSerialiser for WASM calls
- Consider adding loading indicator during share operation
- 100K iterations is security requirement; can't reduce

**Testing Focus:**
- Verify loading/busy state shown during share creation (AC per isBusy pattern in Toolbar.qml)
- Verify dialog remains responsive or shows progress
- Measure actual latency in browser DevTools

### UX-001: Passphrase Dialog Confusing UX

**Score: 4 (Medium)**
**Probability:** Medium (2) — First-time users may not understand options
**Impact:** Medium (2) — User chooses wrong mode or abandons share

**Description:**
ShareDialog offers optional passphrase. Users may:
- Not understand when to use passphrase vs. quick share
- Set weak passphrases
- Forget their passphrase (no recovery)

**Mitigation:**
- AC4 specifies "Brief security explanation text"
- Dev Notes include hint: "Leave empty for quick share, or set passphrase for two-factor security"
- Tooltip (AC3) explains security model

**Testing Focus:**
- Verify dialog text clearly explains both modes
- Verify passphrase placeholder text is helpful
- UX review: is the security trade-off clear?

## Low Priority Risks (Score 2-3)

### TECH-003: AsyncSerialiser Contention

**Score: 3 (Low)**
**Probability:** Low (1) — Share is typically a single operation
**Impact:** High (3) — Tasks could queue or timeout

**Description:**
If user rapidly clicks Share multiple times or share happens during other async operations, AsyncSerialiser queue could back up.

**Mitigation:**
- Existing busy state disables buttons during processing
- 30-second watchdog prevents hung tasks
- Queue limit of 100 tasks with rejection signal

**Testing Focus:**
- Verify Share button disabled during processing (AC per Task 4)
- Rapid-click test doesn't cause queue overflow

### DATA-001: Expired Link UX

**Score: 2 (Low)**
**Probability:** Medium (2) — Links expire after 5 minutes by design
**Impact:** Low (1) — Annoying but clear message shown

**Description:**
User opens expired link and sees error. May be confusing if they don't remember the expiration policy.

**Mitigation:**
- AC12 specifies clear message: "This share link has expired (links valid for 5 minutes)"
- Message explains the 5-minute window

**Testing Focus:**
- Verify expired message is shown (AC12)
- Verify message text is clear and actionable

### TECH-004: ShareDialog Modal Focus Handling

**Score: 2 (Low)**
**Probability:** Low (1) — Standard QML popup behavior
**Impact:** Medium (2) — Keyboard input may not work

**Description:**
Modal dialogs in QML require proper focus management. If focus isn't set to the passphrase field, user may need to click.

**Mitigation:**
- Standard QML Popup modal behavior handles focus
- TextField should auto-focus on dialog open

**Testing Focus:**
- Verify keyboard can navigate dialog without mouse
- Verify passphrase field has focus on open

### TECH-005: PassphrasePrompt Retry State Management

**Score: 2 (Low)**
**Probability:** Low (1) — Edge case: wrong passphrase entered
**Impact:** Medium (2) — User can't retry; must reload

**Description:**
AC13 specifies "retry option" for wrong passphrase. State management for retry attempts needs careful handling.

**Mitigation:**
- PassphrasePrompt shows error message area for "incorrect passphrase"
- User can re-enter and click Decrypt again

**Testing Focus:**
- Test wrong passphrase → error → correct passphrase → success
- Verify error message clears on new attempt

## Risk Distribution

### By Category

| Category     | Count | Critical | High | Medium | Low |
|--------------|-------|----------|------|--------|-----|
| Security     | 3     | 0        | 2    | 1      | 0   |
| Technical    | 5     | 0        | 2    | 0      | 3   |
| Operational  | 1     | 0        | 0    | 1      | 0   |
| UX           | 1     | 0        | 0    | 1      | 0   |
| Data         | 1     | 0        | 0    | 0      | 1   |

### By Component

| Component            | Risks | IDs                                |
|----------------------|-------|------------------------------------|
| bridge.js            | 4     | TECH-001, TECH-002, SEC-003, OPS-001 |
| ShareDialog.qml      | 3     | SEC-002, UX-001, TECH-004          |
| PassphrasePrompt.qml | 2     | SEC-002, TECH-005                  |
| Toolbar.qml          | 1     | TECH-003                           |
| URL handling         | 2     | SEC-001, SEC-003                   |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

| Test Scenario | Risk | AC | Type |
|---------------|------|-----|------|
| Quick share URL format verification | SEC-001 | AC5 | Unit |
| Protected share URL format (no key) | SEC-001 | AC6 | Unit |
| Clipboard write success in Chrome/Firefox/Safari/Edge | TECH-001 | AC16 | Integration |
| Large JSON share error handling | TECH-002 | AC8 | Integration |
| Passphrase field masked input | SEC-002 | AC4 | Manual |
| Passphrase cleared on dialog close | SEC-002 | AC4 | Unit |

### Priority 2: Medium Risk Tests

| Test Scenario | Risk | AC | Type |
|---------------|------|-----|------|
| URL params cleared after processing | SEC-003 | Task 6 | Integration |
| Share button disabled during processing | OPS-001 | AC2 | Unit |
| Dialog security explanation text | UX-001 | AC4 | Manual |
| Busy indicator during share operation | OPS-001 | AC7 | Integration |

### Priority 3: Low Risk Tests

| Test Scenario | Risk | AC | Type |
|---------------|------|-----|------|
| AsyncSerialiser queue behavior | TECH-003 | — | Unit |
| Expired link message display | DATA-001 | AC12 | Integration |
| Dialog keyboard navigation | TECH-004 | AC4 | Manual |
| Wrong passphrase retry flow | TECH-005 | AC13 | Integration |

## Risk Acceptance Criteria

### Must Fix Before Production

- All security risks (SEC-001, SEC-002, SEC-003) must have mitigations verified
- Clipboard functionality must work in all target browsers (AC16)
- URL length validation must handle edge cases

### Can Deploy with Mitigation

- OPS-001: PBKDF2 latency is by design; loading indicator sufficient
- UX-001: Dialog text explains modes; acceptable for MVP

### Accepted Risks

- TECH-003: AsyncSerialiser has existing safeguards; low probability
- DATA-001: Error message meets AC requirements; clear to users

## Monitoring Requirements

Post-deployment monitoring for:
- **Clipboard failures**: Log `copyToClipboard` failures to console for debugging
- **Share creation errors**: Track "too large" and other error occurrences
- **Expired link attempts**: Could indicate users sharing links after expiry

## Risk Review Triggers

Review and update risk profile when:
- URL format changes (affects SEC-001, TECH-002)
- New browser support added (affects TECH-001)
- Encryption parameters change (affects OPS-001)
- Passphrase UX complaints received (affects UX-001)

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 4
    medium: 5
    low: 2
  highest:
    id: SEC-001
    score: 6
    title: 'URL fragment key leakage in quick share mode'
  recommendations:
    must_fix:
      - 'Verify tooltip warns about link security (AC3)'
      - 'Cross-browser clipboard testing (AC16)'
      - 'URL length validation in Safari edge cases'
    monitor:
      - 'Track clipboard API failures'
      - 'Monitor share error rates'
```

## Conclusion

Story 9.3 has **MODERATE-HIGH** overall risk (47/100) with four High-priority risks focused on security and cross-browser compatibility. The cryptographic foundation from Stories 9.1/9.2 is solid, but the UI integration layer introduces typical web-app concerns around clipboard APIs, URL handling, and user experience.

**Gate Recommendation:** CONCERNS — All high risks have mitigations defined but require verification during implementation and testing.

---

**Risk profile:** docs/qa/assessments/9.3-risk-20260128.md
**Reviewed by:** Quinn (Test Architect) — 2026-01-28
