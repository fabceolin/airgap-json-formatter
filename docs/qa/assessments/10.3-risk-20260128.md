# Risk Profile: Story 10.3 - Bridge Layer Markdown Methods

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 2
- Risk Score: 68/100 (calculated)

Story 10.3 extends the existing bridge.js pattern to add Markdown and Mermaid rendering capabilities. The risk profile is **MODERATE** due to the async orchestration complexity and third-party library integration (mermaid.js). No critical security risks exist because the architecture maintains the zero-network constraint and client-side-only processing.

## Critical Risks Requiring Immediate Attention

*None identified - no critical (score 9) risks.*

## High Risks (Score 6)

### 1. TECH-001: Async Orchestration Race Conditions

**Score: 6 (High)**
**Probability**: Medium (2) - The AsyncSerialiser exists but Mermaid rendering involves nested async calls
**Impact**: High (3) - Could cause UI hangs, partial renders, or Asyncify stack corruption in WASM

**Description**: The `renderMarkdownWithMermaid()` method orchestrates multiple async operations:
1. Rust WASM call for Markdown â†’ HTML
2. Loop of async mermaid.render() calls for each diagram
3. HTML string manipulation between calls

The existing AsyncSerialiser prevents concurrent WASM suspensions but doesn't protect against race conditions within a single task that spawns multiple promises.

**Affected Components**:
- `bridge.js:renderMarkdownWithMermaid()`
- `AsyncSerialiser`
- `jsonbridge.cpp:requestRenderMarkdownWithMermaid()`

**Mitigation**:
- Ensure all Mermaid renders within a single task are awaited sequentially (current design does this)
- Add watchdog timeout handling for the combined operation
- Emit partial results if some diagrams fail rather than failing entire operation

**Testing Focus**:
- Test Markdown with 5+ Mermaid diagrams
- Test with mix of valid/invalid Mermaid blocks
- Test timeout behavior with slow-rendering diagrams

---

### 2. TECH-002: Mermaid.js Library Integration Stability

**Score: 6 (High)**
**Probability**: Medium (2) - Mermaid.js is well-maintained but has complex error modes
**Impact**: High (3) - Invalid diagrams could throw unhandled exceptions, crash WASM context

**Description**: Mermaid.js can throw various error types depending on diagram syntax errors, circular references, or rendering failures. The bridge must robustly handle all error paths without corrupting the Qt/WASM integration layer.

**Affected Components**:
- `bridge.js:renderMermaid()`
- `window.renderMermaid` (global mermaid helper)

**Mitigation**:
- Wrap all mermaid.render() calls in try/catch
- Validate Mermaid returns valid SVG before embedding
- Set mermaid securityLevel to 'strict' to prevent XSS
- Implement per-diagram error isolation

**Testing Focus**:
- Test all 8 diagram types (flowchart, sequence, class, state, ER, gantt, pie, mindmap)
- Test malformed diagram syntax variations
- Test diagram with circular references
- Test extremely large diagrams (>1000 nodes)

---

## Medium Risks (Score 4)

### 3. PERF-001: Large Document UI Blocking

**Score: 4 (Medium)**
**Probability**: Medium (2) - 500KB documents are a stated requirement (AC 7)
**Impact**: Medium (2) - UI freeze during processing is poor UX but not data loss

**Description**: Rendering a 500KB Markdown document with multiple Mermaid diagrams could block the main thread, causing UI unresponsiveness.

**Affected Components**:
- `bridge.js:renderMarkdownWithMermaid()`
- `JsonBridge.requestRenderMarkdownWithMermaid()`
- Qt UI thread

**Mitigation**:
- AsyncSerialiser already provides queue-based execution
- Consider chunked processing for large documents (future enhancement)
- Add progress indication for long operations

**Testing Focus**:
- Benchmark 500KB Markdown rendering time
- Test UI responsiveness during large document processing
- Verify watchdog timeout triggers appropriately

---

### 4. SEC-001: Mermaid SVG XSS Potential

**Score: 4 (Medium)**
**Probability**: Low (1) - Mermaid has securityLevel option
**Impact**: High (3) - XSS in rendered content could execute arbitrary code

**Description**: Mermaid diagrams can potentially include JavaScript or event handlers in SVG output if security settings are not properly configured.

**Affected Components**:
- `bridge.js:renderMermaid()`
- SVG embedding in HTML output

**Mitigation**:
- Configure mermaid with `securityLevel: 'strict'`
- Sanitize SVG output before embedding
- Wrap SVG in sandboxed container

**Testing Focus**:
- Test Mermaid diagrams with embedded script tags
- Test onclick/onload handlers in diagram definitions
- Verify strict security level is applied

---

### 5. DATA-001: HTML Entity Encoding/Decoding Errors

**Score: 4 (Medium)**
**Probability**: Medium (2) - Code blocks may contain special characters
**Impact**: Medium (2) - Garbled output or rendering failures

**Description**: The `decodeHtmlEntities()` helper uses textarea trick for decoding. Mermaid code blocks may contain characters that cause encoding issues when extracted from HTML.

**Affected Components**:
- `bridge.js:decodeHtmlEntities()`
- Mermaid code extraction regex

**Mitigation**:
- Test with unicode characters in diagrams
- Test with HTML entities in diagram text
- Consider more robust HTML entity handling

**Testing Focus**:
- Test Mermaid with unicode labels (arrows, emoji, CJK)
- Test Mermaid with HTML entities in node text
- Test nested code blocks and escaping

---

## Low Risks (Score 2-3)

### 6. OPS-001: Theme Parameter Inconsistency

**Score: 3 (Low)**
**Probability**: Medium (2) - Theme must propagate through multiple layers
**Impact**: Low (1) - Visual inconsistency, not functional failure

**Description**: The theme parameter ('dark'/'light') must be passed through renderMarkdownWithMermaid to mermaid.render. Mismatches could cause diagrams to render with wrong colors.

**Affected Components**:
- `bridge.js:renderMarkdownWithMermaid()`
- `JsonBridge.requestRenderMarkdownWithMermaid()`
- Mermaid theme configuration

**Mitigation**:
- Default to 'dark' theme (matches app default)
- Validate theme parameter at bridge entry

**Testing Focus**:
- Test dark theme diagrams
- Test light theme diagrams
- Test theme switching mid-session

---

### 7. TECH-003: Signal/Slot Connection Ordering

**Score: 2 (Low)**
**Probability**: Low (1) - Qt signal/slot is well-established pattern
**Impact**: Medium (2) - Missed signals could cause UI not updating

**Description**: New signals (markdownRendered, markdownRenderError) must be connected before render requests. QML connection timing could cause missed signals.

**Affected Components**:
- `jsonbridge.h` signals
- `Main.qml` connections

**Mitigation**:
- Connect signals in Component.onCompleted
- Document required connection order

**Testing Focus**:
- Test rapid successive render requests
- Test signal emission timing

---

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| TECH-001 | Async race conditions | Medium (2) | High (3) | 6 | High |
| TECH-002 | Mermaid library stability | Medium (2) | High (3) | 6 | High |
| PERF-001 | Large document UI blocking | Medium (2) | Medium (2) | 4 | Medium |
| SEC-001 | Mermaid SVG XSS | Low (1) | High (3) | 3 | Medium |
| DATA-001 | HTML entity encoding | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001 | Theme inconsistency | Medium (2) | Low (1) | 2 | Low |
| TECH-003 | Signal ordering | Low (1) | Medium (2) | 2 | Low |

## Risk Distribution

### By Category
- Technical (TECH): 3 risks (0 critical, 2 high)
- Security (SEC): 1 risk (0 critical)
- Performance (PERF): 1 risk (0 critical)
- Data (DATA): 1 risk (0 critical)
- Operational (OPS): 1 risk (0 critical)

### By Component
- JavaScript Bridge (bridge.js): 5 risks
- C++ Bridge (jsonbridge): 2 risks
- Mermaid Integration: 3 risks
- AsyncSerialiser: 1 risk

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
1. **Async Orchestration Tests**
   - Multiple concurrent render requests
   - Documents with 5+ Mermaid diagrams
   - Timeout behavior verification
   - Error recovery tests

2. **Mermaid Stability Tests**
   - All 8 diagram types
   - Invalid syntax variations
   - Edge case diagrams (empty, huge, circular)

### Priority 2: Medium Risk Tests
1. **Performance Tests**
   - 500KB document rendering
   - UI responsiveness measurement
   - Memory usage profiling

2. **Security Tests**
   - XSS payload in Mermaid diagrams
   - SVG sanitization verification

3. **Data Integrity Tests**
   - Unicode in diagrams
   - HTML entities in code blocks

### Priority 3: Low Risk Tests
1. Theme parameter tests
2. Signal/slot timing tests

## Risk Acceptance Criteria

### Must Fix Before Production
- All high risks (TECH-001, TECH-002) must have mitigations implemented
- SEC-001 mitigation (strict security level) must be verified

### Can Deploy with Mitigation
- PERF-001: Acceptable with watchdog timeout
- DATA-001: Acceptable with documented encoding limitations

### Accepted Risks
- OPS-001: Low impact, visual only
- TECH-003: Standard Qt pattern, low probability

## Monitoring Requirements

Post-deployment monitoring for:
- Console errors during Mermaid rendering
- Watchdog timeout occurrences
- Large document rendering failures

## Risk Review Triggers

Review and update risk profile when:
- Mermaid.js version is upgraded
- AsyncSerialiser implementation changes
- New diagram types are added
- Performance issues are reported

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 3
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: 'Async orchestration race conditions'
  recommendations:
    must_fix:
      - 'Ensure sequential await in renderMarkdownWithMermaid'
      - 'Configure mermaid securityLevel: strict'
    monitor:
      - 'Watchdog timeout occurrences'
      - 'Console errors during Mermaid rendering'
```

---

Risk profile: docs/qa/assessments/10.3-risk-20260128.md
