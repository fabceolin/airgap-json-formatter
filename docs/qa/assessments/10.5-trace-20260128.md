# Requirements Traceability Matrix

## Story: 10.5 - Markdown Preview Pane

**Date:** 2026-01-28
**Traced by:** Quinn (Test Architect)
**Story Status:** Draft (Pre-Implementation)
**Trace Type:** Plan-to-Test Mapping

---

## Coverage Summary

| Metric | Count | Percentage |
|--------|-------|------------|
| Total Requirements (ACs) | 9 | 100% |
| Fully Covered (Planned) | 6 | 67% |
| Partially Covered | 3 | 33% |
| Not Covered | 0 | 0% |
| Security Requirements | 3+ implicit | 100% planned |

**Note:** This is a pre-implementation trace. Coverage refers to planned test design, not executed tests.

---

## Requirement Mappings

### AC1: New "Preview" view mode added to OutputPane

**Coverage: FULL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-001 | Unit | OutputPane viewMode property exists | Inspecting enum values | "preview" is a valid value | Planned |
| 10.5-INT-001 | Integration | OutputPane with viewMode="code" | viewMode set to "preview" | Preview component loads instead of code component | Planned |
| 10.5-INT-002 | Integration | OutputPane with format="json" | viewMode set to "preview" | Preview mode does not activate (wrong format) | Planned |

**Traceability Notes:**
- Maps to Task 1: "Add Preview view mode to OutputPane"
- OutputPane.qml currently has no viewMode property (line 6-8 shows only `text` property)
- Implementation required before tests can execute

---

### AC2: View toggle includes Code | Tree | Preview (where applicable per format)

**Coverage: FULL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-INT-003 | Integration | Toolbar with format="markdown" | Toggle UI renders | "Preview" option visible | Planned |
| 10.5-INT-004 | Integration | Toolbar with format="json" | Toggle UI renders | "Tree" visible, "Preview" hidden | Planned |
| 10.5-E2E-001 | E2E | User viewing markdown in Code view | Clicking Preview toggle | View switches to Preview mode | Planned |
| 10.5-UNIT-002 | Unit | Format type input | Calculating available view modes | Correct mode list returned | Planned |

**Traceability Notes:**
- Maps to Task 1 subtask: "Update view toggle button/tabs to include Preview"
- Current Toolbar.qml has viewMode handling (found via grep) but no Preview option
- Conditional visibility based on format must be implemented

---

### AC3: Preview mode displays rendered HTML correctly

**Coverage: FULL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-INT-005 | Integration | Markdown with H1-H6 headings | Rendered in preview | Each heading has proper font size hierarchy | Planned |
| 10.5-INT-006 | Integration | Markdown with GFM table | Rendered in preview | Table has borders and cell alignment | Planned |
| 10.5-INT-007 | Integration | Markdown with fenced code block | Rendered in preview | Background styling and monospace font applied | Planned |
| 10.5-INT-008 | Integration | Markdown with external link | Rendered in preview | Link displayed with `pointer-events: none` CSS | Planned |
| 10.5-INT-009 | Integration | Markdown with Mermaid block | Rendered in preview | SVG diagram displays inline | Planned |
| 10.5-E2E-002 | E2E | Complex markdown (headings+table+code+mermaid) | Full render in preview | All elements render correctly together | Planned |

**Traceability Notes:**
- Maps to Task 2: "Implement HTML preview rendering"
- MarkdownPreview.qml component does not exist yet
- Depends on Story 10.3 (Bridge Layer) for HTML generation - dependency satisfied per story file

---

### AC4: Preview pane respects Theme.qml colors

**Coverage: FULL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-003 | Unit | Theme.darkMode = true | CSS template generation | Dark color values in CSS variables | Planned |
| 10.5-UNIT-004 | Unit | Theme.darkMode = false | CSS template generation | Light color values in CSS variables | Planned |
| 10.5-INT-010 | Integration | Preview pane in dark mode | User toggles to light mode | CSS variables update without page reload | Planned |
| 10.5-E2E-003 | E2E | User in dark mode preview | Toggling theme | All colors update immediately (bg, text, code) | Planned |

**Traceability Notes:**
- Maps to Task 3: "Apply theme styling"
- Theme.qml exists and has darkMode property
- CSS template with variables documented in Dev Notes (lines 183-285)

---

### AC5: Images show placeholder (no external fetch by default)

**Coverage: FULL (Planned) - Critical Security**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-005 | Unit | URL string starting with http/https | URL classification function | Returns "external" type | Planned |
| 10.5-INT-011 | Integration | Markdown with `![img](https://evil.com/img.png)` | Rendered in preview | Placeholder shown, original URL not fetched | Planned |
| 10.5-E2E-004 | E2E | Markdown with external images loaded in preview | Network traffic monitored | Zero HTTP requests to external domains | Planned |

**Traceability Notes:**
- Maps to Task 4: "Security hardening"
- Mitigates SEC-002 risk (External resource loading)
- CSS approach documented in Dev Notes (lines 273-284)
- Network monitoring required for E2E validation

---

### AC6: Code view shows syntax-highlighted raw HTML

**Coverage: PARTIAL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-006 | Unit | HTML string with tags | Tokenizer function | Returns token array with tag types | Planned |
| 10.5-INT-012 | Integration | Preview pane showing rendered content | User switches to Code view | Raw HTML source shown with syntax highlighting | Planned |

**Gaps Identified:**
- No test for very large HTML (500KB) in code view
- No test for copying from code view vs preview view distinction

**Traceability Notes:**
- Maps to Task 5: "Code view for HTML"
- May reuse existing JSON/XML highlighting infrastructure

---

### AC7: Copy button copies rendered HTML source

**Coverage: PARTIAL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-007 | Unit | Rendered HTML in memory | Copy function called | HTML markup string returned (not plain text) | Planned |
| 10.5-E2E-005 | E2E | User viewing preview with tables | Clicking copy, pasting in editor | Receives `<table>...</table>` markup | Planned |

**Gaps Identified:**
- No test for copy behavior during rendering (race condition)
- No visual feedback verification for copy action

**Traceability Notes:**
- Maps to Task 6: "Copy functionality"
- Current OutputPane.qml has `getPlainText()` method - needs HTML counterpart
- Mitigates DATA-001 risk (clarity about what's copied)

---

### AC8: Large documents scroll smoothly

**Coverage: PARTIAL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-UNIT-008 | Unit | 500KB markdown document | Memory allocation check | Does not exceed threshold | Planned |
| 10.5-E2E-006 | E2E | 500KB rendered document in preview | User scrolls through document | Frame rate maintains 60fps | Planned |

**Gaps Identified:**
- No test for documents larger than 500KB (graceful degradation)
- No test for scroll position preservation on theme change

**Traceability Notes:**
- Maps to Task 7: "Scrolling and performance"
- Mitigates PERF-001 risk

---

### AC9: Preview updates when content changes (debounced)

**Coverage: FULL (Planned)**

| Test ID | Level | Given | When | Then | Status |
|---------|-------|-------|------|------|--------|
| 10.5-E2E-007 | E2E | User typing in input pane | 300ms pause after typing | Preview updates once | Planned |
| 10.5-E2E-008 | E2E | User typing rapidly | Continuous input for 2 seconds | Preview updates only after final 300ms pause | Planned |

**Traceability Notes:**
- Maps to Task 7 subtask: "Debounce preview updates (300ms)"
- No race condition tests with format changes during debounce window

---

## Security Requirements (Implicit - SEC-001 Critical)

**Coverage: FULL (Planned) - 6 dedicated security tests**

The risk profile identified SEC-001 (XSS) as CRITICAL. The following tests were designed in response:

| Test ID | Level | Given | When | Then | Mitigates |
|---------|-------|-------|------|------|-----------|
| 10.5-SEC-001 | Integration | Markdown with `<script>alert('XSS')</script>` | Rendered in preview | Script tag removed from output | SEC-001 |
| 10.5-SEC-002 | Integration | HTML with `<img onerror="alert(1)">` | Rendered in preview | Event handler attribute stripped | SEC-001 |
| 10.5-SEC-003 | Integration | SVG with embedded script | Rendered in preview | Script inside SVG removed | SEC-001 |
| 10.5-SEC-004 | Integration | Link with `javascript:` URL | Rendered in preview | Link href neutralized | SEC-001 |
| 10.5-SEC-005 | Integration | HTML with `<iframe>`, `<object>`, `<embed>` | Rendered in preview | Dangerous tags completely removed | SEC-001 |
| 10.5-SEC-006 | E2E | OWASP XSS cheat sheet payloads | All rendered in preview | None execute JavaScript | SEC-001 |

**Note:** These are critical P0 tests. Story cannot be marked PASS without all 6 passing.

---

## Critical Gaps Summary

| Gap ID | Description | Severity | Recommendation |
|--------|-------------|----------|----------------|
| GAP-001 | No explicit AC for HTML sanitization | Critical | Add AC: "All HTML MUST be sanitized using DOMPurify before display" |
| GAP-002 | No performance target in ACs | High | Add AC: "Preview renders within 200ms for 500KB documents" |
| GAP-003 | No copy behavior during render test | Medium | Add test for copy button state during async render |
| GAP-004 | No graceful degradation test for >500KB | Low | Add test for user feedback on very large documents |
| GAP-005 | No CSP header validation test | Medium | Add integration test verifying Content-Security-Policy |

---

## Dependency Trace

| Story Dependency | Status | Impact on 10.5 |
|------------------|--------|----------------|
| 10.3 (Bridge Layer) | Assumed Complete | Provides `renderMarkdownWithMermaid()` for HTML generation |
| 10.2 (Mermaid JS) | Assumed Complete | Provides Mermaid rendering for SVG diagrams |
| 10.1 (Rust Markdown) | Assumed Complete | Provides core markdown rendering |

---

## Implementation Gap: No Tests Exist Yet

**Current Test File Status:**
- `MarkdownPreview.qml` - **Does not exist**
- `tst_markdown_preview.cpp` - **Does not exist**
- `tests/markdown_preview_tests.html` - **Does not exist**

Existing related tests:
- `qt/tests/tst_markdown_bridge.cpp` - Tests Story 10.3 bridge layer only
- `tests/markdown_bridge_tests.html` - Tests Story 10.3 web bridge only

**Required New Test Files:**
1. `qt/tests/tst_markdown_preview.cpp` - Unit and integration tests
2. `tests/markdown_preview_tests.html` - Browser-based E2E tests
3. `tests/data/basic.md` - Basic markdown test document
4. `tests/data/complex.md` - Complex markdown with all elements
5. `tests/data/large.md` - 500KB performance test document
6. `tests/data/malicious.md` - OWASP XSS payloads
7. `tests/data/external-refs.md` - External resource references

---

## Gate YAML Block

```yaml
trace:
  totals:
    requirements: 9
    full: 6
    partial: 3
    none: 0
  security_requirements:
    explicit: 0
    implicit_from_risk: 6
    coverage: full
  planning_ref: 'docs/qa/assessments/10.5-test-design-20260128.md'
  uncovered:
    - ac: 'AC6'
      reason: 'No large HTML code view test, no copy distinction test'
    - ac: 'AC7'
      reason: 'No race condition test, no visual feedback test'
    - ac: 'AC8'
      reason: 'No >500KB degradation test, no scroll position preservation test'
  critical_gaps:
    - 'No explicit sanitization AC despite SEC-001 critical risk'
    - 'No performance SLA in acceptance criteria'
  notes: 'See docs/qa/assessments/10.5-trace-20260128.md'
```

---

## Story Hook Line

```text
Trace matrix: docs/qa/assessments/10.5-trace-20260128.md
```

---

## Recommendations for Story Refinement

1. **Add Explicit Security AC:** Before implementation, add acceptance criterion: "All rendered HTML MUST be sanitized using DOMPurify or equivalent before display, with CSP headers applied"

2. **Add Performance SLA:** Add acceptance criterion: "Preview MUST render within 200ms for documents up to 500KB"

3. **Clarify Copy Behavior:** AC7 should specify whether copy includes the DOCTYPE wrapper from theme styling or just the body content

4. **Add Error Handling AC:** Add acceptance criterion: "Invalid or malformed markdown gracefully displays error message with fallback to raw text"

5. **Create Test Data Files:** Before implementation begins, create the 5 required test data files to enable test-first development
