# NFR Assessment: 9.2

Date: 2026-01-28
Reviewer: Quinn
Last Updated: 2026-01-28 (YOLO mode re-verification)

## Summary

- Security: PASS - AES-256-GCM with proper primitives; decompression bomb mitigation implemented (10MB limit)
- Performance: CONCERNS - PBKDF2 at 100K iterations may block WASM UI thread; no latency benchmark
- Reliability: PASS - All 39 tests pass; comprehensive error handling with typed variants
- Maintainability: PASS - Injectable clock via `#[cfg(test)]` mock; well-structured code; 39 tests covering all scenarios

## Quality Score

```
100 - 10 (performance CONCERNS) = 90
```

**Score: 90/100** (Updated from 70 post-fix)

## Implementation Verification

### Security ✓ PASS

| Check                    | Status | Evidence |
|--------------------------|--------|----------|
| Input validation         | ✓ PASS | Base64URL, length, version byte validated (lines 231-235, 305-339) |
| Encryption correctness   | ✓ PASS | AES-256-GCM with 32-byte key, 12-byte nonce (lines 237-253) |
| Secret management        | ✓ PASS | Keys never persisted; PBKDF2 with 100K iterations (line 16) |
| Side-channel resistance  | ✓ PASS | Relies on `aes-gcm` crate constant-time guarantees (documented assumption) |
| Decompression limits     | ✓ PASS | `MAX_DECOMPRESSED_SIZE = 10MB` (line 22); chunked reads with limit enforcement (lines 281-293) |
| Error oracle             | ⚠ Note | 5 distinct error codes; `wrong_passphrase` mapped in WASM layer when `is_passphrase=true`. Low risk given 5-minute TTL. |

### Performance ⚠ CONCERNS

| Check                | Status   | Evidence |
|----------------------|----------|----------|
| Response time target | CONCERNS | No explicit latency target defined for decode operation |
| PBKDF2 blocking      | CONCERNS | 100K iterations (line 16) synchronous in WASM may freeze UI |
| Payload size limits  | ✓ PASS   | `MAX_PAYLOAD_CHARS = 6000` (line 21); `MAX_DECOMPRESSED_SIZE = 10MB` (line 22) |
| Resource efficiency  | ✓ PASS   | Chunked read in 8KB buffers (line 282) prevents memory spikes |

### Reliability ✓ PASS

| Check               | Status | Evidence |
|---------------------|--------|----------|
| Error handling       | ✓ PASS | Typed `ShareError` with 9 variants and `error_code()` mapping (lines 42-91) |
| Graceful degradation | ✓ PASS | All failure paths return structured errors, no panics |
| Edge cases           | ✓ PASS | 39 tests covering boundary conditions (expiration 299s/300s/301s), truncation, tampering |
| Wire format handling | ✓ PASS | Bug FIXED: `decompress_raw()` returns `Vec<u8>` (lines 276-296); header extracted before UTF-8 conversion |

### Maintainability ✓ PASS

| Check            | Status | Evidence |
|------------------|--------|----------|
| Test coverage    | ✓ PASS | 39 tests in `src/share.rs` covering all 9 task scenarios |
| Code structure   | ✓ PASS | Clean separation: encoding (lines 127-225), decoding (lines 227-357), tests (lines 363-796) |
| Documentation    | ✓ PASS | Constants documented (lines 10-22); function purposes clear |
| Testability      | ✓ PASS | Injectable clock via `#[cfg(test)]` thread-local `MOCK_TIMESTAMP` (lines 102-125) |

## Critical Issues (Resolved)

1. ~~**Binary header extraction bug**~~ — **FIXED**
   - Was: `decompress_json()` called before `extract_header()`, causing UTF-8 validation failure
   - Fix: Added `decompress_raw()` (lines 276-296) returning `Vec<u8>`; `decode_share_payload()` now extracts header from raw bytes (lines 331-335)

2. ~~**No decompressed payload size limit**~~ — **FIXED**
   - `MAX_DECOMPRESSED_SIZE = 10MB` (line 22)
   - Chunked reads with limit enforcement (lines 281-293)

3. ~~**Timestamp testability**~~ — **FIXED**
   - `#[cfg(test)]` thread-local `MOCK_TIMESTAMP` (lines 118-120)
   - `set_mock_timestamp()` function for tests (lines 122-125)

## Open Concerns

1. **PBKDF2 may block main thread** (Performance)
   - Risk: Key derivation at 100K iterations is CPU-intensive; synchronous WASM execution will freeze UI
   - Recommendation: Future story should integrate with AsyncSerialiser for production use, or offload to Web Worker

2. **No latency benchmark** (Performance)
   - Recommendation: Add performance test asserting decode completes in <2s for 1MB payload in WASM

## Quick Wins

- ✓ ~~Add max decompressed payload size~~ — DONE (10MB limit)
- ✓ ~~Add injectable clock abstraction~~ — DONE (`#[cfg(test)]` mock)
- Add PBKDF2 latency benchmark (~1 hour)
- Consider collapsing `decryption_failed` and `wrong_passphrase` to reduce oracle surface (~30 min)

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'AES-256-GCM correct; 10MB decompression limit; timing relies on aes-gcm crate'
  performance:
    status: CONCERNS
    notes: 'PBKDF2 100K iterations may block WASM UI thread; no latency benchmark'
  reliability:
    status: PASS
    notes: 'Bug fixed; 39/39 tests pass; typed errors with structured responses'
  maintainability:
    status: PASS
    notes: 'Injectable clock; 39 comprehensive tests; clean code structure'
```

---

NFR assessment: docs/qa/assessments/9.2-nfr-20260128.md

Gate NFR block ready → paste into docs/qa/gates/9.2-rust-share-decoding-validation.yml under nfr_validation
