# Test Design: Story 10.3 - Bridge Layer Markdown Methods

Date: 2026-01-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 32
- **Unit tests:** 14 (44%)
- **Integration tests:** 12 (37%)
- **E2E tests:** 6 (19%)
- **Priority distribution:** P0: 10, P1: 14, P2: 6, P3: 2

## Test Strategy Rationale

Story 10.3 introduces JavaScript bridge methods that orchestrate Rust WASM (Markdown rendering) and client-side Mermaid.js (diagram rendering). The test strategy focuses on:

1. **Unit tests** for input validation, error message generation, and helper functions
2. **Integration tests** for WASM↔JS communication and AsyncSerialiser orchestration
3. **E2E tests** for critical user journeys involving QML→C++→JS→WASM chain

Key testing challenges:
- Async orchestration with potential race conditions
- Cross-layer communication (QML, C++, JS, WASM)
- Third-party library integration (mermaid.js)
- Security (XSS prevention in generated SVG)

## Test Scenarios by Acceptance Criteria

### AC1: renderMarkdown(input) method returns success/failure JSON

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-UNIT-001 | Unit | P0 | Valid Markdown input returns `{success: true, html: "..."}` | Pure function output validation | - |
| 10.3-UNIT-002 | Unit | P0 | Invalid input returns `{success: false, error: "..."}` | Error message format consistency | DATA-001 |
| 10.3-UNIT-003 | Unit | P1 | makeError helper produces valid JSON | Isolated helper validation | - |
| 10.3-UNIT-004 | Unit | P1 | makeSuccess helper produces valid JSON | Isolated helper validation | - |
| 10.3-INT-001 | Integration | P0 | renderMarkdown calls wasmModule.renderMarkdown correctly | WASM bridge contract | TECH-002 |

**Test Data:**
- Valid: `# Hello`, `**bold**`, `- list item`, `[link](url)`
- Invalid: WASM not initialized state

---

### AC2: renderMermaid(code) method returns success/failure JSON

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-UNIT-005 | Unit | P0 | Valid Mermaid code returns `{success: true, svg: "..."}` | Pure output validation | - |
| 10.3-UNIT-006 | Unit | P0 | Invalid Mermaid syntax returns `{success: false, error: "..."}` | Error handling | TECH-002 |
| 10.3-INT-002 | Integration | P0 | renderMermaid calls mermaid.render with correct parameters | Third-party integration | TECH-002 |
| 10.3-INT-003 | Integration | P1 | Mermaid library not loaded returns appropriate error | Graceful degradation | TECH-002 |

**Test Data:**
- Valid: `graph TD; A-->B`, `sequenceDiagram; A->>B: Hello`, `pie title Test; "A": 50; "B": 50`
- Invalid: `invalid syntax`, `graph ;;;`, empty string

---

### AC3: renderMarkdownWithMermaid(input) combined method

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-INT-004 | Integration | P0 | Markdown with single Mermaid block renders correctly | Core orchestration flow | TECH-001 |
| 10.3-INT-005 | Integration | P0 | Markdown with multiple Mermaid blocks (5+) renders all | Multi-diagram handling | TECH-001 |
| 10.3-INT-006 | Integration | P1 | Markdown without Mermaid returns HTML unchanged | No-op path | - |
| 10.3-INT-007 | Integration | P1 | Partial failure: some diagrams fail, others succeed | Error isolation | TECH-001 |
| 10.3-UNIT-007 | Unit | P1 | Mermaid regex matches `<pre><code class="language-mermaid">` | Pattern matching | DATA-001 |
| 10.3-UNIT-008 | Unit | P1 | decodeHtmlEntities correctly decodes `&lt;`, `&gt;`, `&amp;` | Entity handling | DATA-001 |

**Test Data:**
- Single diagram: `# Title\n\`\`\`mermaid\ngraph TD; A-->B\n\`\`\``
- Multiple diagrams: Document with 5+ Mermaid blocks of different types
- No diagrams: Plain Markdown document
- Mixed success: Valid + invalid Mermaid blocks in same document

---

### AC4: AsyncSerialiser integration

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-INT-008 | Integration | P0 | Render operation enqueued via AsyncSerialiser | Async safety | TECH-001 |
| 10.3-INT-009 | Integration | P1 | Concurrent render requests are serialized | Race condition prevention | TECH-001 |
| 10.3-INT-010 | Integration | P1 | Watchdog timeout triggers after 30 seconds | Hung task recovery | TECH-001 |
| 10.3-E2E-001 | E2E | P0 | Multiple rapid render requests don't cause WASM suspension error | Asyncify safety | TECH-001 |

---

### AC5: C++ JsonBridge signals

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-INT-011 | Integration | P1 | markdownRendered signal emitted on success | Signal contract | TECH-003 |
| 10.3-INT-012 | Integration | P1 | markdownRenderError signal emitted on failure | Signal contract | TECH-003 |
| 10.3-E2E-002 | E2E | P1 | QML receives markdownRendered signal with correct HTML | End-to-end signal flow | TECH-003 |

---

### AC6: Null/undefined input handling

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-UNIT-009 | Unit | P0 | null input returns `{success: true, html: ""}` | Defensive coding | DATA-001 |
| 10.3-UNIT-010 | Unit | P0 | undefined input returns `{success: true, html: ""}` | Defensive coding | DATA-001 |
| 10.3-UNIT-011 | Unit | P1 | Empty string input returns `{success: true, html: ""}` | Edge case | - |
| 10.3-UNIT-012 | Unit | P2 | Whitespace-only input returns `{success: true, html: ""}` | Edge case | - |

---

### AC7: Large documents (500KB) don't block UI

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-E2E-003 | E2E | P0 | 500KB Markdown renders without UI freeze | Performance validation | PERF-001 |
| 10.3-E2E-004 | E2E | P1 | 500KB Markdown with 5 diagrams completes in <2000ms | Performance threshold | PERF-001 |
| 10.3-UNIT-013 | Unit | P2 | Progress indication triggered for large operations | UX validation | PERF-001 |

**Test Data:**
- 500KB Markdown file with various formatting
- 500KB Markdown with 5 Mermaid diagrams
- 1MB Markdown (stress test, P3)

---

### AC8: Theme parameter (dark/light)

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-UNIT-014 | Unit | P1 | Theme parameter passed to mermaid.render | Parameter propagation | OPS-001 |
| 10.3-E2E-005 | E2E | P1 | Dark theme produces dark-styled SVG | Visual validation | OPS-001 |
| 10.3-E2E-006 | E2E | P2 | Light theme produces light-styled SVG | Visual validation | OPS-001 |

---

## Security Tests (XSS Prevention)

Per NFR Assessment recommendations:

| ID | Level | Priority | Test | Justification | Mitigates Risk |
|----|-------|----------|------|---------------|----------------|
| 10.3-SEC-001 | Integration | P0 | Mermaid SVG sanitizes `onclick` handlers | XSS prevention | SEC-001 |
| 10.3-SEC-002 | Integration | P0 | Mermaid SVG sanitizes `onerror` handlers | XSS prevention | SEC-001 |
| 10.3-SEC-003 | Integration | P0 | Mermaid blocks `javascript:` URIs | XSS prevention | SEC-001 |
| 10.3-SEC-004 | Integration | P1 | Mermaid operates with `securityLevel: 'strict'` | Config validation | SEC-001 |

**XSS Test Payloads:**
- `graph TD; A["<img onerror=alert(1)>"]-->B`
- `graph TD; click A "javascript:alert(1)"`
- `graph TD; A["<script>alert(1)</script>"]-->B`

---

## Risk Coverage Matrix

| Risk ID | Risk Title | Test Coverage |
|---------|------------|---------------|
| TECH-001 | Async orchestration race conditions | 10.3-INT-008, INT-009, INT-010, E2E-001 |
| TECH-002 | Mermaid.js integration stability | 10.3-INT-001, INT-002, INT-003, UNIT-006 |
| TECH-003 | Signal/slot connection ordering | 10.3-INT-011, INT-012, E2E-002 |
| PERF-001 | Large document UI blocking | 10.3-E2E-003, E2E-004, UNIT-013 |
| SEC-001 | Mermaid SVG XSS potential | 10.3-SEC-001, SEC-002, SEC-003, SEC-004 |
| DATA-001 | HTML entity encoding/decoding errors | 10.3-UNIT-007, UNIT-008, UNIT-009, UNIT-010 |
| OPS-001 | Theme parameter inconsistency | 10.3-UNIT-014, E2E-005, E2E-006 |

---

## Test Data Requirements

### Markdown Test Files

| File | Size | Contents | Purpose |
|------|------|----------|---------|
| basic.md | ~100 bytes | `# Hello\n**bold**` | Basic validation |
| single-mermaid.md | ~200 bytes | Markdown + 1 diagram | Single diagram flow |
| multi-mermaid.md | ~2KB | Markdown + 5 diagrams | Multi-diagram orchestration |
| large-plain.md | 500KB | Repeated paragraph text | Performance baseline |
| large-with-diagrams.md | 500KB | Large content + 5 diagrams | Performance with diagrams |
| xss-payloads.md | ~1KB | XSS test vectors | Security validation |

### Mermaid Diagram Types to Test

1. `graph TD` - Flowchart top-down
2. `graph LR` - Flowchart left-right
3. `sequenceDiagram` - Sequence diagram
4. `classDiagram` - Class diagram
5. `stateDiagram-v2` - State diagram
6. `erDiagram` - Entity relationship
7. `pie` - Pie chart
8. `gantt` - Gantt chart

---

## Test Environment Requirements

| Component | Requirement | Notes |
|-----------|-------------|-------|
| Browser | Chrome 90+, Firefox 88+, Safari 14+ | WebAssembly support required |
| WASM Module | Compiled with Asyncify | For async suspension support |
| mermaid.js | v10.x loaded | Per Story 10.2 |
| Qt WebEngine | 6.5+ | For QML integration tests |
| Test Framework | Jest (JS), QtTest (C++) | Language-appropriate |

### Browser Console Test Commands

```javascript
// Unit test: renderMarkdown
console.assert(JSON.parse(JsonBridge.renderMarkdown('# Test')).success === true);
console.assert(JSON.parse(JsonBridge.renderMarkdown(null)).html === '');

// Integration test: renderMermaid
await renderMermaid('graph TD; A-->B', 'dark').then(r => console.assert(r.success === true));

// E2E test: combined
const result = await JsonBridge.renderMarkdownWithMermaid('# Test\n```mermaid\ngraph TD; A-->B\n```', 'dark');
console.assert(JSON.parse(result).success === true);
console.assert(JSON.parse(result).html.includes('<svg'));
```

---

## Recommended Execution Order

1. **P0 Unit tests** (10.3-UNIT-001, 002, 005, 006, 009, 010) - Fail fast on basic functionality
2. **P0 Integration tests** (10.3-INT-001, 002, 004, 005, 008) - Validate component interactions
3. **P0 Security tests** (10.3-SEC-001, 002, 003) - Critical XSS validation
4. **P0 E2E tests** (10.3-E2E-001, 003) - End-to-end validation
5. **P1 tests** - Core journey completion
6. **P2+ tests** - As time permits

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 14
    integration: 12
    e2e: 6
  by_priority:
    p0: 10
    p1: 14
    p2: 6
    p3: 2
  coverage_gaps: []
  security_tests: 4
  risk_coverage:
    tech_001: 4
    tech_002: 4
    tech_003: 3
    perf_001: 3
    sec_001: 4
    data_001: 4
    ops_001: 3
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Security tests address XSS risks
- [x] Performance tests define thresholds

---

## Trace References

```
Test design matrix: docs/qa/assessments/10.3-test-design-20260128.md
P0 tests identified: 10
Security tests identified: 4
Risk mitigations covered: 7/7
```
