# Risk Profile: Story 8.2 - Productionize XML Highlighter

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified:** 7
- **Critical Risks:** 1
- **High Risks:** 1
- **Risk Score:** 59/100 (MODERATE-HIGH)

The XML highlighter PoC requires hardening before production use. The most critical risk is an XSS vulnerability (SEC-001) where single quotes are not escaped, allowing attribute-context injection. A secondary high-risk issue (TECH-001) involves potential infinite loop behavior on malformed input with control characters.

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| SEC-001 | Single quote not escaped in `push_colored_escaped()` (line 360) | High (3) | High (3) | 9 | Critical |
| TECH-001 | Missing index increment in `TagOpen` else branch (line 113-116) - defense-in-depth concern | Medium (2) | High (3) | 6 | High |
| TECH-002 | EOF buffer flush uses wrong color for 6 states (line 304 `_ =>` wildcard) | Medium (2) | Medium (2) | 4 | Medium |
| SEC-002 | `push_colored()` bypasses escaping; relies on caller correctness | Low (1) | High (3) | 3 | Low |
| PERF-001 | No input size guard — large inputs could cause OOM in WASM | Low (1) | High (3) | 3 | Low |
| PERF-002 | `matches_str()` re-allocates Vec<char> per call | Medium (2) | Low (1) | 2 | Low |
| TECH-003 | `TagClose` unexpected char transition to `InTag` may produce edge-case rendering | Low (1) | Low (1) | 1 | Minimal |

## Critical Risks Requiring Immediate Attention

### 1. SEC-001: Single Quote XSS Vulnerability

**Score: 9 (Critical)**

**Location:** `push_colored_escaped()` function, lines 350-364

**Analysis:**
The HTML escaping function escapes 4 of the 5 HTML special characters but omits single quote (`'`):
- ✅ `<` → `&lt;`
- ✅ `>` → `&gt;`
- ✅ `&` → `&amp;`
- ✅ `"` → `&quot;`
- ❌ `'` → NOT ESCAPED

**Impact:** An attacker could inject malicious JavaScript through XML content containing single-quoted attributes, leading to XSS when the highlighted output is rendered in a browser context that uses single quotes.

**Mitigation:**
- Add `'\'' => output.push_str("&#39;")` to the match block at line 360
- Add unit test verifying single quote escaping

**Testing Focus:**
- Input: `<a b='val'>` must produce `&#39;` in output
- Input: `<a onclick='alert(1)'>` must be fully escaped

---

### 2. TECH-001: Missing Index Increment (Defense-in-Depth)

**Score: 6 (High)**

**Location:** `State::TagOpen` else branch, lines 113-116

**Analysis:**
```rust
} else {
    push_colored(&mut output, "&lt;", colors::BRACKET);
    state = State::Text;
    // Note: i is NOT incremented
}
```

When encountering a `<` followed by an unrecognized character (control char, null byte), the code transitions to `State::Text` without incrementing `i`. Trace analysis shows this works correctly because `State::Text` then processes the character — however, this is poor defensive coding.

**Impact:** While not currently exploitable as an infinite loop, future modifications to `State::Text` could introduce a regression. Control characters after `<` are invalid XML and should be explicitly skipped.

**Mitigation:**
- Add `i += 1;` to the else branch for explicit character skipping
- Add regression test with input `<\x01` to verify termination

**Testing Focus:**
- Input: `<\x00`, `<\x01`, `<\t` must terminate and return valid HTML
- Fuzz testing with random byte sequences after `<`

## High-Risk Issues

### 3. TECH-002: Incorrect EOF Flush Colors

**Score: 4 (Medium)**

**Location:** EOF buffer flush, lines 297-307

**Analysis:**
The end-of-input buffer flush maps states to colors, but the `_ =>` wildcard catches `TagName`, `TagClose`, `AttrName`, `AttrValue`, `AttrEquals`, and `InTag`, mapping them all to `colors::TEXT`:

```rust
let color = match state {
    State::Text => colors::TEXT,
    State::Comment => colors::COMMENT,
    State::Cdata => colors::CDATA,
    State::Declaration | State::Doctype => colors::DECLARATION,
    _ => colors::TEXT,  // Incorrect for TagName, AttrValue, etc.
};
```

**Impact:** Truncated XML (unclosed tags, unclosed attributes) renders the remainder in incorrect text color instead of the contextually correct color.

**Mitigation:**
Replace `_ => colors::TEXT` with explicit mappings:
- `State::TagName | State::TagClose` → `colors::TAG`
- `State::AttrName` → `colors::ATTR_NAME`
- `State::AttrValue` → `colors::ATTR_VALUE`
- `State::AttrEquals | State::InTag | State::TagOpen` → `colors::BRACKET`

**Testing Focus:**
- Unclosed tag: `<root` should highlight "root" in TAG color
- Unclosed attr: `<a b="val` should highlight "val" in ATTR_VALUE color

## Lower-Risk Issues

### 4. SEC-002: `push_colored()` Bypass Risk

**Score: 3 (Low)**

The `push_colored()` function (lines 367-373) passes text directly to output without escaping. This is safe only if callers pass static strings. Current usage is correct, but this invariant should be documented.

**Mitigation:** Add code comment documenting that this function must only be called with static/known-safe content.

### 5. PERF-001: No Input Size Guard

**Score: 3 (Low)**

There is no maximum input size check. A 10MB XML input would allocate ~30MB+ via `String::with_capacity(input.len() * 3)`, potentially causing OOM in WASM's limited memory.

**Mitigation:** Add input size guard before the allocation (before line 42):
```rust
const MAX_INPUT_SIZE: usize = 5 * 1024 * 1024;
if input.len() > MAX_INPUT_SIZE {
    return "<pre style=\"color:#f44336\">Error: Input exceeds 5MB limit</pre>".to_string();
}
```

### 6. PERF-002: Redundant Allocation in `matches_str()`

**Score: 2 (Low)**

The `matches_str()` function creates a new `Vec<char>` from the pattern on every call. With many pattern checks per character, this adds allocation overhead.

**Mitigation:** Accept pattern as `&[char]` or iterate directly over string bytes. Low priority — unlikely to be noticeable under 100KB.

### 7. TECH-003: `TagClose` Edge Case

**Score: 1 (Minimal)**

In `State::TagClose` (lines 156-160), unexpected characters cause a transition to `InTag` which may produce odd rendering for heavily malformed closing tags like `</tag@attr>`.

**Mitigation:** None required — behavior is reasonable for invalid XML.

## Risk Distribution

### By Category
- **Security:** 2 risks (1 critical)
- **Technical:** 3 risks (1 high, 1 medium, 1 minimal)
- **Performance:** 2 risks (2 low)
- **Data:** 0 risks
- **Business:** 0 risks
- **Operational:** 0 risks

### By Component
- **State Machine Logic:** 4 risks (TECH-001, TECH-002, TECH-003, PERF-002)
- **Output/Escaping:** 2 risks (SEC-001, SEC-002)
- **Input Handling:** 1 risk (PERF-001)

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (P0 — Must fix before merge)
| Test | Risk | Input | Expected |
|------|------|-------|----------|
| Single quote escape | SEC-001 | `<a b='val'>` | Output contains `&#39;` |
| Control char termination | TECH-001 | `<\x01` | Terminates, returns valid HTML |
| Null byte termination | TECH-001 | `<\x00` | Terminates, returns valid HTML |

### Priority 2: High Risk Tests (P1 — Should have)
| Test | Risk | Input | Expected |
|------|------|-------|----------|
| Unclosed tag EOF color | TECH-002 | `<root` | "root" in TAG color (`#569cd6`) |
| Unclosed attr EOF color | TECH-002 | `<a b="val` | "val" in ATTR_VALUE color (`#ce9178`) |
| Unclosed comment EOF | TECH-002 | `<!-- comment` | "comment" in COMMENT color (`#6a9955`) |
| Unclosed CDATA EOF | TECH-002 | `<![CDATA[data` | "data" in CDATA color (`#dcdcaa`) |
| XSS attribute context | SEC-001 | `<a onclick='x'>` | Fully escaped output |

### Priority 3: Medium/Low Risk Tests (P2 — Nice to have)
| Test | Risk | Input | Expected |
|------|------|-------|----------|
| Large input rejection | PERF-001 | >5MB XML | Error message returned |
| 100KB performance | PERF-002 | 100KB generated XML | < 100ms completion |
| All 5 special chars | SEC-001 | All chars in one doc | All properly escaped |

## Risk Acceptance Criteria

### Must Fix Before Production
- **SEC-001 (Critical):** Single quote escaping — XSS vector
- **TECH-001 (High):** Index increment — defense-in-depth

### Can Deploy with Mitigation
- **TECH-002 (Medium):** Incorrect EOF colors — affects display, not security
- **PERF-001 (Low):** Input size guard — add monitoring for large inputs

### Accepted Risks
- **SEC-002 (Low):** `push_colored()` bypass — documented invariant is sufficient
- **PERF-002 (Low):** Allocation overhead — negligible for typical inputs
- **TECH-003 (Minimal):** TagClose edge case — reasonable degradation for invalid XML

## Monitoring Requirements

Post-deployment monitoring for:
- **Security:** Alert on any unescaped HTML special characters in output (regex audit)
- **Performance:** Log processing time for inputs > 10KB; alert if > 500ms
- **Reliability:** Log any instances where highlighting returns error/empty for non-empty input

## Integration with Quality Gates

**Deterministic gate mapping based on risk scores:**
- Score 9 present (SEC-001) → **Gate = FAIL** unless explicitly waived
- Score 6 present (TECH-001) → **Gate = CONCERNS**
- Current assessment: **CONCERNS** (SEC-001 has straightforward fix)

**Recommendation:** Fix SEC-001 and TECH-001 before requesting gate review. These are P0 fixes in Task 1 of the story.

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 1
    high: 1
    medium: 1
    low: 4
  highest:
    id: SEC-001
    score: 9
    title: 'Single quote not escaped - XSS vulnerability'
  recommendations:
    must_fix:
      - 'SEC-001: Add single quote escaping to push_colored_escaped()'
      - 'TECH-001: Add i += 1 to TagOpen else branch for defense-in-depth'
    monitor:
      - 'Log processing time for inputs > 10KB'
      - 'Alert on highlighting failures for non-empty input'
```

---

Risk profile: docs/qa/assessments/8.2-risk-20260128.md
