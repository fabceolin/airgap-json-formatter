# Test Design: Story 8.3 - Bridge Layer XML Methods

Date: 2026-01-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 8 (29%)
- Integration tests: 14 (50%)
- E2E tests: 6 (21%)
- Priority distribution: P0: 6, P1: 14, P2: 8

## Analysis Summary

Story 8.3 adds XML formatting, minifying, and highlighting methods to the Qt JsonBridge, following the exact same patterns as existing JSON methods. The implementation involves:

1. Header declarations (`jsonbridge.h`)
2. Implementation code (`jsonbridge.cpp`)
3. AsyncSerialiser integration for async operations
4. Signal emission for completion/error handling
5. Dual-target compilation (native Qt + WASM)

### Risk-Based Focus Areas

Based on the risk profile (TECH-001, TECH-002), primary testing focus is on:
- AsyncSerialiser integration consistency
- Native/WASM parity
- Regression prevention for existing JSON methods

---

## Test Scenarios by Acceptance Criteria

### AC1: `formatXml(input, indentType)` method added to JsonBridge

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-UNIT-001 | Unit | P0 | Verify `formatXml` method exists in JsonBridge class | Method declaration verification |
| 8.3-UNIT-002 | Unit | P1 | Verify `formatXml` accepts QString input and indentType parameters | Parameter signature validation |
| 8.3-INT-001 | Integration | P0 | Call `formatXml("<root/>", "2spaces")` and verify formatted XML in signal | End-to-end formatting flow |
| 8.3-INT-002 | Integration | P1 | Call `formatXml("<root/>", "tabs")` and verify tab indentation | Indent type handling |
| 8.3-INT-003 | Integration | P1 | Call `formatXml("<invalid", "2spaces")` and verify error in signal | Error path validation |
| 8.3-INT-004 | Integration | P2 | Call `formatXml("", "2spaces")` with empty input | Empty input boundary |

**Test Data:**
```xml
<!-- Valid XML test cases -->
<root/>
<root><child>text</child></root>
<root attr="value"><child/></root>

<!-- Invalid XML test cases -->
<root
<root><unclosed>
<root attr="no-close
```

---

### AC2: `minifyXml(input)` method added to JsonBridge

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-UNIT-003 | Unit | P0 | Verify `minifyXml` method exists in JsonBridge class | Method declaration verification |
| 8.3-INT-005 | Integration | P0 | Call `minifyXml("<root>\n  <child/>\n</root>")` and verify minified result | Core minification flow |
| 8.3-INT-006 | Integration | P1 | Call `minifyXml("<root/>")` already minified input | Idempotent behavior |
| 8.3-INT-007 | Integration | P1 | Call `minifyXml("<invalid")` and verify error signal | Error path validation |
| 8.3-INT-008 | Integration | P2 | Call `minifyXml("")` with empty input | Empty input boundary |

**Test Data:**
```xml
<!-- Input with whitespace -->
<root>
  <child>
    text
  </child>
</root>

<!-- Expected minified output -->
<root><child>text</child></root>
```

---

### AC3: `highlightXml(input)` synchronous method added to JsonBridge

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-UNIT-004 | Unit | P0 | Verify `highlightXml` method exists and returns QString | Method signature verification |
| 8.3-UNIT-005 | Unit | P1 | Verify `highlightXml` is synchronous (no signal emission) | Synchronous behavior contract |
| 8.3-INT-009 | Integration | P1 | Call `highlightXml("<root/>")` and verify HTML with color spans | Core highlighting flow |
| 8.3-INT-010 | Integration | P1 | Call `highlightXml("<root attr=\"value\"/>")` and verify attribute highlighting | Attribute syntax highlighting |
| 8.3-INT-011 | Integration | P2 | Call `highlightXml("")` with empty input | Empty input boundary |
| 8.3-INT-012 | Integration | P2 | Call `highlightXml("<script>alert('xss')</script>")` verify HTML escaping | Security: XSS prevention |

**Expected Output Pattern:**
```html
<pre style="..."><span style="color:#...;">&lt;root</span>...
```

---

### AC4: Async methods emit completion signals with result/error

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-INT-013 | Integration | P0 | Connect to `formatXmlCompleted` signal, call `formatXml`, verify signal emitted | Signal emission verification |
| 8.3-INT-014 | Integration | P1 | Verify `formatXmlCompleted` result contains `{success: true, result: "..."}` on success | Success payload structure |
| 8.3-INT-015 | Integration | P1 | Verify `formatXmlCompleted` result contains `{success: false, error: "..."}` on error | Error payload structure |
| 8.3-UNIT-006 | Unit | P1 | Connect to `minifyXmlCompleted` signal, call `minifyXml`, verify signal emitted | Signal emission verification |

**Signal Verification Pattern:**
```cpp
QSignalSpy spy(&bridge, &JsonBridge::formatXmlCompleted);
bridge.formatXml("<root/>", "2spaces");
QVERIFY(spy.wait(5000));
QVariantMap result = spy.at(0).at(0).toMap();
QVERIFY(result["success"].toBool());
```

---

### AC5: All XML methods integrate with AsyncSerialiser pattern

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-INT-016 | Integration | P1 | Call `formatXml` while another async op is running, verify queued execution | AsyncSerialiser queue behavior |
| 8.3-INT-017 | Integration | P1 | Verify `isBusy()` returns true during `formatXml` execution | Busy state integration |
| 8.3-INT-018 | Integration | P2 | Mix JSON and XML operations, verify correct completion order | Queue ordering verification |
| 8.3-UNIT-007 | Unit | P2 | Verify `formatXml` calls `AsyncSerialiser::enqueue` (via mock/spy) | Pattern adherence verification |

**Queue Test Pattern:**
```cpp
bridge.formatJson("{}", "2spaces");  // First in queue
bridge.formatXml("<root/>", "2spaces");  // Second in queue
// Verify formatCompleted fires before formatXmlCompleted
```

---

### AC6: Existing JSON methods continue to work unchanged

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-E2E-001 | E2E | P0 | Run full JSON format/minify/validate/highlight suite after XML methods added | Regression prevention |
| 8.3-E2E-002 | E2E | P1 | Verify `formatJson` still emits `formatCompleted` (not `formatXmlCompleted`) | Signal isolation |
| 8.3-E2E-003 | E2E | P1 | Verify `highlightJson` returns JSON-appropriate colors, not XML colors | Output isolation |
| 8.3-UNIT-008 | Unit | P1 | Verify no changes to existing JSON method signatures | API stability |

**Regression Test Matrix:**
| Method | Test Input | Expected Output |
|--------|-----------|-----------------|
| `formatJson` | `{"a":1}` | Indented JSON |
| `minifyJson` | `{ "a" : 1 }` | `{"a":1}` |
| `validateJson` | `{"a":1}` | `{isValid: true, stats: {...}}` |
| `highlightJson` | `{"a":1}` | HTML with JSON syntax colors |
| `loadTreeModel` | `{"a":1}` | Returns true |

---

### AC7: Bridge compiles for both native and WASM targets

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-E2E-004 | E2E | P0 | Run `cmake .. && make` for native build, verify success | Build verification |
| 8.3-E2E-005 | E2E | P0 | Run `emcmake cmake .. && make` for WASM build, verify success | WASM build verification |
| 8.3-E2E-006 | E2E | P1 | Execute XML methods in both native and WASM builds, compare results | Parity verification |

**Build Commands:**
```bash
# Native build
cd qt && mkdir -p build && cd build
cmake .. && make
./tests/tst_jsonbridge_xml

# WASM build
emcmake cmake .. && make
# Deploy to browser test harness
```

---

## Risk Coverage

| Risk ID | Risk | Mitigating Tests |
|---------|------|------------------|
| TECH-001 | AsyncSerialiser integration inconsistency | 8.3-INT-016, 8.3-INT-017, 8.3-INT-018, 8.3-UNIT-007 |
| TECH-002 | Native/WASM parity differences | 8.3-E2E-004, 8.3-E2E-005, 8.3-E2E-006 |
| OPS-001 | Regression impact on existing JSON methods | 8.3-E2E-001, 8.3-E2E-002, 8.3-E2E-003, 8.3-UNIT-008 |
| TECH-003 | Signal connection timing issues | 8.3-INT-013, 8.3-INT-014, 8.3-INT-015, 8.3-UNIT-006 |
| DATA-001 | Large XML input handling | (See boundary tests below) |

### Additional Boundary Tests for DATA-001

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.3-INT-019 | Integration | P2 | Format 100KB XML document, verify completion within reasonable time | Performance boundary |
| 8.3-INT-020 | Integration | P2 | Highlight 50KB XML document, verify no UI freeze | Synchronous operation risk |

---

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on signature issues)
   - 8.3-UNIT-001, 8.3-UNIT-003, 8.3-UNIT-004
2. **P0 Integration tests** (core functionality)
   - 8.3-INT-001, 8.3-INT-005, 8.3-INT-013
3. **P0 E2E tests** (build verification, regression)
   - 8.3-E2E-001, 8.3-E2E-004, 8.3-E2E-005
4. **P1 tests in order** (extended coverage)
5. **P2 tests as time permits** (boundary cases)

---

## Test Environment Requirements

### Native Qt Build
- Qt 6.x development environment
- C++17 compiler (GCC 10+ or Clang 12+)
- CMake 3.16+
- QTest framework

### WASM Build
- Emscripten SDK 3.x
- Qt 6 WASM kit
- Chrome/Firefox for browser testing
- Local HTTP server (e.g., `python -m http.server`)

### Test Data Files
Location: `qt/tests/testdata/`
```
xml_valid_simple.xml
xml_valid_nested.xml
xml_valid_with_attrs.xml
xml_invalid_unclosed.xml
xml_invalid_malformed.xml
xml_large_100kb.xml
```

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 28
  by_level:
    unit: 8
    integration: 14
    e2e: 6
  by_priority:
    p0: 6
    p1: 14
    p2: 8
  coverage_gaps: []
  risk_coverage:
    TECH-001: [8.3-INT-016, 8.3-INT-017, 8.3-INT-018, 8.3-UNIT-007]
    TECH-002: [8.3-E2E-004, 8.3-E2E-005, 8.3-E2E-006]
    OPS-001: [8.3-E2E-001, 8.3-E2E-002, 8.3-E2E-003, 8.3-UNIT-008]
    TECH-003: [8.3-INT-013, 8.3-INT-014, 8.3-INT-015, 8.3-UNIT-006]
    DATA-001: [8.3-INT-019, 8.3-INT-020]
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk mitigations addressed
- [x] Regression tests included for AC6

---

## Trace References

Test design matrix: `docs/qa/assessments/8.3-test-design-20260128.md`
P0 tests identified: 6
