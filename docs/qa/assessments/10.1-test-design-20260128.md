# Test Design: Story 10.1 - Rust Markdown Renderer

Date: 2026-01-28 (v2 — updated for AC13)
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 30
- Unit tests: 19 (63%)
- Integration tests: 8 (27%)
- E2E tests: 3 (10%)
- Priority distribution: P0: 10, P1: 12, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: comrak dependency added with WASM-compatible features

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-INT-001 | Integration | P0 | WASM compilation succeeds with comrak (no syntect) | Build-gate: if this fails nothing else matters |
| 10.1-INT-002 | Integration | P0 | Bundle size increase < 200KB after adding comrak | AC9 hard constraint; must validate in CI |

### AC2: render_markdown function implemented

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-001 | Unit | P0 | `render_markdown("")` returns `Ok("")` | Empty input edge case; pure logic |
| 10.1-UNIT-002 | Unit | P1 | `render_markdown` returns `Ok(String)` for valid input | Happy path; pure function |
| 10.1-UNIT-003 | Unit | P2 | `RenderError` contains meaningful message field | Error type contract |

### AC3: Standard Markdown renders correctly

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-004 | Unit | P1 | `# Heading` → `<h1>Heading</h1>` (h1-h6) | Pure transformation |
| 10.1-UNIT-005 | Unit | P1 | `**bold**` → `<strong>bold</strong>` | Pure transformation |
| 10.1-UNIT-006 | Unit | P1 | `*italic*` → `<em>italic</em>` | Pure transformation |
| 10.1-UNIT-007 | Unit | P1 | Ordered and unordered lists render `<ol>/<ul>/<li>` | Pure transformation |
| 10.1-UNIT-008 | Unit | P2 | Blockquotes render `<blockquote>` | Pure transformation |
| 10.1-UNIT-009 | Unit | P2 | Horizontal rules render `<hr>` | Pure transformation |
| 10.1-UNIT-010 | Unit | P1 | `[link](url)` → `<a href="url">link</a>` | Pure transformation |
| 10.1-UNIT-011 | Unit | P2 | `![alt](src)` → `<img src="src" alt="alt">` | Pure transformation |
| 10.1-UNIT-012 | Unit | P1 | Inline code and fenced code blocks render correctly | Pure transformation |

### AC4: GFM extensions render correctly

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-013 | Unit | P1 | GFM table with column alignment renders `<table>` with `align` attrs | Pure transformation, GFM-specific |
| 10.1-UNIT-014 | Unit | P1 | `- [ ] task` renders `<input type="checkbox">` | GFM extension |
| 10.1-UNIT-015 | Unit | P1 | `~~strike~~` → `<del>strike</del>` | GFM extension |
| 10.1-UNIT-016 | Unit | P2 | Autolinks: bare URL renders as `<a>` | GFM extension |

### AC5: Fenced code blocks include language class

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-017 | Unit | P1 | ` ```js ` block → `<code class="language-js">` | Pure output check |

### AC6: Mermaid blocks output correctly

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-018 | Unit | P1 | ` ```mermaid ` block → `<pre><code class="language-mermaid">` | Contract for Story 10.2 |

### AC7: WASM bindings expose renderMarkdown to JavaScript

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-INT-003 | Integration | P0 | `renderMarkdown` callable from JS after WASM init | Cross-boundary; requires WASM runtime |
| 10.1-INT-004 | Integration | P1 | `renderMarkdown` error returns safe HTML (no XSS) | Security: error path crosses WASM→JS boundary |

### AC8: Unit tests cover edge cases

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-001 | Unit | P0 | (See above) Empty input | Edge case |
| 10.1-INT-005 | Integration | P2 | Unicode content preserved through WASM roundtrip | Encoding edge case across boundary |
| 10.1-UNIT-019 | Unit | P2 | Deeply nested lists (10+ levels) render without panic | Stress edge case |

Note: 10.1-UNIT-001 is reused from AC2.

### AC9: WASM bundle size increase < 200KB

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-INT-002 | Integration | P0 | (See above) Bundle size delta check | CI gate |

### AC10: Render time < 100ms for 500KB Markdown

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-INT-006 | Integration | P0 | 500KB Markdown renders < 100ms in WASM (using `Performance.now()`) | Must validate in actual WASM runtime; `std::time::Instant` unavailable |
| 10.1-E2E-001 | E2E | P2 | 500KB document loads and renders in browser within 100ms | Real-world validation |

### AC11: Error messages HTML-escaped in WASM binding

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-INT-007 | Integration | P0 | Error path HTML-escapes message before embedding in `<div>` | XSS in error output; TECH-002 from risk profile |

### AC12: URI scheme sanitization (no javascript:, data:, vbscript:)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-021 | Unit | P0 | `[click](javascript:alert(1))` URI sanitized or stripped | URI scheme injection; raised in NFR assessment |
| 10.1-E2E-002 | E2E | P1 | Rendered output with links does not violate CSP `connect-src 'none'` | End-to-end security validation |

### AC13: Input size guard (reject > 2MB)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-022 | Unit | P0 | `render_markdown` rejects input > 2MB with `RenderError` | Memory budget protection; pure logic check |
| 10.1-INT-008 | Integration | P0 | WASM `renderMarkdown` returns user-friendly error for > 2MB input | Cross-boundary error handling for oversized input |

### Security (from Risk Profile & NFR Assessment)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 10.1-UNIT-020 | Unit | P0 | `<script>alert(1)</script>` in input is escaped in output | XSS prevention; `unsafe_ = false` verification |
| 10.1-E2E-003 | E2E | P2 | Pathological input (100+ nesting) does not crash browser tab | DoS resilience |

## Risk Coverage

| Risk ID | Risk | Mitigating Tests |
|---------|------|-----------------|
| TECH-001 | syntect incompatible with WASM | 10.1-INT-001 |
| PERF-001 | Bundle size budget | 10.1-INT-002 |
| TECH-002 | XSS in error path | 10.1-INT-007 |
| PERF-002 | WASM render performance | 10.1-INT-006, 10.1-E2E-001 |
| SEC-001 | URI scheme injection | 10.1-UNIT-021, 10.1-E2E-002 |
| OPS-001 | Memory budget / heap exhaustion | 10.1-UNIT-022, 10.1-INT-008 |
| (NFR) Pathological input | Deep nesting DoS | 10.1-UNIT-019, 10.1-E2E-003 |

## Test Data Requirements

| Data | Size/Description | Used By |
|------|-----------------|---------|
| Empty string | `""` | 10.1-UNIT-001 |
| Standard MD samples | ~1KB each, one per element type | 10.1-UNIT-004 through 10.1-UNIT-018 |
| GFM table with alignment | 3-column table with left/center/right | 10.1-UNIT-013 |
| Large document | 500KB synthetic Markdown (repeated sections) | 10.1-INT-006, 10.1-E2E-001 |
| Oversized document | 2.1MB synthetic Markdown | 10.1-UNIT-022, 10.1-INT-008 |
| XSS payloads | Script tags, event handlers, javascript: URIs, data: URIs, vbscript: URIs | 10.1-UNIT-020, 10.1-UNIT-021 |
| Deeply nested lists | 10+ and 100+ nesting levels | 10.1-UNIT-019, 10.1-E2E-003 |
| Unicode content | CJK, emoji, RTL, combining characters | 10.1-INT-005 |
| Error-triggering input | Crafted to produce RenderError with HTML characters in message | 10.1-INT-007 |

## Environment Requirements

| Environment | Tests | Notes |
|-------------|-------|-------|
| Native Rust (`cargo test`) | All UNIT tests (19) | Fast feedback, run first |
| WASM build (`wasm-pack`) | INT-001, INT-002 | Build validation |
| WASM runtime (browser/Node) | INT-003 through INT-008 | Requires wasm-bindgen test harness or browser |
| Browser (Chrome/Firefox) | E2E-001 through E2E-003 | Real browser for CSP and performance validation |

## Recommended Execution Order

1. P0 Unit tests — fail fast on core logic (UNIT-001, 020, 021, 022)
2. P0 Integration — build gate (INT-001, INT-002)
3. P0 Integration — WASM binding & security (INT-003, INT-006, INT-007, INT-008)
4. P1 Unit tests — functional coverage (UNIT-004 through UNIT-018)
5. P1 Integration/E2E — binding quality & CSP (INT-004, E2E-002)
6. P2+ — edge cases, stress tests, nice-to-have

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 30
  by_level:
    unit: 19
    integration: 8
    e2e: 3
  by_priority:
    p0: 10
    p1: 12
    p2: 8
  coverage_gaps: []
  notes: 'All 13 ACs covered. Security scenarios added per risk profile and NFR assessment. AC13 (2MB input guard) added in v2.'
```

## Trace References

Test design matrix: docs/qa/assessments/10.1-test-design-20260128.md
P0 tests identified: 10
