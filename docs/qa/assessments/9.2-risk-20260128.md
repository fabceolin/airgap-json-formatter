# Risk Profile: Story 9.2 - Rust Share Decoding & Validation

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 9
- Critical Risks: 0
- High Risks: 3
- Risk Score: 49/100 (moderate-high risk)

This story handles cryptographic decryption, key derivation, and payload parsing — all security-sensitive operations. While no individual risk reaches Critical (9), three High (6) risks cluster around cryptographic implementation correctness and wire-format compatibility with the encoding story (9.1).

## Risk Matrix

| Risk ID  | Description                                         | Probability | Impact     | Score | Priority |
|----------|-----------------------------------------------------|-------------|------------|-------|----------|
| SEC-001  | Timing side-channel in decryption/key comparison    | Medium (2)  | High (3)   | 6     | High     |
| SEC-003  | Missing ciphertext length validation causing panics  | Medium (2)  | High (3)   | 6     | High     |
| TECH-001 | Encode/decode wire format incompatibility            | Medium (2)  | High (3)   | 6     | High     |
| SEC-002  | Error oracle leaking crypto state via error codes    | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-001 | PBKDF2 blocking UI thread in WASM                   | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-002 | Timestamp validation incorrect (clock skew/TZ)       | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | Decompression bomb via crafted DEFLATE payload       | Low (1)     | High (3)   | 3     | Low      |
| OPS-001  | js_sys::Date makes unit testing hard outside WASM    | High (3)    | Low (1)    | 3     | Low      |
| TECH-002 | WASM Asyncify contention with decrypt operations     | Low (1)     | Medium (2) | 2     | Low      |

## High Risks Requiring Attention

### 1. SEC-001: Timing Side-Channel in Decryption

**Score: 6 (High)**
**Probability**: Medium — AES-GCM via `aes-gcm` crate uses constant-time operations internally, but error-path timing differences between "wrong key" vs "wrong format" may leak information.
**Impact**: High — Could allow an attacker to distinguish between error types faster than through error codes alone.
**Mitigation**:
- Rely on `aes-gcm` crate's constant-time comparison (already built-in)
- Ensure error paths have similar execution time (no early returns before decryption attempt)
- Add a note in code review to verify no timing shortcuts
**Testing Focus**: Not directly testable in unit tests; note for security review.

### 2. SEC-003: Missing Ciphertext Length Validation

**Score: 6 (High)**
**Probability**: Medium — Story defines minimum length checks but off-by-one errors are common in crypto payload parsing.
**Impact**: High — Could cause panics (slice indexing) or undefined behavior in WASM.
**Mitigation**:
- Validate minimum payload sizes at each parsing stage (base64 decoded → salt+nonce+ciphertext minimum)
- Fuzz test with truncated inputs at every byte boundary
- Ensure all slice operations use checked indexing or `.get()` with error returns
**Testing Focus**: Task 9 covers truncated data tests. Add boundary-length inputs (exact minimum, minimum-1).

### 3. TECH-001: Encode/Decode Wire Format Incompatibility

**Score: 6 (High)**
**Probability**: Medium — Two stories (9.1 and 9.2) define the same wire format independently. Byte-order, offset, or version-byte interpretation differences would silently break round-trips.
**Impact**: High — Complete feature failure; encoded payloads cannot be decoded.
**Mitigation**:
- Round-trip integration tests are mandatory (already in Task 9)
- Encode with 9.1, decode with 9.2 in same test
- Document wire format as a shared specification both stories reference
**Testing Focus**: Priority 1 — round-trip tests for both modes.

## Medium Risks

### SEC-002: Error Oracle via Distinct Error Codes
Different error codes for `decryption_failed` vs `wrong_passphrase` vs `invalid_payload` could help an attacker narrow down failure modes. **Mitigation**: Consider collapsing `DecryptionFailed` and `WrongPassphrase` into a single external error code while keeping distinct internal variants for logging.

### PERF-001: PBKDF2 Blocking UI
PBKDF2 with sufficient iterations may block the main thread in WASM. **Mitigation**: Profile actual iteration count timing in WASM; consider Web Worker offload if >200ms.

### DATA-002: Timestamp/Clock Skew
`js_sys::Date::now()` depends on client clock. Clock skew could reject valid links or accept expired ones. **Mitigation**: Document that expiration is based on client clock. Tests should use mocked timestamps.

## Low Risks

- **DATA-001**: Decompression bomb — mitigate with max decompressed size limit (e.g., 10MB)
- **OPS-001**: Testing difficulty — use `#[cfg(test)]` injectable timestamp for testability
- **TECH-002**: Asyncify contention — low probability since decryption is synchronous in Rust

## Risk Distribution

### By Category
- Security: 3 risks (0 critical, 2 high, 1 medium)
- Technical: 2 risks (0 critical, 1 high, 1 low)
- Performance: 1 risk (0 critical, 1 medium)
- Data: 2 risks (0 critical, 2 medium/low)
- Operational: 1 risk (0 critical, 1 low)

### By Component
- Rust/WASM core: 8 risks
- Bridge/JS layer: 1 risk

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Round-trip encode→decode for both random-key and passphrase modes
- Truncated payload at every parsing boundary (pre-salt, pre-nonce, pre-ciphertext, pre-version, pre-timestamp)
- Wrong key and wrong passphrase decryption failures

### Priority 2: Medium Risk Tests
- Timestamp boundary tests (299s, 300s, 301s)
- PBKDF2 performance benchmark in WASM
- Error code mapping verification

### Priority 3: Low Risk Tests
- Large payload decompression (verify no OOM)
- Asyncify queue behavior during decode

## Risk Acceptance Criteria

### Must Fix Before Production
- All slice/index operations must use checked access (SEC-003)
- Round-trip tests must pass for both modes (TECH-001)

### Can Deploy with Mitigation
- Timing side-channel (SEC-001) — acceptable given aes-gcm crate guarantees
- Error oracle (SEC-002) — acceptable for client-side-only tool

### Accepted Risks
- Clock skew (DATA-002) — inherent to client-side expiration; documented limitation
- Testing difficulty (OPS-001) — mitigated by injectable timestamps

## Gate Recommendation

**CONCERNS** — Three High (score 6) risks identified. No Critical risks, but security-sensitive crypto implementation warrants careful code review and thorough round-trip testing before gate can pass.

---

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 3
    low: 3
  highest:
    id: SEC-001
    score: 6
    title: 'Timing side-channel in decryption'
  recommendations:
    must_fix:
      - 'Use checked slice indexing throughout decode pipeline'
      - 'Implement round-trip integration tests with Story 9.1 encoder'
    monitor:
      - 'PBKDF2 performance in WASM (measure wall-clock time)'
      - 'Decompressed payload size limits'
```

Risk profile: docs/qa/assessments/9.2-risk-20260128.md
