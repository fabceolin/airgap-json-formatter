# NFR Assessment: 10.3 Bridge Layer Markdown Methods

Date: 2026-01-28
Reviewer: Quinn (Test Architect)
Story: docs/stories/10.3.bridge-layer-markdown-methods.md
Quality Score: 70/100

## Summary

- Security: **CONCERNS** - XSS mitigation specified but implementation verification needed
- Performance: **CONCERNS** - Large document target stated but response time thresholds undefined
- Reliability: **PASS** - Comprehensive error handling with graceful degradation
- Maintainability: **PASS** - Clear test strategy and follows existing patterns

## Assessment Details

### Security

**Status: CONCERNS**

**Evidence Found:**
- AC 6: Methods handle null/undefined input gracefully (input validation present)
- Risk Profile SEC-001 identifies Mermaid SVG XSS potential
- Mitigation specified: `securityLevel: 'strict'` for mermaid.js configuration

**Gaps Identified:**
1. **HTML entity encoding/decoding** - `decodeHtmlEntities()` function uses DOM-based decoding which is generally safe, but the encoded content originates from user input passed through Markdown rendering
2. **No CSP validation** - Story doesn't verify SVG output complies with application CSP (`connect-src 'none'`)
3. **XSS verification missing** - No acceptance criteria explicitly require XSS testing with malicious payloads

**Recommendations:**
- Add AC for XSS penetration testing: "Mermaid diagrams with XSS payloads (onclick, onerror, javascript:) render as sanitized SVG"
- Verify mermaid.js `securityLevel: 'strict'` is enforced via test case
- Document trusted input flow: user input → comrak (Rust) → HTML → mermaid.js → SVG

### Performance

**Status: CONCERNS**

**Evidence Found:**
- AC 7: "Large documents (500KB) don't block UI"
- AsyncSerialiser integration specified (AC 4)
- Watchdog timeout (30s) prevents hung tasks

**Gaps Identified:**
1. **No response time target** - 500KB document processing time not specified (PRD NFR4 states <100ms for 1MB JSON, but no equivalent for Markdown)
2. **Multiple Mermaid diagrams** - No performance target for documents with many diagrams (5+ mentioned in Risk Profile)
3. **Memory usage unspecified** - Large Markdown + multiple SVG outputs could exceed browser memory limits

**Recommendations:**
- Define: "500KB Markdown with 5 Mermaid diagrams shall render in <2000ms"
- Add memory monitoring test for large document rendering
- Consider progress indication for multi-diagram rendering

### Reliability

**Status: PASS**

**Evidence Found:**
- Task 6 covers comprehensive error handling:
  - WASM not initialized handling
  - Mermaid not loaded handling
  - Empty/null input handling
  - Partial render failures (individual diagrams can fail without blocking others)
- AsyncSerialiser provides:
  - Error isolation between tasks
  - 30-second watchdog timeout
  - Queue bounds (max 100 tasks)
- AC 1-3 specify explicit error response format: `{ success: false, error: "..." }`

**Strengths:**
- Graceful degradation: failed diagrams show error message in-place
- Warnings array returned with partial success
- Existing AsyncSerialiser pattern is proven in codebase

### Maintainability

**Status: PASS**

**Evidence Found:**
- Task 7 specifies comprehensive integration tests
- Test table in story defines clear input/output expectations
- Code follows established patterns (bridge.js structure, JsonBridge object)
- Dev Notes include implementation examples
- Signals follow Qt naming convention (markdownRendered, markdownRenderError)

**Strengths:**
- Test coverage plan includes valid, invalid, empty, and combined scenarios
- Browser console testing examples provided
- Clear separation of concerns (Rust WASM → JS Bridge → Qt Signals)

## Critical Issues

1. **XSS verification gap** (Security)
   - Risk: Malicious Mermaid diagrams could inject scripts if `securityLevel` misconfigured
   - Fix: Add explicit XSS test cases to acceptance criteria

2. **Performance threshold undefined** (Performance)
   - Risk: No measurable target for QA gate pass/fail decision
   - Fix: Define response time target for reference document size

## Quick Wins

- Add XSS test payloads to test table (Task 7)
- Document mermaid.js security configuration requirement in AC
- Add performance benchmark to CI pipeline

## Gate Integration

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: 'XSS mitigation specified (securityLevel:strict) but no verification test in AC; HTML entity decoding needs review'
  performance:
    status: CONCERNS
    notes: 'Large document (500KB) UI blocking addressed via AsyncSerialiser but no response time target defined'
  reliability:
    status: PASS
    notes: 'Comprehensive error handling with graceful degradation; partial failures handled correctly'
  maintainability:
    status: PASS
    notes: 'Clear test strategy, follows existing patterns, integration tests specified'
```

---

NFR assessment: docs/qa/assessments/10.3-nfr-20260128.md
Gate NFR block ready → paste into docs/qa/gates/10.3-bridge-layer-markdown-methods.yml under nfr_validation
