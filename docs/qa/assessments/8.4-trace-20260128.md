# Requirements Traceability Matrix

## Story: 8.4 - Format Auto-Detection

**Date:** 2026-01-28
**Traced by:** Quinn (Test Architect)

---

## Coverage Summary

| Metric | Count | Percentage |
|--------|-------|------------|
| Total Requirements | 7 | 100% |
| Fully Covered | 0 | 0% |
| Partially Covered | 0 | 0% |
| Not Covered | 7 | 100% |

**Status: NOT IMPLEMENTED**

---

## Implementation Status

### Code Analysis

After thorough analysis of the codebase, **Story 8.4 has NOT been implemented**:

| Component | Expected | Actual Status |
|-----------|----------|---------------|
| `JsonBridge::detectFormat()` | Add method | **NOT FOUND** in jsonbridge.h/cpp |
| `formatDetected` signal | Add signal | **NOT FOUND** in jsonbridge.h |
| `detectedFormat` property | Add to Main.qml | **NOT FOUND** |
| Format button routing | Call formatXml/formatJson | **MISSING** - always calls formatJson |
| Test file | `qt/tests/tst_format_detection.cpp` | **NOT FOUND** |

### Current Behavior

The application currently:
1. **Always treats input as JSON** - no XML detection
2. **No detection method exists** - `detectFormat()` is not implemented
3. **No signal is defined** - `formatDetected` signal does not exist
4. **Toolbar hardcoded to JSON** - Format button always calls `formatJson()`

---

## Requirement Mappings

### AC1: Format is auto-detected when content is pasted into input pane

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Detection on paste | Not implemented | No `detectFormat()` call in paste handler |
| Existing code | `handlePastedContent()` in Main.qml | Always calls `formatJson()` |

**Gap Analysis:**
- `Main.qml:157-170` handles paste but does not detect format
- Would need: `JsonBridge.detectFormat(text)` call before formatting

---

### AC2: Format is auto-detected when Format button is clicked

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Detection on format | Not implemented | No format routing logic |
| Existing code | `Toolbar.qml:219` | `formatRequested()` only signals |
| Button handler | `Main.qml:251-257` | Always calls `formatJson()` |

**Gap Analysis:**
- Toolbar.qml Format button always triggers `formatRequested(indentType)`
- Main.qml always responds with `JsonBridge.formatJson()`
- Would need: Check `detectedFormat` property and route to `formatJson()` or `formatXml()`

---

### AC3: Detection logic: `<` prefix = XML, `{` or `[` prefix = JSON

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Detection algorithm | Not implemented | Method does not exist |
| Expected location | `jsonbridge.cpp` | No `detectFormat()` function |

**Gap Analysis:**
- Algorithm documented in Dev Notes but not implemented
- Expected implementation:
  ```cpp
  QString JsonBridge::detectFormat(const QString &input) {
      QString trimmed = input.trimmed();
      if (trimmed.isEmpty()) return "unknown";
      QChar first = trimmed.at(0);
      if (first == '<') return "xml";
      if (first == '{' || first == '[') return "json";
      return "unknown";
  }
  ```

---

### AC4: Unknown format handled gracefully (default to JSON or show message)

**Coverage: NONE (IMPLICITLY PARTIAL)**

| Aspect | Status | Notes |
|--------|--------|-------|
| Unknown handling | Not explicitly implemented | Current behavior defaults to JSON |
| Fallback behavior | Implicit | Everything treated as JSON currently |

**Gap Analysis:**
- Current behavior coincidentally matches spec (defaults to JSON)
- However, this is not intentional - there's no detection at all
- No UI indicator for unknown format

---

### AC5: `formatDetected` signal emitted with detected format

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Signal definition | Not found | Not in jsonbridge.h signals section |
| Signal emission | N/A | Signal doesn't exist |

**Gap Analysis:**
- `jsonbridge.h:63-95` lists all signals - no `formatDetected`
- Would need to add: `void formatDetected(const QString &format);`

---

### AC6: Detection works for content with leading whitespace

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Whitespace handling | Not implemented | Detection doesn't exist |

**Gap Analysis:**
- Algorithm in Dev Notes uses `trimmed()` which would handle this
- But since algorithm isn't implemented, this isn't covered

---

### AC7: Detection is fast (< 1ms for any input size)

**Coverage: NONE**

| Aspect | Status | Notes |
|--------|--------|-------|
| Performance | Not testable | Detection doesn't exist |

**Gap Analysis:**
- Proposed algorithm is O(whitespace) which should meet <1ms easily
- Cannot verify without implementation

---

## Test Coverage Analysis

### Expected Test File

**Location:** `qt/tests/tst_format_detection.cpp`
**Status:** **NOT FOUND**

### Test Cases from Story (All NOT COVERED)

| Test ID | Input | Expected Output | Coverage |
|---------|-------|-----------------|----------|
| 8.4-UNIT-001 | `{"a":1}` | "json" | NONE |
| 8.4-UNIT-002 | `[1,2,3]` | "json" | NONE |
| 8.4-UNIT-003 | `<root/>` | "xml" | NONE |
| 8.4-UNIT-004 | `<?xml version="1.0"?>` | "xml" | NONE |
| 8.4-UNIT-005 | `  \n  <root/>` | "xml" | NONE |
| 8.4-UNIT-006 | `  \n  {"a":1}` | "json" | NONE |
| 8.4-UNIT-007 | `hello` | "unknown" | NONE |
| 8.4-UNIT-008 | `` (empty) | "unknown" | NONE |

---

## Critical Gaps

### Gap 1: Core Detection Method Missing (CRITICAL)

| Attribute | Value |
|-----------|-------|
| Requirement | AC3, AC6, AC7 |
| Risk | HIGH |
| Severity | Blocking |
| Description | `detectFormat()` method not implemented in JsonBridge |
| Suggested Action | Implement method as documented in story Dev Notes |

### Gap 2: formatDetected Signal Missing (CRITICAL)

| Attribute | Value |
|-----------|-------|
| Requirement | AC5 |
| Risk | HIGH |
| Severity | Blocking |
| Description | Signal not defined in header file |
| Suggested Action | Add signal to jsonbridge.h and emit from detectFormat() |

### Gap 3: QML Integration Missing (CRITICAL)

| Attribute | Value |
|-----------|-------|
| Requirement | AC1, AC2 |
| Risk | HIGH |
| Severity | Blocking |
| Description | No `detectedFormat` property in Main.qml, no routing logic |
| Suggested Action | Implement as documented in story Dev Notes |

### Gap 4: Unit Tests Not Created (HIGH)

| Attribute | Value |
|-----------|-------|
| Requirement | Task 6 |
| Risk | HIGH |
| Severity | Blocking for completion |
| Description | `qt/tests/tst_format_detection.cpp` does not exist |
| Suggested Action | Create test file with all 8 test cases |

---

## Risk Assessment

| Risk | Impact | Mitigation |
|------|--------|------------|
| Story marked Approved but not implemented | Users may expect auto-detection | Update story status or implement |
| XML support exists but detection doesn't | User must manually know format | Implement detection or update PRD |
| Existing XML methods (`formatXml`, `highlightXml`) unused | Dead code if not routed | Implement detection or remove XML support |

---

## Recommendations

### Immediate Actions (Pre-Gate)

1. **Update Story Status** - Change from "Approved" to "Not Started" or "In Progress"
2. **Implement Core Detection** - Add `detectFormat()` method to JsonBridge
3. **Add Signal** - Add `formatDetected` signal to header
4. **QML Integration** - Add property and routing logic
5. **Create Tests** - Create `qt/tests/tst_format_detection.cpp`

### Test Design Reference

See: `docs/qa/assessments/8.4-test-design-20260128.md` for complete test scenarios

---

## Traceability Matrix Summary

| AC | Implementation | Tests | Status |
|----|----------------|-------|--------|
| AC1 | Missing | Missing | NOT COVERED |
| AC2 | Missing | Missing | NOT COVERED |
| AC3 | Missing | Missing | NOT COVERED |
| AC4 | Implicit only | Missing | NOT COVERED |
| AC5 | Missing | Missing | NOT COVERED |
| AC6 | Missing | Missing | NOT COVERED |
| AC7 | Missing | Missing | NOT COVERED |

---

## Gate Block (For Gate File)

```yaml
trace:
  totals:
    requirements: 7
    full: 0
    partial: 0
    none: 7
  planning_ref: 'docs/qa/assessments/8.4-test-design-20260128.md'
  uncovered:
    - ac: 'AC1'
      reason: 'detectFormat() not called on paste - method not implemented'
    - ac: 'AC2'
      reason: 'Format button always calls formatJson(), no routing logic'
    - ac: 'AC3'
      reason: 'detectFormat() method not implemented in JsonBridge'
    - ac: 'AC4'
      reason: 'Implicit only - no explicit unknown handling'
    - ac: 'AC5'
      reason: 'formatDetected signal not defined in jsonbridge.h'
    - ac: 'AC6'
      reason: 'Detection method not implemented'
    - ac: 'AC7'
      reason: 'Cannot verify - detection not implemented'
  notes: 'Story 8.4 is NOT IMPLEMENTED. Status should be updated from Approved to Not Started.'
```

---

**Trace matrix:** docs/qa/assessments/8.4-trace-20260128.md
