# Risk Profile: Story 10.6 Markdown Syntax Highlighting

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 1
- Risk Score: 78/100 (calculated)

## Risk Matrix

| Risk ID   | Description                                      | Probability | Impact     | Score | Priority |
|-----------|--------------------------------------------------|-------------|------------|-------|----------|
| SEC-001   | XSS via improperly escaped user content          | Medium (2)  | High (3)   | 6     | High     |
| PERF-001  | Regex catastrophic backtracking on large docs    | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-001  | Nested emphasis parsing complexity               | Medium (2)  | Low (1)    | 2     | Low      |
| TECH-002  | State machine inconsistency in code blocks       | Low (1)     | Medium (2) | 2     | Low      |
| DATA-001  | Unicode edge cases in pattern matching           | Low (1)     | Low (1)    | 1     | Minimal  |
| OPS-001   | Theme color mismatch between dark/light modes    | Low (1)     | Low (1)    | 1     | Minimal  |

## High Risks Requiring Attention

### SEC-001: XSS Vulnerability via Improperly Escaped User Content

**Score: 6 (High)**

**Probability**: Medium - The story acknowledges XSS risk and includes explicit mitigation tasks (Task 8), but Markdown's flexibility with embedded HTML and special constructs creates multiple attack vectors.

**Impact**: High - This is an airgap security tool for sensitive data. XSS would completely undermine the security promise.

**Affected Components**:
- `markdown_highlighter.rs` - HTML escaping function
- bridge.js integration
- OutputPane CSS injection points

**Mitigation**:
- Escape `<`, `>`, `&`, `"`, `'` BEFORE applying span wrappers (order matters)
- Test with OWASP XSS cheat sheet payloads
- Ensure spans cannot be broken by malicious content (e.g., `</span><script>`)
- Validate no injection via CSS class names

**Testing Focus**:
- XSS payload test cases already specified in story
- Add: `**</span><script>alert(1)</script><span>**` style injection
- Add: CSS-based injection via attribute values
- Fuzz testing with malformed Markdown

## Medium Risks

### PERF-001: Regex Catastrophic Backtracking

**Score: 4 (Medium)**

**Probability**: Medium - The proposed implementation uses multiple regex patterns (`BOLD_RE`, `ITALIC_RE`, etc.) that could interact badly on crafted input. Overlapping patterns like `**text**` vs `*text*` require careful ordering.

**Impact**: Medium - Could freeze browser tab or WASM execution on malicious input. Performance requirement is <200ms for 1MB docs.

**Affected Components**:
- All lazy_static regex patterns
- `highlight_line()` function

**Mitigation**:
- Use possessive quantifiers or atomic groups where available
- Implement timeout/bailout for regex execution
- Consider non-regex approach (state machine like XML highlighter) for better worst-case performance
- Profile with pathological inputs like `*****many asterisks*****`

**Testing Focus**:
- Performance test with 1MB document (already specified)
- Add: Pathological regex input tests
- Add: Deeply nested emphasis `**a *b **c *d* e** f* g**`

## Low Risks

### TECH-001: Nested Emphasis Parsing Complexity

**Score: 2 (Low)**

**Probability**: Medium - Markdown emphasis rules are notoriously complex (CommonMark spec is 17 rules). The regex approach will not handle edge cases correctly.

**Impact**: Low - Incorrect highlighting is cosmetic; doesn't affect functionality or security.

**Mitigation**:
- Accept that highlighting won't match all CommonMark edge cases
- Document known limitations
- Consider using simple non-greedy patterns and accepting imperfection

### TECH-002: State Machine Inconsistency in Code Blocks

**Score: 2 (Low)**

**Probability**: Low - Code block detection is straightforward, but handling of ``` within code blocks, or indented code blocks, could cause state corruption.

**Impact**: Medium - Incorrect highlighting propagates to rest of document.

**Mitigation**:
- Clear state reset at code block boundaries
- Test with code blocks containing backticks
- Test with 4-space indented code blocks (if supported)

### DATA-001: Unicode Edge Cases

**Score: 1 (Minimal)**

**Probability**: Low - Regex patterns assume ASCII-compatible line structure.

**Impact**: Low - May not highlight correctly on Unicode edge cases but won't break.

**Mitigation**:
- Test with Unicode headings and emphasis
- Ensure emoji in content don't break parsing

### OPS-001: Theme Color Mismatch

**Score: 1 (Minimal)**

**Probability**: Low - Theme.qml integration is well-established pattern.

**Impact**: Low - Poor readability in one mode; easily caught in visual testing.

**Mitigation**:
- Visual review in both modes before release
- Use existing JSON/XML color patterns as guide

## Risk Distribution

### By Category
- Security: 1 risk (0 critical, 1 high)
- Performance: 1 risk (0 critical)
- Technical: 2 risks (0 critical)
- Data: 1 risk (0 critical)
- Operational: 1 risk (0 critical)

### By Component
- Rust markdown_highlighter.rs: 5 risks
- Theme.qml: 1 risk
- Bridge.js: 1 risk (shared with Rust)

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests (SEC-001)
- XSS payload injection tests (specified in story)
- HTML entity escaping verification
- Span boundary injection tests
- CSS class name sanitization

### Priority 2: Medium Risk Tests (PERF-001)
- 1MB document performance benchmark
- Pathological regex input tests
- Nested/overlapping pattern stress tests

### Priority 3: Low Risk Tests (TECH-*)
- Edge case Markdown documents
- Unicode content handling
- Theme switching visual tests

## Risk Acceptance Criteria

### Must Fix Before Production
- SEC-001: All XSS vectors must be mitigated
- PERF-001: Must meet <200ms benchmark

### Can Deploy with Mitigation
- TECH-001/002: Document known highlighting limitations
- DATA-001: Document Unicode edge case behavior

### Accepted Risks
- Visual highlighting imperfections for complex nested Markdown
- Minor performance variations based on content structure

## Monitoring Requirements

Post-deployment monitoring for:
- Console errors related to highlighting failures
- User feedback on highlighting accuracy
- Performance metrics for large document handling

## Risk Review Triggers

Review and update risk profile when:
- Adding new Markdown syntax support
- Changing regex patterns
- Receiving XSS vulnerability reports
- Performance complaints on large documents

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 4
  highest:
    id: SEC-001
    score: 6
    title: 'XSS via improperly escaped user content'
  recommendations:
    must_fix:
      - 'Verify HTML escaping happens BEFORE span wrapping'
      - 'Test all OWASP XSS payloads from story test cases'
    monitor:
      - 'Performance metrics for 1MB+ documents'
      - 'User feedback on highlighting accuracy'
```

---

Risk profile: docs/qa/assessments/10.6-risk-20260128.md
