# Risk Profile: Story 8.6

Date: 2026-01-28
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 1
- Risk Score: 83/100 (calculated)

This story carries **moderate risk** primarily due to memory management concerns with tree structures and performance requirements for large documents. The well-defined reference implementation (QJsonTreeModel) significantly reduces implementation risk.

## Risk Matrix

| Risk ID   | Description                                      | Probability | Impact     | Score | Priority |
|-----------|--------------------------------------------------|-------------|------------|-------|----------|
| PERF-001  | Memory exhaustion on large XML documents         | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | QXmlStreamReader edge cases (malformed XML)      | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | Namespace handling complexity                    | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | XML entity expansion attacks (billion laughs)    | Low (1)     | High (3)   | 3     | Low      |
| TECH-003  | Model index invalidation during tree updates     | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | TreeView.qml model switching race conditions     | Low (1)     | Medium (2) | 2     | Low      |
| TECH-004  | Memory leaks in QXmlTreeItem ownership           | Low (1)     | Medium (2) | 2     | Low      |

## Critical Risks Requiring Immediate Attention

No critical risks (score 9) identified.

## High Risk Details

### PERF-001: Memory Exhaustion on Large XML Documents

**Score: 6 (High)**

**Probability**: Medium - Documents with 10,000+ nodes are within scope, and deeply nested XML with many attributes can multiply node count beyond expectations.

**Impact**: High - Memory exhaustion could crash the application or cause severe UI lag, impacting user experience and potentially leading to data loss if input is unsaved.

**Affected Components**:
- `QXmlTreeModel::loadXml()`
- `QXmlTreeItem` child list allocation

**Mitigation**:
1. Implement node count guard similar to `QJsonTreeModel::totalNodeCount()`
2. Add configurable maximum node limit (suggest 50,000 default)
3. Emit warning signal when approaching limit
4. Consider lazy loading for very deep trees (future enhancement)

**Testing Focus**:
- Stress test with 10,000+ node documents
- Memory profiling with Valgrind/AddressSanitizer
- Test with pathologically nested structures

## Medium Risk Details

### TECH-001: QXmlStreamReader Edge Cases

**Score: 4 (Medium)**

**Probability**: Medium - Malformed or unusual XML is common in real-world data.

**Impact**: Medium - Parser errors could leave model in inconsistent state or display garbage.

**Mitigation**:
1. Comprehensive error handling around `reader.hasError()`
2. Return false and emit error signal on parse failure
3. Clear any partial tree on error
4. Add unit tests for malformed XML handling

### TECH-002: Namespace Handling Complexity

**Score: 4 (Medium)**

**Probability**: Medium - Namespace-heavy XML (SOAP, XHTML) is common.

**Impact**: Medium - Incorrect namespace display could confuse users or break serialization.

**Mitigation**:
1. Test with multiple namespace declarations
2. Test with default namespace (no prefix)
3. Ensure serialization preserves xmlns declarations
4. Handle namespace undeclaration edge cases

## Low Risk Details

### DATA-001: XML Entity Expansion Attacks

**Score: 3 (Low)**

**Probability**: Low - This is an airgap tool processing user's own data, reducing malicious input likelihood.

**Impact**: High - Billion laughs attack could cause memory exhaustion/DoS.

**Mitigation**:
1. QXmlStreamReader has built-in entity limits
2. Document security considerations in user docs
3. Consider adding explicit entity expansion limit configuration

### TECH-003: Model Index Invalidation

**Score: 2 (Low)**

**Probability**: Low - Model is read-only after load; no dynamic updates.

**Impact**: Medium - Invalid model indices could cause crashes or display corruption.

**Mitigation**:
1. Ensure `beginResetModel()`/`endResetModel()` bracket all tree modifications
2. Never expose raw pointers that could become dangling
3. Test rapid reload scenarios

### OPS-001: TreeView Model Switching

**Score: 2 (Low)**

**Probability**: Low - Format detection and model switching is straightforward QML binding.

**Impact**: Medium - Race condition could show wrong tree or cause binding loops.

**Mitigation**:
1. Use Qt property bindings (reactive, not imperative)
2. Test rapid format switching
3. Ensure model clearing happens before format change

### TECH-004: Memory Leaks in QXmlTreeItem

**Score: 2 (Low)**

**Probability**: Low - Following established QJsonTreeItem pattern reduces error likelihood.

**Impact**: Medium - Memory leaks would accumulate over multiple loads.

**Mitigation**:
1. Follow identical ownership pattern as QJsonTreeItem
2. Parent item owns and deletes children in destructor
3. Run memory leak tests with AddressSanitizer
4. Test repeated load/clear cycles

## Risk Distribution

### By Category
- Technical: 4 risks (0 critical)
- Performance: 1 risk (0 critical)
- Data: 1 risk (0 critical)
- Operational: 1 risk (0 critical)

### By Component
- QXmlTreeModel: 4 risks
- QXmlTreeItem: 2 risks
- TreeView.qml: 1 risk

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- [ ] Load 10,000+ node XML document, verify < 2s load time
- [ ] Memory profiling during large document load
- [ ] Verify node count guard triggers appropriately
- [ ] AddressSanitizer run on load/clear/reload cycle

### Priority 2: Medium Risk Tests
- [ ] Malformed XML: unclosed tags, invalid characters, encoding issues
- [ ] Namespace tests: multiple prefixes, default namespace, nested namespaces
- [ ] Verify error signal emission on parse failure
- [ ] Serialization round-trip with namespaced elements

### Priority 3: Standard Tests
- [ ] Basic element parsing
- [ ] Attribute display with `@` prefix
- [ ] Text content and CDATA handling
- [ ] Comment preservation
- [ ] Copy/serialize functionality
- [ ] Format switching in TreeView

## Risk Acceptance Criteria

### Must Fix Before Production
- All high risks (score 6+) must have mitigations implemented

### Can Deploy with Mitigation
- Medium risks acceptable with documented edge cases
- Performance risks acceptable with node count guards

### Accepted Risks
- Entity expansion attacks: Accepted, relying on QXmlStreamReader built-in limits

## Monitoring Requirements

Post-deployment monitoring for:
- Memory usage during XML tree operations
- Load time metrics for various document sizes
- Error rates from parse failures

## Risk Review Triggers

Review and update risk profile when:
- Adding edit/mutation capabilities to tree model
- Changing parsing library from QXmlStreamReader
- Adding streaming/lazy-load capabilities
- Performance issues reported in production

---

Risk profile: docs/qa/assessments/8.6-risk-20260128.md
