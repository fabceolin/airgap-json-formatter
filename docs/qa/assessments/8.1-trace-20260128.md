# Requirements Traceability Matrix

## Story: 8.1 - Productionize XML Formatter

**Assessment Date:** 2026-01-28 (Updated)
**Reviewer:** Quinn (Test Architect)
**Assessment Mode:** YOLO (Non-interactive)

---

### Coverage Summary

- **Total Requirements:** 9 (AC1-AC9)
- **Fully Covered:** 0 (0%)
- **Partially Covered:** 4 (44%) — AC1, AC2, AC4, AC7
- **Not Covered:** 5 (56%) — AC3, AC5, AC6, AC8, AC9

---

### Requirement Mappings

#### AC1: XML formatting produces correctly indented output for all valid XML inputs

**Coverage: PARTIAL**

Given-When-Then Mappings:

| Test | File:Line | Coverage | Notes |
|------|-----------|----------|-------|
| `test_format_xml_basic` | `xml_formatter.rs:200-207` | Partial | Given: flat XML `<root><child>text</child></root>` / When: `format_xml` with 2-space indent / Then: output contains `<root>`, `<child>`, `text` — **Gap: No indent structure verification (no newline/indent depth checks)** |
| `test_format_xml_with_attributes` | `xml_formatter.rs:209-215` | Partial | Tests attribute preservation, not indentation |
| `test_format_xml_with_declaration` | `xml_formatter.rs:217-223` | Partial | Tests declaration presence, not indentation |

**Gap Analysis:**
- Tests assert content presence (`contains`) but not correct indentation structure
- No tests verify newline placement or indent depth
- No tests for tab indentation variant

**Suggested Tests:**
```yaml
- description: "Verify 2-space indentation produces correct depth"
  given: "Nested XML <root><a><b>text</b></a></root>"
  when: "format_xml with IndentStyle::Spaces(2)"
  then: "Output has \\n, each level indented by 2 additional spaces"

- description: "Verify tab indentation"
  given: "Nested XML"
  when: "format_xml with IndentStyle::Tabs"
  then: "Output uses \\t for indentation"
```

---

#### AC2: XML minification removes all non-essential whitespace while preserving content

**Coverage: PARTIAL**

Given-When-Then Mappings:

| Test | File:Line | Coverage | Notes |
|------|-----------|----------|-------|
| `test_minify_xml` | `xml_formatter.rs:225-231` | Partial | Given: indented XML / When: `minify_xml` / Then: no newlines, tags adjacent — **Gap: Only one input tested; no content preservation assertion** |
| `test_roundtrip` | `xml_formatter.rs:233-242` | Partial | Validates content preserved indirectly via format→minify |

**Gap Analysis:**
- Only one test input (simple indented XML)
- No explicit test that minification preserves all content types
- No test for minifying already-minified input (idempotency)

**Suggested Tests:**
```yaml
- description: "Minify preserves CDATA content"
  given: "XML with CDATA section"
  when: "minify_xml"
  then: "CDATA content unchanged, no extra whitespace"

- description: "Minify idempotent"
  given: "Already minified XML"
  when: "minify_xml"
  then: "Output identical to input"
```

---

#### AC3: Parse errors include line and column position (non-zero) for debugging

**Coverage: NONE** ❌

**Current State:** All `FormatError::new()` calls use hardcoded `(0, 0)` positions:
- Lines 22, 45, 48, 53, 57, 61, 65, 68, 73, 78, 82, 88, 93, 98, 103, 108, 112, 119 — all return `FormatError::new(..., 0, 0)`
- Lines 125, 139, 142, 147, 151, 155, 159, 162, 167, 172, 176, 183, 186, 193 — all return `FormatError::new(..., 0, 0)`

**Critical:** `reader.buffer_position()` API is available (quick-xml provides byte offset) but is **never called**.

**Gap Analysis:**
- AC3 is **structurally impossible to pass** with current code
- Zero tests exist for error positions
- No `position_to_line_column()` helper implemented

**Required Implementation Before Testing:**
1. Implement `position_to_line_column(input, byte_offset)` helper per Dev Notes
2. Wire `reader.buffer_position()` into all `FormatError::new()` call sites
3. Then add tests for position accuracy

**Suggested Tests:**
```yaml
- description: "Unclosed tag error has position"
  given: "XML with unclosed tag <root>"
  when: "format_xml"
  then: "Error with line > 0, column > 0 pointing near EOF"

- description: "Mismatched tags error has position"
  given: "XML <a></b>"
  when: "format_xml"
  then: "Error with position pointing to </b>"

- description: "Invalid attribute error has position"
  given: "XML <a b> (missing =value)"
  when: "format_xml"
  then: "Error with position pointing to invalid attribute"
```

---

#### AC4: All XML constructs are preserved: declarations, comments, CDATA, PIs, namespaces

**Coverage: PARTIAL**

Given-When-Then Mappings:

| Test | File:Line | Coverage | Notes |
|------|-----------|----------|-------|
| `test_format_xml_with_declaration` | `xml_formatter.rs:217-223` | Full (decl) | Tests `<?xml?>` declaration preserved |
| `test_cdata` | `xml_formatter.rs:250-255` | Full (cdata) | Tests CDATA content preserved |
| `test_comments` | `xml_formatter.rs:257-262` | Full (comment) | Tests comment preserved |
| `test_namespace_prefix` | `xml_formatter.rs:264-270` | Full (ns) | Tests namespace prefixes preserved |

**Gap Analysis:**
- **Missing: PI (Processing Instruction) preservation test** — `format_xml` handles PI explicitly (line 100-104), no test exists
- **Missing: DocType preservation test** — `format_xml` handles DocType explicitly (line 105-109), no test exists
- **Critical: minify_xml uses catch-all** — Lines 180-184 use `Ok(event) =>` catch-all for CData, Comment, Decl, PI, DocType — no dedicated tests verify parity with `format_xml`

**Suggested Tests:**
```yaml
- description: "PI preserved in format"
  given: "XML with <?processing instruction?>"
  when: "format_xml"
  then: "PI appears unchanged in output"

- description: "DocType preserved in format"
  given: "XML with <!DOCTYPE root>"
  when: "format_xml"
  then: "DocType appears unchanged in output"

- description: "minify preserves PI via catch-all"
  given: "XML with PI"
  when: "minify_xml"
  then: "PI preserved (validates catch-all path)"

- description: "minify preserves DocType via catch-all"
  given: "XML with DocType"
  when: "minify_xml"
  then: "DocType preserved"
```

---

#### AC5: Format and minify operations produce identical preservation of all XML construct types (parity guarantee)

**Coverage: NONE** ❌

**Current State:**
- No parity tests exist between `format_xml` and `minify_xml`
- `format_xml()` has explicit handlers for all event types (lines 43-114)
- `minify_xml()` uses catch-all arm `Ok(event) =>` (lines 180-184) for CData, Comment, Decl, PI, DocType

**Divergence Risk:**
- Explicit vs catch-all handling may produce different outputs
- No tests verify identical construct preservation

**Gap Analysis:**
- No roundtrip parity test: `content_of(format(x)) == content_of(minify(x))`
- Catch-all path in minify never explicitly tested
- No pre/post refactor equivalence tests

**Suggested Tests:**
```yaml
- description: "Format/minify parity for PI"
  given: "XML with PI"
  when: "format_xml and minify_xml"
  then: "Both preserve PI identically"

- description: "Format/minify parity for DocType"
  given: "XML with DocType"
  when: "format_xml and minify_xml"
  then: "Both preserve DocType identically"

- description: "Roundtrip parity"
  given: "Any valid XML with all construct types"
  when: "format → minify → format"
  then: "Result equals format(original)"
```

---

#### AC6: Code follows DRY principles with shared event handling logic (no duplicated event handlers)

**Coverage: NONE** ❌ (Structural)

**Current State:**
- `format_xml()`: Lines 42-116 — explicit handling for all 10 event types (~73 lines)
- `minify_xml()`: Lines 136-189 — explicit handling for 4 event types + catch-all (~53 lines)

**Code Duplication Analysis:**
- Start event handling: ~10 lines duplicated (lines 43-54 vs 137-148)
- End event handling: ~8 lines duplicated (lines 55-62 vs 149-156)
- Empty event handling: ~12 lines duplicated (lines 63-74 vs 157-168)
- Text event handling: ~9 lines duplicated (lines 75-84 vs 169-178)
- **Total duplication: ~60-70 lines (>50%)**

**Gap Analysis:**
- No shared `write_event_to()` helper exists (Task 2 will create it)
- No pre/post refactor equivalence tests exist (Task 1 baseline tests)
- Story requires shared event handling; current code is duplicated

**Verification Strategy:**
1. Pre-refactor: Add snapshot tests comparing format/minify for all constructs
2. Post-refactor: Verify byte-identical output
3. Add roundtrip property test: `format(minify(format(x))) == format(x)`

---

#### AC7: Test coverage includes malformed XML, edge cases, and resource boundary conditions

**Coverage: PARTIAL** ❌

**Existing Tests:**

| Test | Category | Notes |
|------|----------|-------|
| `test_empty_input` | Edge case | Tests empty string returns error |

**Missing Malformed XML Tests (Required by Story):**

| Test | Status | Story Reference |
|------|--------|-----------------|
| Unclosed tag `<root>` | ❌ Missing | Task 4: Malformed XML tests |
| Mismatched `<a></b>` | ❌ Missing | Task 4: Malformed XML tests |
| Invalid attr `<a b>` | ❌ Missing | Task 4: Malformed XML tests |
| Invalid entity `&badref;` | ❌ Missing | Task 4: Malformed XML tests |

**Missing Edge Case Tests (Required by Story):**

| Test | Status | Story Reference |
|------|--------|-----------------|
| Deep nesting (100 levels) | ❌ Missing | Task 4: Edge cases |
| Large attribute (>1KB) | ❌ Missing | Task 4: Edge cases |
| Multiple namespace declarations | ❌ Missing | Task 4: Edge cases |
| XML with BOM | ❌ Missing | Task 4: Edge cases |
| Whitespace-only text nodes | ❌ Missing | Task 4: Edge cases |
| Roundtrip property test | ❌ Missing | Task 4: Property test |
| Minify idempotency test | ❌ Missing | Task 4: Property test |

**Coverage: 1 of 12+ required tests exist (~8%)**

---

#### AC8: Deep nesting at 500 levels either succeeds or returns graceful FormatError (no panic/trap)

**Coverage: NONE** ❌

**Current State:**
- No deep nesting tests exist at any level
- WASM stack overflow behavior is undefined
- No try-catch boundary for graceful degradation

**Gap Analysis:**
- No test at 100 levels (should succeed)
- No test at 500 levels (should succeed OR graceful error)
- No documentation of supported nesting depth

**Suggested Tests:**
```yaml
- description: "Deep nesting 100 levels succeeds"
  given: "100-level nested XML"
  when: "format_xml"
  then: "Success, output has all 100 levels"

- description: "Deep nesting 500 levels graceful"
  given: "500-level nested XML"
  when: "format_xml"
  then: "Either success OR FormatError (no panic/trap)"
```

---

#### AC9: WASM build succeeds with no new warnings

**Coverage: NONE** ❌

**Current State:**
- No automated WASM build test exists
- No CI pipeline verification
- Manual Task 6 requires developer to run `wasm-pack build --target web --release`

**Gap Analysis:**
- No test or script verifies WASM build success
- No warning detection mechanism
- No export verification test

**Suggested Tests:**
```yaml
- description: "WASM build script"
  type: Integration/CI
  command: "wasm-pack build --target web --release 2>&1"
  then: "Exit code 0, no 'warning:' lines in output"

- description: "WASM exports accessible"
  type: Integration
  given: "Built WASM module"
  when: "Load and call js_format_xml, js_minify_xml"
  then: "Functions callable, return expected types"
```

---

### Critical Gaps Summary

| Priority | Gap | Impact | AC |
|----------|-----|--------|-----|
| **P0** | AC3 impossible — all errors return (0,0) | Users cannot debug XML errors | AC3 |
| **P0** | Zero malformed XML tests with position validation | Error handling untested | AC3, AC7 |
| **P1** | No PI/DocType preservation tests | Construct preservation untested | AC4 |
| **P1** | No format/minify parity tests | Divergence risk undetected | AC5 |
| **P1** | No deep nesting tests | Stack overflow risk untested | AC7, AC8 |
| **P1** | No WASM build verification | Build regression risk | AC9 |
| **P2** | No indent structure tests | Format correctness untested | AC1 |
| **P2** | Pre-refactor baseline missing | Refactor regression risk | AC6 |

---

### Test Design Recommendations

Based on gaps identified, the following tests should be added in priority order:

**P0 — Must have before AC3 can pass:**
1. Implement `position_to_line_column()` helper
2. Wire `reader.buffer_position()` into error paths
3. Add error position tests: unclosed tag, mismatched tags, invalid attribute

**P1 — Must have for acceptance:**
4. Add PI preservation test (format + minify)
5. Add DocType preservation test (format + minify)
6. Add format/minify parity tests for all construct types
7. Add deep nesting test (100 levels → success)
8. Add deep nesting stress test (500 levels → success or graceful error)
9. Add WASM build verification script

**P2 — Should have for robustness:**
10. Add indent structure verification tests
11. Add BOM handling test
12. Add large attribute test (1KB+)
13. Add roundtrip property test
14. Add minify idempotency test
15. Add pre-refactor snapshot baseline tests (before Task 2)

---

### Risk Assessment

| Risk Level | ACs | Notes |
|------------|-----|-------|
| **High** | AC3, AC6, AC7, AC8 | AC3 impossible with current code; AC6 structural issue; AC7 has 8% coverage; AC8 untested |
| **Medium** | AC5, AC9 | No parity tests; no build verification |
| **Low** | AC1, AC2, AC4 | Partially covered, need depth and edge cases |

---

### Gate YAML Block

```yaml
trace:
  totals:
    requirements: 9
    full: 0
    partial: 4
    none: 5
  planning_ref: 'docs/qa/assessments/8.1-test-design-20260128.md'
  uncovered:
    - ac: 'AC3'
      reason: 'All FormatError::new() calls hardcode position (0,0); reader.buffer_position() never called'
    - ac: 'AC5'
      reason: 'No parity tests between format_xml and minify_xml'
    - ac: 'AC6'
      reason: 'No shared write_event_to() helper; ~60-70 lines duplicated'
    - ac: 'AC8'
      reason: 'No deep nesting tests at any level (100/500)'
    - ac: 'AC9'
      reason: 'No automated WASM build test exists'
  notes: 'See docs/qa/assessments/8.1-trace-20260128.md'
```

---

### Story Hook Line

```text
Trace matrix: docs/qa/assessments/8.1-trace-20260128.md
```
