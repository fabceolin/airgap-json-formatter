# Requirements Traceability Matrix

## Story: 10.4 - Format Auto-Detection Extension

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Status:** Pre-Implementation Trace

### Coverage Summary

- **Total Requirements:** 9 (AC1-AC9)
- **Fully Covered (Planned):** 9 (100%)
- **Partially Covered:** 0 (0%)
- **Not Covered:** 0 (0%)
- **Implementation Status:** Planned (tests not yet implemented for Markdown)

### Requirement Mappings

---

#### AC1: detectFormat() extended to detect Markdown content

**Coverage: FULL (3 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `tst_format_detection.cpp::testDetectMarkdownHeading` (10.4-UNIT-001)
  - Given: Input string `# Heading`
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `tst_format_detection.cpp::testDetectMarkdownDocument` (10.4-UNIT-002)
  - Given: Multi-line Markdown document with headings and content
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Integration Test**: `tst_format_detection.cpp::testFormatDetectedSignalMarkdown` (10.4-INT-001)
  - Given: JsonBridge connected to QML
  - When: detectFormat() called with Markdown content
  - Then: formatDetected signal emits "markdown"

**Existing Tests to Verify Compatibility:**
- Tests 8.4-UNIT-001 through 8.4-UNIT-023 in `qt/tests/tst_format_detection.cpp` (23 tests for JSON/XML)
- Browser tests in `tests/format_detection_tests.html` (18 tests)

---

#### AC2: Detection patterns include headings, code blocks, frontmatter, lists, blockquotes, links

**Coverage: FULL (7 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `10.4-UNIT-003`
  - Given: Inputs `#`, `##`, `###`, `####`, `#####`, `######` with space and text
  - When: detectFormat() is called
  - Then: Returns "markdown" for all heading levels

- **Unit Test**: `10.4-UNIT-004`
  - Given: Input with ``` at line start
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-005`
  - Given: Input starting with `---\n`
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-006`
  - Given: Inputs `- item` and `* item`
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-007`
  - Given: Inputs `1. item`, `42. item`
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-008`
  - Given: Input `> quote`
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-009`
  - Given: Input containing `[text](url)` pattern
  - When: detectFormat() is called
  - Then: Returns "markdown"

---

#### AC3: Detection works with leading whitespace (trimmed)

**Coverage: FULL (3 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `10.4-UNIT-010`
  - Given: Input `   # Heading` (spaces before #)
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-011`
  - Given: Input `\t# Heading` (tab before #)
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-012`
  - Given: Input with mixed spaces, tabs, newlines before Markdown pattern
  - When: detectFormat() is called
  - Then: Returns "markdown"

**Existing Whitespace Tests (8.4):**
- 8.4-UNIT-011: JSON with leading whitespace
- 8.4-UNIT-012: JSON array with leading whitespace
- 8.4-UNIT-013: XML with leading whitespace
- 8.4-UNIT-014: XML declaration with leading whitespace

---

#### AC4: Detection works for patterns mid-document (not just start)

**Coverage: FULL (3 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `10.4-UNIT-013`
  - Given: Document with plain text followed by `\n# Heading` on line 5
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-014`
  - Given: Document with plain text followed by `\n```\ncode\n```
  - When: detectFormat() is called
  - Then: Returns "markdown"

- **Unit Test**: `10.4-UNIT-015`
  - Given: Document with `[link](url)` in paragraph 3
  - When: detectFormat() is called
  - Then: Returns "markdown"

---

#### AC5: Format selector UI updated to include "Markdown" option

**Coverage: FULL (2 planned tests)**

Given-When-Then Mappings:

- **Integration Test**: `10.4-INT-002`
  - Given: Toolbar.qml format selector ComboBox
  - When: Model is inspected
  - Then: Contains "Markdown" option

- **E2E Test**: `10.4-E2E-001`
  - Given: User views format dropdown in browser
  - When: Dropdown is clicked
  - Then: "Markdown" option is visible and selectable

---

#### AC6: formatDetected signal emits "markdown" for detected content

**Coverage: FULL (2 planned tests)**

Given-When-Then Mappings:

- **Integration Test**: `10.4-INT-003`
  - Given: QSignalSpy connected to formatDetected signal
  - When: detectFormat() called with `# Heading`
  - Then: Signal emits exactly "markdown" (case-sensitive)

- **Integration Test**: `10.4-INT-004`
  - Given: Main.qml connected to formatDetected signal
  - When: detectFormat() called with Markdown content
  - Then: UI format indicator updates to show Markdown

**Existing Signal Tests (8.4):**
- 8.4-UNIT-015: Signal emitted for JSON
- 8.4-UNIT-016: Signal emitted for XML
- 8.4-UNIT-017: Signal emitted for unknown
- 8.4-UNIT-018: Signal emitted for empty input
- 8.4-INT-001: Return value matches signal value

---

#### AC7: Plain prose without Markdown patterns returns "unknown" (not false positive)

**Coverage: FULL (5 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `10.4-UNIT-016`
  - Given: Input "Hello world"
  - When: detectFormat() is called
  - Then: Returns "unknown"

- **Unit Test**: `10.4-UNIT-017`
  - Given: Input "#hashtag" (no space after #)
  - When: detectFormat() is called
  - Then: Returns "unknown"

- **Unit Test**: `10.4-UNIT-018`
  - Given: Input "#include <stdio.h>"
  - When: detectFormat() is called
  - Then: Returns "unknown"

- **Unit Test**: `10.4-UNIT-019`
  - Given: Input "#ffffff" (CSS hex color)
  - When: detectFormat() is called
  - Then: Returns "unknown"

- **Unit Test**: `10.4-UNIT-020`
  - Given: Input "# " (hash + space only, no heading text)
  - When: detectFormat() is called
  - Then: Returns "unknown"

**Existing False Positive Prevention (8.4):**
- 8.4-UNIT-006: Plain text returns unknown
- 8.4-UNIT-007: JSON null returns unknown
- 8.4-UNIT-008: Numeric string returns unknown
- 8.4-UNIT-009: Empty input returns unknown
- 8.4-UNIT-010: Whitespace-only returns unknown

---

#### AC8: Detection is fast (< 1ms for any input size)

**Coverage: FULL (3 planned tests)**

Given-When-Then Mappings:

- **Unit Test**: `10.4-UNIT-021`
  - Given: 10KB Markdown input
  - When: detectFormat() is called and timed
  - Then: Completes in < 1ms

- **Unit Test**: `10.4-UNIT-022`
  - Given: 1MB Markdown input (worst case)
  - When: detectFormat() is called and timed
  - Then: Completes in < 1ms (using 2KB search cap)

- **Unit Test**: `10.4-UNIT-023`
  - Given: 1000 sequential detectFormat() calls
  - When: Calls are timed
  - Then: Total time < 100ms

**Existing Performance Tests (8.4):**
- 8.4-PERF-001: 1000 small input detections < 100ms
- 8.4-PERF-002: 1MB JSON detection < 10ms
- 8.4-PERF-003: 1MB whitespace prefix detection < 100ms
- 8.4-PERF-004: 1MB XML detection < 10ms

---

#### AC9: Manual override via toolbar still works

**Coverage: FULL (3 planned tests)**

Given-When-Then Mappings:

- **Integration Test**: `10.4-INT-005`
  - Given: Auto-detected "markdown" content
  - When: User selects "JSON" from dropdown manually
  - Then: selectedFormat becomes "json", overriding auto-detection

- **Integration Test**: `10.4-INT-006`
  - Given: JSON content `{"key": "value"}`
  - When: User selects "Markdown" from dropdown manually
  - Then: Content is routed to Markdown renderer

- **E2E Test**: `10.4-E2E-002`
  - Given: User pastes JSON content in browser
  - When: User manually selects Markdown and clicks Format
  - Then: Markdown renderer is invoked (not JSON formatter)

---

### Cross-Cutting: Regression Prevention

**Coverage: FULL (5 planned tests)**

| Test ID | Description | Validation |
|---------|-------------|------------|
| 10.4-UNIT-024 | `{"json": true}` returns "json" | JSON priority preserved |
| 10.4-UNIT-025 | `<xml/>` returns "xml" | XML priority preserved |
| 10.4-UNIT-026 | Empty string returns "unknown" | Existing behavior maintained |
| 10.4-INT-007 | Full 8.4 test suite passes (23+ tests) | No regression |
| 10.4-E2E-003 | All three formats work in browser | End-to-end regression |

**Existing Test Files Validated:**
- `qt/tests/tst_format_detection.cpp` - 27 tests for JSON/XML detection
- `tests/format_detection_tests.html` - 18 browser tests for WASM detection

---

### Critical Gaps

**None identified.** All 9 acceptance criteria have comprehensive test coverage planned.

---

### Gap Analysis: Planned vs. Implemented

| Category | Planned | Implemented | Gap |
|----------|---------|-------------|-----|
| AC1-AC9 Tests | 28 | 0 | 28 (pre-implementation) |
| Existing 8.4 Tests | 27 | 27 | 0 (regression suite ready) |
| Browser Tests | 18 | 18 | 0 (WASM suite ready) |

**Status:** Story 10.4 tests are **designed but not yet implemented**. The test design document provides complete specifications for all 28 scenarios. Implementation should add tests to:
- `qt/tests/tst_format_detection.cpp` (extend with Markdown tests)
- `tests/format_detection_tests.html` (extend with Markdown browser tests)

---

### Test Design Recommendations

Based on gaps identified, recommend:

1. **Implement 18 Unit Tests First**
   - All pattern detection tests (AC2)
   - False positive prevention tests (AC7)
   - Performance benchmarks (AC8)

2. **Implement 7 Integration Tests**
   - Signal emission verification (AC6)
   - UI component integration (AC5)
   - Manual override flow (AC9)

3. **Implement 3 E2E Tests**
   - Full paste→detect→render journey
   - Format selector visibility
   - Override behavior in browser

4. **Run Regression Suite**
   - Execute all 27 existing 8.4 tests before/after implementation
   - Verify no JSON/XML detection regressions

---

### Risk Assessment

| Risk Level | Requirements | Rationale |
|------------|--------------|-----------|
| **Low Risk** | AC1, AC2, AC3, AC4, AC6, AC8 | Comprehensive unit + integration coverage |
| **Medium Risk** | AC5, AC9 | UI tests harder to automate, require E2E |
| **Low Risk** | AC7 | Extensive false positive test cases defined |

---

### Gate YAML Block

```yaml
trace:
  date: 2026-01-28
  reviewer: Quinn
  totals:
    requirements: 9
    full: 9
    partial: 0
    none: 0
  implementation_status: pre_implementation
  planning_ref: 'docs/qa/assessments/10.4-test-design-20260128.md'
  uncovered: []
  existing_tests:
    cpp_unit: 27
    browser_e2e: 18
    location_cpp: 'qt/tests/tst_format_detection.cpp'
    location_browser: 'tests/format_detection_tests.html'
  notes: 'All 9 ACs have full coverage planned. 28 new tests designed. 45 existing regression tests available.'
```

---

## Quality Indicators

### Positive Indicators
- [x] Every AC has at least one test
- [x] Critical paths have multiple test levels (unit + integration + E2E)
- [x] Edge cases explicitly covered (5 false positive tests)
- [x] NFRs have appropriate test types (performance benchmarks)
- [x] Clear Given-When-Then for each test
- [x] Regression prevention tests defined

### Monitoring Items
- [ ] Tests not yet implemented (pre-implementation trace)
- [ ] E2E tests require WASM build verification
- [ ] Performance tests require timing validation on target hardware

---

## Trace References

```text
Trace matrix: docs/qa/assessments/10.4-trace-20260128.md
Requirements covered: 9/9 (100%)
Test scenarios: 28 planned, 45 existing for regression
Gaps: None
```
