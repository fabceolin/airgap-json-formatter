# Requirements Traceability Matrix

## Story: 10.3 - Bridge Layer Markdown Methods

**Assessment Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Story Status:** Draft (Implementation In Progress)

### Coverage Summary

- **Total Requirements:** 8 Acceptance Criteria
- **Fully Covered:** 3 (37.5%)
- **Partially Covered:** 4 (50%)
- **Not Covered:** 1 (12.5%)

### Implementation Status Overview

| Component | Status | Notes |
|-----------|--------|-------|
| Rust renderMarkdown (10.1 dependency) | IMPLEMENTED | `src/markdown_renderer.rs` - Full GFM support |
| JS renderMermaid (10.2 dependency) | IMPLEMENTED | `public/bridge.js:428-474` - Full implementation |
| JS renderMarkdown | NOT IMPLEMENTED | Missing from bridge.js |
| JS renderMarkdownWithMermaid | NOT IMPLEMENTED | Missing from bridge.js |
| C++ markdownRendered signal | NOT IMPLEMENTED | Missing from jsonbridge.h |
| C++ markdownRenderError signal | NOT IMPLEMENTED | Missing from jsonbridge.h |
| C++ renderMermaid | IMPLEMENTED | `qt/jsonbridge.cpp:1016-1073` |

---

### Requirement Mappings

#### AC1: `renderMarkdown(input)` method added to bridge.js

**Coverage: NONE**

The `renderMarkdown` JavaScript wrapper method is **not yet implemented** in `bridge.js`. The story spec provides implementation details but the actual code is missing.

**Required Implementation:**
- File: `public/bridge.js`
- Function signature: `renderMarkdown(input)` returning `{ success: true, html: "..." }` or `{ success: false, error: "..." }`
- Must call `wasmModule.renderMarkdown()`

**Dependency Status:**
- WASM export `js_render_markdown` exists in `src/lib.rs:266-280`
- Rust implementation complete in `src/markdown_renderer.rs`

**Gap:**
- Missing JavaScript bridge method

---

#### AC2: `renderMermaid(code)` method added to bridge.js

**Coverage: FULL**

**Implementation Files:**
- `public/bridge.js:428-474` - `renderMermaid()` async function

**Test Mappings:**

| Test File | Test Case | Coverage |
|-----------|-----------|----------|
| `tests/mermaid_tests.html` | 10.2-UNIT-006 | Given: Valid diagram code<br>When: renderMermaid called<br>Then: Returns `{ success: true, svg: "..." }` |
| `tests/mermaid_tests.html` | 10.2-UNIT-009 | Given: Incomplete syntax<br>When: renderMermaid called<br>Then: Returns `{ success: false, error: "..." }` |
| `tests/mermaid_tests.html` | 10.2-UNIT-010 | Given: Malformed input<br>When: renderMermaid called<br>Then: Returns error with details |
| `tests/mermaid_tests.html` | 10.2-UNIT-011 | Given: Empty string<br>When: renderMermaid called<br>Then: Returns error for empty input |

---

#### AC3: `renderMarkdownWithMermaid(input)` combined method added

**Coverage: NONE**

The combined method is **not yet implemented**. Story spec provides pseudo-code but actual implementation is missing.

**Required Implementation:**
- File: `public/bridge.js`
- Async function that:
  1. Calls `renderMarkdown()` to convert MD to HTML
  2. Finds `<pre><code class="language-mermaid">` blocks
  3. Extracts Mermaid code from each block
  4. Calls `renderMermaid()` for each block
  5. Replaces blocks with SVG output
  6. Returns complete HTML with embedded SVGs

**Gap:**
- Missing combined method implementation
- Missing HTML entity decoder helper

---

#### AC4: All methods integrate with AsyncSerialiser pattern

**Coverage: PARTIAL**

**Implemented:**
- C++ `JsonBridge::renderMermaid()` uses AsyncSerialiser (`qt/jsonbridge.cpp:1018`)
- Existing JSON methods (formatJson, minifyJson) demonstrate pattern

**Test Mappings:**

| Test File | Test Case | Coverage |
|-----------|-----------|----------|
| `qt/tests/tst_mermaid.cpp` | testRenderMermaidUsesAsyncSerialiser | Given: renderMermaid called<br>When: Task enqueued<br>Then: taskStarted signal emitted with "renderMermaid" |
| `qt/tests/tst_mermaid.cpp` | testRenderMermaidSerialExecution | Given: 3 rapid renderMermaid calls<br>When: Queue processed<br>Then: All execute serially |

**Gap:**
- JS `renderMarkdown` not integrated (method doesn't exist)
- JS `renderMarkdownWithMermaid` not integrated (method doesn't exist)
- C++ `requestRenderMarkdown` not implemented

---

#### AC5: JsonBridge C++ class updated with signals

**Coverage: PARTIAL**

**Implemented Signals:**
- `renderMermaidCompleted(QVariantMap)` in `jsonbridge.h:70`

**Missing Signals (per story spec):**
- `markdownRendered(QString html)` - Not implemented
- `markdownRenderError(QString error)` - Not implemented

**Missing Q_INVOKABLE Methods:**
- `requestRenderMarkdown(const QString &input)` - Not implemented
- `requestRenderMarkdownWithMermaid(const QString &input, bool darkTheme)` - Not implemented

**Gap:**
- Only Mermaid signals exist; Markdown-specific signals missing

---

#### AC6: Methods handle null/undefined input gracefully

**Coverage: PARTIAL**

**Implemented:**
- `renderMermaid()` in bridge.js validates input at lines 437-439
- Rust `render_markdown()` handles empty input gracefully

**Test Mappings:**

| Test File | Test Case | Coverage |
|-----------|-----------|----------|
| `tests/mermaid_tests.html` | 10.2-UNIT-011 | Given: Empty string<br>When: renderMermaid called<br>Then: Returns `{ success: false, error: "Empty or invalid diagram code" }` |
| `src/markdown_renderer.rs` | test_empty_input | Given: Empty string<br>When: render_markdown called<br>Then: Returns Ok("") |

**Gap:**
- JS `renderMarkdown` null handling untested (method not implemented)
- JS `renderMarkdownWithMermaid` null handling untested (method not implemented)

---

#### AC7: Large documents (500KB) don't block UI

**Coverage: PARTIAL**

**Implemented:**
- Rust `render_markdown` has 2MB input size guard (`MAX_INPUT_SIZE`)
- Rust performance test validates 500KB < 500ms
- AsyncSerialiser prevents concurrent WASM suspensions

**Test Mappings:**

| Test File | Test Case | Coverage |
|-----------|-----------|----------|
| `src/markdown_renderer.rs` | test_500kb_document_performance | Given: 500KB Markdown<br>When: render_markdown called<br>Then: Completes in <500ms |
| `tests/mermaid_tests.html` | 10.2-PERF-001 | Given: Simple diagram<br>When: renderMermaid called<br>Then: Completes in <500ms |
| `tests/mermaid_tests.html` | 10.2-PERF-002 | Given: 20-node complex diagram<br>When: renderMermaid called<br>Then: Completes in <500ms |

**Gap:**
- No E2E test for 500KB Markdown + 5 Mermaid diagrams combined
- No UI responsiveness test during large document render
- No C++ side performance test

---

#### AC8: Methods work correctly with theme parameter (dark/light)

**Coverage: PARTIAL**

**Implemented:**
- `renderMermaid()` accepts theme parameter (default 'dark')
- `setMermaidTheme()` applies theme configuration
- `getMermaidThemeConfig()` returns dark/light theme variables
- C++ `renderMermaid()` passes theme to JS

**Test Mappings:**

| Test File | Test Case | Coverage |
|-----------|-----------|----------|
| `qt/tests/tst_mermaid.cpp` | testRenderMermaidThemeParameter | Given: Dark/light theme<br>When: renderMermaid called<br>Then: Signal emitted for both |
| `qt/tests/tst_mermaid.cpp` | testRenderMermaidDefaultTheme | Given: No theme specified<br>When: renderMermaid called<br>Then: Defaults to dark |
| `tests/mermaid_tests.html` | 10.2-E2E-005 | Given: 'dark' theme<br>When: renderMermaid called<br>Then: Renders successfully |
| `tests/mermaid_tests.html` | 10.2-E2E-005b | Given: 'light' theme<br>When: renderMermaid called<br>Then: Renders successfully |

**Gap:**
- `renderMarkdownWithMermaid` theme passthrough untested (method not implemented)

---

### Critical Gaps

#### 1. Missing JavaScript Bridge Methods (HIGH PRIORITY)

**Gap:** The core deliverables `renderMarkdown()` and `renderMarkdownWithMermaid()` are not implemented in `bridge.js`.

**Risk:** HIGH - Story cannot pass acceptance criteria without these methods.

**Action:**
- Implement `renderMarkdown()` per story spec
- Implement `renderMarkdownWithMermaid()` per story spec
- Add HTML entity decoder helper

**Suggested Tests:**

| Type | Description | Given-When-Then |
|------|-------------|-----------------|
| Unit | renderMarkdown valid input | Given: `# Hello`<br>When: renderMarkdown called<br>Then: Returns `{ success: true, html: "<h1>Hello</h1>" }` |
| Unit | renderMarkdown null input | Given: `null`<br>When: renderMarkdown called<br>Then: Returns `{ success: true, html: "" }` |
| Unit | renderMarkdown WASM error | Given: WASM not initialized<br>When: renderMarkdown called<br>Then: Returns `{ success: false, error: "WASM not initialized" }` |
| Integration | Combined MD + Mermaid | Given: MD with mermaid block<br>When: renderMarkdownWithMermaid called<br>Then: Returns HTML with embedded SVG |
| Integration | Partial failure | Given: MD with valid + invalid mermaid<br>When: renderMarkdownWithMermaid called<br>Then: Returns HTML with warnings array |

#### 2. Missing C++ Signals (MEDIUM PRIORITY)

**Gap:** `markdownRendered` and `markdownRenderError` signals not in `jsonbridge.h`.

**Risk:** MEDIUM - QML cannot react to Markdown render results without these signals.

**Action:**
- Add `markdownRendered(const QString &html)` signal
- Add `markdownRenderError(const QString &error)` signal
- Add `requestRenderMarkdown()` Q_INVOKABLE method
- Add `requestRenderMarkdownWithMermaid()` Q_INVOKABLE method

#### 3. Combined Performance Test (LOW PRIORITY)

**Gap:** No test for 500KB Markdown + 5 Mermaid diagrams completing in <2000ms.

**Risk:** LOW - Individual components tested, combined may have different characteristics.

**Action:** Add integration test per NFR assessment recommendations.

---

### Test Design Recommendations

Based on gaps identified, recommend:

#### Additional Test Scenarios Needed

| ID | Type | Scenario | Priority |
|----|------|----------|----------|
| 10.3-UNIT-001 | Unit | renderMarkdown valid input | P0 |
| 10.3-UNIT-002 | Unit | renderMarkdown null/undefined | P0 |
| 10.3-UNIT-003 | Unit | renderMarkdown WASM not init | P0 |
| 10.3-UNIT-004 | Unit | renderMarkdown empty string | P0 |
| 10.3-INT-001 | Integration | renderMarkdownWithMermaid single diagram | P0 |
| 10.3-INT-002 | Integration | renderMarkdownWithMermaid multiple diagrams | P0 |
| 10.3-INT-003 | Integration | renderMarkdownWithMermaid no diagrams | P1 |
| 10.3-INT-004 | Integration | renderMarkdownWithMermaid partial failure | P0 |
| 10.3-INT-005 | Integration | renderMarkdownWithMermaid theme passthrough | P1 |
| 10.3-E2E-001 | E2E | C++ signal flow markdownRendered | P0 |
| 10.3-E2E-002 | E2E | C++ signal flow markdownRenderError | P0 |
| 10.3-PERF-001 | Performance | 500KB + 5 diagrams < 2000ms | P1 |

#### Test Data Requirements

1. **Markdown Files:**
   - `basic.md` - Simple heading/paragraph
   - `single-mermaid.md` - One diagram
   - `multi-mermaid.md` - 5+ diagrams
   - `mixed-valid-invalid.md` - Valid MD + invalid diagram

2. **Mock/Stub Strategy:**
   - For C++ unit tests: Mock JavaScript bridge
   - For JS unit tests: Mock WASM module

---

### Risk Assessment Summary

| Risk Level | Count | Requirements |
|------------|-------|--------------|
| HIGH | 2 | AC1 (renderMarkdown), AC3 (combined method) |
| MEDIUM | 2 | AC5 (C++ signals), AC6 (null handling) |
| LOW | 4 | AC2, AC4, AC7, AC8 |

---

### Gate YAML Block

```yaml
trace:
  totals:
    requirements: 8
    full: 3
    partial: 4
    none: 1
  planning_ref: 'docs/qa/assessments/10.3-test-design-20260128.md'
  uncovered:
    - ac: 'AC1'
      reason: 'renderMarkdown() not implemented in bridge.js'
    - ac: 'AC3'
      reason: 'renderMarkdownWithMermaid() not implemented in bridge.js'
    - ac: 'AC5'
      reason: 'markdownRendered/markdownRenderError signals missing from jsonbridge.h'
  notes: 'docs/qa/assessments/10.3-trace-20260128.md'
```

---

### Conclusion

Story 10.3 has significant implementation gaps:

1. **Dependencies (10.1, 10.2) are complete** - Rust Markdown renderer and Mermaid.js integration work correctly
2. **Core deliverables missing** - The JavaScript bridge methods (`renderMarkdown`, `renderMarkdownWithMermaid`) are not implemented
3. **C++ integration incomplete** - Markdown-specific signals and Q_INVOKABLE methods not added

**Gate Recommendation:** **CONCERNS** - Cannot pass until AC1, AC3, and AC5 are implemented and tested.

**Trace Matrix:** docs/qa/assessments/10.3-trace-20260128.md
