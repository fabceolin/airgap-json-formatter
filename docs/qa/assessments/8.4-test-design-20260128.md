# Test Design: Story 8.4

**Title:** Format Auto-Detection
**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios:** 23
- **Unit tests:** 14 (61%)
- **Integration tests:** 6 (26%)
- **E2E tests:** 3 (13%)
- **Priority distribution:** P0: 9, P1: 10, P2: 4

### Strategy Rationale

Format auto-detection is a pure logic feature with a simple algorithm (first-character inspection after whitespace trim). The test strategy shifts heavily left toward unit tests because:

1. **Detection algorithm is pure function** - No side effects, deterministic output
2. **Edge cases are well-documented** - Story defines expected behavior table
3. **Performance requirement is testable in isolation** - <1ms can be verified without UI
4. **Integration points are limited** - Signal emission, property binding, button routing

## Test Scenarios by Acceptance Criteria

### AC1: Format auto-detected when content is pasted into input pane

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-INT-001 | Integration | P0 | Paste JSON triggers detection and updates `detectedFormat` | Validates paste-to-detection flow | TECH-002 |
| 8.4-INT-002 | Integration | P0 | Paste XML triggers detection and updates `detectedFormat` | Validates XML detection on paste | TECH-002 |
| 8.4-E2E-001 | E2E | P1 | User pastes mixed whitespace + JSON, detects correctly | End-to-end paste workflow | TECH-001 |

### AC2: Format auto-detected when Format button is clicked

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-INT-003 | Integration | P0 | Click Format with JSON input calls `formatJson()` | Button routing correctness | DATA-001 |
| 8.4-INT-004 | Integration | P0 | Click Format with XML input calls `formatXml()` | XML routing correctness | DATA-001 |
| 8.4-INT-005 | Integration | P1 | Click Minify with detected format routes correctly | Minify shares detection logic | - |

### AC3: Detection logic: `<` prefix = XML, `{` or `[` prefix = JSON

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-UNIT-001 | Unit | P0 | `{"a":1}` → "json" | Core JSON object detection | TECH-001 |
| 8.4-UNIT-002 | Unit | P0 | `[1,2,3]` → "json" | Core JSON array detection | TECH-001 |
| 8.4-UNIT-003 | Unit | P0 | `<root/>` → "xml" | Core XML detection | TECH-001 |
| 8.4-UNIT-004 | Unit | P1 | `<?xml version="1.0"?>` → "xml" | XML declaration prefix | TECH-001 |
| 8.4-UNIT-005 | Unit | P1 | `<!DOCTYPE html>` → "xml" | HTML doctype (< prefix) | TECH-001 |

### AC4: Unknown format handled gracefully

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-UNIT-006 | Unit | P0 | `hello world` → "unknown" | Plain text fallback | TECH-001 |
| 8.4-UNIT-007 | Unit | P1 | `null` → "unknown" | JSON primitive (ambiguous) | TECH-001 |
| 8.4-UNIT-008 | Unit | P1 | `123` → "unknown" | Numeric literal | TECH-001 |
| 8.4-UNIT-009 | Unit | P0 | Unknown format defaults to JSON on Format click | Safe fallback behavior | DATA-001 |
| 8.4-E2E-002 | E2E | P2 | User types plain text, clicks Format, gets JSON parse error | Graceful error UX | BUS-001 |

### AC5: `formatDetected` signal emitted with detected format

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-UNIT-010 | Unit | P1 | Signal emits "json" for JSON input | Signal emission correctness | TECH-002 |
| 8.4-UNIT-011 | Unit | P1 | Signal emits "xml" for XML input | Signal emission correctness | TECH-002 |
| 8.4-UNIT-012 | Unit | P1 | Signal emits "unknown" for unknown input | Signal emission correctness | TECH-002 |
| 8.4-INT-006 | Integration | P1 | QML receives signal and updates property | Signal→property binding | TECH-002 |

### AC6: Detection works for content with leading whitespace

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-UNIT-013 | Unit | P0 | `  \n\t{"a":1}` → "json" | Whitespace before JSON | TECH-001 |
| 8.4-UNIT-014 | Unit | P0 | `  \n\t<root/>` → "xml" | Whitespace before XML | TECH-001 |
| 8.4-UNIT-015 | Unit | P1 | Empty string → "unknown" | Edge case | TECH-001 |
| 8.4-UNIT-016 | Unit | P1 | Whitespace-only string → "unknown" | Edge case | TECH-001 |

### AC7: Detection is fast (< 1ms for any input size)

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 8.4-PERF-001 | Unit | P1 | 1KB input completes < 1ms | Small input baseline | TECH-003 |
| 8.4-PERF-002 | Unit | P2 | 1MB input completes < 1ms | Large input performance | TECH-003, PERF-001 |
| 8.4-PERF-003 | Unit | P2 | 1MB whitespace prefix + `{` completes < 1ms | Worst-case trimmed() | PERF-001 |
| 8.4-E2E-003 | E2E | P2 | Paste 1MB JSON, no UI freeze | Real-world performance | TECH-003 |

## Risk Coverage Matrix

| Risk ID | Description | Test Coverage |
|---------|-------------|---------------|
| TECH-001 | Detection edge cases | 8.4-UNIT-001 through 016 (all edge cases) |
| TECH-002 | Signal/property sync race | 8.4-INT-001, 002, 006, 8.4-UNIT-010-012 |
| TECH-003 | QML binding performance | 8.4-PERF-001, 002, 003, 8.4-E2E-003 |
| PERF-001 | Large input trimmed() overhead | 8.4-PERF-002, 003 |
| DATA-001 | Detected ≠ valid format | 8.4-UNIT-009, 8.4-INT-003, 004 |
| BUS-001 | User expects smarter detection | 8.4-E2E-002 (documents limitation via error) |
| OPS-001 | Optional UI indicator | Not tested (optional feature) |

## Test Data Requirements

### Core Detection Data

| ID | Input | Expected Output | Category |
|----|-------|-----------------|----------|
| TD-001 | `{"key": "value"}` | "json" | JSON object |
| TD-002 | `[1, 2, 3]` | "json" | JSON array |
| TD-003 | `<root><child/></root>` | "xml" | XML nested |
| TD-004 | `<?xml version="1.0"?><root/>` | "xml" | XML with declaration |
| TD-005 | `<!DOCTYPE html>` | "xml" | HTML doctype |
| TD-006 | `hello world` | "unknown" | Plain text |
| TD-007 | `null` | "unknown" | JSON primitive |
| TD-008 | `123` | "unknown" | Numeric |
| TD-009 | `"string"` | "unknown" | Quoted string |
| TD-010 | `` (empty) | "unknown" | Empty |
| TD-011 | `   ` | "unknown" | Whitespace only |
| TD-012 | `  \n\t{"a":1}` | "json" | Whitespace + JSON |
| TD-013 | `\n\n<root/>` | "xml" | Newlines + XML |

### Performance Test Data

| ID | Size | Content | Purpose |
|----|------|---------|---------|
| TD-PERF-001 | 1KB | Valid JSON object | Baseline |
| TD-PERF-002 | 1MB | Valid JSON object | Large input |
| TD-PERF-003 | 1MB | Whitespace prefix + `{` | Worst-case trim |
| TD-PERF-004 | 1MB | Valid XML document | Large XML |

### Test Data Generation

```cpp
// Generate 1MB JSON for performance tests
QString generateLargeJson(int sizeBytes) {
    QString result = "{\"data\": \"";
    result += QString(sizeBytes - 15, 'x');
    result += "\"}";
    return result;
}

// Generate 1MB whitespace prefix
QString generateWhitespacePrefix(int sizeBytes) {
    return QString(sizeBytes, ' ') + "{";
}
```

## Environment Requirements

### Unit Test Environment

- **Framework:** Qt Test (QTest)
- **Location:** `qt/tests/tst_format_detection.cpp`
- **Build:** `cmake .. && make`
- **Run:** `./tests/tst_format_detection`
- **Dependencies:** JsonBridge class

### Integration Test Environment

- **Framework:** Qt Test with QML
- **Location:** `qt/tests/tst_format_detection_qml.cpp` (if needed)
- **Dependencies:** Full Qt application context, JsonBridge, QML Main.qml
- **Mocking:** None required (testing real signal/slot connections)

### E2E Test Environment

- **Platform:** Desktop (native) or Browser (WASM)
- **Method:** Manual testing or automated UI test framework
- **Data:** Prepared paste fixtures (JSON, XML, unknown)

## Recommended Execution Order

1. **P0 Unit tests (fail fast):** 8.4-UNIT-001, 002, 003, 006, 009, 013, 014
2. **P0 Integration tests:** 8.4-INT-001, 002, 003, 004
3. **P1 Unit tests:** 8.4-UNIT-004, 005, 007, 008, 010, 011, 012, 015, 016
4. **P1 Integration/Performance:** 8.4-INT-005, 006, 8.4-PERF-001
5. **P1 E2E:** 8.4-E2E-001
6. **P2 Performance:** 8.4-PERF-002, 003, 8.4-E2E-002, 003

## Test Implementation Notes

### Unit Test Structure

```cpp
class TestFormatDetection : public QObject
{
    Q_OBJECT
private:
    JsonBridge *bridge;

private slots:
    void initTestCase() { bridge = new JsonBridge(); }
    void cleanupTestCase() { delete bridge; }

    // AC3: Core detection
    void testJsonObject();           // 8.4-UNIT-001
    void testJsonArray();            // 8.4-UNIT-002
    void testXmlElement();           // 8.4-UNIT-003

    // AC4: Unknown handling
    void testPlainText();            // 8.4-UNIT-006
    void testJsonPrimitive();        // 8.4-UNIT-007

    // AC6: Whitespace handling
    void testWhitespaceJson();       // 8.4-UNIT-013
    void testWhitespaceXml();        // 8.4-UNIT-014
    void testEmpty();                // 8.4-UNIT-015

    // AC7: Performance
    void testPerformanceSmall();     // 8.4-PERF-001
    void testPerformanceLarge();     // 8.4-PERF-002
};
```

### Performance Test Approach

```cpp
void TestFormatDetection::testPerformanceLarge()
{
    QString largeJson = generateLargeJson(1024 * 1024); // 1MB

    QElapsedTimer timer;
    timer.start();

    QString result = bridge->detectFormat(largeJson);

    qint64 elapsed = timer.nsecsElapsed() / 1000000.0; // Convert to ms

    QCOMPARE(result, QStringLiteral("json"));
    QVERIFY2(elapsed < 1, qPrintable(QString("Detection took %1ms, expected < 1ms").arg(elapsed)));
}
```

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 23
  by_level:
    unit: 14
    integration: 6
    e2e: 3
  by_priority:
    p0: 9
    p1: 10
    p2: 4
  coverage_gaps: []
  ac_coverage:
    ac1: [8.4-INT-001, 8.4-INT-002, 8.4-E2E-001]
    ac2: [8.4-INT-003, 8.4-INT-004, 8.4-INT-005]
    ac3: [8.4-UNIT-001, 8.4-UNIT-002, 8.4-UNIT-003, 8.4-UNIT-004, 8.4-UNIT-005]
    ac4: [8.4-UNIT-006, 8.4-UNIT-007, 8.4-UNIT-008, 8.4-UNIT-009, 8.4-E2E-002]
    ac5: [8.4-UNIT-010, 8.4-UNIT-011, 8.4-UNIT-012, 8.4-INT-006]
    ac6: [8.4-UNIT-013, 8.4-UNIT-014, 8.4-UNIT-015, 8.4-UNIT-016]
    ac7: [8.4-PERF-001, 8.4-PERF-002, 8.4-PERF-003, 8.4-E2E-003]
  risk_coverage:
    - TECH-001: 16 tests
    - TECH-002: 6 tests
    - TECH-003: 4 tests
    - PERF-001: 2 tests
    - DATA-001: 3 tests
    - BUS-001: 1 test
    - OPS-001: 0 tests (optional feature)
```

---

Test design matrix: docs/qa/assessments/8.4-test-design-20260128.md
P0 tests identified: 9
