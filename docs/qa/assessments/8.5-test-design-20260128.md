# Test Design: Story 8.5 - Toolbar Format Selector

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** Toolbar Format Selector
**Status:** YOLO Mode - Comprehensive Test Design

## Test Strategy Overview

- **Total test scenarios:** 18
- **Unit tests:** 5 (28%)
- **Integration tests:** 8 (44%)
- **E2E tests:** 5 (28%)
- **Priority distribution:** P0: 4, P1: 9, P2: 5

### Test Level Rationale

This story involves UI component behavior with state management. The test distribution favors integration tests because:
1. Core functionality is UI state synchronization (format detection ↔ manual override)
2. Component interactions between Toolbar.qml ↔ Main.qml are critical
3. E2E tests validate keyboard accessibility and visual consistency

## Test Scenarios by Acceptance Criteria

### AC1: Format indicator shows current detected format (JSON/XML/Unknown)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-UNIT-001 | Unit | P1 | displayText computation for "json" → "JSON (auto)" | Pure logic transformation |
| 8.5-UNIT-002 | Unit | P1 | displayText computation for "xml" → "XML (auto)" | Pure logic transformation |
| 8.5-UNIT-003 | Unit | P1 | displayText computation for "unknown" → "Auto" | Pure logic transformation |
| 8.5-INT-001 | Integration | P0 | Format indicator updates when detectedFormat property changes | Property binding verification |
| 8.5-INT-002 | Integration | P1 | Format indicator reflects Main.qml detection result | Cross-component data flow |

**Test Data Requirements:**
- JSON input: `{"key": "value"}`
- XML input: `<root><child/></root>`
- Unknown input: `hello world`

---

### AC2: Format can be manually selected via dropdown

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-INT-003 | Integration | P0 | ComboBox model contains ["Auto", "JSON", "XML"] | Component configuration |
| 8.5-E2E-001 | E2E | P1 | User clicks dropdown and sees all format options | User interaction flow |
| 8.5-E2E-002 | E2E | P1 | User selects "JSON" from dropdown | User interaction flow |
| 8.5-E2E-003 | E2E | P1 | User selects "XML" from dropdown | User interaction flow |

---

### AC3: Manual selection overrides auto-detection

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-UNIT-004 | Unit | P0 | effectiveFormat returns "json" when currentIndex=1 | Pure logic |
| 8.5-UNIT-005 | Unit | P0 | effectiveFormat returns "xml" when currentIndex=2 | Pure logic |
| 8.5-INT-004 | Integration | P0 | Manual "XML" selection used for format operation despite JSON input | Override precedence |
| 8.5-INT-005 | Integration | P1 | formatSelected signal emits correct format after manual selection | Signal verification |

**Critical Test Case:**
```
Given: JSON input is detected
When: User manually selects "XML"
Then: Format button triggers XML formatter (not JSON)
```

---

### AC4: Visual styling matches existing toolbar components

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-INT-006 | Integration | P2 | formatCombo implicitWidth matches indentCombo | Style consistency |
| 8.5-INT-007 | Integration | P2 | formatCombo border.color uses Theme.border | Theme integration |
| 8.5-E2E-004 | E2E | P2 | Visual comparison with indentCombo in light theme | Visual regression |
| 8.5-E2E-005 | E2E | P2 | Visual comparison with indentCombo in dark theme | Visual regression |

---

### AC5: Format selection persists until input changes or manual clear

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-INT-008 | Integration | P1 | Manual selection persists after format operation | State persistence |
| 8.5-INT-009 | Integration | P1 | Clear button resets to "Auto" mode | State reset trigger |
| 8.5-INT-010 | Integration | P1 | Input change does NOT reset manual selection | State persistence |
| 8.5-INT-011 | Integration | P2 | Input cleared to empty resets to "Auto" mode | Edge case handling |

**Edge Case Scenarios:**
1. User selects "JSON" manually, then types more content → stays "JSON"
2. User selects "XML" manually, clicks Clear → returns to "Auto"
3. User backspaces all content → returns to "Auto"

---

### AC6: Tooltip explains auto-detection and override behavior

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-INT-012 | Integration | P2 | ToolTip.text matches expected message | Component property |
| 8.5-INT-013 | Integration | P2 | ToolTip.delay is 500ms | Component property |

**Expected Tooltip Text:** "Format is auto-detected. Select manually to override."

---

### AC7: Keyboard accessible (Tab navigation, Enter to select)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.5-INT-014 | Integration | P1 | focusPolicy is Qt.StrongFocus | Component property |
| 8.5-E2E-006 | E2E | P1 | Tab key navigates to format ComboBox | Keyboard navigation |
| 8.5-E2E-007 | E2E | P1 | Enter/Space opens dropdown when focused | Keyboard activation |
| 8.5-E2E-008 | E2E | P1 | Arrow keys navigate dropdown options | Keyboard navigation |

## Risk Coverage Mapping

| Risk ID | Risk Title | Test Coverage |
|---------|------------|---------------|
| TECH-001 | Format state sync race conditions | 8.5-INT-004, 8.5-INT-005, 8.5-INT-008 |
| TECH-003 | Property binding complexity | 8.5-INT-001, 8.5-INT-002 |
| OPS-001 | Reset behavior edge cases | 8.5-INT-009, 8.5-INT-010, 8.5-INT-011 |
| TECH-002 | ComboBox styling inconsistency | 8.5-INT-006, 8.5-INT-007, 8.5-E2E-004, 8.5-E2E-005 |
| BUS-001 | User confusion with override | 8.5-INT-012, 8.5-INT-013 |

## Test Data Requirements

### Input Data Sets

| ID | Type | Content | Purpose |
|----|------|---------|---------|
| TD-001 | Valid JSON | `{"key": "value", "nested": {"a": 1}}` | Auto-detection JSON |
| TD-002 | Valid XML | `<?xml version="1.0"?><root><child attr="val"/></root>` | Auto-detection XML |
| TD-003 | Invalid/Unknown | `hello world 123` | Unknown format handling |
| TD-004 | Empty | `` | Reset trigger |
| TD-005 | JSON array | `[1, 2, 3]` | JSON variant |
| TD-006 | XML minimal | `<r/>` | XML variant |

### Environment Requirements

- Qt 6.x with QML Quick Controls 2
- Both light and dark themes available
- Keyboard input simulation capability
- Focus tracking for accessibility tests

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on logic)
   - 8.5-UNIT-004, 8.5-UNIT-005

2. **P0 Integration tests** (core functionality)
   - 8.5-INT-001, 8.5-INT-003, 8.5-INT-004

3. **P1 Unit tests**
   - 8.5-UNIT-001, 8.5-UNIT-002, 8.5-UNIT-003

4. **P1 Integration tests**
   - 8.5-INT-002, 8.5-INT-005, 8.5-INT-008, 8.5-INT-009, 8.5-INT-010, 8.5-INT-014

5. **P1 E2E tests**
   - 8.5-E2E-001, 8.5-E2E-002, 8.5-E2E-003, 8.5-E2E-006, 8.5-E2E-007, 8.5-E2E-008

6. **P2 tests** (as time permits)
   - 8.5-INT-006, 8.5-INT-007, 8.5-INT-011, 8.5-INT-012, 8.5-INT-013, 8.5-E2E-004, 8.5-E2E-005

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 5
    integration: 8
    e2e: 5
  by_priority:
    p0: 4
    p1: 9
    p2: 5
  coverage_gaps: []
  risk_mitigation:
    covered: [TECH-001, TECH-002, TECH-003, OPS-001, BUS-001]
    uncovered: []
```

## Quality Checklist

- [x] Every AC has test coverage (7/7 ACs covered)
- [x] Test levels are appropriate (shifted left where possible)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (8.5-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] Risk mitigations addressed (5/5 risks covered)

## Trace Reference

Test design matrix: `docs/qa/assessments/8.5-test-design-20260128.md`
P0 tests identified: 4
