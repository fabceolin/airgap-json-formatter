# Test Design: Story 8.1 - Productionize XML Formatter

Date: 2026-01-28 (Updated)
Designer: Quinn (Test Architect)
Assessment Mode: YOLO (Non-interactive)

## Test Strategy Overview

- Total test scenarios: 34
- Unit tests: 28 (82%)
- Integration tests: 6 (18%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 8, P1: 16, P2: 10

**Rationale**: XML formatting is pure transformation logic with no external dependencies, so unit tests dominate. Integration tests cover WASM build verification and export functionality. No E2E needed since there is no multi-system user journey - this is a library component.

## Test Scenarios by Acceptance Criteria

### AC1: XML formatting produces correctly indented output for all valid XML inputs

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-001 | Unit | P0 | Format basic nested XML with 2-space indent | Correct 2-space indentation per level; line 2 has 2 spaces, line 3 has 4 spaces | Core happy path |
| 8.1-UNIT-002 | Unit | P0 | Format XML with attributes | Attributes preserved on same line as opening tag | Attribute handling |
| 8.1-UNIT-003 | Unit | P1 | Format XML with 4-space indent | Correct 4-space indentation per level | Variant indent size |
| 8.1-UNIT-004 | Unit | P1 | Format XML with tab indentation | Correct tab indentation per level | Alternate indent style |
| 8.1-UNIT-005 | Unit | P1 | Format XML with mixed content (text + children) | Whitespace-trimmed text, children indented | Known limitation area |
| 8.1-UNIT-006 | Unit | P2 | Format XML with whitespace-only text nodes | Whitespace handled per documented behavior | Edge: whitespace semantics |

### AC2: XML minification removes all non-essential whitespace while preserving content

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-007 | Unit | P0 | Minify indented XML | No newlines or indent whitespace; content preserved | Core happy path |
| 8.1-UNIT-008 | Unit | P1 | Minify already-minified XML | Identical output (idempotent): `minify(minify(x)) == minify(x)` | Idempotency check |
| 8.1-UNIT-009 | Unit | P1 | Minify XML with significant text content | Text content preserved, structural whitespace removed | Content preservation |

### AC3: Parse errors include line and column position (non-zero) for debugging

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-010 | Unit | P0 | Parse unclosed tag `<root>` | Error with line=1, column>0 | Core error reporting |
| 8.1-UNIT-011 | Unit | P0 | Parse mismatched tags `<a></b>` | Error with line=1, column pointing near `</b>` | Core error reporting |
| 8.1-UNIT-012 | Unit | P1 | Parse invalid attribute syntax `<a b>` | Error with line=1, column pointing near `b` | Malformed attribute |
| 8.1-UNIT-013 | Unit | P1 | Parse error on multi-line XML (error on line 3) | Error with line=3, column>0 | Multi-line position tracking |

### AC4: All XML constructs preserved (declarations, comments, CDATA, PIs, namespaces)

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-014 | Unit | P0 | Format XML with declaration `<?xml version="1.0"?>` | Declaration preserved in output | Construct preservation |
| 8.1-UNIT-015 | Unit | P0 | Format XML with comments `<!-- comment -->` | Comment preserved in output | Construct preservation |
| 8.1-UNIT-016 | Unit | P0 | Format XML with CDATA `<![CDATA[<markup>]]>` | CDATA section preserved with content intact | Construct preservation |
| 8.1-UNIT-017 | Unit | P1 | Format XML with processing instruction `<?pi data?>` | PI preserved in output | Construct preservation |
| 8.1-UNIT-018 | Unit | P1 | Format XML with DocType `<!DOCTYPE root>` | DocType preserved in output | Construct preservation |
| 8.1-UNIT-019 | Unit | P1 | Format XML with namespace declarations `xmlns:x="..."` | All ns declarations preserved | Namespace handling |

### AC5: Format and minify operations produce identical preservation of all XML construct types (parity guarantee)

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-020 | Unit | P1 | Roundtrip parity: `format(minify(format(x))) == format(x)` | Identical output | Behavioral parity |
| 8.1-UNIT-021 | Unit | P1 | PI preserved identically in both format and minify | PI in output for both operations | Parity: catch-all path validation |
| 8.1-UNIT-022 | Unit | P1 | DocType preserved identically in both format and minify | DocType in output for both operations | Parity: catch-all path validation |

### AC6: Code follows DRY principles with shared event handling logic (no duplicated event handlers)

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-023 | Unit | P1 | All-constructs roundtrip (decl, comment, CDATA, PI, DocType, ns, elements, attributes) | All constructs survive format->minify->format | Shared handler completeness |

**Note**: AC6 is primarily structural (code organization). Behavioral verification is covered by roundtrip tests. Code review confirms shared helper exists with no duplicated event handlers.

### AC7: Test coverage includes malformed XML, edge cases, and resource boundary conditions

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-024 | Unit | P2 | Invalid entity reference `<a>&badref;</a>` | FormatError (not panic) | Malformed input |
| 8.1-UNIT-025 | Unit | P2 | Empty input (empty string) | FormatError with descriptive message | Boundary |
| 8.1-UNIT-026 | Unit | P2 | Whitespace-only input | FormatError with descriptive message | Boundary |
| 8.1-UNIT-027 | Unit | P2 | XML with BOM prefix (`\xEF\xBB\xBF`) | Success (handle gracefully) | Edge: encoding |
| 8.1-UNIT-028 | Unit | P2 | Large attribute value (>1KB) | Success, attribute preserved | Edge: size |
| 8.1-UNIT-029 | Unit | P2 | Self-closing tags `<br/>` | Preserved as empty element | Edge: empty elements |

### AC8: Deep nesting at 500 levels either succeeds or returns graceful FormatError (no panic/trap)

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-UNIT-030 | Unit | P1 | Deep nesting at 100 levels | Success, correctly formatted | Baseline depth |
| 8.1-UNIT-031 | Unit | P2 | Deep nesting at 500 levels | Success OR graceful FormatError (no panic/trap) | Stress: stack depth boundary |

### AC9: WASM build succeeds with no new warnings

| ID | Level | Priority | Test | Expected Result | Justification |
|----|-------|----------|------|-----------------|---------------|
| 8.1-INT-001 | Integration | P1 | `wasm-pack build --target web --release` succeeds | Exit code 0 | Build verification |
| 8.1-INT-002 | Integration | P1 | WASM build produces no new warnings | No `warning:` in output | Quality gate |
| 8.1-INT-003 | Integration | P1 | `cargo test xml_formatter` all pass | All tests green | Regression gate |
| 8.1-INT-004 | Integration | P2 | WASM export `js_format_xml` callable | Function exists, returns formatted XML | Export verification |
| 8.1-INT-005 | Integration | P2 | WASM export `js_minify_xml` callable | Function exists, returns minified XML | Export verification |
| 8.1-INT-006 | Integration | P2 | WASM exports match native behavior | Same output for identical input | Behavioral consistency |

## Risk Coverage Matrix

| Risk ID | Title | Test IDs | Coverage |
|---------|-------|----------|----------|
| TECH-001 | Code duplication causes divergent format/minify behavior | 8.1-UNIT-020, 8.1-UNIT-021, 8.1-UNIT-022, 8.1-UNIT-023 | Roundtrip parity tests ensure format/minify use equivalent logic |
| PERF-001 | Deep nesting (100+ levels) may cause WASM stack overflow | 8.1-UNIT-030, 8.1-UNIT-031 | Tests at 100 and 500 levels; 500 checks for graceful failure |
| DATA-001 | Whitespace trimming silently loses mixed-content data | 8.1-UNIT-005, 8.1-UNIT-006, 8.1-UNIT-009 | Explicit tests for mixed content and whitespace handling |
| TECH-002 | Refactor breaks existing working behavior | 8.1-UNIT-020, 8.1-UNIT-023, all AC4 tests | Pre/post refactor equivalence via roundtrip + construct tests |
| BUS-001 | Error positions always (0,0) - no debug value | 8.1-UNIT-010, 8.1-UNIT-011, 8.1-UNIT-012, 8.1-UNIT-013 | Validate non-zero positions after implementation |
| TECH-003 | Line/column off-by-one conversion errors | 8.1-UNIT-010, 8.1-UNIT-011, 8.1-UNIT-013 | Multi-line test validates position tracking |
| OPS-001 | WASM build regression | 8.1-INT-001, 8.1-INT-002, 8.1-INT-003 | Build and test gate |

## Test Data Requirements

| Data | Description | Source |
|------|-------------|--------|
| Basic nested XML | `<root><child>text</child></root>` | Inline literal |
| XML with all constructs | Decl + comment + CDATA + PI + DocType + ns + elements + attrs | Inline literal |
| Deep nested XML (100) | 100-level nested `<l1><l2>...<l100/>...</l1>` | Generated in test |
| Deep nested XML (500) | 500-level nested `<l1><l2>...<l500/>...</l1>` | Generated in test |
| Multi-namespace XML | Multiple `xmlns:x="..."` declarations | Inline literal |
| BOM-prefixed XML | `\xEF\xBB\xBF<?xml...?><root/>` | Inline literal |
| Large attribute | `<root attr="a{1024}"/>` | Generated in test |
| Multi-line with error | `<root>\n<child>\n<bad` (error on line 3) | Inline literal |

## Test Environment Requirements

- **Rust toolchain**: `cargo test` for unit tests
- **WASM target**: `rustup target add wasm32-unknown-unknown`
- **wasm-pack**: Required for integration tests (AC9)
- **No network**: All tests run offline (airgap constraint)
- **No external fixtures**: All test data inline or generated

## Recommended Execution Order

1. **P0 Unit tests** (8 tests) - fail fast on core logic
   - 8.1-UNIT-001, 002, 007, 010, 011, 014, 015, 016
2. **P1 Unit tests** (13 tests) - broader functional coverage
3. **P1 Integration tests** (3 tests) - build and regression gate
   - 8.1-INT-001, 8.1-INT-002, 8.1-INT-003
4. **P2 Unit tests** (7 tests) - edge cases and stress
5. **P2 Integration tests** (3 tests) - WASM export verification
   - 8.1-INT-004, 8.1-INT-005, 8.1-INT-006

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 34
  by_level:
    unit: 28
    integration: 6
    e2e: 0
  by_priority:
    p0: 8
    p1: 16
    p2: 10
  coverage_gaps: []
  ac_coverage:
    ac1: 6
    ac2: 3
    ac3: 4
    ac4: 6
    ac5: 3
    ac6: 1
    ac7: 6
    ac8: 2
    ac9: 6
```

## Quality Checklist

- [x] Every AC has test coverage (AC1-AC9 all covered)
- [x] Test levels are appropriate (unit for logic, integration for WASM)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (error positions = P0, edge cases = P2)
- [x] Test IDs follow naming convention `{epic}.{story}-{LEVEL}-{SEQ}`
- [x] Scenarios are atomic and independent
- [x] Risk mitigations addressed (all 7 risks have test coverage)

## Trace References

Test design matrix: docs/qa/assessments/8.1-test-design-20260128.md
P0 tests identified: 8
Total scenarios: 34
