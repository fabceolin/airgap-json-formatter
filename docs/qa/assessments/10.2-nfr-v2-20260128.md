# NFR Assessment: 10.2 - Mermaid.js Library Integration

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Mode:** YOLO (non-interactive assessment)
**Story Version:** v1.4
**Assessment Version:** v2 (reassessment per user request)

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | Two-layer XSS defense (mermaid strict + DOMPurify v3.2.4); airgap verified (AC8); pinned versions |
| Performance | PASS | <500ms render target (AC9); 5s timeout ceiling (AC11); benchmarks defined |
| Reliability | PASS | Error handling (AC5); timeout (AC11); AsyncSerialiser via C++ wrapper (AC12); DOM cleanup |
| Maintainability | CONCERNS | Manual browser testing only; 35 test cases documented but not automated |

**Quality Score:** 90/100
**Overall Status:** CONCERNS

## NFR Analysis

### Security (PASS)

**Evidence:**
1. **XSS Defense Layer 1:** Mermaid configured with `securityLevel: 'strict'` and `htmlLabels: false` (AC2, Task 2)
2. **XSS Defense Layer 2:** DOMPurify v3.2.4 post-processes all SVG output (AC10, Task 9)
3. **Version Pinning:** mermaid v11.4.1, DOMPurify v3.2.4 explicitly pinned for security traceability
4. **Airgap Verification:** AC8 requires zero network requests verified via DevTools
5. **XSS Test Vectors:** Task 9 includes `<script>`, `onload=`, `<foreignObject>`, `javascript:` URI tests

**Assessment:** Two independent sanitization layers provide defense-in-depth. Pinned versions allow security auditing. AC8 enforces the core airgap requirement.

### Performance (PASS)

**Evidence:**
1. **Render Target:** AC9 specifies <500ms per diagram for typical complexity
2. **Timeout Ceiling:** AC11 implements 5s `Promise.race` timeout preventing browser hang
3. **Benchmarks:** Task 8 includes render time measurement for simple (5 nodes) and complex (20+ nodes) diagrams
4. **Initialize-Once Pattern:** Dev Notes show `setMermaidTheme()` avoids per-render `mermaid.initialize()` overhead

**Assessment:** Clear performance targets with timeout protection. The 2MB mermaid library size is acceptable for a documentation tool.

### Reliability (PASS)

**Evidence:**
1. **Error Handling:** AC5 requires structured error response on invalid syntax (no crash)
2. **Timeout Protection:** AC11's 5s timeout prevents runaway renders
3. **Concurrency Control:** AC12 routes renders through C++ `JsonBridge::renderMermaid()` → AsyncSerialiser
4. **DOM Cleanup:** Dev Notes show orphan container cleanup on error (`orphan.remove()`)
5. **Signal Pattern:** C++ implementation uses `QMetaObject::invokeMethod` with `Qt::QueuedConnection` for thread safety

**Assessment:** Multiple reliability safeguards: error handling, timeout, serialization, and cleanup. The C++ wrapper (Task 12) adds complexity but is well-documented.

### Maintainability (CONCERNS)

**Evidence:**
1. **Test Documentation:** 35 test scenarios documented in Test Design section
2. **No Automated Framework:** All tests are manual browser tests
3. **C++ Wrapper:** Task 12 adds `JsonBridge::renderMermaid()` without dedicated unit test
4. **Manual SW Cache Verification:** Task 7 requires manual Service Worker update

**Assessment:** Comprehensive test documentation exists, but lack of automated test framework creates regression risk as diagram support grows.

## Critical Issues

1. **No automated test harness** (Maintainability)
   - Risk: Manual testing creates maintenance burden; regressions may slip through
   - Fix: Add automated smoke test framework for `renderMermaid` (success, error, XSS, timeout paths)
   - Effort: Medium (requires test infrastructure setup)

## Missing Considerations

1. **CSP Policy:** No Content-Security-Policy meta tag for inline SVG injection
   - Severity: Low (airgapped app mitigates risk)
   - Recommendation: Add `<meta http-equiv="Content-Security-Policy" content="script-src 'self';">` to index.html

2. **C++ Wrapper Unit Test:** Task 12's `JsonBridge::renderMermaid()` lacks dedicated unit test
   - Severity: Medium
   - Recommendation: Add Qt Test for AsyncSerialiser queue behavior

3. **Memory/DOM Leak Testing:** No explicit test for node accumulation after repeated renders
   - Severity: Low (cleanup code exists in error path)
   - Recommendation: Add DOM node count assertion after 100+ sequential renders

## Quick Wins

- Add CSP meta tag: Low effort, defense-in-depth
- Add `PerformanceObserver` for automated network monitoring: Medium effort
- Document manual test execution steps: Low effort

## Test Recommendations

| Priority | Recommendation | Effort | NFR Impact |
|----------|---------------|--------|------------|
| High | Add automated smoke test harness for `renderMermaid` | Medium | Maintainability |
| Medium | Add C++ unit test for `JsonBridge::renderMermaid()` | Medium | Maintainability |
| Medium | Add CSP meta tag to index.html | Low | Security |
| Low | Add DOM node count assertion after repeated renders | Low | Reliability |
| Low | Add automated network request monitoring | Medium | Security |

## Acceptance Criteria NFR Mapping

| AC | NFR Impact | Status |
|----|------------|--------|
| AC2 | Security | PASS - `securityLevel: 'strict'`, `htmlLabels: false` |
| AC5 | Reliability | PASS - Structured error response, no crash |
| AC8 | Security | PASS - Zero network requests verified |
| AC9 | Performance | PASS - <500ms target with benchmark tasks |
| AC10 | Security | PASS - DOMPurify v3.2.4 SVG post-processing |
| AC11 | Reliability/Performance | PASS - 5s `Promise.race` timeout |
| AC12 | Reliability | PASS - C++ `JsonBridge::renderMermaid()` → AsyncSerialiser |
| - | Maintainability | CONCERNS - No automated test framework |

## Gate YAML Block

```yaml
# Gate YAML (copy/paste into qa.qaLocation/gates/10.2-mermaid-js-integration.yml):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Two-layer XSS defense (mermaid strict + DOMPurify v3.2.4); airgap verified (AC8); versions pinned'
  performance:
    status: PASS
    notes: 'Render <500ms (AC9); 5s timeout (AC11); initialize-once pattern'
  reliability:
    status: PASS
    notes: 'Error handling (AC5); timeout (AC11); AsyncSerialiser via C++ wrapper (AC12); DOM cleanup'
  maintainability:
    status: CONCERNS
    notes: 'Manual testing only; 35 test cases documented but not automated; recommend test harness'
```

## Quality Score Calculation

```
quality_score = 100
- 10 for maintainability CONCERNS
= 90
```

---

NFR assessment: docs/qa/assessments/10.2-nfr-v2-20260128.md

Gate NFR block ready → paste into docs/qa/gates/10.2-mermaid-js-integration.yml under nfr_validation
