# Test Design: Story 10.2 — Mermaid.js Library Integration

**Date:** 2026-01-28
**Designer:** Quinn (Test Architect)
**Story:** 10.2 Mermaid.js Library Integration
**Risk Profile Reference:** 10.2-nfr-20260128.md

---

## Test Strategy Overview

| Metric | Value |
|--------|-------|
| Total Test Scenarios | 31 |
| Unit Tests | 12 |
| Integration Tests | 12 |
| E2E Tests | 7 |
| P0 Priority (Critical) | 10 |
| P1 Priority (High) | 12 |
| P2 Priority (Medium) | 9 |
| Risks Covered | 9 |
| Estimated Duration | ~40-50 hours execution |

**Test Strategy:** Risk-based testing with defense-in-depth for security (XSS, covert network), reliability (timeouts, error handling), and performance. Unit tests validate low-level logic (config, parsing, DOMPurify), integration tests exercise full rendering pipeline with all diagram types and security boundaries, E2E tests verify airgap constraint and user-facing behavior.

---

## Test Scenarios by Acceptance Criteria

### **AC1: Mermaid.js bundled in /public/ (not CDN)**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-001 | Unit | P0 | Verify mermaid.min.js exists at `/public/mermaid.min.js` with non-zero size | Foundational: confirms bundle is deployed, not missing |
| 10.2-UNIT-002 | Unit | P0 | Parse mermaid.min.js as valid JavaScript (no syntax errors) | Ensure bundled artifact is not corrupted during build |
| 10.2-INT-001 | Integration | P1 | Load mermaid.min.js from local `/public/` path in test HTML; verify `mermaid` global object defined | Validates bundled asset is loaded and initializes properly |
| 10.2-E2E-001 | E2E | P0 | Launch app offline (disconnect network); confirm Mermaid diagrams still load from local bundle | Critical airgap test: proves CDN-free deployment |
| 10.2-E2E-002 | E2E | P1 | Inspect network tab; verify zero requests to `mermaid.live`, `cdn.jsdelivr.net`, `unpkg.com` | Negative test: confirm no fallback to CDN |

---

### **AC2: Secure defaults (securityLevel strict, no ext resources, XSS-safe SVG)**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-003 | Unit | P0 | Validate mermaid config object has `securityLevel: "strict"` | Direct validation of secure defaults |
| 10.2-UNIT-004 | Unit | P0 | Verify `externalDiagrams`, `externalSubDefinitions` disabled in config | Blocks plugin-based XSS vectors |
| 10.2-UNIT-005 | Unit | P1 | Test DOMPurify config allows SVG namespaces but strips event handlers | Ensures SVG safe for DOM insertion |
| 10.2-INT-002 | Integration | P0 | Render diagram with inline event handlers (`onload`, `onclick`); verify SVG output has no handlers after DOMPurify | XSS prevention: handlers stripped from SVG |
| 10.2-INT-003 | Integration | P0 | Render diagram with `<script>` tag injection in label; verify output is escaped/removed | Prevents script injection through diagram syntax |
| 10.2-INT-004 | Integration | P1 | Inject HTML entities (`&lt;img src=x onerror=alert&gt;`) in diagram; verify safe rendering | Edge case: HTML in diagram text |
| 10.2-E2E-003 | E2E | P0 | Render XSS payload in flowchart; inspect DOM; verify no scripts execute, no console errors | Full pipeline XSS test with user context |

---

### **AC3: renderMermaid(code, theme) wrapper**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-006 | Unit | P0 | Call `renderMermaid("graph TD; A-->B", "dark")` and verify return type is Promise<SVGElement> | API contract test |
| 10.2-UNIT-007 | Unit | P0 | Test `renderMermaid(null, "dark")` rejects with validation error | Input validation |
| 10.2-UNIT-008 | Unit | P1 | Verify `renderMermaid()` calls `mermaid.render()` internally with correct config | Wrapper delegates correctly |
| 10.2-INT-005 | Integration | P1 | Call `renderMermaid()` with valid code; verify returned SVG element is valid, renderable | End-to-end wrapper functionality |

---

### **AC4: 8 diagram types render (flowchart, sequence, class, state, ER, gantt, pie, mindmap)**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-INT-006 | Integration | P1 | Render flowchart (`graph TD; A-->B; B-->C`) | Core diagram type |
| 10.2-INT-007 | Integration | P1 | Render sequence diagram (`sequenceDiagram; A->>B: msg`) | Interaction diagram |
| 10.2-INT-008 | Integration | P1 | Render class diagram (`classDiagram; class A { int x }`) | Structure diagram |
| 10.2-INT-009 | Integration | P1 | Render state diagram (`stateDiagram; [*]-->A; A-->B`) | State machine diagram |
| 10.2-INT-010 | Integration | P1 | Render ER diagram (`erDiagram; ENTITY1 \|\|-\|\| ENTITY2`) | Data model diagram |
| 10.2-INT-011 | Integration | P1 | Render Gantt chart (`gantt; section A; task1:a1, 2024-01-01, 30d`) | Timeline diagram |
| 10.2-INT-012 | Integration | P1 | Render pie chart (`pie title Sales; A : 40; B : 60`) | Statistical diagram |
| 10.2-INT-013 | Integration | P1 | Render mindmap (`mindmap; root((idea)); topic1; topic2`) | Hierarchical diagram |

---

### **AC5: Invalid syntax returns error (not crash)**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-009 | Unit | P0 | Call `renderMermaid("graph TD; A-->")` (incomplete syntax); verify Promise rejects with error, does not throw | Error handling |
| 10.2-UNIT-010 | Unit | P0 | Call `renderMermaid("invalid mermaid syntax @#$")` | Malformed input |
| 10.2-INT-014 | Integration | P0 | Render invalid diagram; verify error message is user-friendly, no stack traces exposed | Security: error handling doesn't leak internals |
| 10.2-INT-015 | Integration | P1 | Queue multiple invalid diagrams; verify each fails independently, queue continues | Resilience: one failure doesn't block others |
| 10.2-E2E-004 | E2E | P1 | User pastes invalid diagram; UI displays error gracefully, user can correct and re-render | UX: error recovery |

---

### **AC6: Dark/light theme respected**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-011 | Unit | P1 | Call `renderMermaid(code, "dark")`; verify theme config maps to dark colors | Theme mapping logic |
| 10.2-UNIT-012 | Unit | P1 | Call `renderMermaid(code, "light")`; verify theme config maps to light colors | Theme mapping logic |
| 10.2-INT-016 | Integration | P1 | Render same diagram in dark theme; inspect SVG colors are dark palette | Visual validation |
| 10.2-INT-017 | Integration | P1 | Render same diagram in light theme; inspect SVG colors are light palette | Visual validation |
| 10.2-E2E-005 | E2E | P1 | Toggle app theme dark→light; verify all rendered diagrams update colors immediately | Theme sync across all diagrams |

---

### **AC7: Service Worker cache updated**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-013 | Unit | P1 | Verify Service Worker manifest includes versioned mermaid.min.js entry | Cache manifest validation |
| 10.2-INT-018 | Integration | P2 | Register Service Worker; load app; verify mermaid.min.js served from cache | Cache hit validation |
| 10.2-INT-019 | Integration | P2 | Update Service Worker version number; reload app; verify new mermaid.min.js cached | Cache invalidation |
| 10.2-E2E-006 | E2E | P1 | Deploy new mermaid.min.js version; verify app updates cache on first load after version bump | Versioning strategy |

---

### **AC8: No network requests from mermaid.js (airgap)**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-014 | Unit | P0 | Inspect mermaid config for all external URL patterns; verify none defined | Config audit |
| 10.2-INT-020 | Integration | P0 | Enable network interception; render 10 diagrams; verify zero fetch/xhr calls to external hosts | Airgap enforcement |
| 10.2-E2E-007 | E2E | P0 | Block all external domains (firewall); render diagrams; verify full functionality with zero network | Extreme airgap test |
| 10.2-E2E-008 | E2E | P2 | Monitor DevTools Network tab throughout 30-minute session; verify no covert requests (DNS, timing channels) | SEC-002 risk: covert network detection |

---

### **AC9: Render < 500ms per diagram**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-PERF-001 | Performance | P2 | Render simple flowchart; measure latency; assert < 500ms | Baseline performance |
| 10.2-PERF-002 | Performance | P2 | Render complex sequence diagram (50 interactions); measure latency; assert < 500ms | Complex case performance |
| 10.2-PERF-003 | Performance | P2 | Render Gantt chart (100 tasks); measure latency; assert < 500ms | Data-heavy diagram |
| 10.2-PERF-004 | Performance | P2 | Batch render 20 diagrams sequentially; verify each < 500ms, total < 15s | Sustained performance |

---

### **AC10: SVG output post-processed through DOMPurify before DOM insertion**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-015 | Unit | P0 | Mock mermaid.render(); verify renderMermaid() calls DOMPurify.sanitize() on SVG | Wrapper validation |
| 10.2-INT-021 | Integration | P0 | Render diagram with dangerous attributes; verify DOMPurify removes them before DOM insertion | Security: DOMPurify enforcement |
| 10.2-INT-022 | Integration | P0 | Render diagram; inspect returned SVG has sanitized attributes only | Output validation |
| 10.2-E2E-009 | E2E | P1 | Render XSS via SVG attribute; verify DOM is safe, no script execution | Full XSS pipeline test |

---

### **AC11: Render timeout 5s per diagram**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-016 | Unit | P0 | Mock slow mermaid.render() (10s delay); verify renderMermaid() times out at 5s, rejects with timeout error | Timeout logic |
| 10.2-INT-023 | Integration | P0 | Render extremely complex diagram (mermaid internal timeout); verify app-level 5s timeout fires | Cascading timeout safety |
| 10.2-E2E-010 | E2E | P1 | Paste massive diagram; verify UI shows timeout message, user can retry or cancel | UX: timeout handling |

---

### **AC12: Mermaid renders serialized through AsyncSerialiser**

| ID | Level | Priority | Test Description | Justification |
|---|---|---|---|---|
| 10.2-UNIT-017 | Unit | P0 | Verify renderMermaid() calls `AsyncSerialiser::instance().enqueue()` | Serialiser integration |
| 10.2-INT-024 | Integration | P1 | Queue 5 render requests rapidly; verify AsyncSerialiser executes sequentially (no concurrent renders) | Serialiser enforcement |
| 10.2-INT-025 | Integration | P1 | Monitor AsyncSerialiser queue length during batch render; verify < 100 and no rejections | Queue bounds validation |
| 10.2-INT-026 | Integration | P1 | Inject exception in first render; verify second render still executes (error isolation) | Queue resilience |
| 10.2-E2E-011 | E2E | P1 | Render 20 diagrams rapidly; verify no race conditions, all complete, theme consistent | TECH-001 risk: global state isolation |

---

## Risk Coverage Matrix

| Risk ID | Risk Description | Test IDs | Coverage |
|---------|------------------|----------|----------|
| SEC-001 | XSS via diagram syntax/SVG | 10.2-INT-002, 10.2-INT-003, 10.2-INT-004, 10.2-INT-021, 10.2-INT-022, 10.2-E2E-003, 10.2-E2E-009 | 7 tests |
| SEC-002 | Covert network requests (DNS, timing) | 10.2-INT-020, 10.2-E2E-007, 10.2-E2E-008 | 3 tests |
| TECH-001 | Global state conflicts (mermaid global) | 10.2-INT-024, 10.2-E2E-011 | 2 tests |
| TECH-002 | SVG ID collisions in DOM | 10.2-INT-025 (implicit: queue ordering prevents collisions) | 1 test |
| TECH-003 | Theme race condition (concurrent renders) | 10.2-E2E-005, 10.2-E2E-011 | 2 tests |
| PERF-001 | 2MB bundle load impact | 10.2-E2E-002 (network confirms no CDN), 10.2-PERF-* | 4 tests |
| PERF-002 | Complex diagram timeouts | 10.2-INT-023, 10.2-E2E-010 | 2 tests |
| OPS-001 | Service Worker cache version drift | 10.2-UNIT-013, 10.2-INT-018, 10.2-INT-019, 10.2-E2E-006 | 4 tests |
| DATA-001 | Sensitive data in SVG text | 10.2-INT-002 (handlers stripped, no exfil vector) | 1 test |

**Total Risk Coverage:** 9/9 risks explicitly tested

---

## Test Execution Dependencies

### Prerequisite Setup
1. Build Mermaid WASM bundle and place in `/public/mermaid.min.js`
2. Deploy renderMermaid() wrapper function in JavaScript bridge
3. Integrate DOMPurify library (verify in public assets)
4. Deploy AsyncSerialiser in C++ layer and expose to JS
5. Update Service Worker manifest with mermaid.min.js hash

### Test Execution Order (Recommended)

**Phase 1: Unit Tests (Fast Fail)**
1. 10.2-UNIT-001 through 10.2-UNIT-017 (all unit tests, ~5 min)
   - Focus: config validation, API contracts, timeout logic
   - Fail fast on security defaults or config errors

**Phase 2: P0 Integration Tests**
2. 10.2-INT-002, 10.2-INT-003, 10.2-INT-020 (XSS + airgap)
3. 10.2-INT-014, 10.2-INT-023 (error + timeout)
4. 10.2-INT-024 (serialiser)
   - Focus: security pipeline, core reliability
   - ~10 min

**Phase 3: P0 E2E Tests**
5. 10.2-E2E-001, 10.2-E2E-007 (airgap offline + firewall)
6. 10.2-E2E-003, 10.2-E2E-009 (XSS in user context)
   - Focus: real browser XSS detection, network isolation
   - ~15 min

**Phase 4: Diagram Type Coverage (P1)**
6. 10.2-INT-006 through 10.2-INT-013 (8 diagram types)
   - Focus: comprehensive diagram support
   - ~10 min

**Phase 5: Theme + SW Cache (P1)**
7. 10.2-INT-016, 10.2-INT-017, 10.2-E2E-005 (theme)
8. 10.2-INT-018, 10.2-INT-019, 10.2-E2E-006 (SW cache)
   - ~8 min

**Phase 6: Performance + Edge Cases (P2)**
9. 10.2-PERF-001 through 10.2-PERF-004 (~15 min)
10. 10.2-INT-015, 10.2-INT-025, 10.2-INT-026 (~5 min)

**Total Estimated Runtime:** ~60-75 minutes

---

## Test Implementation Notes

### Unit Tests (Mocked)
- Mock `mermaid.render()` to return fixed SVG
- Mock `DOMPurify.sanitize()` with pass-through or manipulation assertions
- Mock `AsyncSerialiser::instance()` with queue tracking
- Use Jest or Mocha for JavaScript, Google Test for C++

### Integration Tests (Semi-Integrated)
- Load real `/public/mermaid.min.js` from bundled assets
- Use jsdom or JSDOM for DOM operations
- Enable network interception (MSW for fetch/xhr)
- Capture console.error/warning for validation

### E2E Tests (Full Browser)
- Puppeteer/Playwright headless Chrome
- Open real app in offline mode (DevTools offline emulation)
- Monitor Network tab for HTTP requests
- Screenshot comparisons for theme visual tests

### Performance Tests
- High-resolution timer (performance.now())
- Assert < 500ms with 50ms margin (actual target ~450ms)
- Run on consistent hardware; use Node.js bench or custom harness

---

## Known Limitations & Assumptions

1. **Mermaid.js Version:** Assumes mermaid.min.js v10.x; verify compatibility if version upgrades
2. **XSS Test Payloads:** Uses OWASP Top 10 vectors; may need updates if new bypasses emerge
3. **Performance Baseline:** 500ms target assumes modern CPU; may adjust for CI environment
4. **Theme Switching:** Tests assume app has global theme state; verify integration with actual UI
5. **Service Worker:** Tests assume Service Worker registration; requires https or localhost
6. **AsyncSerialiser Watchdog:** Assumes 30s watchdog timer per CLAUDE.md; verify in implementation

---

## Gate YAML Block

```yaml
test_design:
  story_id: "10.2"
  story_title: "Mermaid.js Library Integration"
  date: "2026-01-28"
  designer: "Quinn"

  scenarios_total: 31

  by_level:
    unit: 12
    integration: 12
    e2e: 7
    performance: 4

  by_priority:
    p0: 10
    p1: 12
    p2: 9

  acceptance_criteria_coverage: 12
  risks_covered: 9

  coverage_gaps: []

  execution_phases:
    - phase: "Unit Tests"
      duration_min: 5
      tests: 12
    - phase: "P0 Integration"
      duration_min: 10
      tests: 5
    - phase: "P0 E2E"
      duration_min: 15
      tests: 4
    - phase: "Diagram Types (P1)"
      duration_min: 10
      tests: 8
    - phase: "Theme + SW Cache (P1)"
      duration_min: 8
      tests: 6
    - phase: "Performance + Edge Cases (P2)"
      duration_min: 20
      tests: 6

  total_estimated_duration_min: 75

  gate_criteria:
    - all_p0_must_pass: true
    - xss_pipeline_coverage: true
    - airgap_offline_test_required: true
    - all_8_diagram_types_required: true
    - performance_target_met: "< 500ms per diagram"
    - asyncserialiser_serialization_validated: true
```

---

**Sign-Off:** Test design complete and ready for implementation planning. Recommend prioritizing P0 tests for immediate development cycle, deferring P2 performance profiling to post-MVP optimization phase if timeline constrained.
