# Requirements Traceability Matrix

## Story: 10.2 - Mermaid.js Library Integration

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Method:** Given-When-Then traceability mapping against PRD, Epic 10.0, and Story ACs 1-12

---

## Coverage Summary

- **Total Requirements:** 17 (12 Story ACs + 5 PRD/Epic-level)
- **Fully Covered:** 15 (88%)
- **Partially Covered:** 2 (12%)
- **Not Covered:** 0 (0%)

---

## Requirement Mappings

### AC1: Bundled Library (not CDN)

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test:** `10.2-INT-001` - Bundle Verification
  - Given: Application loaded in browser with DevTools Network tab open
  - When: Page finishes loading
  - Then: `mermaid.min.js` loads from `/public/lib/` path; no CDN requests observed

- **E2E Test:** `10.2-E2E-005` - Airgap Verification
  - Given: Application running with all diagram types rendered
  - When: Network tab inspected
  - Then: Zero outbound requests to external hosts

---

### AC2: Secure Defaults

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test:** `10.2-UNIT-001` - Configuration Validation
  - Given: Mermaid library initialized
  - When: Configuration inspected
  - Then: `securityLevel: 'strict'`, `startOnLoad: false`, `htmlLabels: false`

- **Integration Test:** `10.2-INT-002` - XSS: Script Injection
  - Given: Mermaid initialized with strict mode
  - When: Rendering `graph TD; A["<script>alert(1)</script>"]-->B`
  - Then: Output SVG contains no `<script>` elements

- **Integration Test:** `10.2-INT-003` - XSS: Event Handler
  - Given: Mermaid initialized with strict mode
  - When: Rendering `graph TD; A["<img onload=alert(1)>"]-->B`
  - Then: Output SVG contains no `onload` attributes

- **Integration Test:** `10.2-INT-004` - XSS: foreignObject
  - Given: Mermaid initialized with strict mode
  - When: Rendering diagram with `<foreignObject>` injection
  - Then: `foreignObject` content sanitized/stripped

- **Integration Test:** `10.2-INT-005` - XSS: javascript URI
  - Given: Mermaid initialized with strict mode
  - When: Rendering `graph TD; A["<a href='javascript:alert(1)'>"]-->B`
  - Then: No `javascript:` URIs in output SVG

---

### AC3: renderMermaid Wrapper

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test:** `10.2-UNIT-004` - API Contract Success
  - Given: `renderMermaid` function available on `window`
  - When: Called with `"graph TD; A-->B"` and theme='dark'
  - Then: Returns `{ success: true, svg: '<svg>...</svg>' }`

- **Unit Test:** `10.2-UNIT-005` - API Contract Error
  - Given: `renderMermaid` function available
  - When: Called with invalid syntax
  - Then: Returns `{ success: false, error: '...' }` without exception

- **Integration Test:** `10.2-INT-006` - Wrapper End-to-End
  - Given: Application loaded with mermaid + DOMPurify
  - When: `renderMermaid` called via bridge.js
  - Then: SVG returned and DOM insertable

---

### AC4: 8 Diagram Types Render

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test:** `10.2-INT-007` - Flowchart
  - Given: `renderMermaid` called
  - When: Input is `graph TD; A-->B; B-->C`
  - Then: Valid SVG with nodes and edges returned

- **Integration Test:** `10.2-INT-008` - Sequence Diagram
  - Given: `renderMermaid` called
  - When: Input is `sequenceDiagram; A->>B: msg`
  - Then: Valid SVG with actors and messages returned

- **Integration Test:** `10.2-INT-009` - Class Diagram
  - Given: `renderMermaid` called
  - When: Input is `classDiagram; class A { int x }`
  - Then: Valid SVG with class box returned

- **Integration Test:** `10.2-INT-010` - State Diagram
  - Given: `renderMermaid` called
  - When: Input is `stateDiagram; [*]-->A; A-->B`
  - Then: Valid SVG with states returned

- **Integration Test:** `10.2-INT-011` - ER Diagram
  - Given: `renderMermaid` called
  - When: Input is `erDiagram; A ||--o{ B : has`
  - Then: Valid SVG with entities returned

- **Integration Test:** `10.2-INT-012` - Gantt Chart
  - Given: `renderMermaid` called
  - When: Input is `gantt; task1: a1, 2024-01-01, 7d`
  - Then: Valid SVG timeline returned

- **Integration Test:** `10.2-INT-013` - Pie Chart
  - Given: `renderMermaid` called
  - When: Input is `pie; "A": 50; "B": 50`
  - Then: Valid SVG circle returned

- **Integration Test:** `10.2-INT-014` - Mindmap
  - Given: `renderMermaid` called
  - When: Input is `mindmap; root((Main))`
  - Then: Valid SVG tree returned

---

### AC5: Error Handling (Invalid Syntax)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test:** `10.2-UNIT-006` - Empty Input
  - Given: `renderMermaid` function called
  - When: Input is empty string `""`
  - Then: Returns `{ success: false, error: '...' }` without throwing

- **Unit Test:** `10.2-UNIT-007` - Garbage Input
  - Given: `renderMermaid` function called
  - When: Input is `@#$%^&*`
  - Then: Returns `{ success: false, error: '...' }` without throwing

- **Unit Test:** `10.2-UNIT-008` - Incomplete Syntax
  - Given: `renderMermaid` function called
  - When: Input is `graph TD; A-->`
  - Then: Returns `{ success: false, error: '...' }` without throwing

---

### AC6: Dark/Light Theme Support

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **E2E Test:** `10.2-E2E-002` - Theme Toggle
  - Given: Diagram rendered in dark theme
  - When: Theme toggled to light
  - Then: Diagram re-renders with `theme: 'default'`; no race condition

**Gap:** No automated color-value assertion matching Theme.qml palette variables

---

### AC7: Service Worker Cache Updated

**Coverage: FULL**

Given-When-Then Mappings:

- **E2E Test:** `10.2-E2E-003` - Cache Manifest Verification
  - Given: Service Worker inspected
  - When: Cache manifest checked
  - Then: Contains `/lib/mermaid.min.js` and `/lib/purify.min.js`

- **E2E Test:** `10.2-E2E-004` - Offline Loading
  - Given: Application loaded, network disconnected
  - When: Page reloaded
  - Then: mermaid.js and purify.min.js load from cache

---

### AC8: No Network Requests (Airgap)

**Coverage: FULL**

Given-When-Then Mappings:

- **E2E Test:** `10.2-E2E-005` - Network Tab Verification
  - Given: All diagram types rendered in sequence
  - When: Network tab inspected after renders complete
  - Then: Zero outbound requests after initial page load

---

### AC9: Render Performance (< 500ms)

**Coverage: FULL**

Given-When-Then Mappings:

- **E2E Test:** `10.2-E2E-006` - Simple Diagram Performance
  - Given: `renderMermaid` called with 5-node flowchart
  - When: Render completes
  - Then: `performance.now()` delta < 500ms

- **E2E Test:** `10.2-E2E-007` - Complex Diagram Performance
  - Given: `renderMermaid` called with 20+ node diagram
  - When: Render completes
  - Then: `performance.now()` delta < 500ms

---

### AC10: DOMPurify SVG Sanitization

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test:** `10.2-INT-010` - DOMPurify Call Verification
  - Given: Mermaid renders SVG output
  - When: SVG post-processed
  - Then: `DOMPurify.sanitize()` called with SVG profile

- **Integration Test:** `10.2-INT-011` - SVG Elements Preserved
  - Given: Valid diagram rendered
  - When: Output inspected
  - Then: Contains `<path>`, `<rect>`, `<text>` elements

- **Integration Tests:** `10.2-INT-002..005` - XSS Vectors
  - Given: XSS payload in diagram syntax
  - When: Rendered and sanitized
  - Then: No `<script>`, `onload`, `foreignObject`, or `javascript:` URIs

---

### AC11: Render Timeout (5 seconds)

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test:** `10.2-UNIT-012` - Timeout Mechanism
  - Given: `renderMermaid` called with input causing >5s render
  - When: 5 seconds elapse
  - Then: Returns `{ success: false, error: 'Render timeout (5s exceeded)' }`

---

### AC12: AsyncSerialiser Integration

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Test:** `10.2-INT-013` - Serial Execution
  - Given: Three `renderMermaid` calls queued concurrently
  - When: All three dispatched
  - Then: Execute sequentially; no concurrent Asyncify suspension

- **E2E Test:** `10.2-E2E-011` - Theme Race Prevention
  - Given: Render in progress
  - When: Theme toggle triggered
  - Then: No race condition; render completes before re-render

---

## PRD/Epic-Level Requirements

### NFR1: Zero Network After WASM Load

**Coverage: PARTIAL**

- **Test Coverage:** `10.2-E2E-005` (manual DevTools verification)
- **Gap:** No continuous automated network monitor

---

### NFR2: Offline After Initial Load

**Coverage: FULL** (via AC7)

- **Test Coverage:** `10.2-E2E-004`

---

### FR-MD-5: Support 8 Mermaid Diagram Types

**Coverage: FULL** (via AC4)

- **Test Coverage:** `10.2-INT-007..014`

---

### FR-MD-6: Error Messages for Invalid Mermaid

**Coverage: FULL** (via AC5)

- **Test Coverage:** `10.2-UNIT-006..008`

---

### Epic-AC5: No XSS Vulnerabilities

**Coverage: FULL**

- **Test Coverage:** `10.2-INT-002..005`, `10.2-INT-010..011`
- **Defense Layers:** Mermaid strict mode + DOMPurify sanitization

---

## Critical Gaps

### GAP-R01: Theme Color Assertions

- **Requirement:** AC6 (Theme Integration)
- **Gap:** No automated color-value assertion matching Theme.qml palette
- **Severity:** Low
- **Risk:** Visual regression could go undetected
- **Suggested Test:**
  - Type: Integration
  - Description: Programmatic check comparing rendered SVG fill/stroke to theme variables

### GAP-R02: Continuous Network Monitor

- **Requirement:** NFR1 (Airgap)
- **Gap:** Manual DevTools check only; no automated network assertion
- **Severity:** Low
- **Risk:** Unintended network request could be missed
- **Suggested Test:**
  - Type: Integration
  - Description: Add `PerformanceObserver` or test harness network assertion

### GAP-R03: Automated Test Framework

- **Requirement:** Implicit (Maintainability)
- **Gap:** All 35 test cases are manual browser tests
- **Severity:** Medium
- **Risk:** Regression risk as diagram support grows; maintenance burden
- **Suggested Test:**
  - Type: Infrastructure
  - Description: Add Playwright or in-browser test runner for regression automation

---

## Test Design Recommendations

Based on gaps identified, recommend:

1. **Add automated test harness** (GAP-R03) - Most impactful gap; prevents regression risk
2. **Add theme color assertions** (GAP-R01) - Low effort programmatic color check
3. **Add CSP meta tag** to `index.html` restricting `script-src` to `'self'` - defense-in-depth
4. **Consider PerformanceObserver** for continuous network monitoring (GAP-R02)

---

## Risk Assessment

| Risk Level | Requirements |
|------------|--------------|
| **Low Risk** | AC1-5, AC7-12, FR-MD-5, FR-MD-6, Epic-AC5 (Full coverage with unit + integration) |
| **Medium Risk** | AC6, NFR1 (Partial coverage; gaps documented) |
| **High Risk** | None |

---

## Gate YAML Block

```yaml
trace:
  totals:
    requirements: 17
    full: 15
    partial: 2
    none: 0
  planning_ref: 'docs/qa/assessments/10.2-test-design-20260128.md'
  uncovered:
    - ac: 'AC6'
      reason: 'No automated color-value assertion matching Theme.qml'
    - ac: 'NFR1'
      reason: 'Manual DevTools verification only; no continuous automated network monitor'
  notes: 'See docs/qa/assessments/10.2-trace-20260128.md'
```

---

## Revision History

| Date | Version | Description |
|------|---------|-------------|
| 2026-01-28 | 1.0 | Initial requirements trace (YOLO mode) |
