# NFR Assessment: 10.4 - Format Auto-Detection Extension

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Story:** docs/stories/10.4.format-auto-detection-extension.md

## Summary

| NFR | Status | Notes |
|-----|--------|-------|
| Security | PASS | No new attack surface; input-only pattern matching |
| Performance | PASS | <1ms target with 2KB cap on search area |
| Reliability | CONCERNS | No explicit fallback for regex engine failures |
| Maintainability | PASS | Static patterns, clear structure, comprehensive tests |

**Quality Score:** 90/100

## Detailed Analysis

### Security: PASS

**Assessment Criteria:**
- Input validation: Patterns match only, no data transformation
- No storage: Detection is ephemeral, no persistence
- No network: Continues airgap architecture
- No secrets: No credentials or sensitive data involved

**Evidence:**
- Story extends existing `detectFormat()` which is read-only
- Pattern matching uses Qt `QRegularExpression` (well-tested library)
- Detection priority (JSON > XML > Markdown) prevents injection via format confusion
- Architecture requirement: Zero network calls enforced (architecture.md Section 11.1)

**No concerns identified.**

### Performance: PASS

**Requirements Found:**
- AC 8: "Detection is fast (< 1ms for any input size)"
- Dev Notes: "First 2KB only" cap for search area

**Evidence:**
- Story explicitly caps search at `searchArea = input.left(2000)`
- Static `QRegularExpression` patterns (compiled once, reused)
- First-line checks for common patterns before deeper search
- Performance test explicitly listed: "Test: Performance < 1ms"

**Thresholds Met:**
- Target: <1ms
- Evidence: 2KB cap ensures bounded execution time regardless of input size

### Reliability: CONCERNS

**Assessment Criteria:**
- Error handling: Partial
- Graceful degradation: Not explicitly defined
- Retry logic: N/A for synchronous detection

**Concerns Identified:**

1. **Regex Engine Failure** - No explicit handling for regex compilation failures
   - Risk: `QRegularExpression` could fail on malformed patterns (low probability since patterns are static)
   - Mitigation: Add `isValid()` check on regex patterns at startup

2. **Unknown as Fallback** - Good that "unknown" is the default, but:
   - No explicit handling if pattern matching throws an exception
   - Edge case: Very long lines could affect regex performance despite 2KB cap

**Recommended Fix:**
```cpp
bool JsonBridge::isLikelyMarkdown(const QString &input)
{
    static QRegularExpression headingRe(QStringLiteral("^#{1,6}\\s"));
    if (!headingRe.isValid()) {
        qWarning() << "Invalid regex pattern:" << headingRe.errorString();
        return false;  // Fail closed, not open
    }
    // ... rest of implementation
}
```

### Maintainability: PASS

**Assessment Criteria:**
- Test coverage: Comprehensive test plan with 13+ explicit test cases
- Code structure: Clear separation - detection in JsonBridge, UI in Toolbar.qml
- Documentation: Full Dev Notes with algorithm, edge cases, priority table

**Evidence:**
- Test location documented: `qt/tests/tst_format_detection.cpp`
- Edge case table with 8 entries covering ambiguous inputs
- Clear priority chain: JSON > XML > Markdown > Unknown
- Pattern matching isolated in `isLikelyMarkdown()` helper

**No concerns identified.**

## Critical Issues

1. **No Regex Validation** (Reliability - Medium Risk)
   - Risk: Silent failure if regex patterns are malformed
   - Impact: Detection could silently return false for all inputs
   - Fix: Add `isValid()` check on static patterns at initialization
   - Effort: ~30 minutes

## Quick Wins

1. Add defensive `isValid()` checks on all static regex patterns
2. Add unit test for regex pattern validity
3. Consider logging/debugging output for detection path taken (dev builds only)

## Recommendations

1. **Required before gate:** Add regex validation as described in reliability section
2. **Optional enhancement:** Add a debug mode that logs which pattern matched for easier troubleshooting
3. **Future consideration:** If Markdown false-positive rate is high in production, consider requiring 2+ pattern matches for confident detection

---

## Gate YAML Block

```yaml
# Gate YAML (copy/paste):
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: PASS
    notes: 'Read-only pattern matching, no new attack surface'
  performance:
    status: PASS
    notes: '<1ms target with 2KB search cap, static regex patterns'
  reliability:
    status: CONCERNS
    notes: 'Missing explicit validation for regex patterns; recommend isValid() checks'
  maintainability:
    status: PASS
    notes: 'Clear structure, comprehensive test plan with 13+ cases'
```

---

NFR assessment: docs/qa/assessments/10.4-nfr-20260128.md

Gate NFR block ready -> paste into docs/qa/gates/10.4-format-auto-detection-extension.yml under nfr_validation
