# Story 2.9: Fix Loading Screen Timing - Brownfield Addition

## Status: Done

## Story

**As a** user,
**I want** the loading spinner to remain visible until the Qt interface is fully rendered,
**so that** I don't see a blank screen during the Qt WASM initialization period.

## Story Context

**Existing System Integration:**
- Integrates with: `public/index.html` (Qt WASM loader)
- Technology: HTML/CSS/JavaScript, Qt WASM
- Follows pattern: Existing loading indicator pattern in index.html
- Touch points: Lines 117-127 in `public/index.html` (WASM initialization flow)

**Problem Description:**
Currently, `container.innerHTML = ''` (line 117) removes the loading spinner immediately after the Qt factory function is obtained, but before the Qt canvas is visible. This creates a ~5 second blank screen while Qt initializes internally.

## Acceptance Criteria

**Functional Requirements:**
1. Loading spinner remains visible during entire Qt WASM initialization
2. Spinner only disappears when Qt canvas is actually rendered and visible
3. Status message continues updating appropriately during load phases

**Integration Requirements:**
4. Existing fallback interface behavior continues to work unchanged
5. New functionality follows existing loading pattern
6. No changes to Qt WASM initialization API calls

**Quality Requirements:**
7. No visual flicker or jarring transitions
8. Smooth transition from loading spinner to Qt interface
9. No regression in existing functionality verified

## Technical Notes

- **Integration Approach:** Modify the timing of when `container.innerHTML = ''` is called - defer it until Qt signals readiness or use CSS to overlay/hide the loading element
- **Existing Pattern Reference:** Current loading uses CSS `.loading` class positioned absolute over container
- **Key Constraints:** Cannot modify Qt WASM module itself; must work with existing Qt 6 WASM API

### Possible Solutions

**Option A - Wait for Qt canvas render:**
Use a MutationObserver or poll for canvas element existence before hiding loading.

**Option B - CSS overlay approach:**
Keep loading element outside the Qt container, hide it only when Qt signals ready.

**Option C - Qt callback:**
If Qt WASM provides a ready callback, use that to trigger loading removal.

### Relevant Code Location

`public/index.html` lines 98-138 - the `init()` function

```javascript
// Current problematic code (line 117):
container.innerHTML = ''; // This removes loading TOO EARLY

// The Qt instance creation happens after, but Qt takes time to render
const instance = await createQtAppInstance({...});
```

## Definition of Done

- [x] Functional requirements met
- [x] Integration requirements verified
- [x] Existing functionality regression tested
- [x] Code follows existing patterns and standards
- [x] Manual test: loading spinner visible until Qt renders
- [x] Manual test: fallback interface still works if Qt fails

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Timing issues across different browsers/hardware speeds
- **Mitigation:** Use event-based detection (canvas existence) rather than timing
- **Rollback:** Revert index.html to previous state

**Compatibility Verification:**
- [x] No breaking changes to existing APIs
- [x] No database changes
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-20 | 1.1 | Implementation complete - loading timing fix | James (Dev) |
| 2026-01-20 | 1.2 | Production verified and story closed | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
None - no blocking issues encountered

### Completion Notes List
- Moved loading element outside #qt-container for independent visibility control
- Removed premature `container.innerHTML = ''` call that caused blank screen
- Added MutationObserver to detect when Qt adds canvas to container
- Added visibility check (offsetWidth/offsetHeight > 0) before hiding loading
- Loading now stays visible during entire Qt WASM initialization
- Fallback interface logic unchanged - still works as expected

### File List
- `public/index.html` - Modified: loading timing fix

---

## QA Results
*To be filled by QA agent*
