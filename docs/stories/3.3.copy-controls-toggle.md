# Story 3.3: Copy Functionality & Controls

## Status: Draft

## Story

**As a** user working with JSON in the TreeView,
**I want** copy buttons and view toggle controls,
**so that** I can easily copy values/paths and switch between TreeView and TextArea modes based on my needs.

## Story Context

**Existing System Integration:**
- Integrates with: JsonTreeView.qml (Story 3.2), OutputPane.qml, Toolbar.qml, Main.qml
- Technology: Qt 6 QML, Clipboard API
- Follows pattern: Toolbar actions like existing Copy/Format/Minify buttons
- Touch points: JsonTreeView.qml, Toolbar.qml, Main.qml, JsonBridge

## Acceptance Criteria

**Copy Functionality:**

1. Hover over any tree row shows copy icons (fade in)
2. "Copy Value" button copies the node's value to clipboard
   - Primitives: copies the raw value (e.g., `"John"`, `42`, `true`, `null`)
   - Objects/Arrays: copies serialized JSON of that subtree
3. "Copy Path" button copies JSONPath to clipboard (e.g., `$.user.address.city`)
4. Right-click context menu shows "Copy Value" and "Copy Path" options
5. "Copy All" toolbar button copies entire formatted JSON

**Global Controls:**

6. "Expand All" button expands all collapsible nodes
7. "Collapse All" button collapses all collapsible nodes
8. Keyboard shortcuts: Ctrl+E (expand all), Ctrl+Shift+E (collapse all)

**View Toggle:**

9. Toggle button switches between TreeView and TextArea modes
10. Toggle shows current mode icon/label (tree icon vs text icon)
11. Toggle state persists during session (not across browser refresh)
12. Default view is TreeView when JSON is loaded
13. TextArea mode shows existing OutputPane with full text selection capability

**Visual Design:**

14. Copy icons appear on hover, positioned at row end
15. Copy icons use subtle styling (don't distract from content)
16. Toggle button fits in existing Toolbar layout
17. Expand/Collapse buttons are grouped together

**Quality Requirements:**

18. Copy operations complete within 100ms
19. Clipboard write uses secure async API
20. Visual feedback on successful copy (brief highlight or tooltip)

## Tasks / Subtasks

- [ ] Task 1: Add hover copy icons to TreeView delegate (AC: 1, 14, 15)
  - [ ] Add copy icon components to TreeItemDelegate
  - [ ] Implement hover state detection
  - [ ] Fade in/out animation for icons
  - [ ] Position icons at right edge of row

- [ ] Task 2: Implement Copy Value functionality (AC: 2, 18, 19, 20)
  - [ ] Add `copyValue(index)` method to JsonTreeView
  - [ ] For primitives: copy raw value
  - [ ] For containers: serialize subtree to JSON string
  - [ ] Call JsonBridge clipboard method
  - [ ] Show visual feedback on success

- [ ] Task 3: Implement Copy Path functionality (AC: 3, 18, 19, 20)
  - [ ] Add `copyPath(index)` method to JsonTreeView
  - [ ] Get jsonPath from model role
  - [ ] Copy to clipboard
  - [ ] Show visual feedback

- [ ] Task 4: Add context menu (AC: 4)
  - [ ] Create Menu component for tree items
  - [ ] Add "Copy Value" menu item
  - [ ] Add "Copy Path" menu item
  - [ ] Wire up right-click handler
  - [ ] Position menu at cursor

- [ ] Task 5: Add Expand/Collapse All controls (AC: 6, 7, 8)
  - [ ] Add "Expand All" button to Toolbar
  - [ ] Add "Collapse All" button to Toolbar
  - [ ] Wire to JsonTreeView.expandAll() / collapseAll()
  - [ ] Add keyboard shortcuts (Ctrl+E, Ctrl+Shift+E)
  - [ ] Group buttons visually

- [ ] Task 6: Implement view toggle (AC: 9, 10, 11, 12, 13, 16)
  - [ ] Add toggle button to Toolbar
  - [ ] Create viewMode property in Main.qml ("tree" | "text")
  - [ ] Conditionally show JsonTreeView or OutputPane
  - [ ] Default to "tree" mode
  - [ ] Update button icon/label based on mode

- [ ] Task 7: Update Toolbar.qml layout (AC: 5, 16, 17)
  - [ ] Add "Copy All" button (if not present)
  - [ ] Add view toggle button
  - [ ] Add expand/collapse button group
  - [ ] Ensure responsive layout

- [ ] Task 8: Testing and polish (AC: 18, 19, 20)
  - [ ] Test copy with various JSON types
  - [ ] Test copy with large subtrees
  - [ ] Test keyboard shortcuts
  - [ ] Verify clipboard security (async API)
  - [ ] Test toggle persistence

## Dev Notes

### Relevant Source Tree
```
qt/qml/
‚îú‚îÄ‚îÄ Main.qml              # View mode state (modify)
‚îú‚îÄ‚îÄ Toolbar.qml           # Add new buttons (modify)
‚îú‚îÄ‚îÄ OutputPane.qml        # Existing text view (unchanged)
‚îú‚îÄ‚îÄ JsonTreeView.qml      # Add copy methods, context menu (modify)
‚îî‚îÄ‚îÄ Theme.qml             # May need icon colors (check)

qt/
‚îú‚îÄ‚îÄ jsonbridge.cpp        # Clipboard methods (may modify)
‚îî‚îÄ‚îÄ jsonbridge.h
```

### Copy Icons Design

```qml
// In TreeItemDelegate, at end of row
Row {
    id: copyIcons
    anchors.right: parent.right
    anchors.rightMargin: 8
    anchors.verticalCenter: parent.verticalCenter
    spacing: 4
    opacity: delegateRoot.hovered ? 1.0 : 0.0
    visible: opacity > 0

    Behavior on opacity {
        NumberAnimation { duration: 150 }
    }

    // Copy Value button
    Rectangle {
        width: 24
        height: 24
        radius: 4
        color: copyValueMouse.containsMouse ? Theme.backgroundTertiary : "transparent"

        Text {
            anchors.centerIn: parent
            text: "\uf0c5"  // clipboard icon (FontAwesome) or use "üìã"
            font.pixelSize: 12
            color: Theme.textSecondary
        }

        MouseArea {
            id: copyValueMouse
            anchors.fill: parent
            hoverEnabled: true
            cursorShape: Qt.PointingHandCursor
            onClicked: treeView.copyValue(model.index)

            ToolTip.visible: containsMouse
            ToolTip.text: "Copy Value"
            ToolTip.delay: 500
        }
    }

    // Copy Path button
    Rectangle {
        width: 24
        height: 24
        radius: 4
        color: copyPathMouse.containsMouse ? Theme.backgroundTertiary : "transparent"

        Text {
            anchors.centerIn: parent
            text: "\uf0c1"  // link icon or use "üìç"
            font.pixelSize: 12
            color: Theme.textSecondary
        }

        MouseArea {
            id: copyPathMouse
            anchors.fill: parent
            hoverEnabled: true
            cursorShape: Qt.PointingHandCursor
            onClicked: treeView.copyPath(model.index)

            ToolTip.visible: containsMouse
            ToolTip.text: "Copy Path"
            ToolTip.delay: 500
        }
    }
}
```

### Context Menu Implementation

```qml
// In JsonTreeView.qml
Menu {
    id: contextMenu
    property var targetIndex

    MenuItem {
        text: "Copy Value"
        onTriggered: copyValue(contextMenu.targetIndex)
    }

    MenuItem {
        text: "Copy Path"
        onTriggered: copyPath(contextMenu.targetIndex)
    }
}

// In delegate
MouseArea {
    anchors.fill: parent
    acceptedButtons: Qt.RightButton
    onClicked: (mouse) => {
        contextMenu.targetIndex = model.index
        contextMenu.popup(mouse.x, mouse.y)
    }
}
```

### Copy Methods

```qml
// In JsonTreeView.qml
function copyValue(index) {
    const value = model.data(index, QJsonTreeModel.ValueRole)
    const type = model.data(index, QJsonTreeModel.ValueTypeRole)

    let textToCopy
    if (type === "object" || type === "array") {
        // Serialize subtree
        textToCopy = JsonBridge.serializeSubtree(index)
    } else if (type === "string") {
        textToCopy = '"' + value + '"'
    } else {
        textToCopy = String(value)
    }

    JsonBridge.copyToClipboard(textToCopy)
    showCopyFeedback()
}

function copyPath(index) {
    const path = model.data(index, QJsonTreeModel.JsonPathRole)
    JsonBridge.copyToClipboard(path)
    showCopyFeedback()
}

function showCopyFeedback() {
    // Brief tooltip or highlight
    copyFeedback.show()
}
```

### JsonBridge Additions

```cpp
// jsonbridge.h
Q_INVOKABLE void copyToClipboard(const QString& text);
Q_INVOKABLE QString serializeSubtree(const QModelIndex& index);

// jsonbridge.cpp
void JsonBridge::copyToClipboard(const QString& text)
{
    QGuiApplication::clipboard()->setText(text);
}

QString JsonBridge::serializeSubtree(const QModelIndex& index)
{
    // Get the JSON subtree from the model and serialize it
    QJsonTreeItem* item = static_cast<QJsonTreeItem*>(index.internalPointer());
    return item->toJsonString();  // Implement in QJsonTreeItem
}
```

### Toolbar Layout Update

```qml
// Toolbar.qml additions
RowLayout {
    // ... existing buttons (Format, Minify, Copy) ...

    ToolSeparator {}

    // View mode toggle
    Button {
        id: viewToggle
        icon.source: viewMode === "tree" ? "qrc:/icons/tree.svg" : "qrc:/icons/text.svg"
        text: viewMode === "tree" ? "Tree" : "Text"
        onClicked: viewMode = (viewMode === "tree") ? "text" : "tree"

        ToolTip.visible: hovered
        ToolTip.text: viewMode === "tree" ? "Switch to Text View" : "Switch to Tree View"
    }

    ToolSeparator {}

    // Expand/Collapse group
    Row {
        spacing: 2

        Button {
            icon.source: "qrc:/icons/expand-all.svg"
            enabled: viewMode === "tree"
            onClicked: jsonTreeView.expandAll()

            ToolTip.visible: hovered
            ToolTip.text: "Expand All (Ctrl+E)"
        }

        Button {
            icon.source: "qrc:/icons/collapse-all.svg"
            enabled: viewMode === "tree"
            onClicked: jsonTreeView.collapseAll()

            ToolTip.visible: hovered
            ToolTip.text: "Collapse All (Ctrl+Shift+E)"
        }
    }
}
```

### Main.qml View Mode Logic

```qml
// Main.qml
property string viewMode: "tree"  // "tree" or "text"

// In the output area
Loader {
    id: outputLoader
    anchors.fill: parent

    sourceComponent: viewMode === "tree" ? treeViewComponent : textViewComponent
}

Component {
    id: treeViewComponent
    JsonTreeView {
        id: jsonTreeView
        model: JsonBridge.treeModel
    }
}

Component {
    id: textViewComponent
    OutputPane {
        id: outputPane
        text: outputText
    }
}

// Keyboard shortcuts
Shortcut {
    sequence: "Ctrl+E"
    enabled: viewMode === "tree"
    onActivated: jsonTreeView.expandAll()
}

Shortcut {
    sequence: "Ctrl+Shift+E"
    enabled: viewMode === "tree"
    onActivated: jsonTreeView.collapseAll()
}
```

### Visual Feedback on Copy

```qml
// Brief toast/notification
Rectangle {
    id: copyFeedback
    anchors.bottom: parent.bottom
    anchors.horizontalCenter: parent.horizontalCenter
    anchors.bottomMargin: 20
    width: copyFeedbackText.width + 20
    height: 30
    radius: 4
    color: Theme.success
    opacity: 0
    visible: opacity > 0

    Text {
        id: copyFeedbackText
        anchors.centerIn: parent
        text: "Copied!"
        color: "white"
    }

    function show() {
        opacity = 1
        hideTimer.restart()
    }

    Timer {
        id: hideTimer
        interval: 1500
        onTriggered: copyFeedback.opacity = 0
    }

    Behavior on opacity {
        NumberAnimation { duration: 200 }
    }
}
```

### Icons (Simple Text-Based Alternative)

If no icon fonts available, use text-based icons:

| Action | Text Icon |
|--------|-----------|
| Copy Value | üìã or [C] |
| Copy Path | üìç or [P] |
| Expand All | ‚äû or [+] |
| Collapse All | ‚äü or [-] |
| Tree View | üå≥ or [T] |
| Text View | üìù or [A] |

## Technical Notes

- **Integration Approach:** Extend existing Toolbar pattern with new buttons
- **Existing Pattern Reference:** Copy button in current Toolbar
- **Key Constraints:** Clipboard must use Qt's async API for WASM; toggle must not lose data

## Definition of Done

- [ ] Hover copy icons appear and work correctly
- [ ] Copy Value copies correct content (primitives and objects/arrays)
- [ ] Copy Path copies JSONPath notation
- [ ] Context menu works on right-click
- [ ] Copy All copies entire JSON
- [ ] Expand All / Collapse All work
- [ ] Keyboard shortcuts functional
- [ ] View toggle switches between TreeView and TextArea
- [ ] Visual feedback on copy success
- [ ] No regression in existing copy functionality

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Clipboard API differences in WASM vs native
- **Mitigation:** Use Qt's clipboard abstraction; test in both environments
- **Rollback:** Disable TreeView-specific copy; users use TextArea mode

**Compatibility Verification:**
- [ ] Clipboard works in WASM browser environment
- [ ] Context menu displays correctly
- [ ] Keyboard shortcuts don't conflict with browser shortcuts
- [ ] Toggle preserves JSON content when switching

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |
