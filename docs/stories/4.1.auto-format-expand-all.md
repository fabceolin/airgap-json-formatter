# Story 4.1: Auto-Format on Paste & Expand All on First Render

## Status: Blocked - Failed Production Testing

## Story

**As a** user working with JSON data,
**I want** JSON to be automatically formatted when I paste it and the TreeView to expand fully on first render,
**so that** I can immediately see my data in a readable format without extra clicks.

## Story Context

**Existing System Integration:**
- Integrates with: Main.qml (paste handling, format triggering), JsonTreeView.qml (expand behavior)
- Technology: Qt 6 QML, existing JsonBridge
- Follows pattern: Existing Ctrl+V paste shortcut in Main.qml
- Touch points: Main.qml, JsonTreeView.qml

## Acceptance Criteria

**Auto-Format on Paste:**

1. When user pastes JSON (Ctrl+V or browser paste), automatically trigger Format action
2. Use current indent setting from toolbar (spaces:2, spaces:4, or tabs)
3. If pasted content is invalid JSON, show in input pane without formatting (allow user to fix)
4. Auto-format only triggers when input pane is empty or fully selected
5. If input pane has partial content, paste normally without auto-format

**Expand All on First Render:**

6. When JSON is successfully formatted and loaded into TreeView, automatically expand all nodes
7. Only auto-expand on initial load, not on subsequent expand/collapse actions
8. If JSON has more than 1000 nodes, show first 3 levels expanded by default (performance guard)
9. User can still manually collapse/expand after initial render

**Quality Requirements:**

10. Auto-format completes within 200ms for typical JSON (< 100KB)
11. Expand all animation is smooth (no janky scroll)
12. No regression in manual format/expand workflows

## Tasks / Subtasks

- [ ] Task 1: Implement auto-format on paste (AC: 1, 2, 3, 4, 5)
  - [x] Modify paste shortcut handler in Main.qml
  - [x] Check if input pane is empty or fully selected
  - [x] Call formatJson with current indent setting
  - [x] Handle invalid JSON gracefully (paste without format)
  - [ ] Test with various paste scenarios
  - [ ] **FAILED IN PROD** - Needs debugging

- [ ] Task 2: Implement expand all on first render (AC: 6, 7, 9)
  - [x] Add `autoExpandOnLoad` property to JsonTreeView
  - [x] Call expandAll() after model data changes
  - [x] Ensure only triggers on fresh load, not user actions
  - [ ] **FAILED IN PROD** - Needs debugging

- [ ] Task 3: Add performance guard for large JSON (AC: 8)
  - [x] Count nodes before expanding
  - [x] If > 1000 nodes, expand only first 3 levels
  - [x] Add `expandToLevel(depth)` function to JsonTreeView
  - [ ] **FAILED IN PROD** - Needs debugging

- [ ] Task 4: Testing and polish (AC: 10, 11, 12)
  - [ ] Test auto-format with valid/invalid JSON
  - [ ] Test expand performance with large JSON
  - [ ] Verify no regression in manual workflows

## Dev Notes

### Relevant Source Tree
```
qt/qml/
├── Main.qml              # Paste handling, format triggering (modify)
├── JsonTreeView.qml      # Expand all logic (modify)
└── Toolbar.qml           # Get current indent setting (read-only)

qt/
├── qjsontreemodel.h      # May need node count method
└── qjsontreemodel.cpp
```

### Auto-Format on Paste Implementation

```qml
// Main.qml - Modified paste shortcut
Shortcut {
    sequences: [StandardKey.Paste]
    onActivated: {
        const text = JsonBridge.readFromClipboard();
        if (text) {
            // Check if we should auto-format
            const shouldAutoFormat = inputPane.text.trim() === "" ||
                                     inputPane.isFullySelected();

            if (shouldAutoFormat) {
                // Try to format
                const result = JsonBridge.formatJson(text, toolbar.selectedIndent);
                if (result.success) {
                    inputPane.text = text;  // Put original in input
                    currentFormattedJson = result.result;
                    outputPane.text = result.result;
                    JsonBridge.loadTreeModel(result.result);
                    validateInput();
                } else {
                    // Invalid JSON - just paste without formatting
                    inputPane.text = text;
                }
            } else {
                // Has partial content - paste normally
                inputPane.text = text;
            }
        }
    }
}
```

### Expand All on Load Implementation

```qml
// JsonTreeView.qml additions
property bool autoExpandOnLoad: true
property int maxAutoExpandNodes: 1000
property int defaultExpandDepth: 3

Connections {
    target: model
    function onDataChanged() {
        if (autoExpandOnLoad) {
            Qt.callLater(performAutoExpand)
        }
    }
}

function performAutoExpand() {
    const nodeCount = model.totalNodeCount()  // Need to add this method
    if (nodeCount <= maxAutoExpandNodes) {
        expandAll()
    } else {
        expandToLevel(defaultExpandDepth)
    }
}

function expandToLevel(maxDepth) {
    for (let row = 0; row < treeView.rows; row++) {
        const depth = model.data(treeView.index(row, 0), QJsonTreeModel.DepthRole)
        if (depth < maxDepth) {
            treeView.expand(row)
        }
    }
}
```

### InputPane Selection Check

```qml
// InputPane.qml - Add method to check selection state
function isFullySelected() {
    return textArea.selectedText === textArea.text && textArea.text.length > 0
}
```

### Performance Considerations

- Use `Qt.callLater()` for expand operations to avoid blocking UI
- Node count calculation should be O(1) from cached model data
- Consider debouncing rapid paste operations

## Technical Notes

- **Integration Approach:** Extend existing paste shortcut with conditional formatting
- **Existing Pattern Reference:** Current Ctrl+V handler in Main.qml:267-275
- **Key Constraints:** Must not break existing paste behavior for partial content

## Definition of Done

- [ ] Auto-format triggers on paste when input is empty
- [ ] Auto-format uses current indent setting
- [ ] Invalid JSON pastes without formatting
- [ ] TreeView expands all on initial load
- [ ] Large JSON (>1000 nodes) expands to 3 levels only
- [ ] No performance degradation
- [ ] No regression in existing functionality

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Auto-format may be unexpected for users wanting raw paste
- **Mitigation:** Only auto-format when input is empty; document behavior
- **Rollback:** Revert to manual format only

**Compatibility Verification:**
- [ ] Browser paste events still work
- [ ] Manual format workflow unchanged
- [ ] Expand/collapse shortcuts still work
- [ ] Performance acceptable for large JSON

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-21 | 1.0 | Initial story creation | Sarah (PO) |
| 2026-01-21 | 1.1 | Implementation of Tasks 1-3 | James (Dev) |
| 2026-01-21 | 1.2 | Production testing FAILED - marking blocked | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Modified:**
- `qt/qml/Main.qml` - Added auto-format logic to paste shortcut (lines 266-295)
- `qt/qml/InputPane.qml` - Added `isFullySelected()` function (lines 12-15)
- `qt/qml/JsonTreeView.qml` - Added auto-expand properties, `expandToLevel()`, `performAutoExpand()`, and model reset connection (lines 11-61)
- `qt/qjsontreemodel.h` - Added `totalNodeCount()` declaration and `countNodes()` helper (lines 44-51)
- `qt/qjsontreemodel.cpp` - Added `totalNodeCount()` and `countNodes()` implementations (lines 213-231)

**New:**
- None

**Deleted:**
- None

### Debug Log References
- See Debug Log Entry #1 below

### Completion Notes
- Tasks 1-3 implemented: auto-format on paste, expand all on first render, performance guard for large JSON
- Task 4 (testing) pending: Build tools (cmake, qmake) not available in current environment
- Implementation follows dev notes pattern exactly
- Uses Qt6 TreeView's built-in `expandRecursively(row, depth)` for efficient depth-limited expansion
- Model reset signal (`onModelReset`) used instead of `onDataChanged` for cleaner detection of fresh loads
- Node counting is O(n) recursive traversal; acceptable for performance guard threshold check

### Debug Log

#### Entry #1: Production Testing Failed (2026-01-21)
**Commit:** d7e8853
**Result:** FAILED - Features did not work in production

**Possible Issues to Investigate:**

1. **Auto-format on paste:**
   - `JsonBridge.readFromClipboard()` may not work in WASM/browser context
   - Qt WASM clipboard API has known limitations
   - `isFullySelected()` may not correctly detect selection state in TextArea

2. **Expand all on first render:**
   - `onModelReset` signal may not fire correctly in QML
   - `treeView.model.totalNodeCount()` may not be callable from QML (Q_INVOKABLE issue)
   - `expandRecursively()` may need to wait for model to fully populate

3. **General issues:**
   - WASM build may have different behavior than native Qt
   - Check browser console for JavaScript/QML errors
   - Verify C++ methods are properly exposed to QML

**Next Steps for Future Development:**
1. Add console.log/qDebug statements to trace execution flow
2. Test in native Qt build first (not WASM) to isolate issues
3. Verify `totalNodeCount()` is accessible from QML
4. Check if `onModelReset` fires at the right time
5. Test clipboard functionality separately in WASM environment
