# Spike 7.0: XML Formatting Feasibility - Investigation Report

**Date:** 2026-01-26
**Investigator:** James (Dev Agent)
**Status:** Complete

---

## Executive Summary

**Recommendation: PROCEED** with XML formatting support.

The investigation confirms that adding XML formatting is technically feasible with minimal risk. The quick-xml library is WASM-compatible, adds only 58KB to the bundle (well under the 200KB threshold), and integrates cleanly with existing architecture patterns.

---

## Q1: Rust XML Library Selection

### Evaluation

| Library | WASM Build | Performance | Error Quality | Maintenance | Verdict |
|---------|------------|-------------|---------------|-------------|---------|
| **quick-xml** | ✅ Pass | Excellent (streaming) | Good | Active (v0.37) | **Selected** |
| roxmltree | Likely | Good | Excellent | Active | Alternative |
| xml-rs | Untested | Moderate | Good | Mature | Not tested |

### Selection: `quick-xml v0.37`

**Reasons:**
1. **WASM-compatible**: Built and tested successfully with `wasm-pack build --target web`
2. **No networking/file I/O**: Pure parsing/writing, satisfies airgap constraint
3. **Streaming API**: Memory-efficient, matches our existing parse-then-write pattern
4. **Active maintenance**: Regular releases, good issue response time

### Roundtrip Test Results

```
✓ test_format_xml_basic
✓ test_format_xml_with_attributes
✓ test_format_xml_with_declaration
✓ test_minify_xml
✓ test_roundtrip
✓ test_cdata
✓ test_comments
✓ test_namespace_prefix
✓ test_empty_input
```

All 9 formatting tests pass. Parse → serialize roundtrip preserves content integrity.

---

## Q2: WASM Bundle Impact

| Metric | Value |
|--------|-------|
| **Baseline (JSON only)** | 108 KB |
| **With quick-xml** | 166 KB |
| **Delta** | **+58 KB** |
| **Threshold** | <200 KB |
| **Verdict** | ✅ **PASS** |

The 54% increase is acceptable. With gzip compression (typical for web delivery), the delta would be ~15-20KB transferred.

---

## Q3: Formatting Logic Complexity

### Type Reuse

| Type | Reusable | Notes |
|------|----------|-------|
| `IndentStyle` | ✅ Yes | Works directly for XML indentation |
| `FormatError` | ✅ Yes | Same error structure applies |

### XML-Specific Edge Cases

| Edge Case | Handling | Complexity |
|-----------|----------|------------|
| **Namespace prefixes** | ✅ Preserved | Low - quick-xml handles natively |
| **CDATA sections** | ✅ Preserved | Low - passthrough |
| **Comments** | ✅ Preserved | Low - passthrough |
| **Processing instructions** | ✅ Preserved | Low - passthrough |
| **Attribute ordering** | ⚠️ Preserved (not sorted) | Low - matches source order |
| **Mixed content** | ⚠️ Whitespace trimmed | Medium - acceptable default |
| **Self-closing tags** | ✅ Preserved | Low - `<tag/>` stays `<tag/>` |

### Implemented PoC

Created `src/xml_formatter.rs` with:
- `format_xml(input: &str, indent: IndentStyle) -> Result<String, FormatError>`
- `minify_xml(input: &str) -> Result<String, FormatError>`

**Effort estimate:** ~200 lines of Rust (actual: 194 lines)

---

## Q4: Syntax Highlighter Effort

### Architecture Analysis

Reviewed `src/highlighter.rs`:
- **Pattern:** Character-by-character state machine
- **Lines:** ~335 lines
- **States:** 6 (text, object, array, string, number, keyword)

### XML Highlighter Design

Created `src/xml_highlighter.rs` prototype:
- **States:** 12 (Text, TagOpen, TagName, TagClose, InTag, AttrName, AttrEquals, AttrValue, Comment, Cdata, Declaration, Doctype)
- **Token colors:**
  - Tag names: Blue (#569cd6)
  - Attribute names: Light blue (#9cdcfe)
  - Attribute values: Orange (#ce9178)
  - Comments: Green (#6a9955)
  - CDATA: Yellow (#dcdcaa)
  - Declarations: Purple (#c586c0)
- **Lines:** ~320 lines

**Effort estimate:** 2-3 days for production-ready implementation (prototype complete)

### Test Results

```
✓ test_highlight_empty
✓ test_highlight_simple_element
✓ test_highlight_with_attributes
✓ test_highlight_comment
✓ test_highlight_cdata
✓ test_highlight_declaration
✓ test_highlight_namespace
✓ test_escapes_html
```

All 8 highlighter tests pass.

---

## Q5: UI Integration Path

### Format Selector Placement

**Recommended:** Add ComboBox near indent selector in Toolbar.qml

```qml
// Before indent selector
ComboBox {
    id: formatCombo
    model: ["JSON", "XML"]
    currentIndex: 0
    // ... styling matching indentCombo
}
```

**Impact:** Low - additive change, no existing UI disrupted

### Tree View Approach

**Recommendation:** Create separate `QXmlTreeModel`

**Rationale:**
- `QJsonTreeModel` is tightly coupled to `QJsonDocument` and `QJsonTreeItem`
- XML structure differs (attributes, mixed content, namespaces)
- Abstraction would add complexity without clear benefit
- Parallel implementation is cleaner and maintains single-responsibility

**Effort:** 3-5 days for XmlTreeModel + XmlTreeItem

### Format Auto-Detection

**Feasibility:** ✅ Simple and desirable

```cpp
QString detectFormat(const QString &input) {
    QString trimmed = input.trimmed();
    if (trimmed.startsWith('<')) return "xml";
    if (trimmed.startsWith('{') || trimmed.startsWith('[')) return "json";
    return "unknown";
}
```

**Recommendation:** Implement auto-detect but allow manual override

---

## Q6: Bridge Layer Changes

### Required Modifications

**JsonBridge.h additions:**
```cpp
Q_INVOKABLE void formatXml(const QString &input, const QString &indentType);
Q_INVOKABLE void minifyXml(const QString &input);
Q_INVOKABLE QString highlightXml(const QString &input);
Q_INVOKABLE bool loadXmlTreeModel(const QString &xml);

signals:
    void formatXmlCompleted(const QVariantMap &result);
    void minifyXmlCompleted(const QVariantMap &result);
```

**Approach:** Parallel methods (not parameterized) for clarity

### AsyncSerialiser Compatibility

**Status:** ✅ Compatible - no changes needed

XML operations will use the same `AsyncSerialiser::enqueue()` pattern. The serializer is format-agnostic.

---

## Risk Assessment (Updated)

| Risk | Status | Mitigation |
|------|--------|------------|
| XML lib not WASM-compatible | ✅ **Mitigated** | Verified with wasm-pack build |
| Bundle size explosion | ✅ **Mitigated** | +58KB is acceptable |
| Mixed content formatting | ⚠️ **Accepted** | Whitespace trimmed by default |
| Tree model abstraction | ✅ **Mitigated** | Will use parallel implementation |

**No blocking risks identified.**

---

## Effort Estimate

| Component | Estimate | Confidence |
|-----------|----------|------------|
| xml_formatter.rs (production) | 1-2 days | High (PoC done) |
| xml_highlighter.rs (production) | 2-3 days | High (PoC done) |
| XmlTreeModel + XmlTreeItem | 3-5 days | Medium |
| Bridge layer updates | 1-2 days | High |
| Toolbar format selector | 0.5-1 day | High |
| Main.qml format state | 0.5-1 day | High |
| Integration testing | 2-3 days | Medium |
| **Total** | **10-17 days** | Medium |

**Story points (full epic):** 13-21 points

---

## Deliverables Created

1. **src/xml_formatter.rs** - Format/minify XML (194 lines, 9 tests)
2. **src/xml_highlighter.rs** - Syntax highlighting (320 lines, 8 tests)
3. **WASM exports** - `formatXml`, `minifyXml`, `highlightXml` in lib.rs
4. **Cargo.toml** - Added `quick-xml = "0.37"` dependency

---

## Recommendation

### PROCEED with caveats

**Proceed because:**
1. All technical risks validated and mitigated
2. Bundle size impact minimal (+58KB)
3. PoC demonstrates feasibility with working code
4. Existing patterns (formatter, highlighter) apply cleanly

**Caveats:**
1. Tree view requires separate XmlTreeModel (~3-5 days additional effort)
2. Mixed content (text + elements) uses opinionated whitespace handling
3. No XML validation/DTD support (out of scope per story)

---

## Draft Epic Structure

### Epic 8.0: XML Formatting Support

**Stories:**
1. **8.1** Rust XML Formatter - Productionize xml_formatter.rs
2. **8.2** Rust XML Highlighter - Productionize xml_highlighter.rs
3. **8.3** Bridge Layer - Add XML methods to JsonBridge
4. **8.4** Toolbar Format Selector - Add JSON/XML toggle
5. **8.5** Format Auto-Detection - Detect format from content
6. **8.6** XML Tree Model - Create QXmlTreeModel
7. **8.7** Integration Testing - End-to-end XML workflows

**Dependencies:**
- 8.1 → 8.3 → 8.4
- 8.2 → 8.3
- 8.5 can parallel 8.4
- 8.6 can parallel 8.3-8.5
- 8.7 depends on all

---

## Appendix: Test Commands

```bash
# Run all XML tests
cargo test xml

# Build WASM with XML support
wasm-pack build --target web --release

# Measure WASM size
ls -lh pkg/airgap_json_formatter_bg.wasm
```
