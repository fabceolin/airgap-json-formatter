# Story 8.1: Productionize XML Formatter

## Status: Done ✅

> **SM Re-Validation (2026-01-28):** Definition of Ready confirmed - all 7 criteria passed. Story has clear title/description, 9 testable ACs, documented dependencies, comprehensive technical approach, proper sizing (6 tasks), complete QA sections (Risk, NFR, Test Design, Trace), and no blocking unknowns.

## Story

**As a** developer or security analyst working with sensitive XML data in an airgap environment,
**I want** reliable, production-quality XML formatting with accurate error positions and predictable behavior,
**so that** I can confidently process configuration files, API responses, and security reports knowing the tool handles all XML constructs correctly and provides actionable debugging information when issues occur.

## Business Value

- **User Trust:** Accurate error positions enable rapid debugging, reducing frustration and support burden
- **Data Integrity:** Guaranteed preservation of all XML constructs (CDATA, PIs, namespaces) prevents data loss in sensitive documents
- **Operational Reliability:** Predictable behavior under edge cases (deep nesting, large files) ensures the tool works when users need it most
- **Code Quality:** DRY refactoring reduces maintenance burden and eliminates behavioral divergence between format/minify operations

## Acceptance Criteria

1. XML formatting produces correctly indented output for all valid XML inputs
2. XML minification removes all non-essential whitespace while preserving content
3. Parse errors include line and column position (non-zero) for debugging
4. All XML constructs are preserved: declarations, comments, CDATA, PIs, namespaces
5. Format and minify operations produce identical preservation of all XML construct types (parity guarantee)
6. Code follows DRY principles with shared event handling logic (no duplicated event handlers)
7. Test coverage includes malformed XML, edge cases, and resource boundary conditions
8. Deep nesting at 500 levels either succeeds or returns graceful FormatError (no panic/trap)
9. WASM build succeeds with no new warnings

## Tasks / Subtasks

> **Task Dependency Chain:** Tasks 1→2→3 are sequential (each depends on prior). Tasks 4, 5, 6 can run in parallel after Task 3.

- [x] Task 1: Establish pre-refactor baseline tests (AC: 1, 2, 4, 5, 6) — **BLOCKING: Must complete before Task 2**
  - [x] Add snapshot/equivalence tests for `format_xml` and `minify_xml` covering ALL XML construct types (declaration, comment, CDATA, PI, DocType, namespaces, nested elements, attributes, text nodes, empty elements)
  - [x] Add explicit tests that `minify_xml` preserves PI and DocType events (currently untested catch-all path at lines 180-184)
  - [x] Add format/minify parity tests: verify both functions produce identical preservation of all construct types
  - [x] Verify format indentation structure (check newline and indent depth, not just content presence)
  - [x] Capture current output as snapshot baseline (save expected outputs for byte-identical comparison in Task 2)
  - [x] **Exit Criterion:** All baseline tests pass; snapshots recorded

- [x] Task 2: Extract shared event handling (AC: 5, 6) — **BLOCKING: Must complete before Task 3; Requires Task 1**
  - [x] Create `write_event_to()` helper function handling all event types explicitly (no catch-all arms)
  - [x] Refactor `format_xml()` to use shared helper
  - [x] Refactor `minify_xml()` to use shared helper — replace catch-all arm with explicit handlers
  - [x] Run all Task 1 baseline tests — output must be byte-identical to pre-refactor snapshots
  - [x] **Exit Criterion:** Zero behavior changes; all Task 1 tests pass with identical output

- [x] Task 3: Add error position tracking (AC: 3) — **Requires Task 2**
  - [x] Implement `position_to_line_column(input, byte_offset)` helper (see Dev Notes)
  - [x] Thread `input: &str` reference through call sites to enable position calculation
  - [x] Wire `reader.buffer_position()` into all `FormatError::new()` call sites (32 locations identified in trace)
  - [x] Add tests for error position accuracy on: unclosed tag, mismatched tags, invalid attribute syntax
  - [x] Verify positions are non-zero and point to the correct region of the input
  - [x] **Exit Criterion:** All error tests return line > 0, column > 0

- [x] Task 4: Expand test coverage (AC: 7, 8) — **Can run parallel with Tasks 5, 6 after Task 3**
  - [x] Add malformed XML tests:
    - [x] Unclosed tag — verify error position points near EOF
    - [x] Mismatched tags — verify error position points to closing tag
    - [x] Invalid attribute syntax — verify error position points to attribute
    - [x] Invalid entity reference
  - [x] Add edge case tests:
    - [x] Very deeply nested XML (100+ levels) — must succeed
    - [x] Deep nesting at 500 levels — must succeed or return graceful `FormatError` (no panic/trap)
    - [x] Large attribute values (>1KB)
    - [x] Multiple namespace declarations
    - [x] XML with BOM (UTF-8 BOM: `\xEF\xBB\xBF`) — must handle gracefully
    - [x] Whitespace-only text nodes
  - [x] Add roundtrip property test (format → minify → format = format)
  - [x] Add idempotency test for minify (minify(minify(x)) == minify(x))

- [x] Task 5: Update module documentation (AC: 1, 2) — **Can run parallel with Tasks 4, 6**
  - [x] Update module doc comment from "Spike Investigation" to production description
  - [x] Document public API with examples
  - [x] Document known limitations:
    - [x] Mixed content whitespace: text nodes have leading/trailing whitespace trimmed
    - [x] Attribute ordering: preserved from source, not sorted
    - [x] No DTD validation: parser accepts well-formed XML only
    - [x] No input size guard (document max tested size, e.g., "tested up to 10MB")

- [x] Task 6: Verify WASM build (AC: 9) — **Can run parallel with Tasks 4, 5**
  - [x] Run `wasm-pack build --target web --release`
  - [x] Confirm no new compiler warnings (capture output, grep for `warning:`)
  - [x] Verify WASM exports work correctly (js_format_xml, js_minify_xml callable)
  - [x] Test basic format/minify via WASM exports to ensure they match native behavior

## Dev Notes

### Relevant Source Tree

```
src/
├── xml_formatter.rs    # TARGET FILE - refactor and harden
├── formatter.rs        # REFERENCE - JSON formatter pattern (uses serde_json error positions)
├── types.rs            # FormatError struct (line, column fields)
└── lib.rs              # WASM exports (js_format_xml, js_minify_xml)
```

### Current State (from Spike 7.0)

The PoC in `xml_formatter.rs` works but has:
- **Code duplication**: `format_xml()` and `minify_xml()` repeat event handling (lines 43-116 and 136-189)
- **No error positions**: All errors use `FormatError::new("...", 0, 0)` - no line/column
- **Basic tests only**: 9 tests covering happy path, need malformed XML coverage

### Key Patterns to Follow

**Error Handling (from formatter.rs:13-15):**
```rust
// JSON uses serde_json's error positions
let value: Value = serde_json::from_str(input).map_err(|e| {
    FormatError::new(e.to_string(), e.line(), e.column())
})?;
```

**For XML, use quick_xml's buffer_position():**
```rust
// Get byte offset, convert to line/column
let pos = reader.buffer_position();
// Note: quick-xml gives byte offset, not line/column
// You'll need to compute line/column from input string
```

### Line/Column Calculation Helper

```rust
/// Convert byte offset to line/column (1-indexed).
/// CRITICAL: byte_offset must be a valid UTF-8 boundary or this will panic.
fn position_to_line_column(input: &str, byte_offset: usize) -> (usize, usize) {
    let clamped = byte_offset.min(input.len());
    let prefix = &input[..clamped];
    let line = prefix.matches('\n').count() + 1;
    let column = match prefix.rfind('\n') {
        Some(newline_pos) => clamped - newline_pos,  // chars after last newline
        None => clamped + 1,  // no newline, column is offset + 1 (1-indexed)
    };
    (line, column)
}
```

**Implementation Note:** The `reader.buffer_position()` returns a byte offset. The helper above converts this to line/column. You'll need to pass the original `input: &str` through to error sites. Consider adding it as a field or passing it explicitly.

### Shared Event Handling Pattern

Extract common logic into a helper. The helper must take `input` and `reader` to calculate error positions:

```rust
/// Write a single XML event, using reader position for error reporting.
///
/// # Arguments
/// * `writer` - Target writer (formatted or minified)
/// * `event` - The XML event to write
/// * `input` - Original input string (for position calculation)
/// * `reader` - Reader reference (for buffer_position())
fn write_event_to<W: std::io::Write>(
    writer: &mut Writer<W>,
    event: Event<'_>,
    input: &str,
    reader: &Reader<&[u8]>,
) -> Result<(), FormatError> {
    let make_error = |msg: &str| -> FormatError {
        let (line, col) = position_to_line_column(input, reader.buffer_position());
        FormatError::new(msg, line, col)
    };

    match event {
        Event::Start(e) => {
            let name = String::from_utf8(e.name().as_ref().to_vec())
                .map_err(|_| make_error("Invalid UTF-8 in tag name"))?;
            let mut new_elem = BytesStart::new(name);
            for attr in e.attributes() {
                let attr = attr.map_err(|_| make_error("Invalid attribute"))?;
                new_elem.push_attribute(attr);
            }
            writer.write_event(Event::Start(new_elem))
                .map_err(|e| make_error(&format!("Write error: {}", e)))?;
        }
        Event::End(e) => { /* similar pattern */ }
        Event::Empty(e) => { /* similar pattern */ }
        Event::Text(e) => { /* similar pattern */ }
        Event::CData(e) => {
            writer.write_event(Event::CData(e))
                .map_err(|e| make_error(&format!("Write error: {}", e)))?;
        }
        Event::Comment(e) => { /* pass-through with error handling */ }
        Event::Decl(e) => { /* pass-through with error handling */ }
        Event::PI(e) => { /* pass-through with error handling */ }
        Event::DocType(e) => { /* pass-through with error handling */ }
        Event::Eof => { /* no-op */ }
    }
    Ok(())
}
```

**CRITICAL: Both `format_xml()` and `minify_xml()` must call this shared helper for ALL event types.** The only difference is the Writer configuration: `Writer::new_with_indent()` for format, `Writer::new()` for minify.

### Known Limitations to Document

1. **Mixed content whitespace**: Text nodes have leading/trailing whitespace trimmed
2. **Attribute ordering**: Preserved from source, not sorted
3. **No DTD validation**: Parser accepts well-formed XML only
4. **No input size guard**: Large inputs processed without memory limits (WASM has ~4GB max)
5. **Deep nesting**: Stack depth is bounded by WASM stack size; tested up to 500 levels

### WASM Stack Overflow Handling

Deep XML nesting may exhaust the WASM stack. The behavior depends on nesting depth:
- **100 levels**: Must succeed (tested)
- **500 levels**: Must succeed OR return graceful `FormatError` (no trap/panic)
- **1000+ levels**: Undefined; may trap

If quick-xml's internal recursion exceeds WASM stack limits, it will trap. This cannot be caught in Rust/WASM. Test at 500 levels and document the supported depth limit.

### Dependencies

- `quick-xml = "0.37"` (already in Cargo.toml from spike)

### Architecture Decisions

1. **No input size validation**: Adding a hard limit (e.g., 10MB) was considered but not required by business ACs. Document tested max size instead.
2. **Error positions via buffer_position()**: The `quick-xml` reader provides `buffer_position()` returning byte offset. This must be converted to line/column using the helper.
3. **Shared event handler design**: The `write_event_to()` helper takes a generic `Writer<W>` and handles all event types explicitly. Both format and minify call this helper, differing only in Writer configuration (indent vs no-indent).

## Testing

### Test Location
- File: `src/xml_formatter.rs` (inline `#[cfg(test)] mod tests`)
- Pattern: Follow existing test structure in the file

### Test Standards
- Use `#[test]` attribute for unit tests
- Test both success and error cases
- Use descriptive test names: `test_<function>_<scenario>`
- Assert specific error messages for error cases

### Required Test Cases

**P0 — Blocking for AC3 (implement in Task 3):**

| Category | Test | Input | Expected |
|----------|------|-------|----------|
| Error Pos | Unclosed tag | `<root>` | Error with line=1, column>0 |
| Error Pos | Mismatched tags | `<a></b>` | Error with line=1, column pointing to `</b>` |
| Error Pos | Invalid attribute | `<a b>` | Error with line=1, column pointing to `b` |

**P1 — Baseline tests (implement in Task 1):**

| Category | Test | Input | Expected |
|----------|------|-------|----------|
| Construct | PI preserved (format) | `<?xml?><root><?pi data?></root>` | PI in output |
| Construct | PI preserved (minify) | Same | PI in output, validates catch-all path |
| Construct | DocType preserved | `<!DOCTYPE root><root/>` | DocType in output |
| Parity | format/minify PI parity | PI XML | Both preserve identically |
| Parity | format/minify DocType parity | DocType XML | Both preserve identically |
| Indent | Verify indent depth | `<a><b><c/></b></a>` | Line 2 has 2 spaces, line 3 has 4 spaces |

**P2 — Edge cases (implement in Task 4):**

| Category | Test | Input | Expected |
|----------|------|-------|----------|
| Malformed | Invalid entity | `<a>&badref;</a>` | Error with position |
| Edge | Deep nesting (100 levels) | Generated 100-level XML | Success |
| Edge | Deep nesting (500 levels) | Generated 500-level XML | Success OR graceful FormatError (no panic) |
| Edge | Large attribute (1KB) | `<a attr="1KB...">` | Success, attr preserved |
| Edge | Multiple namespaces | `<a xmlns:x="..." xmlns:y="...">` | Both preserved |
| Edge | BOM prefix | `\xEF\xBB\xBF<?xml...` | Handle gracefully (strip or preserve) |
| Edge | Whitespace-only text | `<a>   </a>` | Whitespace handled per doc'd behavior |
| Property | format→minify→format | Any valid XML | Idempotent: result equals format(input) |
| Property | minify→minify | Any valid XML | Idempotent: result unchanged |

### Running Tests
```bash
# Run XML formatter tests only
cargo test xml_formatter

# Run all tests
cargo test

# Run with output
cargo test xml_formatter -- --nocapture
```

## Definition of Done

- [x] All acceptance criteria met
- [x] All tasks completed
- [x] All tests passing (existing + new)
- [x] WASM build succeeds
- [x] No new compiler warnings
- [x] Code reviewed and follows project patterns

## SM Validation

**Date:** 2026-01-28 (Re-validated)
**Validator:** Bob (Scrum Master)
**Result:** ✅ READY FOR DEVELOPMENT

### Definition of Ready - Validation Results

| Criterion | Status | Evidence |
|-----------|--------|----------|
| 1. Clear title and description | ✅ PASS | Title "Productionize XML Formatter"; User story with persona/need/benefit |
| 2. Acceptance criteria testable | ✅ PASS | 9 ACs (AC1-AC9), all measurable, mapped to test matrix |
| 3. Dependencies identified | ✅ PASS | Task chain 1→2→3 documented; Spike 7.0 prior work; quick-xml dependency |
| 4. Technical approach documented | ✅ PASS | Dev Notes with code examples; helper patterns; source tree |
| 5. Story properly sized | ✅ PASS | 6 tasks with subtasks; exit criteria; parallel opportunities |
| 6. QA notes present | ✅ PASS | Risk (52/100), NFR (70/100), Test Design (34 cases), Trace (9 ACs) |
| 7. No blocking issues | ✅ PASS | Gaps identified with mitigation tasks; WASM behavior documented |

### Story Draft Checklist Results

| Category | Status | Notes |
|----------|--------|-------|
| 1. Goal & Context Clarity | PASS | Clear user story, business value, and epic relationship |
| 2. Technical Implementation Guidance | PASS | Key files, APIs, code patterns, and dependencies identified; shared helper signature includes reader/input for error positions |
| 3. Reference Effectiveness | PASS | Specific line numbers, summarized prior work from Spike 7.0 |
| 4. Self-Containment Assessment | PASS | All info needed in story; edge cases and limitations documented |
| 5. Testing Guidance | PASS | 34 test cases in P0/P1/P2 matrix across all 9 ACs |

### Clarity Score: 9/10

Excellent story documentation. The shared helper signature now explicitly shows how to thread `input` and `reader` for error position calculation.

### Developer Perspective

A developer agent can implement this story as written. The task sequencing (1→2→3, then 4/5/6 in parallel) is clear, exit criteria are defined, and code patterns are provided inline.

### Previous Validation (2026-01-28)

Previous validation confirmed with Architect corrections applied. This re-validation confirms Definition of Ready compliance.

---

### Previous Validation History

**Date:** 2026-01-28 (Architect Corrections Applied)
**Validator:** Bob (Scrum Master)
**Result:** READY (superseded by PO corrections)

### Architect Corrections Applied (2026-01-28)

1. **Task Dependency Chain:** Added explicit sequencing — Tasks 1→2→3 must run sequentially; Tasks 4/5/6 can parallelize after Task 3
2. **Exit Criteria:** Added exit criteria to Tasks 1, 2, 3 to ensure blocking dependencies are verified
3. **Format/Minify Parity:** Added explicit parity tests in Task 1 to verify catch-all path (lines 180-184) behaves identically to explicit handlers
4. **Error Position Threading:** Added note that `input: &str` must be threaded through to error sites for position calculation
5. **WASM Stack Overflow:** Added documentation of stack depth behavior and testing requirements (100/500 level thresholds)
6. **Test Case Priorities:** Reorganized test matrix into P0/P1/P2 priorities with specific inputs and expected outputs
7. **Architecture Decisions:** Added section documenting key design decisions for shared event handler and error positions

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- **Task 1**: Added 36 new baseline snapshot tests covering all XML construct types. Discovered CDATA and text node formatting behavior differs from initial expectations (documented in snapshots).
- **Task 2**: Successfully extracted `write_event_to()` shared helper. Removed 70+ lines of duplicated code. All baseline tests pass with byte-identical output.
- **Task 3**: Implemented `position_to_line_column()` helper and wired `reader.buffer_position()` through all error paths. Note: quick-xml doesn't error on unclosed-but-parseable tags like `<root>`, so tests use truncated/mismatched scenarios.
- **Task 4**: Added 13 edge case and property tests. 500-level deep nesting passes successfully.
- **Task 5**: Updated module documentation from "Spike Investigation" to production-quality with examples and known limitations.
- **Task 6**: WASM build verified, no warnings, exports present in TypeScript definitions.

### Debug Log References
N/A - No blocking issues encountered during development.

### File List
| File | Status | Description |
|------|--------|-------------|
| src/xml_formatter.rs | Modified | Refactored with shared event handler, error positions, expanded tests, production docs |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Story created from Epic 8.0 | Sarah (PO) |
| 2026-01-28 | 1.1 | Architect corrections: Task dependencies, exit criteria, WASM stack handling, test priorities | Winston (Architect) |
| 2026-01-28 | 1.2 | PO corrections: Enhanced user story with specific persona and business value; expanded ACs from 7 to 9 (added parity guarantee AC5, resource boundary AC8); improved testability of AC3 (non-zero positions); updated task-AC mappings | Sarah (PO) |
| 2026-01-28 | 1.3 | Architect corrections: Fixed test matrix AC numbering (AC5-AC9 were misaligned); expanded shared helper signature to include input/reader params for error positions; updated test coverage totals to 34 cases | Winston (Architect) |
| 2026-01-28 | 1.4 | PO review: Confirmed story meets Definition of Ready; no additional product corrections required; user story, business value, and ACs are clear and testable | Sarah (PO) |
| 2026-01-28 | 2.0 | Implementation complete: All 6 tasks done, 65 tests passing (up from 9), WASM verified | James (Dev) |

## QA Notes - Risk Profile

**Date:** 2026-01-28
**Reviewer:** Quinn (Test Architect)
**Full Report:** docs/qa/assessments/8.1-risk-20260128.md

### Risk Level: CONCERNS (52/100)

No critical risks. Three high risks identified requiring attention during implementation.

### Identified Risks

| Risk ID | Title | Score | Priority |
|---------|-------|-------|----------|
| TECH-001 | Code duplication causes divergent format/minify behavior | 6 | High |
| PERF-001 | Deep nesting (100+ levels) may cause WASM stack overflow | 6 | High |
| DATA-001 | Whitespace trimming silently loses mixed-content data | 6 | High |
| TECH-002 | Refactor breaks existing working behavior | 4 | Medium |
| SEC-001 | XML entity expansion DoS | 3 | Low |
| PERF-002 | Large XML WASM memory exhaustion | 3 | Low |
| BUS-001 | Error positions always (0,0) - no debug value | 3 | Low |
| TECH-003 | Line/column off-by-one conversion errors | 2 | Low |
| OPS-001 | WASM build regression | 2 | Low |

### Key Mitigations

- **TECH-001**: Extract shared `write_event_to()` helper; add roundtrip tests covering all XML constructs
- **PERF-001**: Test deep nesting at 100/500/1000 levels; verify graceful failure vs panic
- **DATA-001**: Document whitespace trimming as known limitation; add explicit behavior tests

### Testing Priorities

1. **High**: Roundtrip property tests, deep nesting stress tests, whitespace behavior tests, pre/post refactor equivalence
2. **Medium**: Snapshot regression tests, malformed XML with position validation, edge cases (BOM, large attrs, namespaces)
3. **Low**: WASM build verification, entity expansion limits, large input memory tests

## QA Notes - NFR Assessment

**Date:** 2026-01-28 (Updated)
**Reviewer:** Quinn (Test Architect)
**Assessment Mode:** YOLO (Non-interactive)
**Full Report:** docs/qa/assessments/8.1-nfr-20260128.md

### NFR Coverage

| NFR | Status | Summary |
|-----|--------|---------|
| Security | PASS | Client-side only, no XXE exposure, input validation present |
| Performance | CONCERNS | No input size limits, deep nesting stack risk, no defined targets |
| Reliability | CONCERNS | Error positions hardcoded (0,0), no graceful degradation for OOM |
| Maintainability | CONCERNS | ~70% code duplication, 9 happy-path tests, missing edge case coverage |

**Quality Score: 70/100** (100 - 10×3 CONCERNS = 70)

### Critical Issues

1. **AC3 Cannot Pass** (Reliability) - All errors return position (0, 0); `reader.buffer_position()` API available but unused
2. **No Resource Limits** (Performance) - Unbounded input size; unknown stack depth tolerance
3. **Code Duplication** (Maintainability) - ~70 lines duplicated between format/minify; catch-all divergence risk

### Missing Considerations

1. **No input size guard** - Large XML could exhaust WASM memory without warning
2. **No performance targets** - Story lacks defined thresholds for response time or max input size
3. **WASM stack overflow behavior undefined** - Deep nesting may trap without graceful error
4. **Event handling parity** - `format_xml` handles each event explicitly; `minify_xml` uses catch-all arm (divergence risk)

### Test Recommendations

1. **Error Position Tests (P0)** - Test unclosed tag, mismatched tags, invalid attribute syntax return non-zero line/column
2. **Resource Boundary Tests (P1)** - Test input at 1MB/5MB/10MB; test nesting at 100/500/1000 levels
3. **Equivalence Tests (P1)** - Pre/post refactor snapshot tests; format/minify roundtrip property tests
4. Add error path tests for every `FormatError` branch (currently zero coverage)
5. Add pre/post refactor equivalence tests before Task 2 (shared event handler extraction)

### Acceptance Criteria Gaps

| Gap | Recommendation |
|-----|----------------|
| AC3 cannot pass with current code | Implement `position_to_line_column()` helper per Dev Notes |
| No input size limit AC | Add: "Input over 10MB returns FormatError with descriptive message" |
| No resource exhaustion AC | Add: "Deep nesting at 500 levels either succeeds or returns graceful FormatError (no panic)" |
| No format/minify parity AC | Add: "Both functions preserve all XML construct types identically" |

## QA Notes - Requirements Trace

**Date:** 2026-01-28 (Re-validated)
**Reviewer:** Quinn (Test Architect)
**Assessment Mode:** YOLO (Non-interactive)
**Full Report:** docs/qa/assessments/8.1-trace-20260128.md

### Coverage Summary

- **Total Requirements:** 9 (AC1-AC9)
- **Fully Covered:** 0 (0%)
- **Partially Covered:** 4 (44%) — AC1, AC2, AC4, AC7
- **Not Covered:** 5 (56%) — AC3, AC5, AC6, AC8, AC9

### Traceability Matrix

| AC | Requirement | Existing Tests | Coverage | Gaps |
|----|-------------|---------------|----------|------|
| AC1 | Correctly indented output for all valid XML | `test_format_xml_basic`, `test_format_xml_with_attributes`, `test_format_xml_with_declaration` | **PARTIAL** | Tests assert content presence but not correct indentation structure (no newline/indent depth checks); no tab variant test |
| AC2 | Minification removes non-essential whitespace | `test_minify_xml`, `test_roundtrip` | **PARTIAL** | Only one input tested; no explicit content preservation assertion; no idempotency test |
| AC3 | Parse errors include line and column position (non-zero) | *(none)* | **NONE** | All 32 `FormatError::new()` calls hardcoded to `(0, 0)` — code cannot satisfy this AC. `reader.buffer_position()` API available but never called |
| AC4 | All XML constructs preserved (declarations, comments, CDATA, PIs, namespaces) | `test_format_xml_with_declaration`, `test_cdata`, `test_comments`, `test_namespace_prefix` | **PARTIAL** | Missing: PI preservation test, DocType test. `minify_xml` uses catch-all (lines 180-184) — no dedicated parity tests |
| AC5 | Format/minify parity guarantee | *(none)* | **NONE** | No parity tests exist between `format_xml` and `minify_xml`; catch-all path in minify untested |
| AC6 | DRY shared event handling logic | *(structural)* | **NONE** | ~70 lines duplicated between `format_xml` (lines 41-116) and `minify_xml` (lines 135-190). No shared `write_event_to()` helper exists |
| AC7 | Test coverage includes malformed XML and edge cases | `test_empty_input` | **PARTIAL** | 1 of 12+ required tests exist (~8%). Missing: unclosed tag, mismatched tags, invalid attr, invalid entity, deep nesting, large attr, BOM, namespaces, whitespace-only |
| AC8 | Deep nesting 500 levels graceful (no panic) | *(none)* | **NONE** | No deep nesting tests at any level (100/500); WASM stack overflow behavior undefined |
| AC9 | WASM build succeeds with no new warnings | *(none)* | **NONE** | No automated WASM build verification exists |

### Given-When-Then Mappings (Existing Tests)

#### AC1: Correctly indented output

| Test | File:Line | Given | When | Then | Coverage |
|------|-----------|-------|------|------|----------|
| `test_format_xml_basic` | `xml_formatter.rs:201-207` | Flat XML `<root><child>text</child></root>` | Format with 2-space indent | Contains tags and text | PARTIAL (no indent verification) |
| `test_format_xml_with_attributes` | `xml_formatter.rs:209-215` | XML with attrs | Format | Attrs preserved | PARTIAL |
| `test_format_xml_with_declaration` | `xml_formatter.rs:217-223` | XML with declaration | Format | Declaration present | PARTIAL |

#### AC2: Minification

| Test | File:Line | Given | When | Then | Coverage |
|------|-----------|-------|------|------|----------|
| `test_minify_xml` | `xml_formatter.rs:225-231` | Indented XML | Minify | No newlines, compact output | PARTIAL |
| `test_roundtrip` | `xml_formatter.rs:233-242` | Flat XML | Format→minify | Content preserved | PARTIAL |

#### AC4: XML construct preservation

| Test | File:Line | Given | When | Then | Coverage |
|------|-----------|-------|------|------|----------|
| `test_cdata` | `xml_formatter.rs:250-255` | CDATA XML | Format | CDATA intact | FULL |
| `test_comments` | `xml_formatter.rs:257-262` | XML with comment | Format | Comment preserved | FULL |
| `test_namespace_prefix` | `xml_formatter.rs:264-270` | Namespaced XML | Format | Prefixes preserved | FULL |

#### AC7: Edge cases (partial)

| Test | File:Line | Given | When | Then | Coverage |
|------|-----------|-------|------|------|----------|
| `test_empty_input` | `xml_formatter.rs:244-248` | Empty string | Format | Error returned | FULL |

### Critical Gaps

| Priority | Gap | Impact | AC |
|----------|-----|--------|-----|
| **P0** | AC3 impossible — all 32 errors return (0,0), `buffer_position()` never called | Users cannot debug XML errors | AC3 |
| **P0** | Zero malformed XML tests with position validation | Cannot verify error handling | AC3, AC7 |
| **P1** | No PI/DocType preservation tests | Construct preservation untested | AC4 |
| **P1** | No format/minify parity tests | Divergence risk undetected | AC5 |
| **P1** | No deep nesting tests | Stack overflow risk untested | AC7, AC8 |
| **P1** | No WASM build verification | Build regression risk | AC9 |
| **P2** | No indent structure tests | Format correctness untested | AC1 |
| **P2** | Pre-refactor baseline missing | Refactor regression risk | AC6 |

### Recommendations

1. **AC3 Blocker:** Implement `position_to_line_column()` helper and wire `reader.buffer_position()` before any AC3 tests can pass
2. **Pre-refactor baseline (Task 1):** Add snapshot tests for all XML construct types before Task 2 shared helper extraction
3. **Malformed XML tests (Task 4):** At minimum: unclosed tag, mismatched tags, invalid attribute, invalid entity
4. **PI/DocType parity tests:** Verify `minify_xml` catch-all preserves these constructs identically to `format_xml`
5. **Deep nesting tests:** Add tests at 100 levels (must succeed) and 500 levels (success or graceful error)
6. **WASM build check:** Add script or CI step for `wasm-pack build --target web --release`

### Risk Summary

- **High Risk:** AC3 (structurally impossible), AC6 (structural issue), AC7 (8% coverage), AC8 (untested)
- **Medium Risk:** AC5 (no parity tests), AC9 (no build verification)
- **Low Risk:** AC1, AC2, AC4 (partially covered, need depth)

### Source Code Verification (2026-01-28)

Verified against `src/xml_formatter.rs`:
- **Error positions**: All 32 `FormatError::new()` calls confirmed to use `(0, 0)`
- **Code duplication**: `format_xml` (lines 20-120) and `minify_xml` (lines 122-194) share ~70 duplicated lines
- **Catch-all arm**: `minify_xml` line 180-184 uses `Ok(event) =>` catch-all instead of explicit handlers
- **Test count**: 9 tests confirmed at lines 200-271
- **PI/DocType**: `format_xml` has explicit handlers (lines 100-109); `minify_xml` relies on catch-all

---

## QA Notes - Test Design

**Date:** 2026-01-28 (Updated)
**Designer:** Quinn (Test Architect)
**Assessment Mode:** YOLO (Non-interactive)
**Full Report:** docs/qa/assessments/8.1-test-design-20260128.md

### Test Strategy Summary

- **Total Scenarios:** 34
- **Unit Tests:** 28 (82%)
- **Integration Tests:** 6 (18%)
- **E2E Tests:** 0 (0%)
- **Priority Distribution:** P0: 8, P1: 16, P2: 10

### Test Coverage Matrix

| AC | Description | P0 | P1 | P2 | Total |
|----|-------------|----|----|----|----|
| AC1 | Correct indented output | 2 | 3 | 1 | 6 |
| AC2 | Minification preserves content | 1 | 2 | 0 | 3 |
| AC3 | Error positions in parse errors (non-zero) | 2 | 2 | 0 | 4 |
| AC4 | All XML constructs preserved | 3 | 3 | 0 | 6 |
| AC5 | Format/minify parity guarantee | 0 | 3 | 0 | 3 |
| AC6 | DRY / shared event handling | 0 | 1 | 0 | 1 |
| AC7 | Malformed XML & edge cases | 0 | 0 | 6 | 6 |
| AC8 | Deep nesting graceful (500 levels) | 0 | 1 | 1 | 2 |
| AC9 | WASM build succeeds (no warnings) | 0 | 3 | 3 | 6 |
| **Total** | | **8** | **16** | **10** | **34** |

### Key Scenarios with Expected Results

| ID | Scenario | Input | Expected Result | Priority |
|----|----------|-------|-----------------|----------|
| 8.1-UNIT-001 | Basic format | `<root><child>text</child></root>` | 2-space indented XML; line 2 has 2 spaces | P0 |
| 8.1-UNIT-007 | Minify | Indented XML | Single-line, no structural whitespace | P0 |
| 8.1-UNIT-010 | Unclosed tag error | `<root>` | Error with line=1, column>0 | P0 |
| 8.1-UNIT-011 | Mismatched tags | `<a></b>` | Error with position near `</b>` | P0 |
| 8.1-UNIT-016 | CDATA preserved | `<root><![CDATA[<x>]]></root>` | CDATA content intact | P0 |
| 8.1-UNIT-020 | Roundtrip parity | Any valid XML | `format(minify(format(x))) == format(x)` | P1 |
| 8.1-UNIT-021 | PI parity | `<?pi data?><root/>` | PI preserved in both format and minify | P1 |
| 8.1-UNIT-030 | Deep nesting 100 | 100-level nested XML | Success, correctly formatted | P1 |
| 8.1-UNIT-031 | Deep nesting 500 | 500-level nested XML | Success OR graceful FormatError (no panic) | P2 |
| 8.1-UNIT-027 | BOM prefix | `\xEF\xBB\xBF<?xml...` | Handled gracefully | P2 |
| 8.1-UNIT-028 | Large attribute | 1KB+ attribute value | Success, attribute preserved | P2 |
| 8.1-INT-001 | WASM build | `wasm-pack build --release` | Exit code 0, no new warnings | P1 |

### Risk Coverage

| Risk ID | Title | Test IDs |
|---------|-------|----------|
| TECH-001 | Code duplication divergence | 8.1-UNIT-020, 021, 022, 023 |
| PERF-001 | Deep nesting stack overflow | 8.1-UNIT-030, 031 |
| DATA-001 | Whitespace trimming data loss | 8.1-UNIT-005, 006, 009 |
| TECH-002 | Refactor breaks behavior | 8.1-UNIT-020, 023, AC4 tests |
| BUS-001 | Error positions (0,0) | 8.1-UNIT-010, 011, 012, 013 |

### Test Data Requirements

| Data | Description | Source |
|------|-------------|--------|
| Basic nested XML | `<root><child>text</child></root>` | Inline literal |
| All-constructs XML | Decl + comment + CDATA + PI + DocType + ns + elements | Inline literal |
| Deep nested XML | 100/500-level nested elements | Generated in test |
| BOM-prefixed XML | `\xEF\xBB\xBF<?xml...?><root/>` | Inline literal |
| Large attribute | `<root attr="a{1024}"/>` | Generated in test |

### Test Environment Requirements

- **Rust toolchain:** `cargo test` for unit tests
- **WASM target:** `rustup target add wasm32-unknown-unknown`
- **wasm-pack:** Required for AC9 integration tests
- **No network:** All tests run offline (airgap constraint)
- **No external fixtures:** All test data inline or generated

### Execution Order

1. P0 Unit tests (8) - fail fast on core logic
2. P1 Unit tests (13) - broader functional coverage
3. P1 Integration tests (3) - build and regression gate
4. P2 Unit/Integration tests (10) - edge cases and stress

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is production-quality with excellent structure and comprehensive coverage. Key strengths:

1. **Shared Event Handler (`write_event_to`)**: Successfully extracted common logic into a single helper function (lines 103-185), eliminating ~70 lines of duplication and ensuring identical behavior between format and minify operations.

2. **Error Position Tracking**: The `position_to_line_column()` helper (lines 77-86) correctly converts byte offsets to line/column positions. Error reporting now uses `reader.buffer_position()` at all error sites, fulfilling AC3.

3. **Explicit Event Handling**: All 10 XML event types are handled explicitly in the shared helper with no catch-all arms, reducing divergence risk.

4. **Comprehensive Documentation**: Module-level doc comments updated from "Spike Investigation" to production-quality with examples, known limitations, and API documentation.

5. **Test Architecture**: 65 tests covering all 9 ACs with good distribution across unit (baseline snapshots, parity, error positions, edge cases) and integration (WASM build verification) levels.

### Refactoring Performed

None required. Implementation was reviewed and found to be well-structured. No refactoring needed during this QA review.

### Compliance Check

- Coding Standards: ✓ Follows Rust idioms, proper error handling, no unwrap in library code
- Project Structure: ✓ Tests in inline `#[cfg(test)]` module per project convention
- Testing Strategy: ✓ 65 tests covering unit (snapshots, parity, error positions, edge cases) and integration (WASM build)
- All ACs Met: ✓ All 9 Acceptance Criteria verified (see traceability below)

### Acceptance Criteria Verification

| AC | Status | Evidence |
|----|--------|----------|
| AC1 | ✓ PASS | `test_indent_structure_*`, `test_snapshot_format_*` verify correct indentation |
| AC2 | ✓ PASS | `test_minify_xml`, `test_snapshot_minify_*`, `test_property_minify_idempotent` |
| AC3 | ✓ PASS | `test_error_position_*` verify line/column > 0 for mismatched tags, invalid attrs, truncated tags |
| AC4 | ✓ PASS | `test_baseline_all_constructs_*`, `test_snapshot_*_pi/doctype/cdata/comment/declaration` |
| AC5 | ✓ PASS | `test_parity_*` tests for basic, declaration, comment, cdata, pi, doctype, namespace, attributes |
| AC6 | ✓ PASS | Code review confirms `write_event_to()` helper at lines 103-185 handles all events |
| AC7 | ✓ PASS | `test_malformed_*`, `test_edge_*` cover malformed XML and edge cases (BOM, large attrs, namespaces) |
| AC8 | ✓ PASS | `test_edge_deep_nesting_100` (success), `test_edge_deep_nesting_500` (success, no panic) |
| AC9 | ✓ PASS | WASM build verified: `wasm-pack build --target web --release` completes with no warnings; exports `formatXml`, `minifyXml` present in TypeScript definitions |

### Improvements Checklist

All requirements met. No outstanding items:

- [x] Shared event handler extracted (Task 2)
- [x] Error positions implemented (Task 3)
- [x] Baseline snapshot tests added (Task 1)
- [x] Parity tests added (Task 1)
- [x] Edge case tests added (Task 4)
- [x] Deep nesting tests at 100/500 levels (Task 4)
- [x] Module documentation updated (Task 5)
- [x] WASM build verified (Task 6)

### Security Review

No security concerns. The module:
- Processes XML entirely client-side (airgap constraint preserved)
- Does not expand external entities (quick-xml default)
- Returns errors with positions rather than exposing internal state
- No network calls, no file system access

### Performance Considerations

- **Deep Nesting**: 500-level nesting succeeds without stack overflow (verified in test)
- **Large Attributes**: 1KB+ attributes handled successfully
- **No Input Size Limit**: Documented as known limitation; tested up to practical limits

### Files Modified During Review

None. Implementation reviewed without modifications.

### Gate Status

Gate: **PASS** → docs/qa/gates/8.1-productionize-xml-formatter.yml

Risk profile: docs/qa/assessments/8.1-risk-20260128.md (Score: 52/100 - all high risks mitigated)
NFR assessment: docs/qa/assessments/8.1-nfr-20260128.md (Score: 70/100 - CONCERNS addressed in implementation)
Test design: docs/qa/assessments/8.1-test-design-20260128.md (34 scenarios designed, 65 implemented)
Requirements trace: docs/qa/assessments/8.1-trace-20260128.md (Pre-implementation gaps now filled)

### Recommended Status

✓ Ready for Done

All acceptance criteria met. 65 tests passing. WASM build verified. Code quality excellent. No blocking issues.
