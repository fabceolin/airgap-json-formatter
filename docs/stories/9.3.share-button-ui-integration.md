# Story 9.3: Share Button UI Integration

## Status

Draft

## Story

**As a** user who wants to share JSON with a colleague,
**I want** a Share button with optional passphrase protection that generates a time-bounded encrypted URL,
**so that** I can easily share JSON content that expires after 5 minutes, with optional two-factor security.

## Acceptance Criteria

1. Share button added to Toolbar.qml in the right zone (between separator and Copy button)
2. Share button is disabled when input pane is empty or contains invalid JSON
3. Share button tooltip shows security warning: "Time-bounded encrypted link (5 min). Anyone with link can view unless passphrase-protected."
4. Clicking Share opens ShareDialog.qml with:
   - Optional passphrase field (empty = quick share, filled = protected share)
   - "Share" and "Cancel" buttons
   - Brief security explanation text
5. **Quick share (no passphrase):** URL format `?d={data}#{key}`, key in fragment
6. **Protected share (with passphrase):** URL format `?d={data}&p=1`, no key in URL
7. On successful share, URL is copied to clipboard and status shows mode-specific message
8. If JSON is too large for URL, show error in dialog: "JSON too large to share (max ~50KB)"
9. On application startup, detect `?d=` query parameter and check for `p=1` flag
10. If `p=1` (protected): show PassphrasePrompt.qml dialog to enter passphrase
11. If shared link is valid, load JSON into input pane and auto-format
12. If shared link is expired, show message: "This share link has expired (links valid for 5 minutes)"
13. If passphrase is wrong, show message: "Incorrect passphrase" with retry option
14. If shared link is invalid/corrupted, show message: "Invalid or corrupted share link"
15. Keyboard shortcut Ctrl+Shift+S opens share dialog
16. Share flow works in Chrome, Firefox, Safari, and Edge

## Tasks / Subtasks

- [ ] Task 1: Add bridge.js wrapper functions (AC: 5, 6, 9)
  - [ ] Add `JsonBridge.createShareUrl(json, passphrase)` function:
    - Call `wasmModule.createSharePayload(json, passphrase || "")`
    - Parse response JSON
    - If quick share (mode="quick"): construct URL `?d=${data}#${key}`
    - If protected (mode="protected"): construct URL `?d=${data}&p=1`
    - Return `{success, url, mode}` or `{success: false, error}`
  - [ ] Add `JsonBridge.getShareParams()` function:
    - Extract `d` param from `window.location.search`
    - Check for `p=1` flag (passphrase-protected)
    - Extract key from `window.location.hash` (if no p=1)
    - Return `{hasShareData, data?, key?, isProtected?}`
  - [ ] Add `JsonBridge.decodeShare(data, keyOrPassphrase, isPassphrase)` function:
    - Call `wasmModule.decodeSharePayload(data, keyOrPassphrase, isPassphrase)`
    - Return parsed result
  - [ ] Add `JsonBridge.clearShareParams()` to clean URL (history.replaceState)

- [ ] Task 2: Create ShareDialog.qml (AC: 4, 8)
  - [ ] Create new file `qt/qml/ShareDialog.qml`
  - [ ] Modal dialog with:
    - Title: "Share JSON"
    - Security info text: "Creates a time-bounded encrypted link valid for 5 minutes."
    - Optional passphrase TextField (placeholder: "Optional passphrase for extra security")
    - Passphrase hint: "Leave empty for quick share, or set passphrase for two-factor security"
    - "Share" button (primary) and "Cancel" button
  - [ ] Emit signals: `shareConfirmed(passphrase)` and `cancelled()`
  - [ ] Show error message area for "too large" errors
  - [ ] Style consistent with existing dialogs (Theme colors)

- [ ] Task 3: Create PassphrasePrompt.qml (AC: 10, 13)
  - [ ] Create new file `qt/qml/PassphrasePrompt.qml`
  - [ ] Modal dialog with:
    - Title: "Enter Passphrase"
    - Info text: "This shared link is passphrase-protected"
    - Passphrase TextField (password mode)
    - "Decrypt" button (primary) and "Cancel" button
    - Error message area for "incorrect passphrase"
  - [ ] Emit signals: `passphraseEntered(passphrase)` and `cancelled()`
  - [ ] Allow retry on wrong passphrase

- [ ] Task 4: Add Share button to Toolbar.qml (AC: 1, 2, 3, 15)
  - [ ] Add `signal shareRequested()` to toolbar
  - [ ] Add Share button between separator and Copy button
  - [ ] Style to match existing toolbar buttons (outline style)
  - [ ] Add `property bool canShare: false` controlled by Main.qml
  - [ ] Disable button when `!canShare`
  - [ ] Tooltip with security warning: "Time-bounded encrypted link (5 min). Anyone with link can view unless passphrase-protected. (Ctrl+Shift+S)"
  - [ ] Add ToolTip.delay: 500

- [ ] Task 5: Wire up Share flow in Main.qml (AC: 4, 5, 6, 7)
  - [ ] Add ShareDialog instance
  - [ ] Connect `toolbar.shareRequested` → open ShareDialog
  - [ ] Connect `shareDialog.shareConfirmed(passphrase)`:
    - Get JSON from outputPane (prefer formatted) or inputPane
    - Call `JsonBridge.createShareUrl(json, passphrase)` via AsyncSerialiser
    - On success: copy URL, show mode-specific success message
    - On error: show error in dialog
  - [ ] Update `toolbar.canShare` when validation state changes
  - [ ] Add keyboard shortcut Ctrl+Shift+S

- [ ] Task 6: Implement startup share URL detection (AC: 9, 10, 11, 12, 13, 14)
  - [ ] In Main.qml startup:
    - Call `JsonBridge.getShareParams()`
    - If no share data, continue normal startup
    - If protected (p=1): show PassphrasePrompt
    - If quick share: call decode with key from fragment
  - [ ] Handle PassphrasePrompt result:
    - On passphrase entered: call decode with passphrase
    - If wrong passphrase: show error, allow retry
    - On cancel: clear share params, continue to empty state
  - [ ] Handle decode result:
    - Success: load JSON, auto-format, show "Loaded shared JSON"
    - Expired: show "This share link has expired (links valid for 5 minutes)"
    - Invalid: show "Invalid or corrupted share link"
  - [ ] Call `clearShareParams()` after processing

- [ ] Task 7: Status bar feedback messages (AC: 7, 12, 13, 14)
  - [ ] Quick share success: "Share link copied! Expires in 5 min" (green)
  - [ ] Protected share success: "Protected share link copied! Recipient needs passphrase" (green)
  - [ ] Loaded shared: "Loaded shared JSON" (green)
  - [ ] Expired: "This share link has expired (links valid for 5 minutes)" (red)
  - [ ] Wrong passphrase: "Incorrect passphrase" (red, in dialog)
  - [ ] Invalid: "Invalid or corrupted share link" (red)
  - [ ] Too large: "JSON too large to share (max ~50KB)" (red, in dialog)

- [ ] Task 8: Cross-browser testing (AC: 16)
  - [ ] Test quick share flow in Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
  - [ ] Test protected share flow in all browsers
  - [ ] Test passphrase prompt on protected link open
  - [ ] Verify URL fragment preserved (quick share)
  - [ ] Verify clipboard API works
  - [ ] Test expired link handling
  - [ ] Test wrong passphrase handling

## Dev Notes

### Relevant Source Tree
```
public/
├── bridge.js           # Add share functions
qt/qml/
├── Main.qml            # Wire up share flow, startup detection
├── Toolbar.qml         # Add Share button
├── ShareDialog.qml     # NEW - Share dialog with passphrase option
├── PassphrasePrompt.qml # NEW - Passphrase entry for protected links
├── StatusBar.qml       # Share feedback messages
```

### Existing Patterns to Follow

**Toolbar button pattern (from Toolbar.qml):**
```qml
Button {
    id: shareButton
    text: "Share"
    enabled: toolbar.canShare && !toolbar.isBusy
    onClicked: toolbar.shareRequested()

    contentItem: Text {
        text: shareButton.text
        color: Theme.textPrimary
        horizontalAlignment: Text.AlignHCenter
        verticalAlignment: Text.AlignVCenter
        font.pixelSize: 13
        opacity: shareButton.enabled ? 1.0 : 0.5
    }
    background: Rectangle {
        implicitWidth: 60
        implicitHeight: 34
        color: shareButton.hovered && shareButton.enabled ? Theme.backgroundSecondary : "transparent"
        border.color: shareButton.hovered && shareButton.enabled ? Theme.border : "transparent"
        border.width: 1
        radius: 4
        opacity: shareButton.enabled ? 1.0 : 0.5
    }

    ToolTip.visible: hovered
    ToolTip.text: toolbar.canShare
        ? "Time-bounded encrypted link (5 min). Ctrl+Shift+S"
        : "Enter valid JSON to share"
    ToolTip.delay: 500
}
```

### ShareDialog.qml Structure
```qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Popup {
    id: shareDialog
    modal: true
    anchors.centerIn: parent
    width: 400
    padding: 20

    signal shareConfirmed(string passphrase)
    signal cancelled()

    property string errorMessage: ""

    ColumnLayout {
        spacing: 16
        width: parent.width

        Text {
            text: "Share JSON"
            font.pixelSize: 18
            font.weight: Font.DemiBold
            color: Theme.textPrimary
        }

        Text {
            text: "Creates a time-bounded encrypted link valid for 5 minutes."
            font.pixelSize: 13
            color: Theme.textSecondary
            wrapMode: Text.WordWrap
            Layout.fillWidth: true
        }

        TextField {
            id: passphraseField
            placeholderText: "Optional passphrase for extra security"
            echoMode: TextInput.Password
            Layout.fillWidth: true
        }

        Text {
            text: "Leave empty for quick share, or set passphrase for two-factor security."
            font.pixelSize: 11
            color: Theme.textTertiary
            wrapMode: Text.WordWrap
            Layout.fillWidth: true
        }

        Text {
            text: shareDialog.errorMessage
            color: Theme.error
            visible: shareDialog.errorMessage !== ""
            font.pixelSize: 12
        }

        RowLayout {
            Layout.alignment: Qt.AlignRight
            spacing: 8

            Button { text: "Cancel"; onClicked: shareDialog.cancelled() }
            Button { text: "Share"; onClicked: shareDialog.shareConfirmed(passphraseField.text) }
        }
    }
}
```

### Bridge.js Implementation Details

**createShareUrl:**
```javascript
createShareUrl(json, passphrase) {
    if (!isInitialized) {
        return JSON.stringify({ success: false, error: 'WASM not initialized' });
    }

    try {
        const jsonStr = String(json || '');
        if (!jsonStr.trim()) {
            return JSON.stringify({ success: false, error: 'No JSON to share' });
        }

        const passphraseStr = String(passphrase || '');
        const result = JSON.parse(wasmModule.createSharePayload(jsonStr, passphraseStr));

        if (!result.success) {
            return JSON.stringify({ success: false, error: result.error });
        }

        const baseUrl = `${window.location.origin}${window.location.pathname}`;
        let shareUrl;

        if (result.mode === 'quick') {
            // Quick share: key in fragment
            shareUrl = `${baseUrl}?d=${encodeURIComponent(result.data)}#${result.key}`;
        } else {
            // Protected: no key, p=1 flag
            shareUrl = `${baseUrl}?d=${encodeURIComponent(result.data)}&p=1`;
        }

        if (shareUrl.length > 8000) {
            return JSON.stringify({
                success: false,
                error: 'JSON too large to share (max ~50KB)'
            });
        }

        return JSON.stringify({ success: true, url: shareUrl, mode: result.mode });
    } catch (e) {
        console.error('[Bridge] createShareUrl error:', e);
        return JSON.stringify({ success: false, error: String(e) });
    }
}
```

**getShareParams:**
```javascript
getShareParams() {
    const params = new URLSearchParams(window.location.search);
    const data = params.get('d');
    const isProtected = params.get('p') === '1';
    const key = window.location.hash.slice(1); // Remove leading #

    if (!data) {
        return JSON.stringify({ hasShareData: false });
    }

    return JSON.stringify({
        hasShareData: true,
        data: decodeURIComponent(data),
        key: isProtected ? null : key,
        isProtected: isProtected
    });
}
```

**decodeShare:**
```javascript
decodeShare(data, keyOrPassphrase, isPassphrase) {
    if (!isInitialized) {
        return JSON.stringify({ success: false, error: 'WASM not initialized', errorCode: 'not_initialized' });
    }

    try {
        const result = wasmModule.decodeSharePayload(data, keyOrPassphrase, isPassphrase);
        return result; // Already JSON string from WASM
    } catch (e) {
        console.error('[Bridge] decodeShare error:', e);
        return JSON.stringify({ success: false, error: String(e), errorCode: 'unknown' });
    }
}
```

**clearShareParams:**
```javascript
clearShareParams() {
    const url = new URL(window.location.href);
    url.search = '';
    url.hash = '';
    window.history.replaceState({}, '', url.pathname);
}
```

### URL Structures

**Quick share (no passphrase):**
```
https://user.github.io/airgap-json-formatter/?d=BASE64URL_DATA#BASE64URL_KEY
- Key in fragment (not sent to server)
- Anyone with full URL can decrypt
```

**Protected share (with passphrase):**
```
https://user.github.io/airgap-json-formatter/?d=BASE64URL_DATA&p=1
- No key in URL
- Recipient must know passphrase to decrypt
- Two-factor: URL + passphrase
```

### Testing

**Manual test cases:**
1. Quick share: valid JSON → URL copied with key in fragment
2. Protected share: set passphrase → URL copied without key, with p=1
3. Open quick share URL → JSON loads immediately
4. Open protected share URL → passphrase prompt shown
5. Enter correct passphrase → JSON loads
6. Enter wrong passphrase → error, retry allowed
7. Open expired link (either mode) → "expired" message
8. Share very large JSON → "too large" error in dialog
9. Test Ctrl+Shift+S shortcut

**Cross-browser checklist:**
- [ ] Chrome 90+: Both share modes work
- [ ] Firefox 88+: Both share modes work
- [ ] Safari 14+: Both share modes work
- [ ] Edge 90+: Both share modes work
- [ ] Verify URL fragment preserved (quick share mode)
- [ ] Verify clipboard API works in all browsers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-27 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*To be filled by QA agent*
