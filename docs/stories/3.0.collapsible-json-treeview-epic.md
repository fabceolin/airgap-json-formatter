# Epic 3: Collapsible JSON TreeView - Brownfield Enhancement

## Epic Goal

Implement an interactive collapsible JSON TreeView (similar to Amazon's JSON viewer) that allows users to expand/collapse objects and arrays for easier navigation of large JSON documents, while preserving the existing TextArea view as a toggleable alternative.

## Epic Description

### Existing System Context

- **Current relevant functionality:** OutputPane displays formatted JSON in a TextArea with RichText/HTML syntax highlighting generated by Rust (syntect)
- **Technology stack:** Qt 6 QML + Rust (WASM) + C++ bridge (JsonBridge)
- **Integration points:** OutputPane.qml, JsonBridge (C++), highlighter.rs (Rust), Theme.qml

### Enhancement Details

- **What's being added:**
  - Qt QML TreeView component for hierarchical JSON display
  - Expand/collapse functionality for objects `{}` and arrays `[]`
  - Copy buttons (copy value, copy JSON path) on hover/context menu
  - Expand All / Collapse All controls
  - Toggle button to switch between TreeView and TextArea modes

- **How it integrates:**
  - New `QJsonTreeModel` C++ class extends `QAbstractItemModel`
  - New `JsonTreeView.qml` component alongside existing `OutputPane.qml`
  - Toggle state managed in `Main.qml`
  - Reuses existing `Theme.qml` colors for syntax highlighting

- **Success criteria:**
  - Users can expand/collapse any object or array node
  - Users can copy individual values or JSON paths
  - Users can toggle to TextArea for free-form text selection
  - Performance remains acceptable for JSON files up to 1MB
  - Zero network calls maintained (security requirement)

## Stories

### Story 3.1: QJsonTreeModel - C++ Data Model
Create the C++ tree model that converts parsed JSON into Qt's hierarchical model format.

**Scope:**
- Implement `QJsonTreeModel` extending `QAbstractItemModel`
- Parse JSON string into tree node structure
- Expose to QML via JsonBridge
- Support lazy loading for large arrays

**Acceptance Criteria:**
1. Model correctly represents nested JSON objects and arrays
2. Model provides role data: key, value, type, path, childCount
3. Model handles edge cases: empty objects, empty arrays, null values
4. Model registered and accessible from QML

---

### Story 3.2: JsonTreeView QML Component
Create the QML TreeView component with custom delegate for JSON display.

**Scope:**
- Implement `JsonTreeView.qml` using Qt Quick TreeView
- Custom delegate with syntax-colored display (reuse Theme.qml)
- Expand/collapse icons (▼/▶) for objects and arrays
- Show item count badges for collapsed containers: `{ } (5 keys)` / `[ ] (10 items)`

**Acceptance Criteria:**
1. TreeView displays JSON structure hierarchically
2. Click on expand icon toggles node state
3. Keys, strings, numbers, booleans, null use Theme.qml colors
4. Collapsed nodes show child count
5. Smooth expand/collapse animations

---

### Story 3.3: Copy Functionality & Controls
Add copy buttons, context menu, and global expand/collapse controls.

**Scope:**
- Copy Value button (appears on hover)
- Copy Path button (copies JSON path like `$.address.city`)
- Right-click context menu with Copy Value / Copy Path
- Toolbar: Copy All, Expand All, Collapse All buttons
- Toggle button: TreeView ↔ TextArea

**Acceptance Criteria:**
1. Hover on row shows copy icons
2. Copy Value copies the node's value (primitive or serialized object/array)
3. Copy Path copies JSONPath notation
4. Copy All copies entire formatted JSON
5. Expand All / Collapse All work correctly
6. Toggle switches between TreeView and TextArea views
7. Toggle state persists during session

## Compatibility Requirements

- [x] Existing APIs remain unchanged (JsonBridge methods preserved)
- [x] No database/storage changes
- [x] UI changes follow existing Theme.qml patterns
- [x] Performance impact is minimal (lazy loading for large JSON)
- [x] TextArea view remains available via toggle

## Technical Notes

### Architecture Decision: Why TreeView over HTML `<details>`

| Consideration | TreeView | HTML `<details>` |
|---------------|----------|------------------|
| Native Qt feel | ✅ Yes | ❌ No |
| Copy per-node | ✅ Easy | ❌ Harder |
| Performance | ✅ Lazy loading | ⚠️ Full DOM |
| Free text select | ❌ No | ✅ Yes |
| **Decision** | **Selected** (with TextArea toggle) | Alternative |

### Key Implementation References

- [QJsonModel pattern](https://github.com/dridk/QJsonModel) - Reference for tree model structure
- Qt 6 TreeView: `import QtQuick.Controls 6.x`
- Existing colors in `qt/qml/Theme.qml`

## Risk Mitigation

- **Primary Risk:** TreeView performance with very large JSON (>1MB)
- **Mitigation:** Implement lazy loading - only expand visible nodes
- **Rollback Plan:** Toggle allows users to fall back to TextArea; can disable TreeView if issues arise

## Definition of Done

- [ ] All 3 stories completed with acceptance criteria met
- [ ] Existing TextArea functionality preserved and accessible via toggle
- [ ] Integration with Theme.qml verified (dark theme colors)
- [ ] Performance tested with 100KB, 500KB, 1MB JSON files
- [ ] Copy functionality works correctly
- [ ] No regression in existing features (format, minify, validate)
- [ ] Zero external network calls maintained

## Story Dependencies

```
[3.1 QJsonTreeModel]
         ↓
[3.2 JsonTreeView QML]
         ↓
[3.3 Copy & Controls]
```

Stories must be implemented in sequence.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial epic creation | Sarah (PO Agent) |
