# Spike 7.0: XML Formatting Feasibility Investigation

## Status: Done

## Story

**As a** developer planning the XML formatting feature,
**I want** to validate the technical approach and identify risks,
**so that** we can make an informed decision on implementation scope and effort.

## Story Context

**Type:** Spike (Timeboxed Investigation)
**Timebox:** 2-3 days maximum
**Estimated Points:** 3

**Background:**
The airgap-json-formatter currently handles JSON exclusively. Users have expressed interest in XML formatting support. This spike investigates feasibility before committing to a full epic.

## Investigation Questions

### Q1: Rust XML Library Selection

- [ ] Evaluate `quick-xml` vs `roxmltree` vs `xml-rs`
- [ ] Criteria: WASM compatibility, performance, error quality, maintenance status
- [ ] Test basic parse → format → serialize roundtrip
- [ ] Confirm no networking or file I/O dependencies (airgap constraint)

### Q2: WASM Bundle Impact

- [ ] Measure current WASM binary size
- [ ] Add chosen XML library, rebuild, measure delta
- [ ] Target: <200KB increase acceptable

### Q3: Formatting Logic Complexity

- [ ] Can we reuse `IndentStyle` and `FormatError` types?
- [ ] Document XML-specific edge cases:
  - Namespace prefixes
  - CDATA sections
  - Comments and processing instructions
  - Attribute ordering (preserve vs. alphabetize)
  - Mixed content (text + child elements)
  - Self-closing tags vs. explicit close

### Q4: Syntax Highlighter Effort

- [ ] Can we adapt highlighter.rs state machine pattern?
- [ ] Define token types: tag, attribute-name, attribute-value, text, comment, cdata
- [ ] Prototype basic highlighting

### Q5: UI Integration Path

- [ ] How to add format selector to Toolbar.qml without disrupting UX?
- [ ] Tree view approach: extend QJsonTreeModel or create XmlTreeModel?
- [ ] Format auto-detection: feasible? desirable?

### Q6: Bridge Layer Changes

- [ ] Assess JsonBridge modifications:
  - New WASM exports or parameterized existing ones?
  - Signal pattern changes?
- [ ] AsyncSerialiser compatibility (should work unchanged)

## Acceptance Criteria

1. All 6 investigation questions answered with evidence
2. At least one proof-of-concept: basic XML format in Rust compiling to WASM
3. WASM bundle size delta measured
4. Risks documented with mitigation strategies
5. Effort estimate for full implementation (story point range)

## Out of Scope

- Full XML validation against DTD/XSD
- XML Schema editor
- XSLT transformation
- XPath query support

## Risks to Investigate

| Risk | Impact | Mitigation |
|------|--------|------------|
| XML lib not WASM-compatible | Blocker | Test early with wasm-pack |
| Bundle size explosion | High | Measure, consider lazy loading |
| Mixed content formatting ambiguity | Medium | Define opinionated defaults |
| Tree model abstraction overhead | Medium | May accept parallel implementation |

## Deliverables

1. **Spike Report** documenting findings for each question
2. **Recommendation**: Proceed / Proceed with caveats / Do not proceed
3. **Draft Epic** (if proceeding) with scoped stories

## Dev Notes

### Relevant Source Tree

```
src/
├── lib.rs           # WASM exports - would add js_format_xml, js_validate_xml
├── formatter.rs     # JSON formatting - pattern to replicate for XML
├── validator.rs     # JSON validation - pattern to replicate
├── highlighter.rs   # State machine highlighter - adapt for XML tokens
└── types.rs         # IndentStyle, FormatError - potentially reusable

qt/
├── jsonbridge.cpp   # Bridge layer - would need format dispatch
├── qjsontreemodel.* # JSON tree model - evaluate abstraction vs. parallel
└── qml/
    ├── Toolbar.qml  # Add format selector dropdown
    ├── Main.qml     # Track selected/detected format
    └── OutputPane.qml # Route to correct highlighter
```

### Current Dependencies (Cargo.toml)

```toml
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
wasm-bindgen = "0.2"
```

### Candidate XML Libraries

| Library | WASM Support | Streaming | DOM | Notes |
|---------|--------------|-----------|-----|-------|
| `quick-xml` | Yes (no_std) | Yes | No | Fast, low-level, good for reformatting |
| `roxmltree` | Yes | No | Yes | Read-only DOM, good for validation |
| `xml-rs` | Likely | Yes | No | Older, mature |

### Architecture Impact Assessment

**Low Impact (Additive):**
- New Rust modules (xml_formatter.rs, xml_highlighter.rs)
- New WASM exports in lib.rs
- Format selector in Toolbar.qml

**Medium Impact (Changes):**
- JsonBridge.cpp - format dispatch logic
- Main.qml - format state tracking
- OutputPane.qml - highlighter routing

**Higher Impact (Abstraction):**
- Tree view model abstraction (if pursued)
- Format auto-detection (if pursued)

## Tasks / Subtasks

- [x] Task 1: Library Evaluation (Q1)
  - [x] Create test project with quick-xml
  - [x] Verify wasm-pack build succeeds
  - [x] Test parse → serialize roundtrip

- [x] Task 2: Bundle Size Measurement (Q2)
  - [x] Baseline: current WASM size
  - [x] With quick-xml: measure delta
  - [x] Document in spike report

- [x] Task 3: Formatting Proof-of-Concept (Q3)
  - [x] Implement basic `format_xml(input, indent)` function
  - [x] Handle common edge cases
  - [x] Document limitations

- [x] Task 4: Highlighter Assessment (Q4)
  - [x] Review highlighter.rs architecture
  - [x] Sketch XML token state machine
  - [x] Estimate effort for full implementation

- [x] Task 5: UI/Bridge Assessment (Q5, Q6)
  - [x] Mock format selector placement
  - [x] Document bridge changes needed
  - [x] Decide tree model approach

- [x] Task 6: Write Spike Report
  - [x] Consolidate findings
  - [x] Make recommendation
  - [x] Draft epic structure if proceeding

## Definition of Done

- [x] All investigation questions have documented answers
- [x] Proof-of-concept code compiles to WASM
- [x] Bundle size impact measured and documented
- [x] Spike report written with clear recommendation
- [x] If proceeding: draft epic ready for refinement

## Technical Notes

- **Airgap Constraint:** Any XML library must have no network dependencies
- **Pattern Reuse:** Follow existing formatter.rs patterns for consistency
- **AsyncSerialiser:** XML operations should integrate with existing async queue

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File | Action | Description |
|------|--------|-------------|
| src/xml_formatter.rs | Created | XML formatting/minifying (194 lines, 9 tests) |
| src/xml_highlighter.rs | Created | XML syntax highlighting (320 lines, 8 tests) |
| src/lib.rs | Modified | Added xml modules and WASM exports |
| Cargo.toml | Modified | Added quick-xml = "0.37" dependency |
| docs/stories/7.0.spike-report.md | Created | Spike investigation report |
| docs/stories/7.0.spike-xml-formatting-feasibility.md | Modified | Updated checkboxes and status |

### Debug Log References
None - no blocking issues encountered.

### Completion Notes
- All investigation questions (Q1-Q6) answered with evidence
- PoC code compiles to WASM (166KB, +58KB delta)
- 17 tests pass (9 formatter + 8 highlighter)
- Recommendation: PROCEED with caveats
- Draft Epic 8.0 structure provided in spike report

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-26 | 1.0 | Spike created from PO consultation | Sarah (PO) |
| 2026-01-26 | 1.1 | Spike investigation complete | James (Dev) |

## QA Results

### Review Date: 2026-01-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: GOOD** - Spike/PoC quality code that demonstrates feasibility effectively.

The implementation follows existing patterns (mirrors `formatter.rs` and `highlighter.rs`), has comprehensive test coverage for a spike, and successfully validates all investigation questions. The code is appropriately documented with module-level and function-level docs.

**Highlights:**
- Clean state machine pattern in `xml_highlighter.rs` with 12 well-defined states
- Proper `FormatError` and `IndentStyle` type reuse demonstrating architectural compatibility
- Edge case coverage: CDATA, comments, namespaces, declarations, processing instructions
- WASM exports properly defined with clear JS-friendly naming

### Refactoring Performed

None - code is spike/PoC quality and appropriate for its purpose. Refactoring should occur during Epic 8.0 productionization.

### Compliance Check

- Coding Standards: ✓ Follows existing Rust patterns, proper documentation
- Project Structure: ✓ Files placed correctly in `src/` with proper module declaration
- Testing Strategy: ✓ 17 tests covering formatter (9) and highlighter (8) - appropriate for spike
- All ACs Met: ✓ All 5 acceptance criteria verified with evidence

### Improvements Checklist

All items are recommendations for Epic 8.0, not blockers for this spike:

- [ ] Consider extracting shared event-handling logic between `format_xml` and `minify_xml` (DRY improvement)
- [ ] Add `validate_xml` function for consistency with JSON validator
- [ ] Consider error position tracking (line/column) for better error messages
- [ ] Add property-based tests for roundtrip validation
- [ ] Document mixed content whitespace behavior for users

### Security Review

✓ **No concerns** - The XML library (quick-xml) is pure Rust with no network dependencies, satisfying the airgap constraint. Input validation is handled via the parser's error handling.

### Performance Considerations

✓ **No concerns** - Streaming API used (memory efficient). Bundle size impact (+58KB) is well within the 200KB threshold. No performance-critical code paths affected.

### Files Modified During Review

None - no modifications made during QA review.

### Gate Status

**Gate: PASS** → docs/qa/gates/7.0-spike-xml-formatting-feasibility.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive spike report delivered with clear recommendation to proceed. Story owner can close this spike.
