# Story 3.2: JsonTreeView QML Component

## Status: Draft

## Story

**As a** user viewing large JSON documents,
**I want** an interactive tree view with expand/collapse functionality,
**so that** I can navigate complex JSON structures more easily by collapsing sections I don't need to see.

## Story Context

**Existing System Integration:**
- Integrates with: QJsonTreeModel (Story 3.1), Theme.qml, Main.qml
- Technology: Qt 6 QML, TreeView component
- Follows pattern: QML component with model binding (like existing InputPane/OutputPane)
- Touch points: New JsonTreeView.qml, Main.qml, Theme.qml

## Acceptance Criteria

**Functional Requirements:**

1. TreeView displays JSON structure hierarchically with proper indentation
2. Objects `{}` and arrays `[]` show expand/collapse icons (▼/▶)
3. Clicking expand icon toggles node between expanded/collapsed states
4. Collapsed nodes show child count badge: `{ } (5 keys)` or `[ ] (10 items)`
5. Leaf nodes (primitives) display key-value pairs inline
6. Empty containers show as `{ }` or `[ ]` without expand icon

**Visual Requirements:**

7. Keys are colored using `Theme.syntaxKey` color
8. String values use `Theme.syntaxString` color
9. Number values use `Theme.syntaxNumber` color
10. Boolean values use `Theme.syntaxBoolean` color
11. Null values use `Theme.syntaxNull` color
12. Brackets/punctuation use `Theme.syntaxPunctuation` color
13. Font uses `Theme.monoFont` and `Theme.monoFontSize`

**Integration Requirements:**

14. Component receives model from `JsonBridge.treeModel`
15. Component exposes `expandAll()` and `collapseAll()` methods
16. Smooth expand/collapse animations (150-200ms)
17. Vertical scrolling works correctly for large JSON

**Quality Requirements:**

18. Renders 1000+ visible nodes without lag
19. Expand/collapse responds within 50ms
20. Scroll performance is smooth (60fps target)

## Tasks / Subtasks

- [ ] Task 1: Create basic JsonTreeView.qml structure (AC: 1, 14, 17)
  - [ ] Create `qt/qml/JsonTreeView.qml`
  - [ ] Set up TreeView with ScrollView wrapper
  - [ ] Bind to `JsonBridge.treeModel`
  - [ ] Configure basic properties (clip, interactive, etc.)

- [ ] Task 2: Create tree item delegate (AC: 1, 2, 5, 6)
  - [ ] Create item delegate component
  - [ ] Display expand/collapse icon for expandable nodes
  - [ ] Display key-value layout for all node types
  - [ ] Handle empty containers (no expand icon)
  - [ ] Add indentation based on depth

- [ ] Task 3: Implement syntax coloring (AC: 7-12, 13)
  - [ ] Add Theme.qml syntax color properties if missing
  - [ ] Color keys with Theme.syntaxKey
  - [ ] Color values based on type (string, number, boolean, null)
  - [ ] Style brackets and punctuation
  - [ ] Apply monospace font

- [ ] Task 4: Implement child count badges (AC: 4)
  - [ ] Show `(N keys)` for collapsed objects
  - [ ] Show `(N items)` for collapsed arrays
  - [ ] Style badges with muted color

- [ ] Task 5: Implement expand/collapse (AC: 2, 3, 15, 16)
  - [ ] Handle click on expand icon
  - [ ] Toggle TreeView node expansion
  - [ ] Add smooth animation (Behavior on height)
  - [ ] Implement `expandAll()` method
  - [ ] Implement `collapseAll()` method

- [ ] Task 6: Performance optimization (AC: 18, 19, 20)
  - [ ] Use `cacheBuffer` for smooth scrolling
  - [ ] Test with large JSON (1000+ nodes)
  - [ ] Profile and optimize if needed

- [ ] Task 7: Integration with Main.qml (AC: 14)
  - [ ] Import JsonTreeView in Main.qml
  - [ ] Position alongside/instead of OutputPane
  - [ ] Wire up model connection

## Dev Notes

### Relevant Source Tree
```
qt/qml/
├── Main.qml              # Main orchestrator (modify)
├── Theme.qml             # Colors (may need additions)
├── OutputPane.qml        # Existing text output (unchanged)
├── JsonTreeView.qml      # NEW: Tree view component
└── components/
    └── TreeItemDelegate.qml  # NEW: Optional separate delegate
```

### Theme.qml Additions (if needed)

```qml
// Theme.qml - add if not present
pragma Singleton
import QtQuick

QtObject {
    // ... existing properties ...

    // Syntax highlighting colors (from base16-ocean.dark)
    readonly property color syntaxKey: "#8fa1b3"        // Light blue
    readonly property color syntaxString: "#a3be8c"     // Green
    readonly property color syntaxNumber: "#d08770"     // Orange
    readonly property color syntaxBoolean: "#b48ead"    // Purple
    readonly property color syntaxNull: "#bf616a"       // Red
    readonly property color syntaxPunctuation: "#c0c5ce" // Light gray
    readonly property color syntaxBadge: "#65737e"      // Muted for count badges
}
```

### JsonTreeView.qml Structure

```qml
// JsonTreeView.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Rectangle {
    id: root

    property alias model: treeView.model
    property int animationDuration: 150

    color: Theme.backgroundSecondary
    border.color: Theme.border
    border.width: 1

    function expandAll() {
        // Expand all nodes recursively
        for (let i = 0; i < treeView.rows; i++) {
            treeView.expand(i)
        }
    }

    function collapseAll() {
        // Collapse all nodes
        for (let i = 0; i < treeView.rows; i++) {
            treeView.collapse(i)
        }
    }

    ScrollView {
        anchors.fill: parent
        anchors.margins: 8

        TreeView {
            id: treeView
            anchors.fill: parent
            clip: true
            boundsBehavior: Flickable.StopAtBounds

            model: JsonBridge.treeModel

            delegate: TreeItemDelegate {
                // Delegate defined below or in separate file
            }
        }
    }
}
```

### TreeItemDelegate Design

```qml
// Inline delegate or separate TreeItemDelegate.qml
Component {
    id: treeDelegate

    Rectangle {
        id: delegateRoot

        implicitWidth: treeView.width
        implicitHeight: contentRow.height + 4
        color: "transparent"

        required property int depth
        required property bool expanded
        required property bool hasChildren
        required property var model  // Access to role data

        // Indentation
        property int indent: depth * 20

        Row {
            id: contentRow
            x: delegateRoot.indent
            spacing: 4
            height: 24

            // Expand/Collapse indicator
            Text {
                id: expandIcon
                width: 16
                height: parent.height
                text: delegateRoot.hasChildren ? (delegateRoot.expanded ? "▼" : "▶") : ""
                color: Theme.syntaxPunctuation
                font.pixelSize: 10
                verticalAlignment: Text.AlignVCenter
                visible: delegateRoot.hasChildren

                MouseArea {
                    anchors.fill: parent
                    cursorShape: Qt.PointingHandCursor
                    onClicked: {
                        if (delegateRoot.expanded) {
                            treeView.collapse(row)
                        } else {
                            treeView.expand(row)
                        }
                    }
                }
            }

            // Key
            Text {
                id: keyText
                text: model.key ? "\"" + model.key + "\"" : ""
                color: Theme.syntaxKey
                font.family: Theme.monoFont
                font.pixelSize: Theme.monoFontSize
                visible: model.key !== ""
            }

            // Colon separator
            Text {
                text: model.key ? ": " : ""
                color: Theme.syntaxPunctuation
                font.family: Theme.monoFont
                font.pixelSize: Theme.monoFontSize
                visible: model.key !== ""
            }

            // Value or container indicator
            Loader {
                id: valueLoader
                sourceComponent: {
                    switch (model.valueType) {
                        case "object": return objectComponent
                        case "array": return arrayComponent
                        case "string": return stringComponent
                        case "number": return numberComponent
                        case "boolean": return booleanComponent
                        case "null": return nullComponent
                        default: return nullComponent
                    }
                }
            }

            // Child count badge (when collapsed)
            Text {
                id: countBadge
                visible: !delegateRoot.expanded && delegateRoot.hasChildren
                text: {
                    if (model.valueType === "object") {
                        return "(" + model.childCount + " keys)"
                    } else if (model.valueType === "array") {
                        return "(" + model.childCount + " items)"
                    }
                    return ""
                }
                color: Theme.syntaxBadge
                font.family: Theme.monoFont
                font.pixelSize: Theme.monoFontSize - 2
                font.italic: true
            }
        }
    }
}

// Value type components
Component {
    id: objectComponent
    Text {
        text: "{"
        color: Theme.syntaxPunctuation
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}

Component {
    id: arrayComponent
    Text {
        text: "["
        color: Theme.syntaxPunctuation
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}

Component {
    id: stringComponent
    Text {
        text: "\"" + model.value + "\""
        color: Theme.syntaxString
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}

Component {
    id: numberComponent
    Text {
        text: model.value
        color: Theme.syntaxNumber
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}

Component {
    id: booleanComponent
    Text {
        text: model.value ? "true" : "false"
        color: Theme.syntaxBoolean
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}

Component {
    id: nullComponent
    Text {
        text: "null"
        color: Theme.syntaxNull
        font.family: Theme.monoFont
        font.pixelSize: Theme.monoFontSize
    }
}
```

### Closing Brackets

For proper JSON display, closing brackets `}` and `]` should appear after the last child. This can be handled by:

1. **Option A:** Add a visual closing bracket after children in the delegate
2. **Option B:** The model includes "closing" pseudo-nodes

Recommend **Option A** for simplicity:

```qml
// In delegate, after children
Text {
    visible: delegateRoot.expanded && delegateRoot.hasChildren
    text: model.valueType === "object" ? "}" : "]"
    color: Theme.syntaxPunctuation
    font.family: Theme.monoFont
    font.pixelSize: Theme.monoFontSize
    x: delegateRoot.indent
}
```

### Qt 6 TreeView Notes

- Qt 6.3+ has native `TreeView` in QtQuick
- Uses `QAbstractItemModel` directly
- Provides `expand(row)`, `collapse(row)`, `isExpanded(row)`
- Delegate has `required property bool expanded`, `required property int depth`, etc.

### Animation

```qml
TreeView {
    id: treeView

    // Smooth expand/collapse
    Behavior on contentHeight {
        NumberAnimation { duration: 150; easing.type: Easing.OutCubic }
    }
}
```

## Technical Notes

- **Integration Approach:** QML TreeView binding to C++ QJsonTreeModel
- **Existing Pattern Reference:** Similar to OutputPane structure, using Theme.qml
- **Key Constraints:** Must render smoothly; animations should not block interaction

## Definition of Done

- [ ] JsonTreeView.qml created and compiles
- [ ] Tree displays hierarchical JSON correctly
- [ ] Expand/collapse works with visual feedback
- [ ] All JSON types colored correctly per Theme
- [ ] Child count badges display when collapsed
- [ ] expandAll()/collapseAll() methods work
- [ ] Scrolling is smooth
- [ ] Performance acceptable with 1000+ nodes

## Risk and Compatibility Check

**Minimal Risk Assessment:**
- **Primary Risk:** Qt 6 TreeView API differences across versions
- **Mitigation:** Test on target Qt version; use stable API subset
- **Rollback:** Fall back to custom ListView-based implementation

**Compatibility Verification:**
- [ ] Works with Qt 6.x used in project
- [ ] WASM build includes TreeView support
- [ ] Theme colors consistent with existing UI

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |
