name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  # Qt 6.8.0 + Emscripten 3.1.56 is a known-working combination
  QT_VERSION: '6.8.0'
  EMSDK_VERSION: '3.1.56'

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml', 'src/**') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli

      # Note: wasm-opt skipped due to table growth bug in versions 108-118
      # https://github.com/AztecProtocol/aztec-packages/issues/12379

      - name: Build Rust WASM
        run: |
          cargo build --target wasm32-unknown-unknown --release
          mkdir -p dist/pkg
          wasm-bindgen target/wasm32-unknown-unknown/release/airgap_json_formatter.wasm \
              --out-dir dist/pkg \
              --typescript \
              --target web

      - name: Check Rust WASM size
        run: |
          SIZE=$(stat -c%s dist/pkg/airgap_json_formatter_bg.wasm)
          echo "Rust WASM size: $SIZE bytes ($(($SIZE / 1024)) KB)"
          gzip -k dist/pkg/airgap_json_formatter_bg.wasm
          GZIP_SIZE=$(stat -c%s dist/pkg/airgap_json_formatter_bg.wasm.gz)
          echo "Gzipped size: $GZIP_SIZE bytes ($(($GZIP_SIZE / 1024)) KB)"
          rm dist/pkg/airgap_json_formatter_bg.wasm.gz

      # Setup Emscripten SDK (required for Qt WASM)
      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EMSDK_VERSION }}
          actions-cache-folder: 'emsdk-cache'

      - name: Verify Emscripten
        run: |
          emcc --version
          echo "EMSDK: $EMSDK"

      # Install Qt for WebAssembly
      - name: Install Qt WASM
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: 'all_os'
          target: 'wasm'
          arch: 'wasm_singlethread'
          modules: 'qtshadertools'
          cache: true

      - name: Verify Qt Installation
        run: |
          echo "Qt installation directory:"
          ls -la $QT_ROOT_DIR/
          echo "Qt bin directory:"
          ls -la $QT_ROOT_DIR/bin/ || echo "No bin directory"
          echo "Looking for qt-cmake:"
          find $QT_ROOT_DIR -name "qt-cmake*" 2>/dev/null || echo "qt-cmake not found"

      # Build Qt WASM application
      - name: Build Qt WASM
        run: |
          cd qt
          mkdir -p build && cd build

          # Find qt-cmake
          QT_CMAKE=$(find $QT_ROOT_DIR -name "qt-cmake" -type f | head -1)
          echo "Using qt-cmake: $QT_CMAKE"
          chmod +x "$QT_CMAKE"

          # Configure with CMake
          "$QT_CMAKE" .. -DCMAKE_BUILD_TYPE=Release

          # Build
          cmake --build . --parallel $(nproc)

          # Copy Qt WASM outputs to dist
          echo "Build output:"
          ls -la

          # Copy all relevant files
          for ext in wasm js html; do
            for file in *.$ext; do
              if [ -f "$file" ]; then
                cp "$file" ../../dist/
                echo "Copied: $file"
              fi
            done
          done

          # Copy qtloader.js if present
          if [ -f "qtloader.js" ]; then
            cp qtloader.js ../../dist/
          fi

      - name: Copy static assets
        run: |
          # Copy all public assets to dist
          cp public/index.html dist/
          cp public/bridge.js dist/
          cp public/history-storage.js dist/
          cp public/sw.js dist/
          cp public/manifest.json dist/
          cp public/404.html dist/

      - name: List build artifacts
        run: |
          echo "=== Build Output ==="
          find dist -type f -exec ls -lh {} \;
          echo ""
          echo "=== Total size ==="
          du -sh dist/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-24.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
