<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Preview Tests - Story 10.5</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 { color: #4ec9b0; }
        .test { margin: 10px 0; padding: 10px; background: #252526; border-radius: 4px; }
        .pass { border-left: 4px solid #4caf50; }
        .fail { border-left: 4px solid #f44336; }
        .pending { border-left: 4px solid #ff9800; }
        .test-name { font-weight: bold; }
        .test-result { margin-top: 5px; font-size: 12px; color: #808080; }
        pre { background: #1e1e1e; padding: 10px; overflow-x: auto; }
        #summary { margin-top: 20px; padding: 15px; background: #2d2d2d; border-radius: 4px; }
        .output-preview { max-height: 200px; overflow-y: auto; font-size: 11px; background: #1a1a1a; padding: 8px; margin-top: 8px; border-radius: 4px; }
        #preview-container { margin: 20px 0; padding: 20px; background: #252526; border-radius: 4px; }
        #preview-pane { min-height: 200px; border: 1px solid #3c3c3c; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Markdown Preview Tests - Story 10.5</h1>
    <p>Tests for: Defense-in-depth sanitization (AC10), Performance SLA (AC11), HTML rendering</p>
    <div id="summary"></div>
    <div id="tests"></div>

    <h2>Preview Rendering Demo</h2>
    <div id="preview-container">
        <div id="preview-pane"></div>
    </div>

    <!-- Libraries (same as index.html) -->
    <script src="../public/lib/purify.min.js"></script>
    <script src="../public/lib/mermaid.min.js"></script>
    <script src="../public/mermaid-config.js"></script>

    <script type="module">
        // Test framework
        const tests = [];
        let passed = 0;
        let failed = 0;

        function test(name, fn) {
            tests.push({ name, fn });
        }

        function assert(condition, message) {
            if (!condition) throw new Error(message || 'Assertion failed');
        }

        function assertEqual(actual, expected, message) {
            if (actual !== expected) {
                throw new Error(message || `Expected "${expected}", got "${actual}"`);
            }
        }

        function assertIncludes(str, substr, message) {
            if (!str.includes(substr)) {
                throw new Error(message || `Expected "${str}" to include "${substr}"`);
            }
        }

        function assertNotIncludes(str, substr, message) {
            if (str.includes(substr)) {
                throw new Error(message || `Expected "${str}" NOT to include "${substr}"`);
            }
        }

        // Initialize WASM module first
        const { initBridge, JsonBridge } = await import('../public/bridge.js');
        await initBridge();

        // ========== Defense-in-Depth Sanitization Tests (AC10) ==========

        // Simulated defense-in-depth check (mirrors MarkdownPreview.qml sanitizationCheck)
        function sanitizationCheck(htmlContent) {
            if (!htmlContent) return { safe: true, html: "" };

            // Check for script tags
            if (/<script[\s>]/i.test(htmlContent) || /<\/script>/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing <script> tag");
                return { safe: false, reason: "Script tag detected" };
            }

            // Check for iframe tags
            if (/<iframe[\s>]/i.test(htmlContent) || /<\/iframe>/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing <iframe> tag");
                return { safe: false, reason: "Iframe tag detected" };
            }

            // Check for object tags
            if (/<object[\s>]/i.test(htmlContent) || /<\/object>/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing <object> tag");
                return { safe: false, reason: "Object tag detected" };
            }

            // Check for embed tags
            if (/<embed[\s>]/i.test(htmlContent) || /<\/embed>/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing <embed> tag");
                return { safe: false, reason: "Embed tag detected" };
            }

            // Check for on* event handlers (onclick, onload, onerror, etc.)
            if (/\son\w+\s*=/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing event handler");
                return { safe: false, reason: "Event handler detected" };
            }

            // Check for javascript: URLs
            if (/javascript\s*:/i.test(htmlContent)) {
                console.warn("[MarkdownPreview] Defense-in-depth: Rejected HTML containing javascript: URL");
                return { safe: false, reason: "JavaScript URL detected" };
            }

            return { safe: true, html: htmlContent };
        }

        test('10.5-SEC-007: Defense-in-depth rejects HTML with <script> tag', () => {
            const maliciousHtml = '<p>Hello</p><script>alert("XSS")</script>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with script tag');
            assertEqual(result.reason, 'Script tag detected');
        });

        test('10.5-SEC-008: Defense-in-depth rejects HTML with <iframe> tag', () => {
            const maliciousHtml = '<p>Hello</p><iframe src="https://evil.com"></iframe>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with iframe tag');
            assertEqual(result.reason, 'Iframe tag detected');
        });

        test('10.5-SEC-009: Defense-in-depth rejects HTML with onclick handler', () => {
            const maliciousHtml = '<p onclick="alert(1)">Click me</p>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with onclick handler');
            assertEqual(result.reason, 'Event handler detected');
        });

        test('10.5-SEC-010: Defense-in-depth rejects HTML with onerror handler', () => {
            const maliciousHtml = '<img src="x" onerror="alert(1)">';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with onerror handler');
            assertEqual(result.reason, 'Event handler detected');
        });

        test('10.5-SEC-011: Defense-in-depth rejects HTML with javascript: URL', () => {
            const maliciousHtml = '<a href="javascript:alert(1)">Click</a>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with javascript: URL');
            assertEqual(result.reason, 'JavaScript URL detected');
        });

        test('10.5-SEC-012: Defense-in-depth rejects HTML with <object> tag', () => {
            const maliciousHtml = '<object data="malware.swf"></object>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with object tag');
            assertEqual(result.reason, 'Object tag detected');
        });

        test('10.5-SEC-013: Defense-in-depth rejects HTML with <embed> tag', () => {
            const maliciousHtml = '<embed src="malware.swf">';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject HTML with embed tag');
            assertEqual(result.reason, 'Embed tag detected');
        });

        test('10.5-SEC-014: Defense-in-depth allows safe HTML', () => {
            const safeHtml = '<h1>Hello</h1><p>World</p><pre><code>code</code></pre>';
            const result = sanitizationCheck(safeHtml);
            assert(result.safe, 'Should allow safe HTML');
        });

        test('10.5-SEC-015: Defense-in-depth rejects case variations (SCRIPT)', () => {
            const maliciousHtml = '<SCRIPT>alert(1)</SCRIPT>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject uppercase SCRIPT tag');
        });

        test('10.5-SEC-016: Defense-in-depth rejects mixed case (ScRiPt)', () => {
            const maliciousHtml = '<ScRiPt>alert(1)</ScRiPt>';
            const result = sanitizationCheck(maliciousHtml);
            assert(!result.safe, 'Should reject mixed case script tag');
        });

        // ========== Performance SLA Tests (AC11) ==========

        test('10.5-PERF-001: Render time under 200ms for small document (<10KB)', async () => {
            // Generate small markdown
            const markdown = '# Test\n\n' + 'Lorem ipsum dolor sit amet. '.repeat(100);

            const startTime = performance.now();
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const endTime = performance.now();

            const renderTime = endTime - startTime;
            console.log(`Small doc render time: ${renderTime.toFixed(2)}ms`);

            // For WASM, we expect <200ms for small docs
            assert(renderTime < 200, `Render time ${renderTime.toFixed(2)}ms exceeded 200ms SLA`);

            const parsed = JSON.parse(result);
            assert(parsed.success, 'Should render successfully');
        });

        test('10.5-PERF-002: Render time under 200ms for medium document (~50KB)', async () => {
            // Generate ~50KB markdown
            let markdown = '# Large Document Test\n\n';
            for (let i = 0; i < 1000; i++) {
                markdown += `## Section ${i}\n\nThis is paragraph ${i} with some content. `;
            }

            const startTime = performance.now();
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const endTime = performance.now();

            const renderTime = endTime - startTime;
            console.log(`Medium doc render time (${(markdown.length / 1024).toFixed(1)}KB): ${renderTime.toFixed(2)}ms`);

            // For 50KB, we should still be under 200ms
            // This may vary by machine, but the SLA is 200ms for 500KB
            assert(renderTime < 1000, `Render time ${renderTime.toFixed(2)}ms is too slow for medium doc`);

            const parsed = JSON.parse(result);
            assert(parsed.success, 'Should render successfully');
        });

        // ========== HTML Rendering Tests (AC3) ==========

        test('10.5-INT-001: Heading rendering', async () => {
            const markdown = '# H1\n## H2\n### H3\n#### H4';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<h1>', 'Should contain h1');
            assertIncludes(parsed.html, '<h2>', 'Should contain h2');
            assertIncludes(parsed.html, '<h3>', 'Should contain h3');
            assertIncludes(parsed.html, '<h4>', 'Should contain h4');
        });

        test('10.5-INT-002: Table rendering', async () => {
            const markdown = '| A | B |\n|---|---|\n| 1 | 2 |';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<table>', 'Should contain table');
            assertIncludes(parsed.html, '<th>', 'Should contain th');
            assertIncludes(parsed.html, '<td>', 'Should contain td');
        });

        test('10.5-INT-003: Code block rendering', async () => {
            const markdown = '```javascript\nconst x = 1;\n```';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<pre>', 'Should contain pre');
            assertIncludes(parsed.html, '<code', 'Should contain code');
        });

        test('10.5-INT-004: Link rendering (not clickable)', async () => {
            const markdown = '[Google](https://google.com)';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<a ', 'Should contain link');
            assertIncludes(parsed.html, 'href=', 'Should have href attribute');
            // Note: pointer-events: none is applied via CSS in MarkdownPreview.qml
        });

        test('10.5-INT-005: List rendering', async () => {
            const markdown = '- Item 1\n- Item 2\n\n1. First\n2. Second';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<ul>', 'Should contain ul');
            assertIncludes(parsed.html, '<ol>', 'Should contain ol');
            assertIncludes(parsed.html, '<li>', 'Should contain li');
        });

        test('10.5-INT-006: Blockquote rendering', async () => {
            const markdown = '> This is a quote';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, '<blockquote>', 'Should contain blockquote');
        });

        test('10.5-INT-007: Mermaid diagram rendering', async () => {
            const markdown = '```mermaid\ngraph TD\n    A --> B\n```';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully');
            assertIncludes(parsed.html, 'mermaid-diagram', 'Should contain mermaid-diagram class');
            assertIncludes(parsed.html, '<svg', 'Should contain SVG');
        });

        // ========== Copy Functionality Tests (AC7) ==========

        test('10.5-COPY-001: Copy operation returns HTML source', async () => {
            const markdown = '# Hello World';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            // The HTML returned is what should be copied
            assert(parsed.success, 'Should render successfully');
            assert(typeof parsed.html === 'string', 'HTML should be a string');
            assertIncludes(parsed.html, '<h1>', 'Copied content should be raw HTML');
        });

        // ========== Theme Tests (AC4) ==========

        test('10.5-THEME-001: Dark theme rendering', async () => {
            const markdown = '# Dark Theme Test';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'dark');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully with dark theme');
        });

        test('10.5-THEME-002: Light theme rendering', async () => {
            const markdown = '# Light Theme Test';
            const result = await JsonBridge.renderMarkdownWithMermaid(markdown, 'default');
            const parsed = JSON.parse(result);

            assert(parsed.success, 'Should render successfully with light theme');
        });

        // ========== Inline Style Injection Tests (AC4 Full Coverage) ==========

        // Simulated applyThemeStyles function (mirrors MarkdownPreview.qml)
        function applyThemeStyles(htmlContent, darkMode) {
            if (!htmlContent) return "";

            const heading = darkMode ? "#569cd6" : "#0066cc";
            const link = darkMode ? "#4ec9b0" : "#0366d6";
            const codeBg = darkMode ? "#252526" : "#f6f8fa";
            const tableBorder = darkMode ? "#3c3c3c" : "#dfe2e5";

            let styled = htmlContent;

            // Headings
            styled = styled.replace(/<h1([^>]*)>/gi, `<h1$1 style="color: ${heading}; font-weight: 600;">`);
            styled = styled.replace(/<h2([^>]*)>/gi, `<h2$1 style="color: ${heading}; font-weight: 600;">`);

            // Links
            styled = styled.replace(/<a ([^>]*)>/gi, `<a $1 style="color: ${link}; text-decoration: none;">`);

            // Code blocks
            styled = styled.replace(/<pre([^>]*)>/gi, `<pre$1 style="background: ${codeBg};">`);
            styled = styled.replace(/<code([^>]*)>/gi, `<code$1 style="background: ${codeBg};">`);

            // Tables
            styled = styled.replace(/<th([^>]*)>/gi, `<th$1 style="border: 1px solid ${tableBorder};">`);
            styled = styled.replace(/<td([^>]*)>/gi, `<td$1 style="border: 1px solid ${tableBorder};">`);

            return styled;
        }

        test('10.5-THEME-003: Heading receives dark theme color', () => {
            const html = '<h1>Test</h1>';
            const styled = applyThemeStyles(html, true);
            assertIncludes(styled, 'color: #569cd6', 'Dark theme heading should have blue color');
        });

        test('10.5-THEME-004: Heading receives light theme color', () => {
            const html = '<h1>Test</h1>';
            const styled = applyThemeStyles(html, false);
            assertIncludes(styled, 'color: #0066cc', 'Light theme heading should have blue color');
        });

        test('10.5-THEME-005: Link receives theme color', () => {
            const html = '<a href="#">Link</a>';
            const styled = applyThemeStyles(html, true);
            assertIncludes(styled, 'color: #4ec9b0', 'Dark theme link should have teal color');
        });

        test('10.5-THEME-006: Code block receives theme background', () => {
            const html = '<pre><code>code</code></pre>';
            const styled = applyThemeStyles(html, true);
            assertIncludes(styled, 'background: #252526', 'Dark theme code should have dark background');
        });

        test('10.5-THEME-007: Table cells receive theme border', () => {
            const html = '<table><tr><th>H</th><td>D</td></tr></table>';
            const styled = applyThemeStyles(html, true);
            assertIncludes(styled, 'border: 1px solid #3c3c3c', 'Dark theme table should have border');
        });

        // ========== Run Tests ==========

        async function runTests() {
            const testsDiv = document.getElementById('tests');
            const summaryDiv = document.getElementById('summary');

            for (const { name, fn } of tests) {
                const div = document.createElement('div');
                div.className = 'test pending';
                div.innerHTML = `<div class="test-name">${name}</div><div class="test-result">Running...</div>`;
                testsDiv.appendChild(div);

                try {
                    await fn();
                    passed++;
                    div.className = 'test pass';
                    div.querySelector('.test-result').textContent = 'PASSED';
                } catch (e) {
                    failed++;
                    div.className = 'test fail';
                    div.querySelector('.test-result').innerHTML = `<span style="color: #f44747">FAILED: ${e.message}</span>`;
                    console.error(`Test "${name}" failed:`, e);
                }
            }

            summaryDiv.innerHTML = `
                <strong>Results:</strong> ${passed} passed, ${failed} failed, ${tests.length} total
                <br>
                <span style="color: ${failed === 0 ? '#4caf50' : '#f44336'}">
                    ${failed === 0 ? 'ALL TESTS PASSED' : `${failed} TESTS FAILED`}
                </span>
            `;
        }

        // Demo: Render sample markdown in preview pane
        async function demoPreview() {
            const sampleMarkdown = `# Markdown Preview Demo

## Features

- **Bold text** and *italic text*
- [Links](https://example.com) (disabled for security)
- Code blocks with syntax highlighting

### Table Example

| Name | Value |
|------|-------|
| One  | 1     |
| Two  | 2     |

### Code Block

\`\`\`javascript
function hello() {
    console.log("Hello, World!");
}
\`\`\`

### Mermaid Diagram

\`\`\`mermaid
graph LR
    A[Start] --> B{Decision}
    B -->|Yes| C[OK]
    B -->|No| D[Cancel]
\`\`\`

> This is a blockquote for reference.
`;

            const result = await JsonBridge.renderMarkdownWithMermaid(sampleMarkdown, 'dark');
            const parsed = JSON.parse(result);

            if (parsed.success) {
                const previewPane = document.getElementById('preview-pane');
                previewPane.innerHTML = parsed.html;
                previewPane.style.cssText = `
                    background: #1e1e1e;
                    color: #d4d4d4;
                    padding: 16px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 14px;
                    line-height: 1.6;
                `;

                // Apply basic styling
                const style = document.createElement('style');
                style.textContent = `
                    #preview-pane h1, #preview-pane h2, #preview-pane h3 { color: #569cd6; margin: 16px 0 8px; }
                    #preview-pane a { color: #4ec9b0; pointer-events: none; }
                    #preview-pane code { background: #252526; padding: 2px 6px; border-radius: 3px; }
                    #preview-pane pre { background: #252526; padding: 12px; border-radius: 4px; overflow-x: auto; }
                    #preview-pane pre code { background: transparent; padding: 0; }
                    #preview-pane table { border-collapse: collapse; width: 100%; margin: 16px 0; }
                    #preview-pane th, #preview-pane td { border: 1px solid #3c3c3c; padding: 8px; }
                    #preview-pane th { background: #252526; }
                    #preview-pane blockquote { border-left: 4px solid #3c3c3c; margin: 16px 0; padding-left: 16px; opacity: 0.85; }
                    #preview-pane .mermaid-diagram { text-align: center; margin: 16px 0; }
                `;
                document.head.appendChild(style);
            }
        }

        // Run everything
        await runTests();
        await demoPreview();
    </script>
</body>
</html>
